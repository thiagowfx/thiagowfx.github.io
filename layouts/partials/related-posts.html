{{- $currentPage := . -}}
{{- $currentTitle := .Title | lower -}}
{{- $posts := where .Site.RegularPages "Section" "posts" -}}
{{- $posts = where $posts "Permalink" "ne" .Permalink -}}

{{- /* Extract words from current title (min 4 chars to skip common words) */ -}}
{{- $titleWords := slice -}}
{{- range split $currentTitle " " -}}
  {{- $word := . | replaceRE "[^a-z0-9]+" "" -}}
  {{- if ge (len $word) 4 -}}
    {{- $titleWords = $titleWords | append $word -}}
  {{- end -}}
{{- end -}}

{{- /* Score posts by matching title words */ -}}
{{- $scored := slice -}}
{{- range $posts -}}
  {{- $otherTitle := .Title | lower -}}
  {{- $score := 0 -}}
  {{- range $titleWords -}}
    {{- if in $otherTitle . -}}
      {{- $score = add $score 1 -}}
    {{- end -}}
  {{- end -}}
  {{- /* Also boost if they share tags */ -}}
  {{- $sharedTags := intersect $currentPage.Params.tags .Params.tags -}}
  {{- $score = add $score (len $sharedTags) -}}
  {{- if gt $score 0 -}}
    {{- $scored = $scored | append (dict "page" . "score" $score) -}}
  {{- end -}}
{{- end -}}

{{- /* Sort by score descending and take top 2 */ -}}
{{- $sorted := sort $scored "score" "desc" -}}
{{- $related := slice -}}
{{- range first 2 $sorted -}}
  {{- $related = $related | append .page -}}
{{- end -}}

{{- if $related -}}
<div style="border: 2px solid var(--border-color); border-radius: .5rem; padding: 1.5rem; margin: 2rem 0;">
  <h4 style="margin-top: 0;">Related Posts</h4>
  <section style="display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem 0;">
    {{- range $related -}}
    <article style="flex: 1 1 250px; padding: 1rem; background: var(--code-bg); border-radius: .25rem; color: var(--text-color);">
      <h5 style="margin-top: 0; margin-bottom: .5rem; color: var(--heading-color);">
        <a href="{{ .Permalink }}">{{ .Title }}</a>
      </h5>
      {{- with .Summary -}}
      <p style="margin: .5rem 0; font-size: .9rem;">{{ . | plainify | truncate 150 }}</p>
      {{- end -}}
      <small style="color: var(--color-gray);">{{ .Date.Format "Jan 02, 2006" }}</small>
    </article>
    {{- end -}}
  </section>
</div>
{{- end -}}
