{{- /* Skip backlinks in quick builds (pre-commit) */ -}}
{{- if ne hugo.Environment "quick" -}}

{{- $currentFilename := path.Base .File.Path | replaceRE "\\.md$" "" -}}
{{- $linkData := index $.Site.Data.links.posts $currentFilename -}}
{{- $backlinkIds := $linkData.backlinks | default slice -}}
{{- $paths := $.Site.Data.links.paths -}}

{{- /* Resolve backlink IDs to page objects */ -}}
{{- $backlinks := slice -}}
{{- range $backlinkIds -}}
  {{- $hugoPath := index $paths . -}}
  {{- if $hugoPath -}}
    {{- $page := $.Site.GetPage $hugoPath -}}
    {{- if $page -}}
      {{- $backlinks = $backlinks | append $page -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $backlinks -}}
<div class="backlinks" style="border: 2px solid var(--border-color); border-radius: .5rem; padding: 1.5rem 1.5rem 1rem; margin-top: 1.5rem;">
  <h4 id="backlinks" style="margin-top: 0; margin-bottom: 0.25rem;">Backlinks</h4>
  <ul style="margin-bottom: 0;">
    {{- range $backlinks -}}
    <li>
      <a href="{{ .Permalink }}">{{ .Title }}</a>
      <small style="color: var(--color-gray);">({{ .Date.Format "Jan 02, 2006" }})</small>
    </li>
    {{- end -}}
  </ul>
</div>
{{- end -}}

{{- end -}}
