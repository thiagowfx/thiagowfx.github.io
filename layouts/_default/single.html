{{- define "main" }}
{{- $posts := where .Site.RegularPages "Section" .Section }}
{{- if in .Params.tags "coding" }}
  {{- $posts = where $posts "Params.tags" "intersect" (slice "coding") }}
{{- else }}
  {{- $posts = where $posts "Params.tags" "intersect" (slice "coding") | symdiff $posts }}
{{- end }}
{{- $prevPost := "" }}
{{- $nextPost := "" }}
{{- range $posts }}
  {{- if lt .Date $.Date }}
    {{- if or (eq $prevPost "") (gt .Date $prevPost.Date) }}
      {{- $prevPost = . }}
    {{- end }}
  {{- else if gt .Date $.Date }}
    {{- if or (eq $nextPost "") (lt .Date $nextPost.Date) }}
      {{- $nextPost = . }}
    {{- end }}
  {{- end }}
{{- end }}
<script>
  document.addEventListener('keydown', function(event) {
    if (event.key === 'j' || event.key === 'ArrowLeft') {
      const prev = document.querySelector('[data-nav="prev"]');
      if (prev && prev.href) window.location.href = prev.href;
    } else if (event.key === 'k' || event.key === 'ArrowRight') {
      const next = document.querySelector('[data-nav="next"]');
      if (next && next.href) window.location.href = next.href;
    }
  });
</script>
<a href="{{ with $prevPost }}{{ .Permalink }}{{ end }}" data-nav="prev" style="display: none;"></a>
<a href="{{ with $nextPost }}{{ .Permalink }}{{ end }}" data-nav="next" style="display: none;"></a>
{{- $hasCommentaryCategory := false }}
{{- range (.GetTerms "categories") }}
  {{- if eq .Name "commentary" }}
    {{- $hasCommentaryCategory = true }}
  {{- end }}
{{- end }}
{{- if not .Params.menu }}
<article class="h-entry">
<div class="article-header">
  <h2>
    {{- if in .Params.tags "bestof" }}
    <span>‚òÖ</span>
    {{- end }}
    {{- if and (.Params.external_link) $hasCommentaryCategory }}
    üîó Reply to: <a href="{{ .Params.external_link }}" class="p-name u-in-reply-to" target="_blank" rel="noopener noreferrer">{{ replace .Title "Reply to: " "" }}</a>
    {{- else }}
    <span class="p-name">{{ .Title }}</span>
    {{- end }}
  </h2>
  <button id="fullscreen-btn" class="fullscreen-btn" aria-label="Toggle fullscreen mode" title="Toggle fullscreen mode (f)">
    <span id="fullscreen-icon">‚õ∂</span>
  </button>
</div>
<p>
  {{ if not .Date.IsZero }}
  <span class="pubdate-single">
    <time class="dt-published" datetime='{{ .Date.Format "2006-01-02T15:04:05-07:00" }}' pubdate>
      {{ .Date.Format (default "02 Jan, 2006" .Site.Params.dateFormat) }}
    </time>
    {{ with .WordCount }} ‚Ä¢ {{ . }} words {{ end }} {{ with .ReadingTime }} ‚Ä¢ {{
    . }} min {{ end }}
    {{ if and .GitInfo (ne (.Date.Format "2006-01-02") (.Lastmod.Format "2006-01-02")) }}
    ‚Ä¢ updated <time datetime='{{ .Lastmod.Format "2006-01-02" }}'>{{ .Lastmod.Format (default "02 Jan, 2006" .Site.Params.dateFormat) }}</time>
    {{ end }}
  </span>
  {{ else }}
  <span class="pubdate-single">
    Last updated <time datetime='{{ .Lastmod.Format "2006-01-02" }}'>{{ .Lastmod.Format (default "02 Jan, 2006" .Site.Params.dateFormat) }}</time>
  </span>
  {{ end }}
</p>
{{- end }}
{{- $warningYears := int (default 0 .Site.Params.oldEntryWarningYears) }}
{{- $isPost := or (eq .Section "posts") (eq .Type "posts") }}
{{- if and $isPost (gt $warningYears 0) (not .Date.IsZero) }}
  {{- $yearsOffset := int (mul -1 $warningYears) }}
  {{- $thresholdDate := now.AddDate $yearsOffset 0 0 }}
  {{- if lt .Date $thresholdDate }}
    {{- $thresholdText := printf "%d years" $warningYears }}
    {{- if eq $warningYears 1 }}
      {{- $thresholdText = "one year" }}
    {{- end }}
    <div class="old-entry-warning" role="note">
      ‚ö†Ô∏è This post is over {{ $thresholdText }} old. It may no longer be up to date or relevant. Opinions may have changed.
    </div>
  {{- end }}
{{- end }}

{{- $showToc := .Params.toc | default true -}}
{{- if and (gt (len .TableOfContents) 100) $showToc }}
<details class="toc">
  <summary>Table of Contents</summary>
  {{ .TableOfContents }}
</details>
{{- end }}
<div class="e-content"> {{ .Content }} </div>
{{- $showEmail := .Params.email | default true -}}
{{- $hasCategories := gt (len (.GetTerms "categories")) 0 -}}
{{- $hasTags := gt (len (.GetTerms "tags")) 0 -}}
{{- if or $showEmail $hasCategories $hasTags -}}
<p style="text-align: center; margin: 2em 0 1em;">‚Äî ¬ß ‚Äî</p>
<div style="display: flex; justify-content: space-between">
  {{ if $showEmail }}
  <p style="margin: 0;">
    Reply via
    <a
      href="mailto:{{ .Site.Params.Author.email }}?subject=Reply to: {{ .Title }}"
      >email</a
    >
  </p>
  {{ end }}
  {{ if or $hasCategories $hasTags }}
  <p style="margin: 0;">
    {{- $categoryLinks := slice }}
    {{- range (.GetTerms "categories") }}
    {{- $categoryLinks = $categoryLinks | append (printf `<a href="%s">%%%s</a>` .Permalink .Name) }}
    {{- end }}
    {{- $tagLinks := slice }}
    {{- range (.GetTerms "tags") }}
    {{- $tagLinks = $tagLinks | append (printf `<a href="%s">#%s</a>` .Permalink .Name) }}
    {{- end }}
    {{- delimit $categoryLinks " " | safeHTML }}{{- if and $hasCategories $hasTags }} ‚Ä¢ {{ end }}{{- delimit $tagLinks " " | safeHTML }}
  </p>
  {{ end }}
</div>
{{- end -}}
{{- if eq .Section "posts" -}}
{{- partial "related-posts.html" . -}}
{{- partial "backlinks.html" . -}}
{{- end -}}
<a class="u-url" href="{{ .Permalink }}" aria-hidden="true" style="display:none;"></a>
<div class="h-card" style="display:none;">
  <a class="p-name u-url" href="{{ "" | absURL }}" rel="author">{{ .Site.Params.Author.name }}</a>
  <span class="p-nickname">{{ .Site.Params.Author.nickname }}</span>
  <a class="u-email" href="mailto:{{ .Site.Params.Author.email }}">{{ .Site.Params.Author.email }}</a>
  <img class="u-photo" src="{{ "thiagowfx.webp" | absURL }}" alt="{{ .Site.Params.Author.name }}" />
</div>
</article>
{{- end -}}
