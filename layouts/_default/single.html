{{- define "main" }}
{{- $posts := where .Site.RegularPages "Section" .Section }}
{{- if in .Params.tags "coding" }}
  {{- $posts = where $posts "Params.tags" "intersect" (slice "coding") }}
{{- else }}
  {{- $posts = where $posts "Params.tags" "intersect" (slice "coding") | symdiff $posts }}
{{- end }}
{{- $prevPost := "" }}
{{- $nextPost := "" }}
{{- range $posts }}
  {{- if lt .Date $.Date }}
    {{- if or (eq $prevPost "") (gt .Date $prevPost.Date) }}
      {{- $prevPost = . }}
    {{- end }}
  {{- else if gt .Date $.Date }}
    {{- if or (eq $nextPost "") (lt .Date $nextPost.Date) }}
      {{- $nextPost = . }}
    {{- end }}
  {{- end }}
{{- end }}
<script>
  document.addEventListener('keydown', function(event) {
    if (event.key === 'j' || event.key === 'ArrowLeft') {
      const prev = document.querySelector('[data-nav="prev"]');
      if (prev && prev.href) window.location.href = prev.href;
    } else if (event.key === 'k' || event.key === 'ArrowRight') {
      const next = document.querySelector('[data-nav="next"]');
      if (next && next.href) window.location.href = next.href;
    }
  });
</script>
<a href="{{ with $prevPost }}{{ .Permalink }}{{ end }}" data-nav="prev" style="display: none;"></a>
<a href="{{ with $nextPost }}{{ .Permalink }}{{ end }}" data-nav="next" style="display: none;"></a>
{{- if not .Params.menu }}
<h2>
  {{- if in .Params.tags "bestof" }}
  <span>★</span>
  {{- end }} {{ .Title }}
</h2>
<p>
  {{ if not .Date.IsZero }}
  <span class="pubdate-single">
    <time datetime='{{ .Date.Format "2006-01-02" }}' pubdate>
      {{ .Date.Format (default "02 Jan, 2006" .Site.Params.dateFormat) }}
    </time>
    {{ with .WordCount }} • {{ . }} words {{ end }} {{ with .ReadingTime }} • {{
    . }} min {{ end }}
    {{ if and .GitInfo (ne (.Date.Format "2006-01-02") (.Lastmod.Format "2006-01-02")) }}
    • updated <time datetime='{{ .Lastmod.Format "2006-01-02" }}'>{{ .Lastmod.Format (default "02 Jan, 2006" .Site.Params.dateFormat) }}</time>
    {{ end }}
  </span>
  {{ else }}
  <span class="pubdate-single">
    Last updated <time datetime='{{ .Lastmod.Format "2006-01-02" }}'>{{ .Lastmod.Format (default "02 Jan, 2006" .Site.Params.dateFormat) }}</time>
  </span>
  {{ end }}
</p>
{{- end }}
{{- $warningYears := int (default 0 .Site.Params.oldEntryWarningYears) }}
{{- $isPost := or (eq .Section "posts") (eq .Type "posts") }}
{{- if and $isPost (gt $warningYears 0) (not .Date.IsZero) }}
  {{- $yearsOffset := int (mul -1 $warningYears) }}
  {{- $thresholdDate := now.AddDate $yearsOffset 0 0 }}
  {{- if lt .Date $thresholdDate }}
    {{- $thresholdText := printf "%d years" $warningYears }}
    {{- if eq $warningYears 1 }}
      {{- $thresholdText = "one year" }}
    {{- end }}
    <div class="old-entry-warning" role="note">
      ⚠️ This post is over {{ $thresholdText }} old. It may no longer be up to date. Opinions may have changed.
    </div>
  {{- end }}
{{- end }}
{{- if gt (len .TableOfContents) 100 }}
<details class="toc">
  <summary>Table of Contents</summary>
  {{ .TableOfContents }}
</details>
{{- end }}
<content> {{ .Content }} </content>
{{- $showEmail := .Params.email | default true -}}
{{- $hasTags := gt (len (.GetTerms "tags")) 0 -}}
{{- if or $showEmail $hasTags -}}
<p style="text-align: center; margin: 2em 0 1em;">— § —</p>
<div style="display: flex; justify-content: space-between">
  {{ if $showEmail }}
  <p style="margin: 0;">
    Reply via
    <a
      href="mailto:{{ .Site.Params.Author.email }}?subject=Reply to: {{ .Title }}"
      >email</a
    >
  </p>
  {{ end }}
  {{ if $hasTags }}
  <p style="margin: 0;">
    {{- range (.GetTerms "tags") }}
    <a href="{{ .Permalink }}">#{{ .Name }}</a>
    {{- end }}
  </p>
  {{ end }}
</div>
{{- end -}}
{{- partial "related-posts.html" . -}}
{{- end }}
