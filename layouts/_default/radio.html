{{- define "main" }}
<style>
  .radio-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }
  .radio-controls button {
    background: none;
    border: 1px solid var(--border-color);
    border-radius: .25rem;
    padding: 0.25rem 0.75rem;
    cursor: pointer;
    color: var(--text-color);
    font-size: 0.85rem;
  }
  .radio-controls button:hover {
    border-color: var(--link-color);
    color: var(--link-color);
  }
  .radio-volume {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.85rem;
    color: var(--color-gray);
    margin-left: auto;
  }
  .radio-volume button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    padding: 0;
    line-height: 1;
  }
  .radio-volume input[type="range"] {
    width: 6rem;
    accent-color: var(--link-color);
  }
  .radio-now-playing {
    display: none;
    padding: 0.5rem 0.75rem;
    margin-bottom: 1rem;
    border: 1px solid var(--link-color);
    border-radius: .25rem;
    font-size: 0.85rem;
    color: var(--text-color);
    background: color-mix(in srgb, var(--link-color) 8%, var(--bg-color));
  }
  .radio-now-playing.visible {
    display: block;
  }
  .radio-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
  }
  @media (max-width: 900px) {
    .radio-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 600px) {
    .radio-grid {
      grid-template-columns: 1fr;
    }
  }
  .radio-card {
    border: 1px solid var(--border-color);
    border-radius: .25rem;
    padding: 0.75rem;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
  }
  .radio-card:hover {
    border-color: var(--link-color);
  }
  .radio-card.playing {
    border-color: var(--link-color);
    background: color-mix(in srgb, var(--link-color) 8%, var(--bg-color));
  }
  .radio-card.error {
    border-color: #c44;
    background: color-mix(in srgb, #c44 8%, var(--bg-color));
  }
  .radio-card-error {
    display: none;
    font-size: 0.75rem;
    color: #c44;
    margin-top: 0.25rem;
  }
  .radio-card.error .radio-card-error {
    display: block;
  }
  .radio-card-name {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
  }
  .radio-card-star {
    color: #e2b714;
  }
  .radio-card-genre {
    font-size: 0.75rem;
    color: var(--color-gray);
  }
  .radio-card-link {
    font-size: 0.75rem;
    color: var(--color-gray);
    text-decoration: none;
    margin-top: 0.25rem;
    display: inline-block;
  }
  .radio-card-link:hover {
    color: var(--link-color);
  }
  .radio-card-dot {
    display: none;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--link-color);
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    animation: radio-pulse 1.5s ease-in-out infinite;
  }
  .radio-card.playing .radio-card-dot {
    display: block;
  }
  @keyframes radio-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  @media (prefers-reduced-motion: reduce) {
    .radio-card-dot {
      animation: none;
    }
  }
</style>

<div class="article-header">
  <h2>{{ .Title }}</h2>
  <button id="fullscreen-btn" class="fullscreen-btn" aria-label="Toggle fullscreen mode" title="Toggle fullscreen mode (f)">
    <span id="fullscreen-icon">â›¶</span>
  </button>
</div>
<p>Internet radio stations for coding. Mirrors my <a href="https://github.com/thiagowfx/pancake/tree/master/radio"><code>radio</code></a> shell script. Most stations are from <a href="https://somafm.com/">SomaFM</a>, a listener-supported internet radio service (<a href="https://somafm.com/support/">donate</a>).</p>

<div class="radio-controls">
  <button id="radio-random" title="Play a random station">&#x1f3b2; Random</button>
  <button id="radio-burst" title="Play 3 random stations">&#x1f4a5; Burst</button>
  <button id="radio-stop" title="Stop all stations">&#x23f9;&#xfe0f; Stop all</button>
  <div class="radio-volume">
    <button id="radio-mute" title="Mute/unmute">&#x1f50a;</button>
    <input type="range" id="radio-volume" min="0" max="100" value="80" aria-label="Volume">
  </div>
</div>

<div class="radio-now-playing" id="radio-now-playing">
  Now playing: <span id="radio-now-playing-list"></span>
</div>

<div class="radio-grid" id="radio-grid"></div>

<script>
(function() {
  const stations = [
    // keep-sorted start
    { name: 'KFAI Minneapolis', id: 'kfai', genre: 'community', url: 'https://kfai.broadcasttool.stream/kfai-1', homepage: 'https://www.kfai.org/' },
    { name: 'Latina Salsa', id: 'salsa', genre: 'latin', url: 'https://latinasalsa.ice.infomaniak.ch/latinasalsa.mp3', homepage: 'https://www.radio.net/s/latinasalsa' },
    { name: 'Lo-fi Hip Hop', id: 'lofi', genre: 'hip hop', url: 'https://live.hunter.fm/lofi_low', homepage: 'https://hunter.fm/' },
    { name: 'Nightride FM', id: 'nightride', genre: 'synthwave', url: 'https://stream.nightride.fm/nightride.ogg', homepage: 'https://nightride.fm/' },
    { name: 'SomaFM Beat Blender', id: 'beatblender', genre: 'deep house', url: 'https://ice2.somafm.com/beatblender-64-aac', homepage: 'https://somafm.com/beatblender/' },
    { name: 'SomaFM Bossa Beyond', id: 'bossa', genre: 'bossa nova', url: 'https://ice2.somafm.com/bossa-64-aac', homepage: 'https://somafm.com/bossa/' },
    { name: 'SomaFM DEF CON Radio', id: 'defcon', genre: 'hacking', url: 'https://ice2.somafm.com/defcon-64-aac', homepage: 'https://somafm.com/defcon/', starred: true },
    { name: 'SomaFM Deep Space One', id: 'deepspaceone', genre: 'space', url: 'https://ice2.somafm.com/deepspaceone-64-aac', homepage: 'https://somafm.com/deepspaceone/' },
    { name: 'SomaFM Drone Zone', id: 'ambient', genre: 'drone', url: 'https://ice2.somafm.com/dronezone-64-aac', homepage: 'https://somafm.com/dronezone/' },
    { name: 'SomaFM Groove Salad', id: 'groovesalad', genre: 'downtempo', url: 'https://ice2.somafm.com/groovesalad-64-aac', homepage: 'https://somafm.com/groovesalad/' },
    { name: 'SomaFM Indie Pop Rocks', id: 'indie', genre: 'pop', url: 'https://ice2.somafm.com/indiepop-64-aac', homepage: 'https://somafm.com/indiepop/' },
    { name: 'SomaFM Jazz', id: 'jazz', genre: 'jazz', url: 'https://ice2.somafm.com/live-64-aac', homepage: 'https://somafm.com/live/' },
    { name: 'SomaFM Space Station', id: 'spacestation', genre: 'electronica', url: 'https://ice2.somafm.com/spacestation-64-aac', homepage: 'https://somafm.com/spacestation/' },
    { name: 'WFMU', id: 'wfmu', genre: 'freeform', url: 'https://stream0.wfmu.org/freeform-128k.mp3', homepage: 'https://wfmu.org/' },
    // keep-sorted end
  ];

  const somaServers = ['ice1', 'ice2', 'ice3', 'ice4', 'ice5', 'ice6'];
  const playing = new Map();
  let volume = 0.8;

  const grid = document.getElementById('radio-grid');
  const nowPlaying = document.getElementById('radio-now-playing');
  const nowPlayingList = document.getElementById('radio-now-playing-list');
  const volumeSlider = document.getElementById('radio-volume');

  stations.forEach((s) => {
    const card = document.createElement('div');
    card.className = 'radio-card';
    card.dataset.id = s.id;
    const star = s.starred ? '<span class="radio-card-star">&#9733; </span>' : '';
    card.innerHTML = '<div class="radio-card-dot"></div>' +
      '<div class="radio-card-name">' + star + s.name + '</div>' +
      '<div class="radio-card-genre">' + s.genre + '</div>' +
      '<a class="radio-card-link" href="' + s.homepage + '" target="_blank" rel="noopener">&#x2197; website</a>' +
      '<div class="radio-card-error">Station unavailable</div>';
    card.addEventListener('click', (e) => {
      if (e.target.closest('.radio-card-link')) return;
      toggle(s.id);
    });
    grid.appendChild(card);
  });

  function getStation(id) {
    return stations.find((s) => s.id === id);
  }

  function getCard(id) {
    return grid.querySelector('.radio-card[data-id="' + id + '"]');
  }

  function play(id, somaIdx) {
    if (playing.has(id)) return;
    const s = getStation(id);
    const isSoma = /ice\d+\.somafm\.com/.test(s.url);
    const idx = somaIdx || 0;
    const url = isSoma ? s.url.replace(/ice\d+/, somaServers[idx]) : s.url;
    const audio = new Audio(url);
    audio.volume = volume;
    getCard(id).classList.remove('error');
    if (isSoma && idx + 1 < somaServers.length) {
      audio.addEventListener('error', () => {
        if (audio._stopped) return;
        audio.src = '';
        playing.delete(id);
        play(id, idx + 1);
      }, { once: true });
    } else {
      audio.addEventListener('error', () => {
        if (audio._stopped) return;
        audio.src = '';
        playing.delete(id);
        getCard(id).classList.add('error');
        updateUI();
      }, { once: true });
    }
    audio.play().catch((e) => {
      console.warn('Failed to play ' + s.name + ':', e.message);
    });
    playing.set(id, audio);
    updateUI();
  }

  function stop(id) {
    const audio = playing.get(id);
    if (!audio) return;
    audio._stopped = true;
    audio.pause();
    audio.src = '';
    playing.delete(id);
    updateUI();
  }

  function toggle(id) {
    if (playing.has(id)) {
      stop(id);
    } else {
      play(id);
    }
  }

  function stopAll() {
    const ids = Array.from(playing.keys());
    ids.forEach((id) => stop(id));
    grid.querySelectorAll('.radio-card.error').forEach((c) => c.classList.remove('error'));
  }

  function playRandom() {
    stopAll();
    const idx = Math.floor(Math.random() * stations.length);
    play(stations[idx].id);
  }

  function playBurst() {
    stopAll();
    const indices = [];
    while (indices.length < 3 && indices.length < stations.length) {
      const idx = Math.floor(Math.random() * stations.length);
      if (indices.indexOf(idx) === -1) indices.push(idx);
    }
    indices.forEach((i) => play(stations[i].id));
  }

  function updateUI() {
    grid.querySelectorAll('.radio-card').forEach((card) => {
      card.classList.toggle('playing', playing.has(card.dataset.id));
    });

    const names = [];
    playing.forEach((audio, id) => {
      names.push(getStation(id).name);
    });
    if (names.length > 0) {
      nowPlayingList.textContent = names.join(', ');
      nowPlaying.classList.add('visible');
    } else {
      nowPlaying.classList.remove('visible');
    }
  }

  let muted = false;
  let volumeBeforeMute = volume;
  const muteBtn = document.getElementById('radio-mute');

  volumeSlider.addEventListener('input', function() {
    volume = this.value / 100;
    muted = volume === 0;
    muteBtn.innerHTML = muted ? '&#x1f507;' : '&#x1f50a;';
    playing.forEach((audio) => { audio.volume = volume; });
  });

  muteBtn.addEventListener('click', () => {
    if (muted) {
      volume = volumeBeforeMute || 0.8;
      volumeSlider.value = volume * 100;
    } else {
      volumeBeforeMute = volume;
      volume = 0;
      volumeSlider.value = 0;
    }
    muted = !muted;
    muteBtn.innerHTML = muted ? '&#x1f507;' : '&#x1f50a;';
    playing.forEach((audio) => { audio.volume = volume; });
  });

  document.getElementById('radio-random').addEventListener('click', playRandom);
  document.getElementById('radio-burst').addEventListener('click', playBurst);
  document.getElementById('radio-stop').addEventListener('click', stopAll);
})();
</script>
{{- end -}}
