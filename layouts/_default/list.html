{{- define "main" }}
<div class="h-feed">
<div class="content">
  {{- $pages := where .Pages "Site.Language.Lang" .Site.Language.Lang }}
  {{- $excludeCategories := slice "coding" "recipes" }}

  <h2 id="posts" class="p-name" style="display: flex; align-items: center; gap: 0;">
    {{- if .Data.Singular }}
      {{- if eq .Section "tags" }} {{ i18n "postsTaggedWith" }} #{{ .Name }}
      {{- else if eq .Section "categories" }} {{ i18n "postsCategorizedAs" }} %{{ .Name }}
      {{- end }} ({{ len .Pages }})
    {{- else }} {{ i18n "allPosts" }} ({{ len $pages }}) {{- end }}
    <a href='{{ (.OutputFormats.Get "RSS").Permalink }}' class="rss-link" title="RSS feed">{{- partial "rss-icon.html" . -}}</a>
  </h2>

  {{- if .Data.Singular }}
   {{- if eq .Section "tags" }}
   {{- partial "search-widget.html" (dict "contentSelector" "#posts-content" "includeTags" (slice .Name) "lang" .Site.Language.Lang) }}
   {{- else if eq .Section "categories" }}
   {{- partial "search-widget.html" (dict "contentSelector" "#posts-content" "includeCategories" (slice .Name) "lang" .Site.Language.Lang) }}
   {{- end }}
   {{- else }}
   {{- partial "search-widget.html" (dict "contentSelector" "#posts-content" "excludeCategories" (slice "coding" "recipes") "lang" .Site.Language.Lang) }}
   {{- end }}

  <div id="posts-content">
  <div class="e-content">
  {{- if and .Data.Singular (eq .Name "coding") }}
  <!-- Cumulative Problems Solved Graph -->
  <div style="margin: 2rem 0;">
    <h3>Progress</h3>
    <canvas id="cumulative-chart" style="width: 100%; height: 400px;"></canvas>
  </div>
  {{- end }}


  {{ $currentYear := now.Year | printf "%d" }}
  {{ $pagesGroupedByYear := $pages.GroupByDate "2006" }}
  {{- if and (not .Data.Singular) (eq .Section "posts") }}
    {{- $filteredGroups := slice }}
    {{- range $group := $pagesGroupedByYear }}
      {{- $filteredPages := slice }}
      {{- range $page := $group.Pages }}
        {{- $isExcluded := false }}
        {{- $isSectionPage := eq .Kind "section" }}
        {{- if $isSectionPage }}
          {{- $isExcluded = true }}
        {{- else }}
          {{- range $cat := $page.Params.categories }}
            {{- if in $excludeCategories $cat }}
              {{- $isExcluded = true }}
            {{- end }}
          {{- end }}
        {{- end }}
        {{- if not $isExcluded }}
          {{- $filteredPages = $filteredPages | append $page }}
        {{- end }}
      {{- end }}
      {{- if gt (len $filteredPages) 0 }}
        {{- $filteredGroups = $filteredGroups | append (dict "Key" $group.Key "Pages" $filteredPages) }}
      {{- end }}
    {{- end }}
    {{- $pagesGroupedByYear = $filteredGroups }}
  {{- end }}

  {{ if not $pagesGroupedByYear }}
    <ul class="blog-posts">
      <li>No posts yet</li>
    </ul>
  {{ else }}
    {{ range $i, $group := $pagesGroupedByYear }}
    <details class="year-group" {{ if eq $group.Key $currentYear }}open{{ end }}>
      <summary>
        <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" height="1.2em" width="1.2em">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg>
        <strong>{{ $group.Key }}</strong> <span style="color: var(--color-gray); font-weight: 400;">({{ len $group.Pages }} {{ if eq (len $group.Pages) 1 }}post{{ else }}posts{{ end }})</span>
      </summary>
      <div class="year-content">
        <div class="year-content-inner">
          <ul class="blog-posts">
            {{ $lastDate := "" }}
            {{ range $group.Pages }}
            {{ $currentDate := .Date.Format "02 Jan, 2006" }}
            <li class="h-entry">
              <span>
                {{ if ne $currentDate $lastDate }}
                <a class="u-url" href="{{ .Permalink }}">
                  <time
                    class="dt-published"
                    datetime='{{ .Date.Format "2006-01-02T15:04:05-07:00" }}'
                  >
                    {{ .Date.Format (default "02 Jan, 2006" .Site.Params.dateFormat) }}
                  </time>
                </a>
                {{ end }}
              </span>
              <a href="{{ .Permalink }}">
                {{- if in .Params.tags "bestof" }}
                <span>â˜…</span>
                {{- end }}
                {{- $hasCommentaryCategory := false }}
                {{- range (.GetTerms "categories") }}
                  {{- if eq .Name "commentary" }}
                    {{- $hasCommentaryCategory = true }}
                  {{- end }}
                {{- end }}
                {{- if and (.Params.external_link) $hasCommentaryCategory }}
                <span>ðŸ”—</span>
                {{- end }}
                <span class="p-name">{{ .Title }}</span>
              </a>
            </li>
            {{ $lastDate = $currentDate }}
            {{ end }}
          </ul>
        </div>
      </div>
    </details>
    {{ end }}
  {{ end }}
  {{- if not .Data.Singular }}
  <hr>
  <h2 id="categories">
    {{ i18n "categories" }}
    <a href='{{ "categories/#categories" | absURL }}'>%</a>
  </h2>
  {{- $categories := sort .Site.Taxonomies.categories "Page.Name" }}
  {{- if $categories }}
  <div class="tag-cloud">
    {{- range $categories }}
    <a href="{{ .Page.Permalink }}" class="tag-pill">%{{ .Page.Name | lower }}<span class="tag-count">{{ len .Pages }}</span></a>
    {{- end }}
  </div>
  {{- else }}
  <p>{{ i18n "noCategories" }}</p>
  {{- end }}
  <hr>
  <h2 id="tags">
    Tags
    <a href='{{ "posts/#tags" | absURL }}'>#</a>
  </h2>
  <div class="tag-cloud">
    {{- range sort .Site.Taxonomies.tags "Page.Name" }}
    <a href="{{ .Page.Permalink }}" class="tag-pill">#{{ .Page.Name | lower }}<span class="tag-count">{{ len .Pages }}</span></a>
    {{- else }} {{ i18n "noTags" }} {{- end }}
  </div>
  {{- end }}
  </div>
  </div>
  </div>
</div>

  {{- if and .Data.Singular (eq .Name "coding") }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
  // Coding posts data (extracted from Hugo pages, filtered by platform)
  const leetCodePostDates = [
    {{ range .Pages }}{{ if (findRE "leetcode" .File.BaseFileName) }}'{{ .Date.Format "2006-01-02" }}',{{ end }}{{ end }}
  ];
  const byteByteGoPostDates = [
    {{ range .Pages }}{{ if (findRE "bytebytego" .File.BaseFileName) }}'{{ .Date.Format "2006-01-02" }}',{{ end }}{{ end }}
  ];
  const aocPostDates = [
    {{ range .Pages }}{{ if (findRE "(aoc|advent)" .File.BaseFileName) }}'{{ .Date.Format "2006-01-02" }}',{{ end }}{{ end }}
  ];
  const otherCodingPostDates = [
    {{ range .Pages }}{{ if and (not (findRE "leetcode" .File.BaseFileName)) (not (findRE "bytebytego" .File.BaseFileName)) (not (findRE "(aoc|advent)" .File.BaseFileName)) }}'{{ .Date.Format "2006-01-02" }}',{{ end }}{{ end }}
  ];
</script>
{{- $chartJs := resources.Get "coding-chart.js" | minify | fingerprint }}
<script src="{{ $chartJs.RelPermalink }}"></script>
{{- end }}
{{- end }}
