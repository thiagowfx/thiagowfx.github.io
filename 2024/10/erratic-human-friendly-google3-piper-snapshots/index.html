<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Erratic: human-friendly google3 piper snapshots | not just serendipity üçÄ</title><meta name=title content="Erratic: human-friendly google3 piper snapshots">
<meta name=description content="In the google3 codebase, when working with Piper directly (i.e. not
Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er),
which was a 20% project of another Software Engineer1.
google3 workflow
The workflow is as follows:

Make some changes: g4 open, g4 edit, etc
Create a CL (ChangeList) g4 change

Now let&rsquo;s say you&rsquo;re anticipating some heavy refactoring, in the same CL2,
that you could potentially regret and want to revert."><meta name=keywords content="dev,bestof,"><meta property="og:url" content="https://perrotta.dev/2024/10/erratic-human-friendly-google3-piper-snapshots/"><meta property="og:site_name" content="not just serendipity üçÄ"><meta property="og:title" content="Erratic: human-friendly google3 piper snapshots"><meta property="og:description" content="In the google3 codebase, when working with Piper directly (i.e. not Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er), which was a 20% project of another Software Engineer1.
google3 workflow The workflow is as follows:
Make some changes: g4 open, g4 edit, etc Create a CL (ChangeList) g4 change Now let‚Äôs say you‚Äôre anticipating some heavy refactoring, in the same CL2, that you could potentially regret and want to revert."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-02T13:33:56+02:00"><meta property="article:modified_time" content="2024-10-02T13:33:56+02:00"><meta property="article:tag" content="Dev"><meta property="article:tag" content="Bestof"><meta name=twitter:card content="summary"><meta name=twitter:title content="Erratic: human-friendly google3 piper snapshots"><meta name=twitter:description content="In the google3 codebase, when working with Piper directly (i.e. not Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er), which was a 20% project of another Software Engineer1.
google3 workflow The workflow is as follows:
Make some changes: g4 open, g4 edit, etc Create a CL (ChangeList) g4 change Now let‚Äôs say you‚Äôre anticipating some heavy refactoring, in the same CL2, that you could potentially regret and want to revert."><meta itemprop=name content="Erratic: human-friendly google3 piper snapshots"><meta itemprop=description content="In the google3 codebase, when working with Piper directly (i.e. not Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er), which was a 20% project of another Software Engineer1.
google3 workflow The workflow is as follows:
Make some changes: g4 open, g4 edit, etc Create a CL (ChangeList) g4 change Now let‚Äôs say you‚Äôre anticipating some heavy refactoring, in the same CL2, that you could potentially regret and want to revert."><meta itemprop=datePublished content="2024-10-02T13:33:56+02:00"><meta itemprop=dateModified content="2024-10-02T13:33:56+02:00"><meta itemprop=wordCount content="518"><meta itemprop=keywords content="Dev,Bestof"><meta name=referrer content="no-referrer-when-downgrade"><link rel="shortcut icon" href=https://perrotta.dev/favicon.ico><link rel=canonical href=https://perrotta.dev/2024/10/erratic-human-friendly-google3-piper-snapshots/><style>:root{--color-gray:#888;--color-grayer:#666;--font-title:'Inter', 'Fira Sans', 'Lato', system-ui, -apple-system, BlinkMacSystemFont, 'Avenir Next', 'Avenir', 'Segoe UI', 'Helvetica Neue', Helvetica, Ubuntu, Roboto, Noto, Cantarell, Arial, sans-serif;--font-body:'Crimson Pro', 'Vollkorn', 'Alegreya', 'Iowan Old Style', 'Apple Garamond', 'Baskerville', 'Times New Roman', 'Noto Serif', 'Droid Serif', 'Times', 'Source Serif Pro', serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';--font-code:'Fira Code', 'PT Mono', 'IBM Plex Mono', Menlo, Consolas, Monaco, 'Liberation Mono', 'Ubuntu Mono', 'Lucida Console', monospace}body{font-family:var(--font-body);margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fffcf0;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444;-webkit-text-size-adjust:100%}h1,h2,h3,h4,h5,h6,strong,b{color:#222}h1,h2,h3,h4,h5,h6,footer,nav{font-family:var(--font-title)}footer{font-size:smaller;padding:8px;text-align:center}a{color:#3273dc}a.title{text-decoration:none;border:0;display:flex;align-items:center;column-gap:10px}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}li code,p code{font-size:small}pre code{color:#222;display:block;padding:20px;white-space:pre;font-size:14px;overflow-x:auto}code,pre{font-family:var(--font-code)}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 110px}ul.blog-posts li a:visited{color:#8b6fcb}.pubdate-list{color:var(--color-gray);font-style:italic}.pubdate-single{color:var(--color-grayer);font-style:italic}.social-link-wrapper{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:8px}.social-link{text-decoration:none;font-size:1.25em}sup.gray{color:var(--color-grayer)}@media(prefers-color-scheme:dark){body{background-color:#01242e;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#444}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}}</style><link rel=apple-touch-icon href=https://perrotta.dev/apple-touch-icon.png></head><body><header><a href=/ class=title><img src=https://perrotta.dev/thiagowfx.png alt="thiagowfx's avatar" width=32 height=32><h2>not just serendipity üçÄ</h2></a><nav><a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags/bestof/>‚òÖ</a></nav></header><main><h1><span>‚òÖ</span>
Erratic: human-friendly google3 piper snapshots</h1><p><span class=pubdate-single><time datetime=2024-10-02 pubdate>02 Oct, 2024
</time>‚Ä¢ 518 words
‚Ä¢ 3 min</span></p><content><p>In the google3 codebase, when working with Piper directly (i.e. not
Fig[-on-CitC]), I often liked to use this tool called <code>erratic</code> (abbrev: <code>er</code>),
which was a 20% project of another Software Engineer<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><h2 id=google3-workflow>google3 workflow</h2><p>The workflow is as follows:</p><ul><li>Make some changes: <code>g4 open</code>, <code>g4 edit</code>, etc</li><li>Create a CL (ChangeList) <code>g4 change</code></li></ul><p>Now let&rsquo;s say you&rsquo;re anticipating some heavy refactoring, in the same CL<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>,
that you could potentially regret and want to revert.</p><p>This would be a great moment to use <code>erratic</code>. After installing it (or aliasing
it, if using it via X20), run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% er explain <span style=color:#e6db74>&#34;this is working perfectly before bob@ asked me to refactor it&#34;</span>
</span></span></code></pre></div><ul><li>Make additional changes</li><li>Feel free to make more snapshots (checkpoints), as you see fit</li></ul><p>If you ever want to roll back, run <code>er list</code>. It will list all explicit
snapshots you annotated so far. Locate the one you want to roll back to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% er list
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span> <span style=color:#e6db74>&#34;this is working perfectly before bob@ asked me to refactor it&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>78</span> <span style=color:#e6db74>&#34;second refactoring&#34;</span>
</span></span></code></pre></div><p>Now just roll back to it:</p><pre tabindex=0><code>% er restore 42
</code></pre><p>Sometimes you&rsquo;ll need to run <code>g4 add</code> afterwards. And we&rsquo;re done!</p><p><strong>Colophon</strong>: Why use <code>erratic</code> at all, since CitC already does automatic
periodic snapshots out-of-the-box? Because these automatic snapshots are meant
for machines, not humans; they are not very developer-friendly. You could get
your way around <code>rsync</code> + finding the correct timestamps to copy from, but
that&rsquo;s not fun at all, and not a good use of time either.</p><h2 id=git-workflow>git workflow</h2><p>How to replicate a similar workflow in a non-Google world?</p><p>For most of us, non-Google necessarily means <code>git</code>. Let&rsquo;s ignore <code>hg</code>
(mercurial) in this context.</p><p>There is not much to do, actually: <a href=https://github.blog/open-source/git/commits-are-snapshots-not-diffs/>https://github.blog/open-source/git/commits-are-snapshots-not-diffs/</a></p><p><code>git</code> commits are already snapshots. The workflow is:</p><ul><li>Make some changes, then <code>git add</code></li><li>Create a branch (<code>git switch --create</code>), commit your changes</li><li>To make a snapshot, just make a new commit and annotate it (<code>git commit -m "foo"</code>)</li><li>To list your snapshots, run <code>git rev-list $(git show-branch --merge-base HEAD)^..HEAD --pretty</code>. This will list all commits since your branch diverted.
You could add an alias to it in your <code>~/.gitconfig</code>.</li><li>To roll back, run <code>git reset --hard {commit}</code>.</li></ul><p><strong>Caveat</strong>: You will lose track of all commits after <code>{commit}</code>. Although it
would still be possible to recover them with <code>git reflog</code> (in case of a
mistake), that is not a developer-friendly workflow.</p><p>Then the follow-up question is: how to roll back without losing track of
intermediate work?</p><p>One way is to create a new branch that points out to <code>{commit}</code> instead of
hard-resetting your entire worktree:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% git checkout -b mynewbranch <span style=color:#f92672>{</span>commit<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Once you are satisfied, just delete the previous branch and then rename the
current one to it.</p><p>Another possibility is the use of <a href=https://git-scm.com/docs/git-worktree>git
worktrees</a> to divert (spin-off) branches.</p><p>This becomes a very natural workflow once you repeat it a couple of times.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>I have gladly peer bonused him. You should <em>always</em> peer bonus those folks
who helped you become more productive.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Arguably you should create a separate CL for that (go/small-cls), but who
am I to judge? Unless I am your teammate&mldr;&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></content><p><a href=https://perrotta.dev/tags/dev/>#dev</a>
<a href=https://perrotta.dev/tags/bestof/>#bestof</a></p></main><hr><footer><span>¬© 2021 - 2025 Thiago Perrotta ¬∑
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>some rights reserved</a> ¬∑
a fork of <a href=https://github.com/janraasch/hugo-bearblog/>hugo  ï‚Ä¢·¥•‚Ä¢ î bear</a></span><div class=social-link-wrapper><a target=_blank rel=noopener class=social-link href=https://stackoverflow.com/users/1745064/thiagowfx title="StackOverflow profile"><svg stroke="currentcolor" fill="currentcolor" stroke-width="0" viewBox="0 0 384 512" height="1em" width="1em"><path d="M290.7 311 95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 3e2zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-2e2v39.7h2e2zm39.7 80H42.7V320h-40v160h359.5V320h-40z"/></svg>
</a><a target=_blank rel=noopener class=social-link href=https://github.com/thiagowfx title="Github profile"><svg stroke="currentcolor" fill="currentcolor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</a><a target=_blank rel=noopener class=social-link href=https://goodreads.com/user/show/7873832-thiago title="Goodreads profile"><svg stroke="currentcolor" fill="currentcolor" stroke-width="0" viewBox="0 0 50 50" height="1em" width="1em"><path d="M25 2c-4.541.0-8.41336 1.9082151-11.017578 4.9453125C11.378203 9.9824099 10 14.07975 10 18.5s1.378203 8.517589 3.982422 11.554688C16.58664 33.091785 20.459 35 25 35c4.531588.0 8.395936-1.901605 11-4.927734V35c0 2.598543-.818503 4.764071-2.451172 6.339844C31.91616 42.915616 29.363725 44 25.5 44 17.784314 44 15 39.933333 15 36H11c0 6.066667 5.215686 12 14.5 12 4.636275.0 8.33384-1.377726 10.826172-3.783203C38.818503 41.811319 40 38.476457 40 35V18.5 3H36V6.9277344C33.395936 3.9016049 29.531588 2 25 2zm0 4c3.459.0 6.08664 1.3379255 7.982422 3.5488281C34.878203 11.759731 36 14.91225 36 18.5s-1.121797 6.740269-3.017578 8.951172C31.08664 29.662074 28.459 31 25 31s-6.08664-1.337926-7.982422-3.548828C15.121797 25.240269 14 22.08775 14 18.5s1.121797-6.740269 3.017578-8.9511719C18.91336 7.3379255 21.541 6 25 6z"/></svg>
</a><a target=_blank rel=noopener class=social-link href=https://linkedin.com/in/thiagoperrotta title="LinkedIn profile"><svg stroke="currentcolor" fill="currentcolor" stroke-width="0" viewBox="0 0 30 30" height="1.2em" width="1.2em"><path d="M24 4H6C4.895 4 4 4.895 4 6v18c0 1.105.895 2 2 2h18c1.105.0 2-.895 2-2V6c0-1.105-.895-2-2-2zM10.954 22h-2.95v-9.492h2.95V22zM9.449 11.151c-.951.0-1.72-.771-1.72-1.72s.77-1.719 1.72-1.719c.948.0 1.719.771 1.719 1.719C11.168 10.38 10.397 11.151 9.449 11.151zM22.004 22h-2.948v-4.616c0-1.101-.02-2.517-1.533-2.517-1.535.0-1.771 1.199-1.771 2.437V22h-2.948v-9.492h2.83v1.297h.04c.394-.746 1.356-1.533 2.791-1.533 2.987.0 3.539 1.966 3.539 4.522V22z"/></svg>
</a><a target=_blank rel=noopener class=social-link href=mailto:notjustserendipity@perrotta.dev title="Email address"><svg stroke="currentcolor" fill="currentcolor" stroke-width="0" viewBox="0 0 24 24" height="1.3em" width="1.3em"><g transform="translate(0.000000,24.000000) scale(0.100000,-0.100000)"><path d="M26 191c-4-5 16-23 44-40l50-31 50 31c28 17 48 35 44 40-7 12-181 12-188 0z"/><path d="M22 103l3-58 93-3c104-3 105-3 1e2 71l-3 46-48-29-47-30-38 23c-20 13-43 27-50 31-10 6-12-5-10-51z"/></g></svg>
</a><a target=_blank rel=noopener class=social-link href=https://perrotta.dev/index.xml title="RSS feed"><svg stroke="currentcolor" fill="currentcolor" stroke-width="0" viewBox="0 0 56.693 56.693" height="1em" width="1em"><path d="M3.428 31.085c6.19.0 12.009 2.418 16.382 6.816 4.381 4.398 6.793 10.256 6.793 16.492h9.539c0-18.113-14.676-32.848-32.714-32.848v9.54zM3.443 14.174c22.061.0 40.01 18.047 40.01 40.231h9.539c0-27.445-22.229-49.77-49.549-49.77v9.539zM16.634 47.741c0 3.648-2.959 6.607-6.607 6.607S3.42 51.39 3.42 47.741c0-3.65 2.958-6.607 6.606-6.607s6.608 2.957 6.608 6.607z"/></svg></a></div></footer></body></html>