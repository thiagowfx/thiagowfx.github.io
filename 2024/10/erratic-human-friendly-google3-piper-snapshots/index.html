<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>★ Erratic: human-friendly google3 piper snapshots | not just serendipity</title>
<meta name=keywords content="dev,devops,bestof"><meta name=description content="In the google3 codebase, when working with Piper directly (i.e. not
Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er),
which was a 20% project of another Software Engineer1."><meta name=author content="Thiago Perrotta"><link rel=canonical href=https://www.perrotta.dev/2024/10/erratic-human-friendly-google3-piper-snapshots/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://www.perrotta.dev/favicon.ico><link rel=apple-touch-icon href=https://www.perrotta.dev/apple-touch-icon.png><link rel=mask-icon href=https://www.perrotta.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.perrotta.dev/2024/10/erratic-human-friendly-google3-piper-snapshots/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav,.toc,.post-meta{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style><meta property="og:title" content="★ Erratic: human-friendly google3 piper snapshots"><meta property="og:description" content="In the google3 codebase, when working with Piper directly (i.e. not
Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er),
which was a 20% project of another Software Engineer1."><meta property="og:type" content="article"><meta property="og:url" content="https://www.perrotta.dev/2024/10/erratic-human-friendly-google3-piper-snapshots/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-02T13:33:56+02:00"><meta property="article:modified_time" content="2024-10-02T13:33:56+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="★ Erratic: human-friendly google3 piper snapshots"><meta name=twitter:description content="In the google3 codebase, when working with Piper directly (i.e. not
Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er),
which was a 20% project of another Software Engineer1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.perrotta.dev/posts/"},{"@type":"ListItem","position":2,"name":"★ Erratic: human-friendly google3 piper snapshots","item":"https://www.perrotta.dev/2024/10/erratic-human-friendly-google3-piper-snapshots/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"★ Erratic: human-friendly google3 piper snapshots","name":"★ Erratic: human-friendly google3 piper snapshots","description":"In the google3 codebase, when working with Piper directly (i.e. not Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er), which was a 20% project of another Software Engineer1.\n","keywords":["dev","devops","bestof"],"articleBody":"In the google3 codebase, when working with Piper directly (i.e. not Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er), which was a 20% project of another Software Engineer1.\ngoogle3 workflow The workflow is as follows:\nMake some changes: g4 open, g4 edit, etc Create a CL (ChangeList) g4 change Now let’s say you’re anticipating some heavy refactoring, in the same CL2, that you could potentially regret and want to revert.\nThis would be a great moment to use erratic. After installing it (or aliasing it, if using it via X20), run:\n% er explain \"this is working perfectly before bob@ asked me to refactor it\" Make additional changes Feel free to make more snapshots (checkpoints), as you see fit If you ever want to roll back, run er list. It will list all explicit snapshots you annotated so far. Locate the one you want to roll back to:\n% er list 42 \"this is working perfectly before bob@ asked me to refactor it\" 78 \"second refactoring\" Now just roll back to it:\n% er restore 42 Sometimes you’ll need to run g4 add afterwards. And we’re done!\nColophon: Why use erratic at all, since CitC already does automatic periodic snapshots out-of-the-box? Because these automatic snapshots are meant for machines, not humans; they are not very developer-friendly. You could get your way around rsync + finding the correct timestamps to copy from, but that’s not fun at all, and not a good use of time either.\ngit workflow How to replicate a similar workflow in a non-Google world?\nFor most of us, non-Google necessarily means git. Let’s ignore hg (mercurial) in this context.\nThere is not much to do, actually: https://github.blog/open-source/git/commits-are-snapshots-not-diffs/\ngit commits are already snapshots. The workflow is:\nMake some changes, then git add Create a branch (git switch --create), commit your changes To make a snapshot, just make a new commit and annotate it (git commit -m \"foo\") To list your snapshots, run git rev-list $(git show-branch --merge-base HEAD)^..HEAD --pretty. This will list all commits since your branch diverted. You could add an alias to it in your ~/.gitconfig. To roll back, run git reset --hard {commit}. Caveat: You will lose track of all commits after {commit}. Although it would still be possible to recover them with git reflog (in case of a mistake), that is not developer-friendly workflow.\nThen the follow-up question is: how to roll back without losing track of intermediate work?\nOne way is to create a new branch that points out to {commit} instead of hard-resetting your entire worktree:\n% git checkout -b mynewbranch {commit} Once you are satisfied, just delete the previous branch and then rename the current one to it.\nAnother possibility is the use of git worktrees to divert (spin-off) branches.\nThis becomes a very natural workflow once you repeat it a couple of times.\nI have gladly peer bonused him. You should always peer bonus those folks who helped you become more productive. ↩︎\nArguably you should create a separate CL for that (go/small-cls), but who am I to judge? Unless I am your teammate… ↩︎\n","wordCount":"517","inLanguage":"en","datePublished":"2024-10-02T13:33:56+02:00","dateModified":"2024-10-02T13:33:56+02:00","author":{"@type":"Person","name":"Thiago Perrotta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.perrotta.dev/2024/10/erratic-human-friendly-google3-piper-snapshots/"},"publisher":{"@type":"Person","name":"not just serendipity","logo":{"@type":"ImageObject","url":"https://www.perrotta.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.perrotta.dev/ accesskey=h title="not just serendipity (Alt + H)"><img src=https://www.perrotta.dev/apple-touch-icon.png alt aria-label=logo height=32>not just serendipity</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.perrotta.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://www.perrotta.dev/tags/bestof/ title="★ bestof"><span>★ bestof</span></a></li><li><a href=https://www.perrotta.dev/tags/serenity/ title=serenity><span>serenity</span></a></li><li><a href=https://www.perrotta.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://www.perrotta.dev/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://www.perrotta.dev/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">★ Erratic: human-friendly google3 piper snapshots</h1><div class=post-meta><span title='2024-10-02 13:33:56 +0200 +0200'>October 2, 2024</span>&nbsp;·&nbsp;517 words&nbsp;·&nbsp;Thiago Perrotta</div></header><div class=post-content><p>In the google3 codebase, when working with Piper directly (i.e. not
Fig[-on-CitC]), I often liked to use this tool called <code>erratic</code> (abbrev: <code>er</code>),
which was a 20% project of another Software Engineer<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><h2 id=google3-workflow>google3 workflow<a hidden class=anchor aria-hidden=true href=#google3-workflow>#</a></h2><p>The workflow is as follows:</p><ul><li>Make some changes: <code>g4 open</code>, <code>g4 edit</code>, etc</li><li>Create a CL (ChangeList) <code>g4 change</code></li></ul><p>Now let&rsquo;s say you&rsquo;re anticipating some heavy refactoring, in the same CL<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>,
that you could potentially regret and want to revert.</p><p>This would be a great moment to use <code>erratic</code>. After installing it (or aliasing
it, if using it via X20), run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% er explain <span style=color:#e6db74>&#34;this is working perfectly before bob@ asked me to refactor it&#34;</span>
</span></span></code></pre></div><ul><li>Make additional changes</li><li>Feel free to make more snapshots (checkpoints), as you see fit</li></ul><p>If you ever want to roll back, run <code>er list</code>. It will list all explicit
snapshots you annotated so far. Locate the one you want to roll back to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% er list
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span> <span style=color:#e6db74>&#34;this is working perfectly before bob@ asked me to refactor it&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>78</span> <span style=color:#e6db74>&#34;second refactoring&#34;</span>
</span></span></code></pre></div><p>Now just roll back to it:</p><pre tabindex=0><code>% er restore 42
</code></pre><p>Sometimes you&rsquo;ll need to run <code>g4 add</code> afterwards. And we&rsquo;re done!</p><p><strong>Colophon</strong>: Why use <code>erratic</code> at all, since CitC already does automatic
periodic snapshots out-of-the-box? Because these automatic snapshots are meant
for machines, not humans; they are not very developer-friendly. You could get
your way around <code>rsync</code> + finding the correct timestamps to copy from, but
that&rsquo;s not fun at all, and not a good use of time either.</p><h2 id=git-workflow>git workflow<a hidden class=anchor aria-hidden=true href=#git-workflow>#</a></h2><p>How to replicate a similar workflow in a non-Google world?</p><p>For most of us, non-Google necessarily means <code>git</code>. Let&rsquo;s ignore <code>hg</code>
(mercurial) in this context.</p><p>There is not much to do, actually: <a href=https://github.blog/open-source/git/commits-are-snapshots-not-diffs/>https://github.blog/open-source/git/commits-are-snapshots-not-diffs/</a></p><p><code>git</code> commits are already snapshots. The workflow is:</p><ul><li>Make some changes, then <code>git add</code></li><li>Create a branch (<code>git switch --create</code>), commit your changes</li><li>To make a snapshot, just make a new commit and annotate it (<code>git commit -m "foo"</code>)</li><li>To list your snapshots, run <code>git rev-list $(git show-branch --merge-base HEAD)^..HEAD --pretty</code>. This will list all commits since your branch diverted.
You could add an alias to it in your <code>~/.gitconfig</code>.</li><li>To roll back, run <code>git reset --hard {commit}</code>.</li></ul><p><strong>Caveat</strong>: You will lose track of all commits after <code>{commit}</code>. Although it
would still be possible to recover them with <code>git reflog</code> (in case of a
mistake), that is not developer-friendly workflow.</p><p>Then the follow-up question is: how to roll back without losing track of
intermediate work?</p><p>One way is to create a new branch that points out to <code>{commit}</code> instead of
hard-resetting your entire worktree:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% git checkout -b mynewbranch <span style=color:#f92672>{</span>commit<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Once you are satisfied, just delete the previous branch and then rename the
current one to it.</p><p>Another possibility is the use of <a href=https://git-scm.com/docs/git-worktree>git
worktrees</a> to divert (spin-off) branches.</p><p>This becomes a very natural workflow once you repeat it a couple of times.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>I have gladly peer bonused him. You should <em>always</em> peer bonus those folks
who helped you become more productive.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Arguably you should create a separate CL for that (go/small-cls), but who
am I to judge? Unless I am your teammate&mldr;&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.perrotta.dev/tags/dev/>Dev</a></li><li><a href=https://www.perrotta.dev/tags/devops/>Devops</a></li><li><a href=https://www.perrotta.dev/tags/bestof/>Bestof</a></li></ul></footer></article></main><footer class=footer><span>Copyright © 2021 - 2024 Thiago Perrotta · <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> · <a href=/index.xml>RSS</a> · Made with ♥ in 🇨🇦</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>