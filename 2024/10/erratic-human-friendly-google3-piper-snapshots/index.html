<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Erratic: human-friendly google3 piper snapshots | not just serendipity</title><meta name=title content="Erratic: human-friendly google3 piper snapshots">
<meta name=description content="In the google3 codebase, when working with Piper directly (i.e. not
Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er),
which was a 20% project of another Software Engineer1.
google3 workflow
The workflow is as follows:

Make some changes: g4 open, g4 edit, etc
Create a CL (ChangeList) g4 change

Now let&rsquo;s say you&rsquo;re anticipating some heavy refactoring, in the same CL2,
that you could potentially regret and want to revert."><meta name=keywords content="dev,bestof,"><meta property="og:url" content="https://perrotta.dev/2024/10/erratic-human-friendly-google3-piper-snapshots/"><meta property="og:site_name" content="not just serendipity"><meta property="og:title" content="Erratic: human-friendly google3 piper snapshots"><meta property="og:description" content="In the google3 codebase, when working with Piper directly (i.e. not Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er), which was a 20% project of another Software Engineer1.
google3 workflow The workflow is as follows:
Make some changes: g4 open, g4 edit, etc Create a CL (ChangeList) g4 change Now let’s say you’re anticipating some heavy refactoring, in the same CL2, that you could potentially regret and want to revert."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-02T13:33:56+02:00"><meta property="article:modified_time" content="2024-10-02T13:33:56+02:00"><meta property="article:tag" content="Dev"><meta property="article:tag" content="Bestof"><meta name=twitter:card content="summary"><meta name=twitter:title content="Erratic: human-friendly google3 piper snapshots"><meta name=twitter:description content="In the google3 codebase, when working with Piper directly (i.e. not Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er), which was a 20% project of another Software Engineer1.
google3 workflow The workflow is as follows:
Make some changes: g4 open, g4 edit, etc Create a CL (ChangeList) g4 change Now let’s say you’re anticipating some heavy refactoring, in the same CL2, that you could potentially regret and want to revert."><meta itemprop=name content="Erratic: human-friendly google3 piper snapshots"><meta itemprop=description content="In the google3 codebase, when working with Piper directly (i.e. not Fig[-on-CitC]), I often liked to use this tool called erratic (abbrev: er), which was a 20% project of another Software Engineer1.
google3 workflow The workflow is as follows:
Make some changes: g4 open, g4 edit, etc Create a CL (ChangeList) g4 change Now let’s say you’re anticipating some heavy refactoring, in the same CL2, that you could potentially regret and want to revert."><meta itemprop=datePublished content="2024-10-02T13:33:56+02:00"><meta itemprop=dateModified content="2024-10-02T13:33:56+02:00"><meta itemprop=wordCount content="518"><meta itemprop=keywords content="Dev,Bestof"><meta name=referrer content="no-referrer-when-downgrade"><link rel="shortcut icon" href=https://perrotta.dev/favicon.ico><link rel=canonical href=https://perrotta.dev/2024/10/erratic-human-friendly-google3-piper-snapshots/><style>:root{--color-gray:#888;--color-grayer:#666;--font-title:'Inter', 'Fira Sans', 'Lato', system-ui, -apple-system, BlinkMacSystemFont, 'Avenir Next', 'Avenir', 'Segoe UI', 'Helvetica Neue', Helvetica, Ubuntu, Roboto, Noto, Cantarell, Arial, sans-serif;--font-body:'Crimson Pro', 'Vollkorn', 'Alegreya', 'Iowan Old Style', 'Apple Garamond', 'Baskerville', 'Times New Roman', 'Noto Serif', 'Droid Serif', 'Times', 'Source Serif Pro', serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';--font-code:'Fira Code', 'PT Mono', 'IBM Plex Mono', Menlo, Consolas, Monaco, 'Liberation Mono', 'Ubuntu Mono', 'Lucida Console', monospace}body{font-family:var(--font-body);margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fffcf0;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444;-webkit-text-size-adjust:100%}h1,h2,h3,h4,h5,h6,strong,b{color:#222}h1,h2,h3,h4,h5,h6,footer,nav{font-family:var(--font-title)}footer{font-size:small;padding:8px;text-align:center}a{color:#3273dc}a.title{text-decoration:none;border:0;display:flex;align-items:center;column-gap:10px}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}li code,p code{font-size:small}pre code{color:#222;display:block;padding:20px;white-space:pre;font-size:14px;overflow-x:auto}code,pre{font-family:var(--font-code)}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 110px}ul.blog-posts li a:visited{color:#8b6fcb}.pubdate-list{color:var(--color-gray);font-style:italic}.pubdate-single{color:var(--color-grayer);font-style:italic}sup.gray{color:var(--color-grayer)}@media(prefers-color-scheme:dark){body{background-color:#01242e;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#444}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}}</style><link rel=apple-touch-icon href=https://perrotta.dev/apple-touch-icon.png></head><body><header><a href=/ class=title><img src=https://perrotta.dev/thiagowfx.png alt="thiagowfx's avatar" width=32 height=32><h2>not just serendipity</h2></a><nav><a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags/bestof/>★</a></nav></header><main><h1><span>★</span>
Erratic: human-friendly google3 piper snapshots</h1><p><span class=pubdate-single><time datetime=2024-10-02 pubdate>02 Oct, 2024
</time>• 518 words
• 3 min</span></p><content><p>In the google3 codebase, when working with Piper directly (i.e. not
Fig[-on-CitC]), I often liked to use this tool called <code>erratic</code> (abbrev: <code>er</code>),
which was a 20% project of another Software Engineer<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><h2 id=google3-workflow>google3 workflow</h2><p>The workflow is as follows:</p><ul><li>Make some changes: <code>g4 open</code>, <code>g4 edit</code>, etc</li><li>Create a CL (ChangeList) <code>g4 change</code></li></ul><p>Now let&rsquo;s say you&rsquo;re anticipating some heavy refactoring, in the same CL<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>,
that you could potentially regret and want to revert.</p><p>This would be a great moment to use <code>erratic</code>. After installing it (or aliasing
it, if using it via X20), run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% er explain <span style=color:#e6db74>&#34;this is working perfectly before bob@ asked me to refactor it&#34;</span>
</span></span></code></pre></div><ul><li>Make additional changes</li><li>Feel free to make more snapshots (checkpoints), as you see fit</li></ul><p>If you ever want to roll back, run <code>er list</code>. It will list all explicit
snapshots you annotated so far. Locate the one you want to roll back to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% er list
</span></span><span style=display:flex><span><span style=color:#ae81ff>42</span> <span style=color:#e6db74>&#34;this is working perfectly before bob@ asked me to refactor it&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>78</span> <span style=color:#e6db74>&#34;second refactoring&#34;</span>
</span></span></code></pre></div><p>Now just roll back to it:</p><pre tabindex=0><code>% er restore 42
</code></pre><p>Sometimes you&rsquo;ll need to run <code>g4 add</code> afterwards. And we&rsquo;re done!</p><p><strong>Colophon</strong>: Why use <code>erratic</code> at all, since CitC already does automatic
periodic snapshots out-of-the-box? Because these automatic snapshots are meant
for machines, not humans; they are not very developer-friendly. You could get
your way around <code>rsync</code> + finding the correct timestamps to copy from, but
that&rsquo;s not fun at all, and not a good use of time either.</p><h2 id=git-workflow>git workflow</h2><p>How to replicate a similar workflow in a non-Google world?</p><p>For most of us, non-Google necessarily means <code>git</code>. Let&rsquo;s ignore <code>hg</code>
(mercurial) in this context.</p><p>There is not much to do, actually: <a href=https://github.blog/open-source/git/commits-are-snapshots-not-diffs/>https://github.blog/open-source/git/commits-are-snapshots-not-diffs/</a></p><p><code>git</code> commits are already snapshots. The workflow is:</p><ul><li>Make some changes, then <code>git add</code></li><li>Create a branch (<code>git switch --create</code>), commit your changes</li><li>To make a snapshot, just make a new commit and annotate it (<code>git commit -m "foo"</code>)</li><li>To list your snapshots, run <code>git rev-list $(git show-branch --merge-base HEAD)^..HEAD --pretty</code>. This will list all commits since your branch diverted.
You could add an alias to it in your <code>~/.gitconfig</code>.</li><li>To roll back, run <code>git reset --hard {commit}</code>.</li></ul><p><strong>Caveat</strong>: You will lose track of all commits after <code>{commit}</code>. Although it
would still be possible to recover them with <code>git reflog</code> (in case of a
mistake), that is not a developer-friendly workflow.</p><p>Then the follow-up question is: how to roll back without losing track of
intermediate work?</p><p>One way is to create a new branch that points out to <code>{commit}</code> instead of
hard-resetting your entire worktree:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% git checkout -b mynewbranch <span style=color:#f92672>{</span>commit<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Once you are satisfied, just delete the previous branch and then rename the
current one to it.</p><p>Another possibility is the use of <a href=https://git-scm.com/docs/git-worktree>git
worktrees</a> to divert (spin-off) branches.</p><p>This becomes a very natural workflow once you repeat it a couple of times.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>I have gladly peer bonused him. You should <em>always</em> peer bonus those folks
who helped you become more productive.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Arguably you should create a separate CL for that (go/small-cls), but who
am I to judge? Unless I am your teammate&mldr;&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></content><p><a href=https://perrotta.dev/tags/dev/>#dev</a>
<a href=https://perrotta.dev/tags/bestof/>#bestof</a></p></main><hr><footer><span>© 2021 - 2025
<a href=mailto:notjustserendipity@perrotta.dev>Thiago Perrotta
</a>·
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>some rights reserved</a> ·
<a href=/index.xml>RSS</a> ·
a fork of <a href=https://github.com/janraasch/hugo-bearblog/>hugo ʕ•ᴥ•ʔ bear</a></span></footer></body></html>