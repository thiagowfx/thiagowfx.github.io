<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://perrotta.dev/favicon.ico><title>skopeo: operate container images and registries | not just serendipity</title>
<meta name=title content="skopeo: operate container images and registries"><meta name=description content='When working with docker and private image registries, a common workflow is to copy images from one private registry in the cloud to another. This can be done with skopeo.
This post includes some common recipes for it.
Usage 1) Default / Root to Staging
From the default / root account registry to the staging registry:
skopeo sync \
  --src-creds "AWS:$(aws ecr get-login-password --region {region} --profile default)" \
  --dest-creds "AWS:$(aws ecr get-login-password --region {region} --profile staging)" \
  --override-os linux --override-arch amd64 \
  --src docker --dest docker \
  {account_id_root}.dkr.ecr.{region}.amazonaws.com/{org}/{repository}:{tag} \
  {account_id_staging}.dkr.ecr.{region}.amazonaws.com/{org}
Example values1:'><meta name=keywords content="dev,"><meta property="og:url" content="https://perrotta.dev/2024/12/skopeo-operate-container-images-and-registries/"><meta property="og:site_name" content="not just serendipity"><meta property="og:title" content="skopeo: operate container images and registries"><meta property="og:description" content='When working with docker and private image registries, a common workflow is to copy images from one private registry in the cloud to another. This can be done with skopeo.
This post includes some common recipes for it.
Usage 1) Default / Root to Staging From the default / root account registry to the staging registry:
skopeo sync \ --src-creds "AWS:$(aws ecr get-login-password --region {region} --profile default)" \ --dest-creds "AWS:$(aws ecr get-login-password --region {region} --profile staging)" \ --override-os linux --override-arch amd64 \ --src docker --dest docker \ {account_id_root}.dkr.ecr.{region}.amazonaws.com/{org}/{repository}:{tag} \ {account_id_staging}.dkr.ecr.{region}.amazonaws.com/{org} Example values1:'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-17T17:49:31-03:00"><meta property="article:modified_time" content="2024-12-17T17:49:31-03:00"><meta property="article:tag" content="Dev"><meta name=twitter:card content="summary"><meta name=twitter:title content="skopeo: operate container images and registries"><meta name=twitter:description content='When working with docker and private image registries, a common workflow is to copy images from one private registry in the cloud to another. This can be done with skopeo.
This post includes some common recipes for it.
Usage 1) Default / Root to Staging From the default / root account registry to the staging registry:
skopeo sync \ --src-creds "AWS:$(aws ecr get-login-password --region {region} --profile default)" \ --dest-creds "AWS:$(aws ecr get-login-password --region {region} --profile staging)" \ --override-os linux --override-arch amd64 \ --src docker --dest docker \ {account_id_root}.dkr.ecr.{region}.amazonaws.com/{org}/{repository}:{tag} \ {account_id_staging}.dkr.ecr.{region}.amazonaws.com/{org} Example values1:'><meta itemprop=name content="skopeo: operate container images and registries"><meta itemprop=description content='When working with docker and private image registries, a common workflow is to copy images from one private registry in the cloud to another. This can be done with skopeo.
This post includes some common recipes for it.
Usage 1) Default / Root to Staging From the default / root account registry to the staging registry:
skopeo sync \ --src-creds "AWS:$(aws ecr get-login-password --region {region} --profile default)" \ --dest-creds "AWS:$(aws ecr get-login-password --region {region} --profile staging)" \ --override-os linux --override-arch amd64 \ --src docker --dest docker \ {account_id_root}.dkr.ecr.{region}.amazonaws.com/{org}/{repository}:{tag} \ {account_id_staging}.dkr.ecr.{region}.amazonaws.com/{org} Example values1:'><meta itemprop=datePublished content="2024-12-17T17:49:31-03:00"><meta itemprop=dateModified content="2024-12-17T17:49:31-03:00"><meta itemprop=wordCount content="301"><meta itemprop=keywords content="Dev"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><link rel=apple-touch-icon href=https://perrotta.dev/apple-touch-icon.png><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style></head><body><header><a href=/ class=title><h2>not just serendipity</h2></a><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href=/tags/bestof/>★</a></nav></header><main><content><p>When working with <code>docker</code> and private image registries, a common workflow is to copy images from one private registry in the cloud to another. This can be done with <a href=https://github.com/containers/skopeo/><code>skopeo</code></a>.</p><p>This post includes some common recipes for it.</p><h2 id=usage-1-default--root-to-staging>Usage 1) Default / Root to Staging</h2><p>From the default / root account registry to the staging registry:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>skopeo sync <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --src-creds <span style=color:#e6db74>&#34;AWS:</span><span style=color:#66d9ef>$(</span>aws ecr get-login-password --region <span style=color:#f92672>{</span>region<span style=color:#f92672>}</span> --profile default<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --dest-creds <span style=color:#e6db74>&#34;AWS:</span><span style=color:#66d9ef>$(</span>aws ecr get-login-password --region <span style=color:#f92672>{</span>region<span style=color:#f92672>}</span> --profile staging<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --override-os linux --override-arch amd64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --src docker --dest docker <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>{</span>account_id_root<span style=color:#f92672>}</span>.dkr.ecr.<span style=color:#f92672>{</span>region<span style=color:#f92672>}</span>.amazonaws.com/<span style=color:#f92672>{</span>org<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>repository<span style=color:#f92672>}</span>:<span style=color:#f92672>{</span>tag<span style=color:#f92672>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>{</span>account_id_staging<span style=color:#f92672>}</span>.dkr.ecr.<span style=color:#f92672>{</span>region<span style=color:#f92672>}</span>.amazonaws.com/<span style=color:#f92672>{</span>org<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Example values<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>:</p><ul><li>repository: <code>argocd-gitops-tools</code></li><li>tag (version): <code>1.0.1</code></li><li>region: <code>us-east-1</code></li></ul><h2 id=usage-2-public-to-mfa>Usage 2) Public to MFA</h2><p>From a public registry to a private registry that uses MFA (multi-factor authentication).</p><p>First, it’s necessary to get MFA credentials:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># shellcheck disable=SC2155</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export AWS_PROFILE<span style=color:#f92672>=</span>china
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo -n <span style=color:#e6db74>&#34;Enter the MFA token code for your AWS China account: &#34;</span> <span style=color:#f92672>&amp;&amp;</span> read -r token
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mfa_arn<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>aws iam --profile <span style=color:#e6db74>&#34;</span>$AWS_PROFILE<span style=color:#e6db74>&#34;</span> get-user --output text --query User.Arn | sed <span style=color:#e6db74>&#39;s/:user\//:mfa\//&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>credentials<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>aws --profile <span style=color:#e6db74>&#34;</span>$AWS_PROFILE<span style=color:#e6db74>&#34;</span> sts get-session-token --serial-number <span style=color:#e6db74>&#34;</span>$mfa_arn<span style=color:#e6db74>&#34;</span> --token-code <span style=color:#e6db74>&#34;</span>$token<span style=color:#e6db74>&#34;</span> --duration-seconds 86400<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Got credentials: </span>$credentials<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export AWS_ACCESS_KEY_ID<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$credentials<span style=color:#e6db74>&#34;</span> | jq -r <span style=color:#e6db74>&#39;.Credentials.AccessKeyId&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>export AWS_SECRET_ACCESS_KEY<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$credentials<span style=color:#e6db74>&#34;</span> | jq -r <span style=color:#e6db74>&#39;.Credentials.SecretAccessKey&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>export AWS_SESSION_TOKEN<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$credentials<span style=color:#e6db74>&#34;</span> | jq -r <span style=color:#e6db74>&#39;.Credentials.SessionToken&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[[</span> -n <span style=color:#e6db74>&#34;</span>$AWS_SESSION_TOKEN<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Success!&#34;</span>
</span></span></code></pre></div><p>Then we can proceed with the image sync:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>skopeo sync <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --dest-creds <span style=color:#e6db74>&#34;AWS:</span><span style=color:#66d9ef>$(</span>aws ecr get-login-password --region cn-north-1<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --override-os linux --override-arch amd64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --src docker --dest docker <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  quay.io/argoproj/argocd:v2.12.6 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>{</span>account_id_mfa<span style=color:#f92672>}</span>.dkr.ecr.cn-north-1.amazonaws.com.cn/quay.io/argoproj
</span></span></code></pre></div><p>Notes:</p><ul><li>A public registry does not need authentication, hence there’s no <code>--src-creds</code>.</li><li><code>--dest-creds</code> does not specify a <code>--profile</code>. Likewise, no <code>AWS_PROFILE</code> env var should be defined.</li><li>In this example, China (<code>cn-north-1</code>) is an AWS account with MFA enabled.</li></ul><p>It’s possible to pass <code>--scoped</code> to prefix images at destination using the full source image path as scope.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>image = registry (includes the org name) + repository + tag&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></content><p><a href=https://perrotta.dev/tags/dev/>#dev</a></p></main><footer></footer><footer><span>Copyright © 2021 - 2025 Thiago Perrotta · <a href=/index.xml>RSS</a> · <a href=https://github.com/janraasch/hugo-bearblog/>hugo ʕ•ᴥ•ʔ bear</a></span></footer></body></html>