<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://perrotta.dev/favicon.ico><title>sd-world: perform a full system upgrade | not just serendipity</title>
<meta name=title content="sd-world: perform a full system upgrade"><meta name=description content="Whenever I want to upgrade any one of my systems, I run sd-world."><meta name=keywords content="dev,"><meta property="og:url" content="https://perrotta.dev/2024/01/sd-world-perform-a-full-system-upgrade/"><meta property="og:site_name" content="not just serendipity"><meta property="og:title" content="sd-world: perform a full system upgrade"><meta property="og:description" content="Whenever I want to upgrade any one of my systems, I run sd-world."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-28T01:42:04-03:00"><meta property="article:modified_time" content="2024-01-28T01:42:04-03:00"><meta property="article:tag" content="Dev"><meta name=twitter:card content="summary"><meta name=twitter:title content="sd-world: perform a full system upgrade"><meta name=twitter:description content="Whenever I want to upgrade any one of my systems, I run sd-world."><meta itemprop=name content="sd-world: perform a full system upgrade"><meta itemprop=description content="Whenever I want to upgrade any one of my systems, I run sd-world."><meta itemprop=datePublished content="2024-01-28T01:42:04-03:00"><meta itemprop=dateModified content="2024-01-28T01:42:04-03:00"><meta itemprop=wordCount content="628"><meta itemprop=keywords content="Dev"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><link rel=apple-touch-icon href=https://perrotta.dev/apple-touch-icon.png><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style></head><body><header><a href=/ class=title><h2>not just serendipity</h2></a><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href=/tags/bestof/>â˜…</a></nav></header><main><h1>sd-world: perform a full system upgrade</h1><p><i><time datetime=2024-01-28 pubdate>28 Jan, 2024</time></i></p><content><p>Whenever I want to upgrade any one of my systems, I run <code>sd-world</code>.</p><p>You can find the current version of <code>sd-world</code>
<a href=https://github.com/thiagowfx/.dotfiles/blob/master/scripts/.bin/sd-world>here</a>
in my dotfiles.</p><p>Here&rsquo;s a snapshot<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># perform a full system upgrade</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set -euo pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	local bold<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>tput bold<span style=color:#66d9ef>)</span> normal<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>tput sgr0<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>	echo <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>bold<span style=color:#e6db74>}</span>$*<span style=color:#e6db74>${</span>normal<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>run_if_exists<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> command -v <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> $# -eq <span style=color:#ae81ff>1</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>			log <span style=color:#e6db74>&#34;Running </span>$1<span style=color:#e6db74>...&#34;</span>
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>			shift
</span></span><span style=display:flex><span>			log <span style=color:#e6db74>&#34;Running </span>$*<span style=color:#e6db74>...&#34;</span>
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>elif</span> <span style=color:#f92672>[[</span> -d <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		shift
</span></span><span style=display:flex><span>		log <span style=color:#e6db74>&#34;Running </span>$*<span style=color:#e6db74>...&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;</span>$@<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># usage: do_git &lt;path/to/git/repo&gt;</span>
</span></span><span style=display:flex><span>do_git<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -d <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		run_if_exists <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> git -C <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> pull origin master
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>uname<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> in
</span></span><span style=display:flex><span>	<span style=color:#75715e># linux</span>
</span></span><span style=display:flex><span>	Linux<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># alpine linux</span>
</span></span><span style=display:flex><span>		run_if_exists <span style=color:#e6db74>&#34;apk&#34;</span> doas apk upgrade
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># arch linux</span>
</span></span><span style=display:flex><span>		run_if_exists <span style=color:#e6db74>&#34;pacman&#34;</span> sudo pacman -Syu
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># debian linux</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># warning: macos has /usr/bin/apt which is a Java thing</span>
</span></span><span style=display:flex><span>		run_if_exists <span style=color:#e6db74>&#34;apt-get&#34;</span> sudo apt-get upgrade -y
</span></span><span style=display:flex><span>		run_if_exists <span style=color:#e6db74>&#34;apt-get&#34;</span> sudo apt-get autoremove
</span></span><span style=display:flex><span>		;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># macOS</span>
</span></span><span style=display:flex><span>	Darwin<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># homebrew</span>
</span></span><span style=display:flex><span>		run_if_exists <span style=color:#e6db74>&#34;brew&#34;</span> brew upgrade
</span></span><span style=display:flex><span>		run_if_exists <span style=color:#e6db74>&#34;brew&#34;</span> brew cleanup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># system update and app store</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># run_if_exists &#34;softwareupdate&#34; softwareupdate --install --all</span>
</span></span><span style=display:flex><span>		run_if_exists <span style=color:#e6db74>&#34;mas&#34;</span> mas upgrade
</span></span><span style=display:flex><span>		;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># windows</span>
</span></span><span style=display:flex><span>	MINGW*<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># third-party package manager</span>
</span></span><span style=display:flex><span>		run_if_exists <span style=color:#e6db74>&#34;scoop&#34;</span> scoop update
</span></span><span style=display:flex><span>		;;
</span></span><span style=display:flex><span><span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># flatpaks</span>
</span></span><span style=display:flex><span>run_if_exists <span style=color:#e6db74>&#34;flatpak&#34;</span> flatpak update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># nix</span>
</span></span><span style=display:flex><span>run_if_exists <span style=color:#e6db74>&#34;nix-channel&#34;</span> nix-channel --update
</span></span><span style=display:flex><span>run_if_exists <span style=color:#e6db74>&#34;nix-env&#34;</span> nix-env -u
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># pihole</span>
</span></span><span style=display:flex><span><span style=color:#75715e># update pihole itself and gravity lists</span>
</span></span><span style=display:flex><span>run_if_exists <span style=color:#e6db74>&#34;pihole&#34;</span> pihole -up
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># dotfiles</span>
</span></span><span style=display:flex><span>do_git <span style=color:#e6db74>&#34;</span>$HOME<span style=color:#e6db74>/.dotfiles&#34;</span>
</span></span><span style=display:flex><span>do_git <span style=color:#e6db74>&#34;</span>$HOME<span style=color:#e6db74>/.dotfiles_corp&#34;</span>
</span></span></code></pre></div><p>There&rsquo;s a lot to unpack here.</p><h2 id=why-is-it-called-sd-world>Why is it called <code>sd-world</code>?</h2><p><code>world</code> is an inspiration taken from <a href=https://www.gentoo.org/>Gentoo Linux</a>.
To upgrade a typical gentoo system, you usually run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>emerge --ask --quiet --update --changed-use --deep @world
</span></span></code></pre></div><p>There&rsquo;s something deeply inspiring about saying it out loud: &ldquo;emerge the
world&rdquo;. As if the whole world is at your fingertips.</p><p><code>sd</code> stands for &ldquo;script directory&rdquo;, it&rsquo;s an inspiration taken from <a href=https://ianthehenry.com/posts/sd-my-script-directory/>Ian
Henry</a>.</p><p><strong>Rationale</strong>: I tend to put scripts I run semi-frequently in a <code>.bin</code>
directory that is in my system <code>$PATH</code>. However, there&rsquo;s always a chance their
name could clash with a built-in one (e.g. in <code>/usr/bin/</code>). In order to prevent
(or mitigate) it from happening, a prefix is added. For a long time in my life
I used the <code>t-</code> prefix, merely because of my first name initial. At some point
I migrated to <code>sd-</code>. That&rsquo;s all, nothing fancy about it.</p><h2 id=why-bash>Why <code>bash</code>?</h2><p><code>bash</code> is the de-facto standard shell in most Linux distributions I care about.
And it&rsquo;s also easily available in macOS and BSDs. And it&rsquo;s POSIX compliant.</p><p><strong>Therefore</strong>: availability, portability and compatibility.</p><h2 id=why-usrbinenv-bash-instead-of-binbash>Why <code>/usr/bin/env bash</code> instead of <code>/bin/bash</code>?</h2><p>Because the <code>env</code> shebang is more portable. This is more relevant when working
with BSDs. On Linux <code>/bin/bash</code> should be mostly fine.</p><h2 id=why-set--euo-pipefail>Why <code>set -euo pipefail</code>?</h2><p>A well-established <a href=https://gist.github.com/mohanpedala/1e2ff5661761d3abd0385e8223e16425>good
practice</a>.</p><h2 id=why-use-a-separare-log-function>Why use a separare <code>log</code> function?</h2><ol><li>Old habits die hard.</li><li>Consistent formatting.</li></ol><h2 id=why-run_if_exists>Why <code>run_if_exists</code>?</h2><p>Since the script attempts to upgrade (potentially) many package managers, at
the very least we try to skip the ones that aren&rsquo;t installed. For example,
there&rsquo;s no need to attempt to run <code>pacman</code> in a macOS system.</p><h2 id=what-else>What else?</h2><p>The rest should be quite straightforward to understand. Some design decisions:</p><ul><li><code>sudo</code> permissions are not asked upfront, because not every system uses
<code>sudo</code>. Notably, Alpine Linux and OpenBSD use <code>doas</code> by default. Also,
laziness is OK as the script is intended for interactive use.</li><li><code>git</code> is there merely for convenience. Updating my dotfiles could be done
from a separate script, but that would be overkill for my simple use case.</li><li>There&rsquo;s no concurrency / parallelism, and that&rsquo;s intentional. I prefer output
readability and system stability in this case.</li></ul><p><a href=https://en.wikipedia.org/wiki/Scarface:_The_World_Is_Yours>The world is yours</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Prefer to refer to the up-to-date version in my
<a href=https://github.com/thiagowfx/.dotfiles>dotfiles</a> repository though. I
included a snapshot merely because there&rsquo;s a non-zero chance the git
version could be moved elsewhere someday.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></content><p><a href=https://perrotta.dev/tags/dev/>#dev</a></p></main><footer><span>Copyright Â© 2021 - 2025 Thiago Perrotta Â· <a href=/index.xml>RSS</a> Â· <a href=https://github.com/janraasch/hugo-bearblog/>hugo Ê•â€¢á´¥â€¢Ê” bear</a></span></footer></body></html>