<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>★ Terraforming a Linode: hello world | Not Just Serendipity</title>
<meta name=keywords content="bestof,dev,selfhosted"><meta name=description content="I host my own Miniflux instance, which happens to be
my favorite RSS reader. Currently it is hosted on Linode (Akamai Cloud)
running Alpine Linux.
My current setup was performed manually. I was thinking that, for fun, it would
be cool to fully automate it under the principles of
IaC."><meta name=author content="Thiago Perrotta"><link rel=canonical href=https://www.perrotta.dev/2024/01/terraforming-a-linode-hello-world/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://www.perrotta.dev/favicon.ico><link rel=apple-touch-icon href=https://www.perrotta.dev/apple-touch-icon.png><link rel=mask-icon href=https://www.perrotta.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.perrotta.dev/2024/01/terraforming-a-linode-hello-world/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav,.toc,.post-meta{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style><meta property="og:title" content="★ Terraforming a Linode: hello world"><meta property="og:description" content="I host my own Miniflux instance, which happens to be
my favorite RSS reader. Currently it is hosted on Linode (Akamai Cloud)
running Alpine Linux.
My current setup was performed manually. I was thinking that, for fun, it would
be cool to fully automate it under the principles of
IaC."><meta property="og:type" content="article"><meta property="og:url" content="https://www.perrotta.dev/2024/01/terraforming-a-linode-hello-world/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-23T23:27:04-03:00"><meta property="article:modified_time" content="2024-01-23T23:27:04-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="★ Terraforming a Linode: hello world"><meta name=twitter:description content="I host my own Miniflux instance, which happens to be
my favorite RSS reader. Currently it is hosted on Linode (Akamai Cloud)
running Alpine Linux.
My current setup was performed manually. I was thinking that, for fun, it would
be cool to fully automate it under the principles of
IaC."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.perrotta.dev/posts/"},{"@type":"ListItem","position":2,"name":"★ Terraforming a Linode: hello world","item":"https://www.perrotta.dev/2024/01/terraforming-a-linode-hello-world/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"★ Terraforming a Linode: hello world","name":"★ Terraforming a Linode: hello world","description":"I host my own Miniflux instance, which happens to be my favorite RSS reader. Currently it is hosted on Linode (Akamai Cloud) running Alpine Linux.\nMy current setup was performed manually. I was thinking that, for fun, it would be cool to fully automate it under the principles of IaC.\n","keywords":["bestof","dev","selfhosted"],"articleBody":"I host my own Miniflux instance, which happens to be my favorite RSS reader. Currently it is hosted on Linode (Akamai Cloud) running Alpine Linux.\nMy current setup was performed manually. I was thinking that, for fun, it would be cool to fully automate it under the principles of IaC.\nThe current setup does not use any containers. I had proudly made it as KISS as possible at the time:\nLinode is a very beginner-friendly (and cheap) VPS Alpine Linux is a first-class citizen on Linode There’s an apk package for miniflux There’s an OpenRC1 script for miniflux (so that it can be controlled via service) For the first part of this automation we will look into provisioning a Linode with an Alpine Linux installation. In order to do so we will use HashiCorp Terraform.\nRequirements Provision a new Linode Deploy it in Europe Use the smallest shape (a so-called Nanode) Run Alpine Linux Set it up with my public ssh key, which is hosted on Github Terraform setup Install a provider for Linode: https://registry.terraform.io/providers/linode/linode/latest/docs Scaffold it like this, in a main.tf file:\nterraform { required_providers { linode = { source = \"linode/linode\" } } } Then run:\n% terraform init Generate a Linode API token Go to https://cloud.linode.com/profile/tokens, create a new token called terraform. with the “Linodes” scope set to “Read/Write”.\nAppend this API token to main.tf: provider \"linode\" { token = \"\" } Add a linode_instance with the appropriate fields set according to the documentation: resource \"linode_instance\" \"coruscant\" { label = \"coruscant\" image = \"linode/alpine3.19\" region = \"eu-central\" type = \"g6-nanode-1\" authorized_keys = [\"\"] backups_enabled = \"false\" watchdog_enabled = \"true\" booted = \"true\" } Then run:\n% terraform plan “Plan” is basically a dry-run. Terraform will output what it intends to do, but nothing will be done yet.\nAnalyze the output and double check that it looks correct. To actually perform the provisioning, run:\n% terraform apply Then confirm the prompt.\nWithin a few seconds (or maybe minutes), you should see your new Linode in the Linode Console.\nWe can test our deployment by ssh’ing to our new machine:\n% ssh root@ -i ~/.ssh/my_ssh_key Welcome to Alpine! The Alpine Wiki contains a large amount of how-to guides and general information about administrating Alpine systems. See . You can setup the system with the command: setup-alpine You may change this message by editing /etc/motd. Let’s take a pause to appreciate how lightweight it is:\nlocalhost:~# df -h Filesystem Size Used Available Use% Mounted on devtmpfs 10.0M 0 10.0M 0% /dev shm 487.8M 0 487.8M 0% /dev/shm /dev/sda 24.1G 238.1M 22.6G 1% / tmpfs 195.1M 268.0K 194.8M 0% /run Only 238 MiB!\nTo deprovision it, run:\n% terraform plan -destroy If everything looks correct, run:\n% terraform destroy Warning: It turns out the “Linodes” scope was not enough to do the deprovisioning. I needed to create a new scope, with more permissions, in order to do so.\nAs you can see, terraform makes it very trivial to deprovision systems.\nBonus points: run terraform fmt to format your file. Never go out of style.\nTip: At any point you can run terraform validate to verify your main.tf file is syntatically correct.\nTwo things could be improved in the previous setup:\nWe could use authorized_users to pass in our linode username. If we add an SSH key to our linode account, then that key would be automatically deployed to the system, thereby removing the need to specify authorized_keys. Alternatively, we could fetch our key from an URL endpoint with the use of the hashicorp/http provider, like so: terraform { required_providers { http = { source = \"hashicorp/http\" } } } data \"http\" \"thiagowfx_ssh_keys\" { url = \"https://github.com/thiagowfx.keys\" } resource \"linode_instance\" \"coruscant\" { # ... authorized_keys = compact([for line in split(\"\\n\", data.http.thiagowfx_ssh_keys.response_body) : chomp(line)]) # ... } The “list comprehension” above does line splitting magic to convert them to a list of string, and the compact removes the empty new line at the end.\nWe could improve the example above even further.\nFor starters, let’s parameterize out the username to a variable:\nvariable \"github_username\" { type = string default = \"thiagowfx\" } data \"http\" \"user_ssh_keys\" { url = \"https://github.com/${var.github_username}.keys\" } resource \"linode_instance\" \"coruscant\" { # ... authorized_keys = compact([for line in split(\"\\n\", data.http.user_ssh_keys.response_body) : chomp(line)]) # ... } We could then easily supply another username with -var:\n% terraform plan -var github_username=torvalds Note that the above example leverages string interpolation.\nWe could also extract the SSH keys list to its own “variable” (locals):\nlocals { ssh_keys = compact([for line in split(\"\\n\", data.http.user_ssh_keys.response_body) : chomp(line)]) } resource \"linode_instance\" \"coruscant\" { # ... authorized_keys = local.ssh_keys # ... } A more robust (and stable) way to query the key though is through the Github API:\ndata \"http\" \"github_keys\" { url = \"https://api.github.com/users/${var.github_username}/keys\" } locals { ssh_keys = jsondecode(data.http.github_keys.response_body)[*].key } Note that a typical response body looks like the following:\n[ { \"id\": \"\", \"key\": \"\" } ] API endpoint documentation: https://docs.github.com/en/rest/users/keys?apiVersion=2022-11-28#list-public-keys-for-a-user\nIf we use output instead of locals, then we can debug (inspect) it with terraform output.\nAnd that’s it for today! In a future post, we will continue from here by using Ansible to install and set up Miniflux in our new Linode.\nAlpine Linux does not use systemd. ↩︎\n","wordCount":"884","inLanguage":"en","datePublished":"2024-01-23T23:27:04-03:00","dateModified":"2024-01-23T23:27:04-03:00","author":{"@type":"Person","name":"Thiago Perrotta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.perrotta.dev/2024/01/terraforming-a-linode-hello-world/"},"publisher":{"@type":"Person","name":"Not Just Serendipity","logo":{"@type":"ImageObject","url":"https://www.perrotta.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.perrotta.dev/ accesskey=h title="Not Just Serendipity (Alt + H)"><img src=https://www.perrotta.dev/apple-touch-icon.png alt aria-label=logo height=32>Not Just Serendipity</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://www.perrotta.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://www.perrotta.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://www.perrotta.dev/tags/bestof/ title=bestof><span>bestof</span></a></li><li><a href=https://www.perrotta.dev/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://www.perrotta.dev/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>★ Terraforming a Linode: hello world</h1><div class=post-meta><span title='2024-01-23 23:27:04 -0300 -0300'>January 23, 2024</span>&nbsp;·&nbsp;884 words&nbsp;·&nbsp;Thiago Perrotta</div></header><div class=post-content><p>I host my own <a href=https://miniflux.app/>Miniflux</a> instance, which happens to be
my favorite RSS reader. Currently it is hosted on Linode (Akamai Cloud)
running <a href=https://www.alpinelinux.org/>Alpine Linux</a>.</p><p>My current setup was performed manually. I was thinking that, for fun, it would
be cool to fully automate it under the principles of
<a href=https://en.wikipedia.org/wiki/Infrastructure_as_code>IaC</a>.</p><p>The current setup does not use any containers. I had proudly made it as KISS as
possible at the time:</p><ol><li>Linode is a very beginner-friendly (and cheap) VPS</li><li>Alpine Linux is a first-class citizen on Linode</li><li>There&rsquo;s an <code>apk</code> <a href="https://pkgs.alpinelinux.org/packages?name=miniflux">package</a> for <code>miniflux</code></li><li>There&rsquo;s an OpenRC<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> script for <code>miniflux</code> (so that it can be controlled via <code>service</code>)</li></ol><p>For the first part of this automation we will look into provisioning a Linode
with an Alpine Linux installation. In order to do so we will use HashiCorp
<a href=https://www.terraform.io/>Terraform</a>.</p><h2 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h2><ul><li>Provision a new Linode</li><li>Deploy it in Europe</li><li>Use the smallest shape (a so-called <a href=https://www.linode.com/community/questions/211/what-is-a-nanode>Nanode</a>)</li><li>Run Alpine Linux</li><li>Set it up with my <a href=https://github.com/thiagowfx.keys>public ssh key</a>, which is hosted on Github</li></ul><h2 id=terraform-setup>Terraform setup<a hidden class=anchor aria-hidden=true href=#terraform-setup>#</a></h2><ul><li>Install a provider for Linode: <a href=https://registry.terraform.io/providers/linode/linode/latest/docs>https://registry.terraform.io/providers/linode/linode/latest/docs</a></li></ul><p>Scaffold it like this, in a <code>main.tf</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>required_providers</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>linode</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;linode/linode&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% terraform init
</span></span></code></pre></div><ul><li>Generate a Linode API token</li></ul><p>Go to <a href=https://cloud.linode.com/profile/tokens>https://cloud.linode.com/profile/tokens</a>, create a new token called
<code>terraform</code>. with the &ldquo;Linodes&rdquo; scope set to &ldquo;Read/Write&rdquo;.</p><ul><li>Append this API token to <code>main.tf</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;linode&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>token</span> = <span style=color:#e6db74>&#34;&lt;your token here&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>Add a
<a href=https://registry.terraform.io/providers/linode/linode/latest/docs/resources/instance><code>linode_instance</code></a>
with the appropriate fields set according to the documentation:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;linode_instance&#34;</span> <span style=color:#e6db74>&#34;coruscant&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>label</span>  = <span style=color:#e6db74>&#34;coruscant&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>image</span>  = <span style=color:#e6db74>&#34;linode/alpine3.19&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>region</span> = <span style=color:#e6db74>&#34;eu-central&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>   = <span style=color:#e6db74>&#34;g6-nanode-1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authorized_keys</span>  = [<span style=color:#e6db74>&#34;&lt;your ssh public key here&gt;&#34;</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>backups_enabled</span>  = <span style=color:#e6db74>&#34;false&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>watchdog_enabled</span> = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>booted</span>           = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% terraform plan
</span></span></code></pre></div><p>&ldquo;Plan&rdquo; is basically a dry-run. Terraform will output what it intends to do, but nothing will be done yet.</p><ul><li>Analyze the output and double check that it looks correct.</li></ul><p>To actually perform the provisioning, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% terraform apply
</span></span></code></pre></div><p>Then confirm the prompt.</p><p>Within a few seconds (or maybe minutes), you should see your new Linode in the
<a href=https://cloud.linode.com/>Linode Console</a>.</p><p>We can test our deployment by ssh&rsquo;ing to our new machine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% ssh root@&lt;public IP address&gt; -i ~/.ssh/my_ssh_key
</span></span><span style=display:flex><span>Welcome to Alpine!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The Alpine Wiki contains a large amount of how-to guides and general
</span></span><span style=display:flex><span>information about administrating Alpine systems.
</span></span><span style=display:flex><span>See &lt;https://wiki.alpinelinux.org/&gt;.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You can setup the system with the command: setup-alpine
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You may change this message by editing /etc/motd.
</span></span></code></pre></div><p>Let&rsquo;s take a pause to appreciate how lightweight it is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>localhost:~# df -h
</span></span><span style=display:flex><span>Filesystem                Size      Used Available Use% Mounted on
</span></span><span style=display:flex><span>devtmpfs                 10.0M         <span style=color:#ae81ff>0</span>     10.0M   0% /dev
</span></span><span style=display:flex><span>shm                     487.8M         <span style=color:#ae81ff>0</span>    487.8M   0% /dev/shm
</span></span><span style=display:flex><span>/dev/sda                 24.1G    238.1M     22.6G   1% /
</span></span><span style=display:flex><span>tmpfs                   195.1M    268.0K    194.8M   0% /run
</span></span></code></pre></div><p>Only 238 MiB!</p><p>To deprovision it, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% terraform plan -destroy
</span></span></code></pre></div><p>If everything looks correct, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% terraform destroy
</span></span></code></pre></div><p><strong>Warning</strong>: It turns out the &ldquo;Linodes&rdquo; scope was not enough to do the
deprovisioning. I needed to create a new scope, with more permissions, in order
to do so.</p><p>As you can see, terraform makes it very trivial to deprovision systems.</p><p><strong>Bonus points</strong>: run <code>terraform fmt</code> to format your file. Never go <a href="https://www.youtube.com/watch?v=-CmadmM5cOk">out of
style</a>.</p><p><strong>Tip</strong>: At any point you can run <code>terraform validate</code> to verify your <code>main.tf</code>
file is syntatically correct.</p><p>Two things could be improved in the previous setup:</p><ul><li>We could use <code>authorized_users</code> to pass in our linode username. If we add an
SSH key to our linode account, then that key would be automatically deployed
to the system, thereby removing the need to specify <code>authorized_keys</code>.</li><li>Alternatively, we could fetch our key from an URL endpoint with the use of
the <code>hashicorp/http</code> provider, like so:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>required_providers</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;hashicorp/http&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#e6db74>&#34;thiagowfx_ssh_keys&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;https://github.com/thiagowfx.keys&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;linode_instance&#34;</span> <span style=color:#e6db74>&#34;coruscant&#34;</span> {<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>authorized_keys</span>  = compact([<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>line</span> <span style=color:#66d9ef>in</span> split(<span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>n&#34;</span>, data.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>thiagowfx_ssh_keys</span>.<span style=color:#a6e22e>response_body</span>) <span style=color:#f92672>:</span> chomp(<span style=color:#a6e22e>line</span>)])<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>The &ldquo;list comprehension&rdquo; above does line splitting magic to convert them to a
list of string, and the <code>compact</code> removes the empty new line at the end.</p><p>We could improve the example above even further.</p><p>For starters, let&rsquo;s parameterize out the username to a variable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;github_username&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>    = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>default</span> = <span style=color:#e6db74>&#34;thiagowfx&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#e6db74>&#34;user_ssh_keys&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;https://github.com/</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>github_username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.keys&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;linode_instance&#34;</span> <span style=color:#e6db74>&#34;coruscant&#34;</span> {<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>authorized_keys</span>  = compact([<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>line</span> <span style=color:#66d9ef>in</span> split(<span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>n&#34;</span>, data.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>user_ssh_keys</span>.<span style=color:#a6e22e>response_body</span>) <span style=color:#f92672>:</span> chomp(<span style=color:#a6e22e>line</span>)])<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>We could then easily supply another username with <code>-var</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% terraform plan -var github_username<span style=color:#f92672>=</span>torvalds
</span></span></code></pre></div><p>Note that the above example leverages <a href=https://developer.hashicorp.com/terraform/language/expressions/strings>string interpolation</a>.</p><p>We could also extract the SSH keys list to its own &ldquo;variable&rdquo; (<a href=https://developer.hashicorp.com/terraform/language/values/locals>locals</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>locals</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ssh_keys</span> = compact([<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>line</span> <span style=color:#66d9ef>in</span> split(<span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>n&#34;</span>, data.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>user_ssh_keys</span>.<span style=color:#a6e22e>response_body</span>) <span style=color:#f92672>:</span> chomp(<span style=color:#a6e22e>line</span>)])
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;linode_instance&#34;</span> <span style=color:#e6db74>&#34;coruscant&#34;</span> {<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>authorized_keys</span>  = <span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>ssh_keys</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>A more robust (and stable) way to query the key though is through the Github API:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#e6db74>&#34;github_keys&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;https://api.github.com/users/</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>github_username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/keys&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>locals</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ssh_keys</span> = jsondecode(data.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>github_keys</span>.<span style=color:#a6e22e>response_body</span>)[<span style=color:#f92672>*</span>].<span style=color:#a6e22e>key</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note that a typical response body looks like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;&lt;id&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;&lt;ssh key&gt;&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>API endpoint documentation:
<a href="https://docs.github.com/en/rest/users/keys?apiVersion=2022-11-28#list-public-keys-for-a-user">https://docs.github.com/en/rest/users/keys?apiVersion=2022-11-28#list-public-keys-for-a-user</a></p><p>If we use <code>output</code> instead of <code>locals</code>, then we can debug (inspect) it with
<code>terraform output</code>.</p><p>And that&rsquo;s it for today! In a future post, we will continue from here by using
<a href=https://www.ansible.com/>Ansible</a> to install and set up Miniflux in our new
Linode.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Alpine Linux does not use <code>systemd</code>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.perrotta.dev/tags/bestof/>Bestof</a></li><li><a href=https://www.perrotta.dev/tags/dev/>Dev</a></li><li><a href=https://www.perrotta.dev/tags/selfhosted/>Selfhosted</a></li></ul></footer><div style=text-align:center><a href="mailto:tbperrotta@gmail.com?subject=RE: Not%20Just%20Serendipity comment for '%e2%98%85%20Terraforming%20a%20Linode%3a%20hello%20world'" target=_blank><button>Reply via email</button></a></div></article></main><footer class=footer><span>Copyright © 2021 - 2024 Thiago Perrotta • <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> • <a href=/index.xml>RSS</a> •</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>