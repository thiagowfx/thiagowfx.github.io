<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Synchronized in Python | not just serendipity</title><meta name=title content="Synchronized in Python">
<meta name=description content="
In Java, you can make a variable thread safe by just adding the synchronized
keyword. Is there anything that can achieve the same results in
Python?

Without having prior knowledge of any python libraries to do so, the primitive interface
I would expect resembles the following:
class Foo(object):
  def __init__(self):
    self.lock = Lock()

  def perform_mutation(self, bytes):
    print(bytes)

  def write(self, bytes):
    self.lock.acquire()
    self.perform_mutation(bytes)
    self.lock.release()
This isn&rsquo;t robust: if an exception happens in perform_mutation the lock would
never be released. A small improvement we can make is to wrap it with
try/finally:"><meta name=keywords content="dev,bestof★,"><meta property="og:url" content="https://perrotta.dev/2024/01/synchronized-in-python/"><meta property="og:site_name" content="not just serendipity"><meta property="og:title" content="Synchronized in Python"><meta property="og:description" content="In Java, you can make a variable thread safe by just adding the synchronized keyword. Is there anything that can achieve the same results in Python?
Without having prior knowledge of any python libraries to do so, the primitive interface I would expect resembles the following:
class Foo(object): def __init__(self): self.lock = Lock() def perform_mutation(self, bytes): print(bytes) def write(self, bytes): self.lock.acquire() self.perform_mutation(bytes) self.lock.release() This isn’t robust: if an exception happens in perform_mutation the lock would never be released. A small improvement we can make is to wrap it with try/finally:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-15T14:42:51-03:00"><meta property="article:modified_time" content="2024-01-15T14:42:51-03:00"><meta property="article:tag" content="Dev"><meta property="article:tag" content="Bestof★"><meta name=twitter:card content="summary"><meta name=twitter:title content="Synchronized in Python"><meta name=twitter:description content="In Java, you can make a variable thread safe by just adding the synchronized keyword. Is there anything that can achieve the same results in Python?
Without having prior knowledge of any python libraries to do so, the primitive interface I would expect resembles the following:
class Foo(object): def __init__(self): self.lock = Lock() def perform_mutation(self, bytes): print(bytes) def write(self, bytes): self.lock.acquire() self.perform_mutation(bytes) self.lock.release() This isn’t robust: if an exception happens in perform_mutation the lock would never be released. A small improvement we can make is to wrap it with try/finally:"><meta itemprop=name content="Synchronized in Python"><meta itemprop=description content="In Java, you can make a variable thread safe by just adding the synchronized keyword. Is there anything that can achieve the same results in Python?
Without having prior knowledge of any python libraries to do so, the primitive interface I would expect resembles the following:
class Foo(object): def __init__(self): self.lock = Lock() def perform_mutation(self, bytes): print(bytes) def write(self, bytes): self.lock.acquire() self.perform_mutation(bytes) self.lock.release() This isn’t robust: if an exception happens in perform_mutation the lock would never be released. A small improvement we can make is to wrap it with try/finally:"><meta itemprop=datePublished content="2024-01-15T14:42:51-03:00"><meta itemprop=dateModified content="2024-01-15T14:42:51-03:00"><meta itemprop=wordCount content="553"><meta itemprop=keywords content="Dev,Bestof★"><meta name=referrer content="no-referrer-when-downgrade"><link rel="shortcut icon" href=https://perrotta.dev/favicon.ico><link rel=canonical href=https://perrotta.dev/><style>body{font-family:crimson pro,vollkorn,alegreya,iowan old style,apple garamond,baskerville,times new roman,noto serif,droid serif,times,source serif pro,serif,apple color emoji,segoe ui emoji,segoe ui symbol,noto color emoji;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fffcf0;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}h1,h2,h3,h4,h5,h6,footer,nav{font-family:inter,fira sans,lato,system-ui,-apple-system,BlinkMacSystemFont,avenir next,avenir,segoe ui,helvetica neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}footer{font-size:small;padding:25px;text-align:center}a{color:#3273dc}.title{text-decoration:none;border:0;display:flex;align-items:center;column-gap:10px}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}li code,p code{font-size:small}pre code{color:#222;display:block;padding:20px;white-space:pre;font-size:14px;overflow-x:auto}code,pre{font-family:fira code,pt mono,ibm plex mono,Menlo,Consolas,Monaco,liberation mono,ubuntu mono,lucida console,monospace}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 110px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#01242e;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#444}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}}</style><link rel=apple-touch-icon href=https://perrotta.dev/apple-touch-icon.png></head><body><header><a href=/ class=title><img src=https://perrotta.dev/thiagowfx.png alt="not just serendipity" style=height:2em><h2>not just serendipity</h2></a><nav><a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags/bestof/>★</a></nav></header><main><h1><span>★</span>
Synchronized in Python</h1><p><i><time datetime=2024-01-15 pubdate>15 Jan, 2024
</time>• 553 words</i></p><content><blockquote><p><a href=https://stackoverflow.com/questions/53026622/python-equivalent-of-java-synchronized>In Java, you can make a variable thread safe by just adding the <code>synchronized</code>
keyword. Is there anything that can achieve the same results in
Python?</a></p></blockquote><p>Without having prior knowledge of any python libraries to do so, the primitive interface
I would expect resembles the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Foo</span>(object):
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>lock <span style=color:#f92672>=</span> Lock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>perform_mutation</span>(self, bytes):
</span></span><span style=display:flex><span>    print(bytes)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(self, bytes):
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>lock<span style=color:#f92672>.</span>acquire()
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>perform_mutation(bytes)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>lock<span style=color:#f92672>.</span>release()
</span></span></code></pre></div><p>This isn&rsquo;t robust: if an exception happens in <code>perform_mutation</code> the lock would
never be released. A small improvement we can make is to wrap it with
<code>try/finally</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Foo</span>(object):
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>lock <span style=color:#f92672>=</span> Lock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>perform_mutation</span>(self, bytes):
</span></span><span style=display:flex><span>    print(bytes)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(self, bytes):
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>lock<span style=color:#f92672>.</span>acquire()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>perform_mutation(bytes)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>finally</span>:
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>lock<span style=color:#f92672>.</span>release()
</span></span></code></pre></div><p>However it turns out there&rsquo;s a more pythonic way to do so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Lock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Foo</span>(object):
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>lock <span style=color:#f92672>=</span> Lock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>perform_mutation</span>(self, bytes):
</span></span><span style=display:flex><span>    print(bytes)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(self, bytes):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>lock:
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>perform_mutation(bytes)
</span></span></code></pre></div><p>How can we test this? First, let&rsquo;s use a single thread.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>  foo <span style=color:#f92672>=</span> Foo()
</span></span><span style=display:flex><span>  foo<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#34;hello from the main thread&#34;</span>)
</span></span></code></pre></div><p>Now let&rsquo;s use multiple threads:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>  foo <span style=color:#f92672>=</span> Foo()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  threads <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>):
</span></span><span style=display:flex><span>    thread <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>foo<span style=color:#f92672>.</span>write, args<span style=color:#f92672>=</span>(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;hello from thread </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,))
</span></span><span style=display:flex><span>    threads<span style=color:#f92672>.</span>append(thread)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Start all threads</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> thread <span style=color:#f92672>in</span> threads:
</span></span><span style=display:flex><span>    thread<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Wait for all threads to finish</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> thread <span style=color:#f92672>in</span> threads:
</span></span><span style=display:flex><span>    thread<span style=color:#f92672>.</span>join()
</span></span></code></pre></div><p>Without the lock this is one of the results I get locally:</p><pre tabindex=0><code>% python3 lock.py
hello from thread 0
hello from thread 1
hello from thread 2
hello from thread 3
hello from thread 4
hello from thread 6
hello from thread 8
hello from thread 7
hello from thread 5
hello from thread 9
</code></pre><p>With the lock I always get the following, as you would predict:</p><pre tabindex=0><code>% python3 lock.py
hello from thread 0
hello from thread 1
hello from thread 2
hello from thread 3
hello from thread 4
hello from thread 5
hello from thread 6
hello from thread 7
hello from thread 8
hello from thread 9
</code></pre><p>We could go one level deeper in the abstraction by using a <code>@synchronized</code> decorator:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Foo</span>(object):
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>perform_mutation</span>(self, bytes):
</span></span><span style=display:flex><span>    print(bytes)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@synchronized</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write</span>(self, bytes):
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>perform_mutation(bytes)
</span></span></code></pre></div><p>How do we implement it?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>synchronized</span>(member):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@wraps</span>(member)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs):
</span></span><span style=display:flex><span>        lock <span style=color:#f92672>=</span> vars(member)<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;_synchronized_lock&#34;</span>, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> lock <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            lock <span style=color:#f92672>=</span> vars(member)<span style=color:#f92672>.</span>setdefault(<span style=color:#e6db74>&#34;_synchronized_lock&#34;</span>, Lock())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> lock:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> member(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kwargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> wrapper
</span></span></code></pre></div><p>One last concept to learn: <code>RLock</code> a.k.a. reentrant lock.</p><p>Consider the following program:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Lock, Thread
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Foo</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>lock <span style=color:#f92672>=</span> Lock()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>changeA</span>(self, bytes):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>lock:
</span></span><span style=display:flex><span>            print(bytes)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>changeB</span>(self, bytes):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>lock:
</span></span><span style=display:flex><span>            print(bytes)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>changeAandB</span>(self, bytes):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> self<span style=color:#f92672>.</span>lock:
</span></span><span style=display:flex><span>            print(bytes)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>changeA(bytes) <span style=color:#75715e># a usual lock would block here</span>
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>changeB(bytes)
</span></span></code></pre></div><p>Invoked as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span>foo <span style=color:#f92672>=</span> Foo()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>threads <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>5</span>):
</span></span><span style=display:flex><span>    thread <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>foo<span style=color:#f92672>.</span>changeA, args<span style=color:#f92672>=</span>(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;hello from thread </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74> A&#34;</span>,))
</span></span><span style=display:flex><span>    threads<span style=color:#f92672>.</span>append(thread)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    thread <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>foo<span style=color:#f92672>.</span>changeB, args<span style=color:#f92672>=</span>(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;hello from thread </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74> B&#34;</span>,))
</span></span><span style=display:flex><span>    threads<span style=color:#f92672>.</span>append(thread)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    thread <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>foo<span style=color:#f92672>.</span>changeAandB, args<span style=color:#f92672>=</span>(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;hello from thread </span><span style=color:#e6db74>{</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74> AB&#34;</span>,))
</span></span><span style=display:flex><span>    threads<span style=color:#f92672>.</span>append(thread)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Start all threads</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> thread <span style=color:#f92672>in</span> threads:
</span></span><span style=display:flex><span>    thread<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Wait for all threads to finish</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> thread <span style=color:#f92672>in</span> threads:
</span></span><span style=display:flex><span>    thread<span style=color:#f92672>.</span>join()
</span></span></code></pre></div><p>It will not work as expected. As soon as the first <code>changeAandB</code> gets called, its inner
<code>self.changeA</code> call will block. This is because the lock can only be acquired once.</p><p>In this specific example, the straightforward way to fix the issue is to use an <code>RLock</code>:
<code>self.lock = RLock()</code>. The reentrant lock can be locked multiple times.</p><h2 id=references>References</h2><ul><li><a href=https://theorangeduck.com/page/synchronized-python>https://theorangeduck.com/page/synchronized-python</a></li><li><a href=https://stackoverflow.com/questions/29158282/how-to-create-a-synchronized-function-across-all-instances>https://stackoverflow.com/questions/29158282/how-to-create-a-synchronized-function-across-all-instances</a></li><li><a href=https://stackoverflow.com/questions/53026622/python-equivalent-of-java-synchronized>https://stackoverflow.com/questions/53026622/python-equivalent-of-java-synchronized</a></li><li><a href=https://stackoverflow.com/questions/16567958/when-and-how-to-use-pythons-rlock>https://stackoverflow.com/questions/16567958/when-and-how-to-use-pythons-rlock</a></li></ul></content><p><a href=https://perrotta.dev/tags/dev/>#dev</a>
<a href=https://perrotta.dev/tags/bestof/>#bestof★</a></p></main><footer><span>© 2021 - 2025 <a href=mailto:tbperrotta@gmail.com>Thiago Perrotta</a> <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>Some Rights Reserved</a> · <a href=/index.xml>RSS</a> · a fork of <a href=https://github.com/janraasch/hugo-bearblog/>hugo ʕ•ᴥ•ʔ bear</a></span></footer></body></html>