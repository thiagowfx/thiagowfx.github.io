<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Python: all hail to cache memoization | not just serendipity</title>
<meta name=keywords content="dev"><meta name=description content="In a typical dynamic programming (DP) problem, you&rsquo;ll usually instantiate a
variable to hold previously computed data (cache)."><meta name=author content="Thiago Perrotta"><link rel=canonical href=https://www.perrotta.dev/2024/01/python-all-hail-to-cache-memoization/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://www.perrotta.dev/favicon.ico><link rel=apple-touch-icon href=https://www.perrotta.dev/apple-touch-icon.png><link rel=mask-icon href=https://www.perrotta.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.perrotta.dev/2024/01/python-all-hail-to-cache-memoization/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav,.toc,.post-meta{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style><meta property="og:title" content="Python: all hail to cache memoization"><meta property="og:description" content="In a typical dynamic programming (DP) problem, you&rsquo;ll usually instantiate a
variable to hold previously computed data (cache)."><meta property="og:type" content="article"><meta property="og:url" content="https://www.perrotta.dev/2024/01/python-all-hail-to-cache-memoization/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-12T14:37:13+01:00"><meta property="article:modified_time" content="2024-01-12T14:37:13+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python: all hail to cache memoization"><meta name=twitter:description content="In a typical dynamic programming (DP) problem, you&rsquo;ll usually instantiate a
variable to hold previously computed data (cache)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.perrotta.dev/posts/"},{"@type":"ListItem","position":2,"name":"Python: all hail to cache memoization","item":"https://www.perrotta.dev/2024/01/python-all-hail-to-cache-memoization/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Python: all hail to cache memoization","name":"Python: all hail to cache memoization","description":"In a typical dynamic programming (DP) problem, you\u0026rsquo;ll usually instantiate a variable to hold previously computed data (cache).\n","keywords":["dev"],"articleBody":"In a typical dynamic programming (DP) problem, you’ll usually instantiate a variable to hold previously computed data (cache).\nFor example, let’s consider a naive implementation of the factorial function:\ndef factorial(n: int) -\u003e int: if n == 0: return 1 return n * factorial(n - 1) Now let’s add a cache to improve it, upon a use case wherein it would be called multiple times in a row:\ncache: dict[int, int] = {} def factorial(n: int) -\u003e int: if n == 0: return 1 if n in cache: return cache[n] cache[n] = n * factorial(n - 1) return cache[n] This is straightforward, the only caveat to watch out for is the scope of the cache. In general you wouldn’t want to store it globally.\nOne elegant way to address this is with lru_cache:\nfrom functools import lru_cache @lru_cache(maxsize=None) def factorial(n: int) -\u003e int: if n == 0: return 1 return n * factorial(n - 1) The snippet above creates and maintains a cache under the hood. The main caveat of that snippet is that it’s not easy to remember:\nis it max_size or maxsize? is it maxsize=0 or maxsize=None? This week I found out that there’s an even more ergonomic decorator, which it is super easy to remember!\nfrom functools import cache @cache def factorial(n: int) -\u003e int: if n == 0: return 1 return n * factorial(n - 1) @cache is equivalent to lru_cache(maxsize=None).\nWith this trick, you won’t ever need to manually memoize any function in python anymore!\nThis works for any number of arguments so long as they can be used as dictionary keys, i.e. the arguments must be hashable. Practically speaking, this means lists are not cacheable, but tuples are.\nHappy dynamic programming!\nReference: https://docs.python.org/3/library/functools.html\n","wordCount":"289","inLanguage":"en","datePublished":"2024-01-12T14:37:13+01:00","dateModified":"2024-01-12T14:37:13+01:00","author":{"@type":"Person","name":"Thiago Perrotta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.perrotta.dev/2024/01/python-all-hail-to-cache-memoization/"},"publisher":{"@type":"Person","name":"not just serendipity","logo":{"@type":"ImageObject","url":"https://www.perrotta.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.perrotta.dev/ accesskey=h title="not just serendipity (Alt + H)"><img src=https://www.perrotta.dev/apple-touch-icon.png alt aria-label=logo height=32>not just serendipity</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.perrotta.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://www.perrotta.dev/tags/bestof/ title="★ bestof"><span>★ bestof</span></a></li><li><a href=https://www.perrotta.dev/tags/serenity/ title=serenity><span>serenity</span></a></li><li><a href=https://www.perrotta.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://www.perrotta.dev/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://www.perrotta.dev/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Python: all hail to cache memoization</h1><div class=post-meta><span title='2024-01-12 14:37:13 +0100 +0100'>January 12, 2024</span>&nbsp;·&nbsp;289 words&nbsp;·&nbsp;Thiago Perrotta</div></header><div class=post-content><p>In a typical dynamic programming (DP) problem, you&rsquo;ll usually instantiate a
variable to hold previously computed data (cache).</p><p>For example, let&rsquo;s consider a naive implementation of the factorial function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>factorial</span>(n: int) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> n <span style=color:#f92672>*</span> factorial(n <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><p>Now let&rsquo;s add a cache to improve it, upon a use case wherein it would be called
multiple times in a row:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>cache: dict[int, int] <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>factorial</span>(n: int) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> n <span style=color:#f92672>in</span> cache:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cache[n]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cache[n] <span style=color:#f92672>=</span> n <span style=color:#f92672>*</span> factorial(n <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> cache[n]
</span></span></code></pre></div><p>This is straightforward, the only caveat to watch out for is the scope of the
cache. In general you wouldn&rsquo;t want to store it globally.</p><p>One elegant way to address this is with <code>lru_cache</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> lru_cache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@lru_cache</span>(maxsize<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>factorial</span>(n: int) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> n <span style=color:#f92672>*</span> factorial(n <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><p>The snippet above creates and maintains a cache under the hood. The main caveat
of that snippet is that it&rsquo;s not easy to remember:</p><ul><li>is it <code>max_size</code> or <code>maxsize</code>?</li><li>is it <code>maxsize=0</code> or <code>maxsize=None</code>?</li></ul><p>This week I found out that there&rsquo;s an even more ergonomic decorator, which it is
super easy to remember!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> cache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@cache</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>factorial</span>(n: int) <span style=color:#f92672>-&gt;</span> int:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> n <span style=color:#f92672>*</span> factorial(n <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><p><code>@cache</code> is equivalent to <code>lru_cache(maxsize=None)</code>.</p><p>With this trick, you won&rsquo;t ever need to manually memoize any function in python
anymore!</p><p>This works for any number of arguments so long as they can be used as
dictionary keys, i.e. the arguments must be
<a href=https://docs.python.org/3/glossary.html#term-hashable>hashable</a>. Practically
speaking, this means lists are not cacheable, but tuples are.</p><p>Happy dynamic programming!</p><p><strong>Reference</strong>: <a href=https://docs.python.org/3/library/functools.html>https://docs.python.org/3/library/functools.html</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.perrotta.dev/tags/dev/>Dev</a></li></ul></footer><div style=text-align:center><a href="mailto:tbperrotta@gmail.com?subject=RE: not%20just%20serendipity comment for 'Python%3a%20all%20hail%20to%20cache%20memoization'" target=_blank><button>Reply via email</button></a></div></article></main><footer class=footer><span>Copyright © 2021 - 2024 Thiago Perrotta · <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> • <a href=/index.xml>RSS</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>