<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>★ Integrating terraform with ansible | not just serendipity</title>
<meta name=keywords content="bestof,dev,selfhosted"><meta name=description content="This post is a follow-up of Terraforming a Linode: hello world.

In a future post, we will continue from here by using Ansible to install and
set up Miniflux in our new Linode.

Before we extensively use Ansible to configure our VPS instance, first let&rsquo;s
set up a basic integration between Terraform and Ansible."><meta name=author content="Thiago Perrotta"><link rel=canonical href=https://www.perrotta.dev/2024/02/integrating-terraform-with-ansible/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://www.perrotta.dev/favicon.ico><link rel=apple-touch-icon href=https://www.perrotta.dev/apple-touch-icon.png><link rel=mask-icon href=https://www.perrotta.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.perrotta.dev/2024/02/integrating-terraform-with-ansible/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav,.toc,.post-meta{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style><meta property="og:title" content="★ Integrating terraform with ansible"><meta property="og:description" content="This post is a follow-up of Terraforming a Linode: hello world.

In a future post, we will continue from here by using Ansible to install and
set up Miniflux in our new Linode.

Before we extensively use Ansible to configure our VPS instance, first let&rsquo;s
set up a basic integration between Terraform and Ansible."><meta property="og:type" content="article"><meta property="og:url" content="https://www.perrotta.dev/2024/02/integrating-terraform-with-ansible/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-01T14:02:28-03:00"><meta property="article:modified_time" content="2024-02-01T14:02:28-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="★ Integrating terraform with ansible"><meta name=twitter:description content="This post is a follow-up of Terraforming a Linode: hello world.

In a future post, we will continue from here by using Ansible to install and
set up Miniflux in our new Linode.

Before we extensively use Ansible to configure our VPS instance, first let&rsquo;s
set up a basic integration between Terraform and Ansible."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.perrotta.dev/posts/"},{"@type":"ListItem","position":2,"name":"★ Integrating terraform with ansible","item":"https://www.perrotta.dev/2024/02/integrating-terraform-with-ansible/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"★ Integrating terraform with ansible","name":"★ Integrating terraform with ansible","description":"This post is a follow-up of Terraforming a Linode: hello world.\nIn a future post, we will continue from here by using Ansible to install and set up Miniflux in our new Linode.\nBefore we extensively use Ansible to configure our VPS instance, first let\u0026rsquo;s set up a basic integration between Terraform and Ansible.\n","keywords":["bestof","dev","selfhosted"],"articleBody":"This post is a follow-up of Terraforming a Linode: hello world.\nIn a future post, we will continue from here by using Ansible to install and set up Miniflux in our new Linode.\nBefore we extensively use Ansible to configure our VPS instance, first let’s set up a basic integration between Terraform and Ansible.\nFirst of all, here’s an overview of where I stopped last time. There were a couple of lightweight modifications since then. I’ll explain some of them below.\n% cat variables.tf variable \"github_username\" { type = string default = \"thiagowfx\" } variable \"linode_hostname\" { type = string default = \"coruscant\" } variable \"linode_region\" { type = string default = \"eu-central\" } All variables were moved to a variables.tf file. This is to follow standard terraform conventions / recommendations for module structures. Furthermore, it becomes easier to manage variables when they are all stored in a single place.\nThe main module file now looks like this:\n% cat main.tf terraform { required_providers { http = { source = \"hashicorp/http\" } linode = { source = \"linode/linode\" } } } provider \"linode\" {} data \"http\" \"github_keys\" { url = \"https://api.github.com/users/${var.github_username}/keys\" } locals { keys = jsondecode(data.http.github_keys.response_body)[*].key } resource \"linode_instance\" \"nanode\" { type = \"g6-nanode-1\" image = \"linode/alpine3.19\" label = var.linode_hostname region = var.linode_region authorized_keys = local.keys backups_enabled = \"false\" booted = \"true\" watchdog_enabled = \"true\" } I removed the token from the linode provider. Now it is supplied via the LINODE_TOKEN environment variable. In order to automatically populate that variable, I use direnv. There’s an .envrc file that provides its value, like so:\n#!/bin/sh # terraform init export LINODE_TOKEN=\"my-token-here\" I also created a repository for this project: https://github.com/thiagowfx/knol. That’s enough for preliminaries, now let’s go back to Ansible.\nThe first component we’ll need is an Ansible inventory file, containing the IP address of the host we’ll manage. It could look like this:\n[all] 1.2.3.4 ansible_user=root …wherein 1.2.3.4 is the IP address of our VPS.\nThat said, due to the fact the VPS instance is created dynamically, maintaining that IP address manually would be tedious. Therefore, let’s have Terraform manage it.\nWe can do so with a local_file. Heck, we could even use a template_file, however it would be overkill as there are only two simple lines in our inventory at this point. A local_file is created upon terraform apply and deleted upon terraform destroy. Therefore it doesn’t even need to be tracked by our VCS:\nresource \"local_file\" \"ansible_inventory\" { content = \u003c\u003c-EOF [all] ${linode_instance.nanode.ip_address} ansible_user=root EOF filename = \"inventory.ini\" file_permission = \"0644\" } Once we run terraform (plan + apply), an inventory.ini file should be created with the above contents.\nBecause the IP address is ephemeral and dynamic, we should have a straightforward way to see its value. A terraform output is perfect for that:\n% cat outputs.tf output \"ip_address\" { value = linode_instance.nanode.ip_address } Later on (after terraforming) we will be able to use terraform output to see the server IP address.\nWe have the inventory file. Now we need a playbook. A playbook contains a sequence of tasks to be applied to our server.\nLet’s start with a basic playbook that just installs and starts nginx:\n--- - hosts: all tasks: - name: Install the web server (nginx) community.general.apk: name: nginx state: present - name: Start the web server service: name: nginx state: started Save this to a playbook.yml file.\nAfter terraforming, we should now be able to run ansible:\n% ansible-playbook -i inventory.ini playbook.yml In order to make this setup more ergonomic, let’s create a Makefile:\nTERRAFORM := terraform all: terraform ansible ansible: ansible-playbook -i inventory.ini playbook.yml terraform: $(TERRAFORM) init $(TERRAFORM) plan $(TERRAFORM) apply clean: $(TERRAFORM) destroy .PHONY: all ansible terraform clean Then we can just run make terraform or make ansible for granular steps. Or just make to run everything in the right order.\nI extracted the terraform binary to its own variable because it facilitates the use of OpenTofu (a fork) in lieu of terraform.\nAnd that’s it for today! In a future post, we’ll look into extending our Ansible usage to fully bootstrap Miniflux on the server.\n","wordCount":"684","inLanguage":"en","datePublished":"2024-02-01T14:02:28-03:00","dateModified":"2024-02-01T14:02:28-03:00","author":{"@type":"Person","name":"Thiago Perrotta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.perrotta.dev/2024/02/integrating-terraform-with-ansible/"},"publisher":{"@type":"Person","name":"not just serendipity","logo":{"@type":"ImageObject","url":"https://www.perrotta.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.perrotta.dev/ accesskey=h title="not just serendipity (Alt + H)"><img src=https://www.perrotta.dev/apple-touch-icon.png alt aria-label=logo height=32>not just serendipity</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.perrotta.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://www.perrotta.dev/tags/bestof/ title="★ bestof"><span>★ bestof</span></a></li><li><a href=https://www.perrotta.dev/tags/serenity/ title=serenity><span>serenity</span></a></li><li><a href=https://www.perrotta.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://www.perrotta.dev/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://www.perrotta.dev/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">★ Integrating terraform with ansible</h1><div class=post-meta><span title='2024-02-01 14:02:28 -0300 -0300'>February 1, 2024</span>&nbsp;·&nbsp;684 words&nbsp;·&nbsp;Thiago Perrotta</div></header><div class=post-content><p>This post is a follow-up of <a href=https://www.perrotta.dev/2024/01/terraforming-a-linode-hello-world/>Terraforming a Linode: hello world</a>.</p><blockquote><p>In a future post, we will continue from here by using Ansible to install and
set up Miniflux in our new Linode.</p></blockquote><p>Before we extensively use Ansible to configure our VPS instance, first let&rsquo;s
set up a basic integration between Terraform and Ansible.</p><p>First of all, here&rsquo;s an overview of where I stopped last time. There were a
couple of lightweight modifications since then. I&rsquo;ll explain some of them
below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#f92672>%</span> <span style=color:#a6e22e>cat</span> var<span style=color:#a6e22e>iables</span>.<span style=color:#a6e22e>tf</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;github_username&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>    = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>default</span> = <span style=color:#e6db74>&#34;thiagowfx&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linode_hostname&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>    = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>default</span> = <span style=color:#e6db74>&#34;coruscant&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linode_region&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>    = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>default</span> = <span style=color:#e6db74>&#34;eu-central&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>All variables were moved to a <code>variables.tf</code> file. This is to follow standard
terraform
<a href=https://developer.hashicorp.com/terraform/language/modules/develop/structure>conventions</a>
/ recommendations for module structures. Furthermore, it becomes easier to
manage variables when they are all stored in a single place.</p><p>The main module file now looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#f92672>%</span> <span style=color:#a6e22e>cat</span> <span style=color:#a6e22e>main</span>.<span style=color:#a6e22e>tf</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>required_providers</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;hashicorp/http&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>linode</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;linode/linode&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;linode&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#e6db74>&#34;github_keys&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;https://api.github.com/users/</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>github_username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/keys&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>locals</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>keys</span> = jsondecode(data.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>github_keys</span>.<span style=color:#a6e22e>response_body</span>)[<span style=color:#f92672>*</span>].<span style=color:#a6e22e>key</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;linode_instance&#34;</span> <span style=color:#e6db74>&#34;nanode&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>             = <span style=color:#e6db74>&#34;g6-nanode-1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>image</span>            = <span style=color:#e6db74>&#34;linode/alpine3.19&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>label</span>            = var.<span style=color:#a6e22e>linode_hostname</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>region</span>           = var.<span style=color:#a6e22e>linode_region</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authorized_keys</span>  = <span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>keys</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>backups_enabled</span>  = <span style=color:#e6db74>&#34;false&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>booted</span>           = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>watchdog_enabled</span> = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I removed the token from the linode provider. Now it is supplied via the
<code>LINODE_TOKEN</code> environment variable. In order to automatically populate that
variable, I use <a href=https://www.perrotta.dev/2022/01/direnv-automate-your-environment-variables/><code>direnv</code></a>. There&rsquo;s an <code>.envrc</code> file that provides its value, like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># terraform init</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export LINODE_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;my-token-here&#34;</span>
</span></span></code></pre></div><p>I also created a repository for this project:
<a href=https://github.com/thiagowfx/knol>https://github.com/thiagowfx/knol</a>. That&rsquo;s enough for preliminaries, now let&rsquo;s
go back to Ansible.</p><p>The first component we&rsquo;ll need is an Ansible
<a href=https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html>inventory</a>
file, containing the IP address of the host we&rsquo;ll manage. It could look like
this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[all]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>1.2.3.4 ansible_user</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span></code></pre></div><p>&mldr;wherein <code>1.2.3.4</code> is the IP address of our VPS.</p><p>That said, due to the fact the VPS instance is created dynamically, maintaining
that IP address manually would be tedious. Therefore, let&rsquo;s have Terraform
manage it.</p><p>We can do so with a
<a href=https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/file><code>local_file</code></a>.
Heck, we could even use a
<a href=https://registry.terraform.io/providers/hashicorp/template/latest/docs/data-sources/file><code>template_file</code></a>,
however it would be overkill as there are only two simple lines in our
inventory at this point. A <code>local_file</code> is created upon <code>terraform apply</code> and
deleted upon <code>terraform destroy</code>. Therefore it doesn&rsquo;t even need to be tracked
by our VCS:</p><pre tabindex=0><code>resource &#34;local_file&#34; &#34;ansible_inventory&#34; {
  content  = &lt;&lt;-EOF
[all]
${linode_instance.nanode.ip_address} ansible_user=root
EOF
  filename = &#34;inventory.ini&#34;
  file_permission = &#34;0644&#34;
}
</code></pre><p>Once we run terraform (plan + apply), an <code>inventory.ini</code> file should be created
with the above contents.</p><p>Because the IP address is ephemeral and dynamic, we should have a
straightforward way to see its value. A terraform
<a href=https://developer.hashicorp.com/terraform/language/values/outputs><code>output</code></a>
is perfect for that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#f92672>%</span> <span style=color:#a6e22e>cat</span> <span style=color:#a6e22e>outputs</span>.<span style=color:#a6e22e>tf</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;ip_address&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>linode_instance</span>.<span style=color:#a6e22e>nanode</span>.<span style=color:#a6e22e>ip_address</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Later on (after terraforming) we will be able to use <code>terraform output</code> to see
the server IP address.</p><p>We have the inventory file. Now we need a
<a href=https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html>playbook</a>.
A playbook contains a sequence of tasks to be applied to our server.</p><p>Let&rsquo;s start with a basic playbook that just installs and starts <code>nginx</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install the web server (nginx)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>community.general.apk</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Start the web server</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span></code></pre></div><p>Save this to a <code>playbook.yml</code> file.</p><p>After terraforming, we should now be able to run ansible:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% ansible-playbook -i inventory.ini playbook.yml
</span></span></code></pre></div><p>In order to make this setup more ergonomic, let&rsquo;s create a <code>Makefile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=display:flex><span>TERRAFORM <span style=color:#f92672>:=</span> terraform
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>all</span><span style=color:#f92672>:</span> terraform ansible
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ansible</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	ansible-playbook -i inventory.ini playbook.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>terraform</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>TERRAFORM<span style=color:#66d9ef>)</span> init
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>TERRAFORM<span style=color:#66d9ef>)</span> plan
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>TERRAFORM<span style=color:#66d9ef>)</span> apply
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>clean</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>TERRAFORM<span style=color:#66d9ef>)</span> destroy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>.PHONY</span><span style=color:#f92672>:</span> all ansible terraform clean
</span></span></code></pre></div><p>Then we can just run <code>make terraform</code> or <code>make ansible</code> for granular steps. Or
just <code>make</code> to run everything in the right order.</p><p>I extracted the <code>terraform</code> binary to its own variable because it facilitates
the use of <a href=https://opentofu.org/>OpenTofu</a> (a fork) in lieu of terraform.</p><p>And that&rsquo;s it for today! In a future post, we&rsquo;ll look into extending our
Ansible usage to fully bootstrap Miniflux on the server.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.perrotta.dev/tags/bestof/>Bestof</a></li><li><a href=https://www.perrotta.dev/tags/dev/>Dev</a></li><li><a href=https://www.perrotta.dev/tags/selfhosted/>Selfhosted</a></li></ul></footer></article></main><footer class=footer><span>Copyright © 2021 - 2024 Thiago Perrotta · <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> · <a href=/index.xml>RSS</a> · Made with ♥ in 🇨🇦</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>