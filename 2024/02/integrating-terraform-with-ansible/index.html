<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>★ Integrating terraform with ansible | not just serendipity</title>
<meta name=title content="★ Integrating terraform with ansible"><meta name=description content="This post is a follow-up of Terraforming a Linode: hello world.

In a future post, we will continue from here by using Ansible to install and
set up Miniflux in our new Linode.

Before we extensively use Ansible to configure our VPS instance, first let&rsquo;s
set up a basic integration between Terraform and Ansible.
First of all, here&rsquo;s an overview of where I stopped last time. There were a
couple of lightweight modifications since then. I&rsquo;ll explain some of them
below."><meta name=keywords content="bestof★,dev,selfhosted,"><meta property="og:url" content="https://perrotta.dev/2024/02/integrating-terraform-with-ansible/"><meta property="og:site_name" content="not just serendipity"><meta property="og:title" content="★ Integrating terraform with ansible"><meta property="og:description" content="This post is a follow-up of Terraforming a Linode: hello world.
In a future post, we will continue from here by using Ansible to install and set up Miniflux in our new Linode.
Before we extensively use Ansible to configure our VPS instance, first let’s set up a basic integration between Terraform and Ansible.
First of all, here’s an overview of where I stopped last time. There were a couple of lightweight modifications since then. I’ll explain some of them below."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-01T14:02:28-03:00"><meta property="article:modified_time" content="2024-02-01T14:02:28-03:00"><meta property="article:tag" content="Bestof★"><meta property="article:tag" content="Dev"><meta property="article:tag" content="Selfhosted"><meta name=twitter:card content="summary"><meta name=twitter:title content="★ Integrating terraform with ansible"><meta name=twitter:description content="This post is a follow-up of Terraforming a Linode: hello world.
In a future post, we will continue from here by using Ansible to install and set up Miniflux in our new Linode.
Before we extensively use Ansible to configure our VPS instance, first let’s set up a basic integration between Terraform and Ansible.
First of all, here’s an overview of where I stopped last time. There were a couple of lightweight modifications since then. I’ll explain some of them below."><meta itemprop=name content="★ Integrating terraform with ansible"><meta itemprop=description content="This post is a follow-up of Terraforming a Linode: hello world.
In a future post, we will continue from here by using Ansible to install and set up Miniflux in our new Linode.
Before we extensively use Ansible to configure our VPS instance, first let’s set up a basic integration between Terraform and Ansible.
First of all, here’s an overview of where I stopped last time. There were a couple of lightweight modifications since then. I’ll explain some of them below."><meta itemprop=datePublished content="2024-02-01T14:02:28-03:00"><meta itemprop=dateModified content="2024-02-01T14:02:28-03:00"><meta itemprop=wordCount content="684"><meta itemprop=keywords content="Bestof★,Dev,Selfhosted"><meta name=referrer content="no-referrer-when-downgrade"><link rel="shortcut icon" href=https://perrotta.dev/favicon.ico><link rel=canonical href=https://perrotta.dev/><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}h1,h2,h3,h4,h5,h6,footer,nav{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}footer{font-size:small}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}li code,p code{font-size:small}pre code{color:#222;display:block;padding:20px;white-space:pre;font-size:14px;overflow-x:auto}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#444}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}}</style><link rel=apple-touch-icon href=https://perrotta.dev/apple-touch-icon.png></head><body><header><a href=/ class=title><h2>not just serendipity</h2></a><nav><a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags/bestof/>★</a></nav></header><main><h1>★ Integrating terraform with ansible</h1><p><i><time datetime=2024-02-01 pubdate>01 Feb, 2024
</time>• 684 words</i></p><content><p>This post is a follow-up of <a href=https://perrotta.dev/2024/01/terraforming-a-linode-hello-world/>Terraforming a Linode: hello world</a>.</p><blockquote><p>In a future post, we will continue from here by using Ansible to install and
set up Miniflux in our new Linode.</p></blockquote><p>Before we extensively use Ansible to configure our VPS instance, first let&rsquo;s
set up a basic integration between Terraform and Ansible.</p><p>First of all, here&rsquo;s an overview of where I stopped last time. There were a
couple of lightweight modifications since then. I&rsquo;ll explain some of them
below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#f92672>%</span> <span style=color:#a6e22e>cat</span> var<span style=color:#a6e22e>iables</span>.<span style=color:#a6e22e>tf</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;github_username&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>    = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>default</span> = <span style=color:#e6db74>&#34;thiagowfx&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linode_hostname&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>    = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>default</span> = <span style=color:#e6db74>&#34;coruscant&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;linode_region&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>    = <span style=color:#a6e22e>string</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>default</span> = <span style=color:#e6db74>&#34;eu-central&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>All variables were moved to a <code>variables.tf</code> file. This is to follow standard
terraform
<a href=https://developer.hashicorp.com/terraform/language/modules/develop/structure>conventions</a>
/ recommendations for module structures. Furthermore, it becomes easier to
manage variables when they are all stored in a single place.</p><p>The main module file now looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#f92672>%</span> <span style=color:#a6e22e>cat</span> <span style=color:#a6e22e>main</span>.<span style=color:#a6e22e>tf</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>required_providers</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;hashicorp/http&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>linode</span> = {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span> = <span style=color:#e6db74>&#34;linode/linode&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;linode&#34;</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#e6db74>&#34;github_keys&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span> = <span style=color:#e6db74>&#34;https://api.github.com/users/</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>github_username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/keys&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>locals</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>keys</span> = jsondecode(data.<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>github_keys</span>.<span style=color:#a6e22e>response_body</span>)[<span style=color:#f92672>*</span>].<span style=color:#a6e22e>key</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;linode_instance&#34;</span> <span style=color:#e6db74>&#34;nanode&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>             = <span style=color:#e6db74>&#34;g6-nanode-1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>image</span>            = <span style=color:#e6db74>&#34;linode/alpine3.19&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>label</span>            = var.<span style=color:#a6e22e>linode_hostname</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>region</span>           = var.<span style=color:#a6e22e>linode_region</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authorized_keys</span>  = <span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>keys</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>backups_enabled</span>  = <span style=color:#e6db74>&#34;false&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>booted</span>           = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>watchdog_enabled</span> = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I removed the token from the linode provider. Now it is supplied via the
<code>LINODE_TOKEN</code> environment variable. In order to automatically populate that
variable, I use <a href=https://perrotta.dev/2022/01/direnv-automate-your-environment-variables/><code>direnv</code></a>. There&rsquo;s an <code>.envrc</code> file that provides its value, like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># terraform init</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export LINODE_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;my-token-here&#34;</span>
</span></span></code></pre></div><p>I also created a repository for this project:
<a href=https://github.com/thiagowfx/knol>https://github.com/thiagowfx/knol</a>. That&rsquo;s enough for preliminaries, now let&rsquo;s
go back to Ansible.</p><p>The first component we&rsquo;ll need is an Ansible
<a href=https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html>inventory</a>
file, containing the IP address of the host we&rsquo;ll manage. It could look like
this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[all]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>1.2.3.4 ansible_user</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span></code></pre></div><p>&mldr;wherein <code>1.2.3.4</code> is the IP address of our VPS.</p><p>That said, due to the fact the VPS instance is created dynamically, maintaining
that IP address manually would be tedious. Therefore, let&rsquo;s have Terraform
manage it.</p><p>We can do so with a
<a href=https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/file><code>local_file</code></a>.
Heck, we could even use a
<a href=https://registry.terraform.io/providers/hashicorp/template/latest/docs/data-sources/file><code>template_file</code></a>,
however it would be overkill as there are only two simple lines in our
inventory at this point. A <code>local_file</code> is created upon <code>terraform apply</code> and
deleted upon <code>terraform destroy</code>. Therefore it doesn&rsquo;t even need to be tracked
by our VCS:</p><pre tabindex=0><code>resource &#34;local_file&#34; &#34;ansible_inventory&#34; {
  content  = &lt;&lt;-EOF
[all]
${linode_instance.nanode.ip_address} ansible_user=root
EOF
  filename = &#34;inventory.ini&#34;
  file_permission = &#34;0644&#34;
}
</code></pre><p>Once we run terraform (plan + apply), an <code>inventory.ini</code> file should be created
with the above contents.</p><p>Because the IP address is ephemeral and dynamic, we should have a
straightforward way to see its value. A terraform
<a href=https://developer.hashicorp.com/terraform/language/values/outputs><code>output</code></a>
is perfect for that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#f92672>%</span> <span style=color:#a6e22e>cat</span> <span style=color:#a6e22e>outputs</span>.<span style=color:#a6e22e>tf</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;ip_address&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>linode_instance</span>.<span style=color:#a6e22e>nanode</span>.<span style=color:#a6e22e>ip_address</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Later on (after terraforming) we will be able to use <code>terraform output</code> to see
the server IP address.</p><p>We have the inventory file. Now we need a
<a href=https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html>playbook</a>.
A playbook contains a sequence of tasks to be applied to our server.</p><p>Let&rsquo;s start with a basic playbook that just installs and starts <code>nginx</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install the web server (nginx)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>community.general.apk</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Start the web server</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>started</span>
</span></span></code></pre></div><p>Save this to a <code>playbook.yml</code> file.</p><p>After terraforming, we should now be able to run ansible:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% ansible-playbook -i inventory.ini playbook.yml
</span></span></code></pre></div><p>In order to make this setup more ergonomic, let&rsquo;s create a <code>Makefile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=display:flex><span>TERRAFORM <span style=color:#f92672>:=</span> terraform
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>all</span><span style=color:#f92672>:</span> terraform ansible
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ansible</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	ansible-playbook -i inventory.ini playbook.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>terraform</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>TERRAFORM<span style=color:#66d9ef>)</span> init
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>TERRAFORM<span style=color:#66d9ef>)</span> plan
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>TERRAFORM<span style=color:#66d9ef>)</span> apply
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>clean</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>$(</span>TERRAFORM<span style=color:#66d9ef>)</span> destroy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>.PHONY</span><span style=color:#f92672>:</span> all ansible terraform clean
</span></span></code></pre></div><p>Then we can just run <code>make terraform</code> or <code>make ansible</code> for granular steps. Or
just <code>make</code> to run everything in the right order.</p><p>I extracted the <code>terraform</code> binary to its own variable because it facilitates
the use of <a href=https://opentofu.org/>OpenTofu</a> (a fork) in lieu of terraform.</p><p>And that&rsquo;s it for today! In a future post, we&rsquo;ll look into extending our
Ansible usage to fully bootstrap Miniflux on the server.</p></content><p><a href=https://perrotta.dev/tags/bestof/>#bestof★</a>
<a href=https://perrotta.dev/tags/dev/>#dev</a>
<a href=https://perrotta.dev/tags/selfhosted/>#selfhosted</a></p></main><footer><span>© 2021 - 2025 <a href=mailto:tbperrotta@gmail.com>Thiago Perrotta</a> <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>Some Rights Reserved</a> · <a href=/index.xml>RSS</a> · a fork of <a href=https://github.com/janraasch/hugo-bearblog/>hugo ʕ•ᴥ•ʔ bear</a></span></footer></body></html>