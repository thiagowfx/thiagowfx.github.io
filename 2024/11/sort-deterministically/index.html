<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>sort deterministically | not just serendipity</title>
<meta name=keywords content="dev"><meta name=description content="We had the following code in a CI pipeline:
find apps/base/ -type d -exec basename {} \; | sort | sed -e 's/^/- /
It lists all directories in apps/base.
We add sort to make the output canonical.
The sed part is just to make an unordered list out of it.
There was an issue though."><meta name=author content="Thiago Perrotta"><link rel=canonical href=https://www.perrotta.dev/2024/11/sort-deterministically/><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://www.perrotta.dev/favicon.ico><link rel=apple-touch-icon href=https://www.perrotta.dev/apple-touch-icon.png><link rel=mask-icon href=https://www.perrotta.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.perrotta.dev/2024/11/sort-deterministically/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav,.toc,.post-meta{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style><meta property="og:url" content="https://www.perrotta.dev/2024/11/sort-deterministically/"><meta property="og:site_name" content="not just serendipity"><meta property="og:title" content="sort deterministically"><meta property="og:description" content="We had the following code in a CI pipeline:
find apps/base/ -type d -exec basename {} \; | sort | sed -e 's/^/- / It lists all directories in apps/base. We add sort to make the output canonical. The sed part is just to make an unordered list out of it.
There was an issue though."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-12T11:25:12+01:00"><meta property="article:modified_time" content="2024-11-12T11:25:12+01:00"><meta property="article:tag" content="Dev"><meta name=twitter:card content="summary"><meta name=twitter:title content="sort deterministically"><meta name=twitter:description content="We had the following code in a CI pipeline:
find apps/base/ -type d -exec basename {} \; | sort | sed -e 's/^/- /
It lists all directories in apps/base.
We add sort to make the output canonical.
The sed part is just to make an unordered list out of it.
There was an issue though."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.perrotta.dev/posts/"},{"@type":"ListItem","position":2,"name":"sort deterministically","item":"https://www.perrotta.dev/2024/11/sort-deterministically/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"sort deterministically","name":"sort deterministically","description":"We had the following code in a CI pipeline:\nfind apps/base/ -type d -exec basename {} \\; | sort | sed -e \u0026#39;s/^/- / It lists all directories in apps/base. We add sort to make the output canonical. The sed part is just to make an unordered list out of it.\nThere was an issue though.\n","keywords":["dev"],"articleBody":"We had the following code in a CI pipeline:\nfind apps/base/ -type d -exec basename {} \\; | sort | sed -e 's/^/- / It lists all directories in apps/base. We add sort to make the output canonical. The sed part is just to make an unordered list out of it.\nThere was an issue though.\nIn my machine, and in CI (GitHub Actions), the following output was produced:\ngarden-info-export gardenia I use macOS + sort from GNU coreutils via homebrew:\n% which sort /opt/homebrew/opt/coreutils/libexec/gnubin/sort % sort --version sort (GNU coreutils) 9.5 Copyright (C) 2024 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later . This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Written by Mike Haertel and Paul Eggert. In a coworker’s machine (Ubuntu Linux), it produced the following instead:\ngardenia garden-info-export We had the same locale (en_US.UTF-8), and the coworker was also using sort from GNU coreutils. Puzzling.\nIn order to force a deterministic output, I proposed to use -d. From sort(1):\n-d, --dictionary-order Consider only blank spaces and alphanumeric characters in comparisons. And therein reproducibility was achieved1.\nI do not really know why the outputs were different even with the same locale (LANG, LC_COLLATE, LC_ALL, etc). For future reference, my current locale:\n% locale LANG=\"en_US.UTF-8\" LC_COLLATE=\"en_US.UTF-8\" LC_CTYPE=\"en_US.UTF-8\" LC_MESSAGES=\"en_US.UTF-8\" LC_MONETARY=\"en_US.UTF-8\" LC_NUMERIC=\"en_US.UTF-8\" LC_TIME=\"en_US.UTF-8\" LC_ALL= And my coworker’s:\n$ locale LANG=en_US.UTF-8 LANGUAGE=en_US LC_CTYPE=\"en_US.UTF-8\" LC_NUMERIC=en_US.UTF-8 LC_TIME=en_US.UTF-8 LC_COLLATE=\"en_US.UTF-8\" LC_MONETARY=en_US.UTF-8 LC_MESSAGES=\"en_US.UTF-8\" LC_PAPER=en_US.UTF-8 LC_NAME=en_US.UTF-8 LC_ADDRESS=en_US.UTF-8 LC_TELEPHONE=en_US.UTF-8 LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=en_US.UTF-8 LC_ALL= In this case, the coworker’s version became the canonical one. ↩︎\n","wordCount":"262","inLanguage":"en","datePublished":"2024-11-12T11:25:12+01:00","dateModified":"2024-11-12T11:25:12+01:00","author":{"@type":"Person","name":"Thiago Perrotta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.perrotta.dev/2024/11/sort-deterministically/"},"publisher":{"@type":"Person","name":"not just serendipity","logo":{"@type":"ImageObject","url":"https://www.perrotta.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.perrotta.dev/ accesskey=h title="not just serendipity (Alt + H)"><img src=https://www.perrotta.dev/apple-touch-icon.png alt aria-label=logo height=32>not just serendipity</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.perrotta.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://www.perrotta.dev/tags/bestof/ title="★ bestof"><span>★ bestof</span></a></li><li><a href=https://www.perrotta.dev/tags/serenity/ title=serenity><span>serenity</span></a></li><li><a href=https://www.perrotta.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://www.perrotta.dev/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://www.perrotta.dev/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">sort deterministically</h1><div class=post-meta><span title='2024-11-12 11:25:12 +0100 +0100'>November 12, 2024</span>&nbsp;·&nbsp;262 words&nbsp;·&nbsp;Thiago Perrotta</div></header><div class=post-content><p>We had the following code in a CI pipeline:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>find apps/base/ -type d -exec basename <span style=color:#f92672>{}</span> <span style=color:#ae81ff>\;</span> | sort | sed -e <span style=color:#960050;background-color:#1e0010>&#39;</span>s/^/- /
</span></span></code></pre></div><p>It lists all directories in <code>apps/base</code>.
We add <code>sort</code> to make the output canonical.
The <code>sed</code> part is just to make an unordered list out of it.</p><p>There was an issue though.</p><p>In my machine, and in CI (GitHub Actions), the following output was produced:</p><pre tabindex=0><code>garden-info-export
gardenia
</code></pre><p>I use macOS + <code>sort</code> from GNU <code>coreutils</code> via homebrew:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% which sort
</span></span><span style=display:flex><span>/opt/homebrew/opt/coreutils/libexec/gnubin/sort
</span></span><span style=display:flex><span>% sort --version
</span></span><span style=display:flex><span>sort <span style=color:#f92672>(</span>GNU coreutils<span style=color:#f92672>)</span> 9.5
</span></span><span style=display:flex><span>Copyright <span style=color:#f92672>(</span>C<span style=color:#f92672>)</span> <span style=color:#ae81ff>2024</span> Free Software Foundation, Inc.
</span></span><span style=display:flex><span>License GPLv3+: GNU GPL version <span style=color:#ae81ff>3</span> or later &lt;https://gnu.org/licenses/gpl.html&gt;.
</span></span><span style=display:flex><span>This is free software: you are free to change and redistribute it.
</span></span><span style=display:flex><span>There is NO WARRANTY, to the extent permitted by law.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Written by Mike Haertel and Paul Eggert.
</span></span></code></pre></div><p>In a coworker’s machine (Ubuntu Linux), it produced the following instead:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gardenia
</span></span><span style=display:flex><span>garden-info-export
</span></span></code></pre></div><p>We had the same <code>locale</code> (<code>en_US.UTF-8</code>), and the coworker was also using <code>sort</code> from GNU <code>coreutils</code>. Puzzling.</p><p>In order to force a deterministic output, I proposed to use <code>-d</code>. From <code>sort(1)</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-d, --dictionary-order
</span></span><span style=display:flex><span>	Consider only blank spaces and alphanumeric characters in comparisons.
</span></span></code></pre></div><p>And therein reproducibility was achieved<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>I do not really know why the outputs were different even with the same <code>locale</code> (<code>LANG</code>, <code>LC_COLLATE</code>, <code>LC_ALL</code>, etc). For future reference, my current locale:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% locale
</span></span><span style=display:flex><span>LANG<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_COLLATE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_CTYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_MESSAGES<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_MONETARY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_NUMERIC<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_TIME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_ALL<span style=color:#f92672>=</span>
</span></span></code></pre></div><p>And my coworker’s:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ locale
</span></span><span style=display:flex><span>LANG<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LANGUAGE<span style=color:#f92672>=</span>en_US
</span></span><span style=display:flex><span>LC_CTYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_NUMERIC<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_TIME<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_COLLATE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_MONETARY<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_MESSAGES<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_PAPER<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_NAME<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_ADDRESS<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_TELEPHONE<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_MEASUREMENT<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_IDENTIFICATION<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_ALL<span style=color:#f92672>=</span>
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>In this case, the coworker’s version became the canonical one.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.perrotta.dev/tags/dev/>Dev</a></li></ul></footer></article></main><footer class=footer><span>Copyright © 2021 - 2024 Thiago Perrotta · <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> · <a href=/index.xml>RSS</a> · Made with ♥ in 🇨🇦</span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>