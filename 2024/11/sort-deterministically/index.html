<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://perrotta.dev/favicon.ico><title>sort deterministically | not just serendipity</title>
<meta name=title content="sort deterministically"><meta name=description content="We had the following code in a CI pipeline:
find apps/base/ -type d -exec basename {} \; | sort | sed -e 's/^/- /
It lists all directories in apps/base.
We add sort to make the output canonical.
The sed part is just to make an unordered list out of it.
There was an issue though.
In my machine, and in CI (GitHub Actions), the following output was produced:
garden-info-export
gardenia
I use macOS + sort from GNU coreutils via homebrew:"><meta name=keywords content="dev,"><meta property="og:url" content="https://perrotta.dev/2024/11/sort-deterministically/"><meta property="og:site_name" content="not just serendipity"><meta property="og:title" content="sort deterministically"><meta property="og:description" content="We had the following code in a CI pipeline:
find apps/base/ -type d -exec basename {} \; | sort | sed -e 's/^/- / It lists all directories in apps/base. We add sort to make the output canonical. The sed part is just to make an unordered list out of it.
There was an issue though.
In my machine, and in CI (GitHub Actions), the following output was produced:
garden-info-export gardenia I use macOS + sort from GNU coreutils via homebrew:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-12T11:25:12+01:00"><meta property="article:modified_time" content="2024-11-12T11:25:12+01:00"><meta property="article:tag" content="Dev"><meta name=twitter:card content="summary"><meta name=twitter:title content="sort deterministically"><meta name=twitter:description content="We had the following code in a CI pipeline:
find apps/base/ -type d -exec basename {} \; | sort | sed -e 's/^/- / It lists all directories in apps/base. We add sort to make the output canonical. The sed part is just to make an unordered list out of it.
There was an issue though.
In my machine, and in CI (GitHub Actions), the following output was produced:
garden-info-export gardenia I use macOS + sort from GNU coreutils via homebrew:"><meta itemprop=name content="sort deterministically"><meta itemprop=description content="We had the following code in a CI pipeline:
find apps/base/ -type d -exec basename {} \; | sort | sed -e 's/^/- / It lists all directories in apps/base. We add sort to make the output canonical. The sed part is just to make an unordered list out of it.
There was an issue though.
In my machine, and in CI (GitHub Actions), the following output was produced:
garden-info-export gardenia I use macOS + sort from GNU coreutils via homebrew:"><meta itemprop=datePublished content="2024-11-12T11:25:12+01:00"><meta itemprop=dateModified content="2024-11-12T11:25:12+01:00"><meta itemprop=wordCount content="262"><meta itemprop=keywords content="Dev"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}h1,h2,h3,h4,h5,h6,footer,nav{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}footer{font-size:small}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2;font-size:small}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#444}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}}</style><link rel=apple-touch-icon href=https://perrotta.dev/apple-touch-icon.png></head><body><header><a href=/ class=title><h2>not just serendipity</h2></a><nav><a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags/bestof/>★</a></nav></header><main><h1>sort deterministically</h1><p><i><time datetime=2024-11-12 pubdate>12 Nov, 2024
</time>• 262 words</i></p><content><p>We had the following code in a CI pipeline:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>find apps/base/ -type d -exec basename <span style=color:#f92672>{}</span> <span style=color:#ae81ff>\;</span> | sort | sed -e <span style=color:#960050;background-color:#1e0010>&#39;</span>s/^/- /
</span></span></code></pre></div><p>It lists all directories in <code>apps/base</code>.
We add <code>sort</code> to make the output canonical.
The <code>sed</code> part is just to make an unordered list out of it.</p><p>There was an issue though.</p><p>In my machine, and in CI (GitHub Actions), the following output was produced:</p><pre tabindex=0><code>garden-info-export
gardenia
</code></pre><p>I use macOS + <code>sort</code> from GNU <code>coreutils</code> via homebrew:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% which sort
</span></span><span style=display:flex><span>/opt/homebrew/opt/coreutils/libexec/gnubin/sort
</span></span><span style=display:flex><span>% sort --version
</span></span><span style=display:flex><span>sort <span style=color:#f92672>(</span>GNU coreutils<span style=color:#f92672>)</span> 9.5
</span></span><span style=display:flex><span>Copyright <span style=color:#f92672>(</span>C<span style=color:#f92672>)</span> <span style=color:#ae81ff>2024</span> Free Software Foundation, Inc.
</span></span><span style=display:flex><span>License GPLv3+: GNU GPL version <span style=color:#ae81ff>3</span> or later &lt;https://gnu.org/licenses/gpl.html&gt;.
</span></span><span style=display:flex><span>This is free software: you are free to change and redistribute it.
</span></span><span style=display:flex><span>There is NO WARRANTY, to the extent permitted by law.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Written by Mike Haertel and Paul Eggert.
</span></span></code></pre></div><p>In a coworker’s machine (Ubuntu Linux), it produced the following instead:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gardenia
</span></span><span style=display:flex><span>garden-info-export
</span></span></code></pre></div><p>We had the same <code>locale</code> (<code>en_US.UTF-8</code>), and the coworker was also using <code>sort</code> from GNU <code>coreutils</code>. Puzzling.</p><p>In order to force a deterministic output, I proposed to use <code>-d</code>. From <code>sort(1)</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-d, --dictionary-order
</span></span><span style=display:flex><span>	Consider only blank spaces and alphanumeric characters in comparisons.
</span></span></code></pre></div><p>And therein reproducibility was achieved<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>I do not really know why the outputs were different even with the same <code>locale</code> (<code>LANG</code>, <code>LC_COLLATE</code>, <code>LC_ALL</code>, etc). For future reference, my current locale:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% locale
</span></span><span style=display:flex><span>LANG<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_COLLATE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_CTYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_MESSAGES<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_MONETARY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_NUMERIC<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_TIME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_ALL<span style=color:#f92672>=</span>
</span></span></code></pre></div><p>And my coworker’s:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ locale
</span></span><span style=display:flex><span>LANG<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LANGUAGE<span style=color:#f92672>=</span>en_US
</span></span><span style=display:flex><span>LC_CTYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_NUMERIC<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_TIME<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_COLLATE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_MONETARY<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_MESSAGES<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en_US.UTF-8&#34;</span>
</span></span><span style=display:flex><span>LC_PAPER<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_NAME<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_ADDRESS<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_TELEPHONE<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_MEASUREMENT<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_IDENTIFICATION<span style=color:#f92672>=</span>en_US.UTF-8
</span></span><span style=display:flex><span>LC_ALL<span style=color:#f92672>=</span>
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>In this case, the coworker’s version became the canonical one.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></content><p><a href=https://perrotta.dev/tags/dev/>#dev</a></p></main><footer><span>Copyright © 2021 - 2025 <a href=mailto:tbperrotta@gmail.com>Thiago Perrotta</a> · <a href=/index.xml>RSS</a> · a fork of <a href=https://github.com/janraasch/hugo-bearblog/>hugo ʕ•ᴥ•ʔ bear</a></span></footer></body></html>