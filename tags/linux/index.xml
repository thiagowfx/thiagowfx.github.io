<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Linux on ¬ just serendipity 🍀</title><link>https://perrotta.dev/tags/linux/</link><description>Recent content in Linux on ¬ just serendipity 🍀</description><generator>Hugo</generator><language>en-us</language><managingEditor>serendipity@perrotta.dev (Thiago Perrotta)</managingEditor><webMaster>serendipity@perrotta.dev (Thiago Perrotta)</webMaster><copyright>© 2021 - 2025 Thiago Perrotta ·
[some rights reserved](https://creativecommons.org/licenses/by-nc-sa/4.0/) ·
a fork of [hugo ʕ•ᴥ•ʔ bear](https://github.com/janraasch/hugo-bearblog/)</copyright><lastBuildDate>Sat, 24 May 2025 16:00:23 +0200</lastBuildDate><atom:link href="https://perrotta.dev/tags/linux/index.xml" rel="self" type="application/rss+xml"/><item><title>PostgreSQL major version upgrade on Alpine Linux</title><link>https://perrotta.dev/2025/05/postgresql-major-version-upgrade-on-alpine-linux/</link><pubDate>Sat, 24 May 2025 16:00:23 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/postgresql-major-version-upgrade-on-alpine-linux/</guid><description>&lt;h2 id="problem-statement">Problem statement&lt;/h2>
&lt;p>Given Alpine Linux 3.22 running PostgreSQL 16, upgrade to PostgreSQL 17. For
this specific example, consider a &lt;a href="https://miniflux.app/">&lt;code>miniflux&lt;/code>&lt;/a> database.&lt;/p>
&lt;h2 id="procedure">Procedure&lt;/h2>
&lt;p>Install PostgreSQL 17:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% doas apk add postgres
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It can coexist with &lt;code>postgres16&lt;/code>.&lt;/p>
&lt;p>Stop the PostgreSQL daemon:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% doas service postgresql stop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If you navigate to the Miniflux server with your browser, it will fail, as
expected:&lt;/p>
&lt;pre tabindex="0">&lt;code>store: unable to create app session: dial tcp [::1]:5432: connect: connection refused
&lt;/code>&lt;/pre>&lt;p>Change the PostgreSQL system version to the desired one:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% doas pg_versions set-default &lt;span style="color:#d19a66">17&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Change to the root user, for convenience, then change to the existing postgresql
directory:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% doas su
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% &lt;span style="color:#e5c07b">cd&lt;/span> /var/lib/postgresql/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Prepare files and directories for the upgrade:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% &lt;span style="color:#e5c07b">cd&lt;/span> 16/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% mv data olddata
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% &lt;span style="color:#e5c07b">cd&lt;/span> ../
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% mkdir 17/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% &lt;span style="color:#e5c07b">cd&lt;/span> 17/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% mkdir data tmp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% chown postgres:postgres data tmp
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Change to the &lt;code>postgres&lt;/code> user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% su postgres
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% &lt;span style="color:#e5c07b">cd&lt;/span> tmp/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Initialize the new cluster:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% initdb -D /var/lib/postgresql/17/data --locale&lt;span style="color:#56b6c2">=&lt;/span>en_US.UTF-8 --encoding&lt;span style="color:#56b6c2">=&lt;/span>UTF8 &lt;span style="color:#56b6c2">[&lt;/span>--data-checksums&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>The files belonging to this database system will be owned by user &lt;span style="color:#98c379">&amp;#34;postgres&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>This user must also own the server process.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>The database cluster will be initialized with locale &lt;span style="color:#98c379">&amp;#34;en_US.UTF-8&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>The default text search configuration will be &lt;span style="color:#e5c07b">set&lt;/span> to &lt;span style="color:#98c379">&amp;#34;english&amp;#34;&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Data page checksums are disabled.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>fixing permissions on existing directory /var/lib/postgresql/17/data ... ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>creating subdirectories ... ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>selecting dynamic shared memory implementation ... posix
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>selecting default &lt;span style="color:#98c379">&amp;#34;max_connections&amp;#34;&lt;/span> ... &lt;span style="color:#d19a66">100&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>selecting default &lt;span style="color:#98c379">&amp;#34;shared_buffers&amp;#34;&lt;/span> ... 128MB
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>selecting default &lt;span style="color:#e5c07b">time&lt;/span> zone ... America/Toronto
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>creating configuration files ... ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>running bootstrap script ... ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>performing post-bootstrap initialization ... ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>syncing data to disk ... ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>initdb: warning: enabling &lt;span style="color:#98c379">&amp;#34;trust&amp;#34;&lt;/span> authentication &lt;span style="color:#c678dd">for&lt;/span> &lt;span style="color:#e5c07b">local&lt;/span> connections
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>initdb: hint: You can change this by editing pg_hba.conf or using the option -A, or --auth-local and --auth-host, the next &lt;span style="color:#e5c07b">time&lt;/span> you run initdb.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Success.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In the previous command I chose to omit &lt;code>--data-checksums&lt;/code>, otherwise I get the
following error:&lt;/p>
&lt;pre tabindex="0">&lt;code>old cluster does not use data checksums but the new one does
Failure, exiting
&lt;/code>&lt;/pre>&lt;p>Upgrade the new cluster:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% pg_upgrade -b /usr/libexec/postgresql16/ -B /usr/libexec/postgresql17/ -d /var/lib/postgresql/16/olddata/ -D /var/lib/postgresql/17/data/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Performing Consistency Checks
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-----------------------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking cluster versions ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking database user is the install user ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking database connection settings ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking &lt;span style="color:#c678dd">for&lt;/span> prepared transactions ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking &lt;span style="color:#c678dd">for&lt;/span> contrib/isn with bigint-passing mismatch ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking data &lt;span style="color:#e5c07b">type&lt;/span> usage ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Creating dump of global objects ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Creating dump of database schemas
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking &lt;span style="color:#c678dd">for&lt;/span> presence of required libraries ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking database user is the install user ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking &lt;span style="color:#c678dd">for&lt;/span> prepared transactions ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking &lt;span style="color:#c678dd">for&lt;/span> new cluster tablespace directories ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>If pg_upgrade fails after this point, you must re-initdb the
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>new cluster before continuing.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Performing Upgrade
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>------------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Setting locale and encoding &lt;span style="color:#c678dd">for&lt;/span> new cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Analyzing all rows in the new cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Freezing all rows in the new cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Deleting files from new pg_xact ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Copying old pg_xact to new server ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Setting oldest XID &lt;span style="color:#c678dd">for&lt;/span> new cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Setting next transaction ID and epoch &lt;span style="color:#c678dd">for&lt;/span> new cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Deleting files from new pg_multixact/offsets ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Copying old pg_multixact/offsets to new server ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Deleting files from new pg_multixact/members ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Copying old pg_multixact/members to new server ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Setting next multixact ID and offset &lt;span style="color:#c678dd">for&lt;/span> new cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Resetting WAL archives ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Setting frozenxid and minmxid counters in new cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Restoring global objects in the new cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Restoring database schemas in the new cluster
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Copying user relation files
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Setting next OID &lt;span style="color:#c678dd">for&lt;/span> new cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Sync data directory to disk ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Creating script to delete old cluster ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Checking &lt;span style="color:#c678dd">for&lt;/span> extension updates ok
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Upgrade Complete
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>----------------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Optimizer statistics are not transferred by pg_upgrade.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Once you start the new server, consider running:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> /usr/libexec/postgresql17/vacuumdb --all --analyze-in-stages
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Running this script will delete the old cluster&amp;#39;s data files:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ./delete_old_cluster.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now clean up:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% ^D &lt;span style="color:#7f848e"># go back to the root user&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% /var/lib/postgresql/17/tmp/delete_old_cluster.sh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% rmdir /var/lib/postgresql/16/ &lt;span style="color:#7f848e"># it should be empty by now&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If you&amp;rsquo;re curious about this script, it&amp;rsquo;s a simple one-liner:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#!/bin/sh
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rm -rf &lt;span style="color:#98c379">&amp;#39;/var/lib/postgresql/16/olddata&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Finally, let&amp;rsquo;s get the cluster back up and vacuum it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% ^D &lt;span style="color:#7f848e"># go back to your main user&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% doas service postgresql start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% doas su - postgres -c &lt;span style="color:#98c379">&amp;#39;/usr/libexec/postgresql17/vacuumdb --all --analyze-in-stages&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vacuumdb: processing database &lt;span style="color:#98c379">&amp;#34;miniflux&amp;#34;&lt;/span>: Generating minimal optimizer statistics &lt;span style="color:#56b6c2">(&lt;/span>&lt;span style="color:#d19a66">1&lt;/span> target&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vacuumdb: processing database &lt;span style="color:#98c379">&amp;#34;postgres&amp;#34;&lt;/span>: Generating minimal optimizer statistics &lt;span style="color:#56b6c2">(&lt;/span>&lt;span style="color:#d19a66">1&lt;/span> target&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vacuumdb: processing database &lt;span style="color:#98c379">&amp;#34;template1&amp;#34;&lt;/span>: Generating minimal optimizer statistics &lt;span style="color:#56b6c2">(&lt;/span>&lt;span style="color:#d19a66">1&lt;/span> target&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vacuumdb: processing database &lt;span style="color:#98c379">&amp;#34;miniflux&amp;#34;&lt;/span>: Generating medium optimizer statistics &lt;span style="color:#56b6c2">(&lt;/span>&lt;span style="color:#d19a66">10&lt;/span> targets&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vacuumdb: processing database &lt;span style="color:#98c379">&amp;#34;postgres&amp;#34;&lt;/span>: Generating medium optimizer statistics &lt;span style="color:#56b6c2">(&lt;/span>&lt;span style="color:#d19a66">10&lt;/span> targets&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vacuumdb: processing database &lt;span style="color:#98c379">&amp;#34;template1&amp;#34;&lt;/span>: Generating medium optimizer statistics &lt;span style="color:#56b6c2">(&lt;/span>&lt;span style="color:#d19a66">10&lt;/span> targets&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vacuumdb: processing database &lt;span style="color:#98c379">&amp;#34;miniflux&amp;#34;&lt;/span>: Generating default &lt;span style="color:#56b6c2">(&lt;/span>full&lt;span style="color:#56b6c2">)&lt;/span> optimizer statistics
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vacuumdb: processing database &lt;span style="color:#98c379">&amp;#34;postgres&amp;#34;&lt;/span>: Generating default &lt;span style="color:#56b6c2">(&lt;/span>full&lt;span style="color:#56b6c2">)&lt;/span> optimizer statistics
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vacuumdb: processing database &lt;span style="color:#98c379">&amp;#34;template1&amp;#34;&lt;/span>: Generating default &lt;span style="color:#56b6c2">(&lt;/span>full&lt;span style="color:#56b6c2">)&lt;/span> optimizer statistics
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>At this point, Miniflux should be working again.
Navigate to &lt;code>/about&lt;/code> and verify its database version: &lt;code>Postgres version: 17.5&lt;/code>.&lt;/p>
&lt;p>Last step, delete the previous package:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% doas apk del postgresql16 postgres16-contrib
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Double-check the newer version is still installed:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% apk list -I | grep postgres
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>libpq-17.5-r0 x86_64 &lt;span style="color:#56b6c2">{&lt;/span>postgresql17&lt;span style="color:#56b6c2">}&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>PostgreSQL&lt;span style="color:#56b6c2">)&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span>installed&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>postgresql-common-1.2-r1 x86_64 &lt;span style="color:#56b6c2">{&lt;/span>postgresql-common&lt;span style="color:#56b6c2">}&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>MIT&lt;span style="color:#56b6c2">)&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span>installed&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>postgresql-common-openrc-1.2-r1 x86_64 &lt;span style="color:#56b6c2">{&lt;/span>postgresql-common&lt;span style="color:#56b6c2">}&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>MIT&lt;span style="color:#56b6c2">)&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span>installed&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>postgresql-zsh-completion-5.9-r5 x86_64 &lt;span style="color:#56b6c2">{&lt;/span>zsh&lt;span style="color:#56b6c2">}&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>MIT-Modern-Variant AND GPL-2.0-only&lt;span style="color:#56b6c2">)&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span>installed&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>postgresql17-17.5-r0 x86_64 &lt;span style="color:#56b6c2">{&lt;/span>postgresql17&lt;span style="color:#56b6c2">}&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>PostgreSQL&lt;span style="color:#56b6c2">)&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span>installed&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>postgresql17-client-17.5-r0 x86_64 &lt;span style="color:#56b6c2">{&lt;/span>postgresql17&lt;span style="color:#56b6c2">}&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>PostgreSQL&lt;span style="color:#56b6c2">)&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span>installed&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>postgresql17-contrib-17.5-r0 x86_64 &lt;span style="color:#56b6c2">{&lt;/span>postgresql17&lt;span style="color:#56b6c2">}&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>PostgreSQL&lt;span style="color:#56b6c2">)&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span>installed&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>postgresql17-openrc-17.5-r0 x86_64 &lt;span style="color:#56b6c2">{&lt;/span>postgresql17&lt;span style="color:#56b6c2">}&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>PostgreSQL&lt;span style="color:#56b6c2">)&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span>installed&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And we&amp;rsquo;re done!&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://wiki.alpinelinux.org/wiki/Postgresql">https://wiki.alpinelinux.org/wiki/Postgresql&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://beune.dev/posts/upgrade-alpine-postgresql/">https://beune.dev/posts/upgrade-alpine-postgresql/&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Tailspin</title><link>https://perrotta.dev/2025/05/tailspin/</link><pubDate>Sat, 24 May 2025 15:17:27 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/tailspin/</guid><description>&lt;p>&lt;a href="https://github.com/bensadeh/tailspin">tailspin&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>tailspin&lt;/code> works by reading through a log file line by line, running a series
of regexes against each line. The regexes recognize patterns you expect to
find in a logfile, like dates, numbers, severity keywords and more.&lt;/p>
&lt;p>&lt;code>tailspin&lt;/code> does not make any assumptions on the format or position of the
items it wants to highlight. For this reason, it requires no configuration and
the highlighting will work consistently across different logfiles.&lt;/p>
&lt;/blockquote>
&lt;p>The binary name is &lt;code>tspin(1)&lt;/code>, not &lt;code>tailspin(1)&lt;/code> (confusing!). MacOS has an
existing &lt;code>/usr/bin/tailspin&lt;/code> binary, which appears to be kernel-related.&lt;/p>
&lt;p>It supports &lt;code>-f&lt;/code> (&lt;code>--follow&lt;/code>), just like &lt;code>tail(1)&lt;/code>. In fact, you can think of
&lt;code>tspin -f&lt;/code> as a drop-in replacement for &lt;code>tail -f&lt;/code>.&lt;/p>
&lt;p>It is available in &lt;a href="https://repology.org/project/tailspin/versions">most package
managers&lt;/a>.&lt;/p>
&lt;p>It supports custom highlight rules (groups) via a &lt;code>~/.config/tailspin&lt;/code> file.&lt;/p>
&lt;p>Usage:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># against a log file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% tspin -f /var/log/system.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># against a command&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% kubectl logs mypod -n myns -f | tspin
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># built-in highlighters showcase&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% &lt;span style="color:#e5c07b">echo&lt;/span> &lt;span style="color:#98c379">&amp;#34;2025-01-01 hello null true false 42 https://example.com?param1=foo&amp;amp;param2=bar ERROR WARNING WARN INFO 127.0.0.1 /etc/passwd foo=&amp;#39;bar&amp;#39;&amp;#34;&lt;/span> | tspin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It&amp;rsquo;s possible to add one-off highlighters from the command line (note: case
sensitive).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% tspin --highlight&lt;span style="color:#56b6c2">=&lt;/span>red:err,error,fail --highlight&lt;span style="color:#56b6c2">=&lt;/span>green:success,ok
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>watch with --color</title><link>https://perrotta.dev/2025/05/watch-with--color/</link><pubDate>Sat, 24 May 2025 14:40:07 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/watch-with--color/</guid><description>&lt;p>When using &lt;code>watch(1)&lt;/code> to monitor program output, colors will not be emitted by
default.&lt;/p>
&lt;p>Thankfully &lt;a href="https://man.archlinux.org/man/watch.1">&lt;code>watch(1)&lt;/code>&lt;/a> has a &lt;code>--color&lt;/code>
(or &lt;code>-c&lt;/code> flag).&lt;/p>
&lt;p>Still, when using it with e.g. &lt;a href="https://nodejs.org/api/test.html">&lt;code>node&lt;/code> tests&lt;/a>,
colors are not emitted:&lt;/p>
&lt;pre tabindex="0">&lt;code>% watch --color -- node mytest.js
Every 2.0s: node ex5.js MacBookAir: 14:43:06
 in 0.107s (0)
✔ toWasm (0.865792ms)
ℹ tests 1
ℹ suites 0
ℹ pass 1
ℹ fail 0
ℹ cancelled 0
ℹ skipped 0
ℹ todo 0
ℹ duration_ms 3.8805
&lt;/code>&lt;/pre>&lt;p>The command detects that it&amp;rsquo;s not attached to the terminal. :(&lt;/p>
&lt;p>How can we &lt;strong>force color output&lt;/strong> in this case?&lt;/p>
&lt;p>There&amp;rsquo;s no universal answer:&lt;/p>
&lt;ul>
&lt;li>Set &lt;a href="https://bixense.com/clicolors/">&lt;code>CLICOLOR=1&lt;/code>, &lt;code>CLICOLOR_FORCE=1&lt;/code>&lt;/a>&lt;/li>
&lt;li>See whether the program has a &lt;code>--color&lt;/code> flag. For example:
&lt;a href="https://git-scm.com/book/sv/v2/Customizing-Git-Git-Configuration">&lt;code>git&lt;/code>&lt;/a> and
&lt;a href="https://superuser.com/questions/665274/how-to-make-ls-color-its-output-by-default-without-setting-up-an-alias">&lt;code>ls&lt;/code>&lt;/a>
both support &lt;code>--color=always&lt;/code>.&lt;/li>
&lt;/ul>
&lt;p>Another possibility, which is program agnostic, is to use an utility such as
&lt;a href="https://man.archlinux.org/man/unbuffer.1">&lt;code>unbuffer(1)&lt;/code>&lt;/a> from the &lt;a href="https://wiki.tcl-lang.org/page/Expect">TCL
Expect&lt;/a> package:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% watch --color -- unbuffer node mytest.js
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>unbuffer&lt;/code> solution is my favorite.&lt;/p>
&lt;p>&lt;strong>Reference&lt;/strong>: &lt;a href="https://stackoverflow.com/questions/3793126/colors-with-unix-command-watch">Stack
Overflow&lt;/a>.&lt;/p></description></item><item><title>WebAssembly: hello world</title><link>https://perrotta.dev/2025/05/webassembly-hello-world/</link><pubDate>Sat, 24 May 2025 10:39:13 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/webassembly-hello-world/</guid><description>&lt;p>Today I am attending a WebAssembly workshop.&lt;/p>
&lt;p>&lt;a href="https://webassembly.org/">WebAssembly&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>WebAssembly (abbreviated &lt;em>Wasm&lt;/em>) is a binary instruction format for a
stack-based virtual machine. Wasm is designed as a portable compilation target
for programming languages, enabling deployment on the web for client and
server applications.&lt;/p>
&lt;/blockquote>
&lt;p>Given &lt;code>add.wat&lt;/code>:&lt;/p>
&lt;pre tabindex="0">&lt;code>(module
 ;; stack/forth syntax
 ;; looks like vanilla assembly
 (func $add (param $a i32) (param $b i32) (result i32)
 local.get $a
 local.get $b
 i32.add
 )

 ;; nested/lisp syntax
 ;; functional, parentheses hell
 (func $add-alt (param $a i32) (param $b i32) (result i32)
 (i32.add
 (local.get $a)
 (local.get $b))
 )

 (export &amp;#34;add&amp;#34; (func $add))
 (export &amp;#34;addAlt&amp;#34; (func $add-alt))
)
&lt;/code>&lt;/pre>&lt;p>&amp;hellip;it adds two integers.
There are two implementations, they are equivalent.&lt;/p>
&lt;p>Install dependencies:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% brew install wabt wasm-tools
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We can compile &lt;code>.wat&lt;/code> to &lt;code>.wasm&lt;/code> with one of:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% wat2wasm add.wat
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% wasm-tools parse add.wat -o add.wasm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now how do we consume it? Create a &lt;code>test.js&lt;/code> file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">import&lt;/span> &lt;span style="color:#e06c75">test&lt;/span> &lt;span style="color:#e06c75">from&lt;/span> &lt;span style="color:#98c379">&amp;#34;node:test&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">import&lt;/span> &lt;span style="color:#e06c75">assert&lt;/span> &lt;span style="color:#e06c75">from&lt;/span> &lt;span style="color:#98c379">&amp;#34;node:assert&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">import&lt;/span> &lt;span style="color:#e06c75">fs&lt;/span> &lt;span style="color:#e06c75">from&lt;/span> &lt;span style="color:#98c379">&amp;#34;node:fs/promises&amp;#34;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">test&lt;/span>(&lt;span style="color:#98c379">&amp;#34;Instantiate add.wasm and call exported functions&amp;#34;&lt;/span>, &lt;span style="color:#c678dd">async&lt;/span> () =&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">const&lt;/span> &lt;span style="color:#e06c75">bytes&lt;/span> &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#c678dd">await&lt;/span> &lt;span style="color:#e06c75">fs&lt;/span>.&lt;span style="color:#e06c75">readFile&lt;/span>(&lt;span style="color:#98c379">&amp;#34;add.wasm&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">const&lt;/span> {&lt;span style="color:#e06c75">instance&lt;/span>} &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#c678dd">await&lt;/span> &lt;span style="color:#e06c75">WebAssembly&lt;/span>.&lt;span style="color:#e06c75">instantiate&lt;/span>(&lt;span style="color:#e06c75">bytes&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">const&lt;/span> {&lt;span style="color:#e06c75">add&lt;/span>, &lt;span style="color:#e06c75">addAlt&lt;/span>} &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#e06c75">instance&lt;/span>.&lt;span style="color:#e06c75">exports&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">assert&lt;/span>.&lt;span style="color:#e06c75">equal&lt;/span>(&lt;span style="color:#e06c75">add&lt;/span>(&lt;span style="color:#d19a66">1&lt;/span>, &lt;span style="color:#d19a66">4&lt;/span>), &lt;span style="color:#d19a66">5&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">assert&lt;/span>.&lt;span style="color:#e06c75">equal&lt;/span>(&lt;span style="color:#e06c75">addAlt&lt;/span>(&lt;span style="color:#d19a66">10&lt;/span>, &lt;span style="color:#d19a66">40&lt;/span>), &lt;span style="color:#d19a66">50&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>});
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute it with &lt;code>node&lt;/code> (&lt;code>brew install node&lt;/code>):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% node ex0.js
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>✔ Instantiate add.wasm and call exported functions &lt;span style="color:#56b6c2">(&lt;/span>4.1875ms&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ℹ tests &lt;span style="color:#d19a66">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ℹ suites &lt;span style="color:#d19a66">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ℹ pass &lt;span style="color:#d19a66">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ℹ fail &lt;span style="color:#d19a66">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ℹ cancelled &lt;span style="color:#d19a66">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ℹ skipped &lt;span style="color:#d19a66">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ℹ todo &lt;span style="color:#d19a66">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ℹ duration_ms 7.125625
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Explanation:&lt;/p>
&lt;ul>
&lt;li>&lt;code>bytes&lt;/code> reads the &lt;code>.wasm&lt;/code> file, nothing special&lt;/li>
&lt;li>&lt;a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Reference/JavaScript_interface/instantiate_static">&lt;code>WebAssembly.instantiate&lt;/code>&lt;/a>:
compile and instantiate WebAssembly code&lt;/li>
&lt;li>access its
&lt;a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Reference/JavaScript_interface/Module/exports_static">&lt;code>exports&lt;/code>&lt;/a>
field&lt;/li>
&lt;/ul>
&lt;h2 id="references">References&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://wasmgroundup.com/">WebAssembly from the Ground up&lt;/a> by Mariano Guerra
&amp;amp; Patrick Dubroy
&lt;ul>
&lt;li>&lt;a href="https://wasmgroundup.com/workshop/">Workshop&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="https://www.w3.org/TR/2019/REC-wasm-core-1-20191205/">WebAssembly Core
Specification&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>bash: set a trap to log errors</title><link>https://perrotta.dev/2025/05/bash-set-a-trap-to-log-errors/</link><pubDate>Thu, 22 May 2025 13:41:43 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/bash-set-a-trap-to-log-errors/</guid><description>&lt;p>Create &lt;code>main.sh&lt;/code> and mark it as executable (&lt;code>chmod +x&lt;/code>):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#!/usr/bin/env bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">&lt;/span>&lt;span style="color:#e5c07b">set&lt;/span> -euo pipefail
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Set a trap to handle errors and log them.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">trap&lt;/span> &lt;span style="color:#98c379">&amp;#39;echo &amp;#34;Error occurred at line $LINENO. Command: $BASH_COMMAND&amp;#34;&amp;#39;&lt;/span> ERR
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now execute it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% ./main.sh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Error occurred at line 7. Command: &lt;span style="color:#e5c07b">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This pattern is useful to debug failing (non-zero exit code) shell scripts.&lt;/p></description></item><item><title>kubernetes: list pending pods in daemonset</title><link>https://perrotta.dev/2025/05/kubernetes-list-pending-pods-in-daemonset/</link><pubDate>Tue, 20 May 2025 16:41:00 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/kubernetes-list-pending-pods-in-daemonset/</guid><description>&lt;p>&lt;strong>Problem statement&lt;/strong>: Given a DaemonSet with a couple of pods stuck in
&amp;ldquo;Pending&amp;rdquo; state during their rollout, find out which nodes did not yet complete
the pod initialization.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% kubectl get nodes -o name | grep -vFf &amp;lt;&lt;span style="color:#56b6c2">(&lt;/span>kubectl get pods -n &lt;span style="color:#56b6c2">{&lt;/span>namespace&lt;span style="color:#56b6c2">}&lt;/span> -l &lt;span style="color:#56b6c2">{&lt;/span>ds-label-selector&lt;span style="color:#56b6c2">}&lt;/span> -o wide --no-headers | awk &lt;span style="color:#98c379">&amp;#39;{print &amp;#34;node/&amp;#34; $7}&amp;#39;&lt;/span>&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>node/aks-database-12345678-vmss000000
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>node/aks-database-12345678-vmss000002
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>node/aks-systempool-87654321-vmss000000
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>node/aks-systempool-87654321-vmss000001
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Notes:&lt;/p>
&lt;ul>
&lt;li>&lt;code>kubectl get nodes -o name&lt;/code>: list all node names in the &lt;code>node/&amp;lt;name&amp;gt;&lt;/code> form&lt;/li>
&lt;li>&lt;code>kubectl get pods [...] -o wide&lt;/code>: get the node name for each running DaemonSet pod&lt;/li>
&lt;li>&lt;code>awk '{print &amp;quot;node/&amp;quot; $7}'&lt;/code>: get the node name matching the output of &lt;code>get nodes&lt;/code>&lt;/li>
&lt;li>&lt;code>grep [...]&lt;/code>: find the nodes we are looking for&lt;/li>
&lt;/ul>
&lt;p>Surely there must be an easier way to accomplish this?&lt;/p></description></item><item><title>ack with context</title><link>https://perrotta.dev/2025/05/ack-with-context/</link><pubDate>Mon, 19 May 2025 14:12:35 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/ack-with-context/</guid><description>&lt;p>I often use &lt;a href="https://beyondgrep.com/">&lt;code>ack(1)&lt;/code>&lt;/a> to &lt;code>grep&lt;/code> for text patterns in git
repositories&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>.&lt;/p>
&lt;p>Today I learned about its &lt;a href="https://linux.die.net/man/1/ack">&lt;code>-C&lt;/code>&lt;/a> flag:&lt;/p>
&lt;pre tabindex="0">&lt;code>-C [ NUM ], --context[= NUM ]
 Print NUM lines (default 2) of context around matching lines.
&lt;/code>&lt;/pre>&lt;p>It&amp;rsquo;s a handy shortcut, better than fiddling with &lt;code>-A&lt;/code> and &lt;code>-B&lt;/code> (after and
before, respectively).&lt;/p>
&lt;p>&lt;strong>Bonus&lt;/strong>: the same flag exists in &lt;code>grep&lt;/code> and in &lt;code>rg&lt;/code> (&lt;code>ripgrep&lt;/code>).&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>I should probably fully migrate to
&lt;a href="https://github.com/BurntSushi/ripgrep">&lt;code>ripgrep&lt;/code>&lt;/a> one day. Heck, it&amp;rsquo;s not
even in the &lt;a href="https://aur.archlinux.org/packages/ack">Arch core repositories&lt;/a>
anymore.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>fpp: facebook path picker</title><link>https://perrotta.dev/2025/05/fpp-facebook-path-picker/</link><pubDate>Sun, 18 May 2025 18:34:19 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/fpp-facebook-path-picker/</guid><description>&lt;p>&lt;a href="https://github.com/facebook/PathPicker">&lt;code>fpp&lt;/code>&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>PathPicker accepts a wide range of input &amp;ndash; output from git commands, grep
results, searches &amp;ndash; pretty much anything. After parsing the input, PathPicker
presents you with a nice UI to select which files you&amp;rsquo;re interested in. After
that you can open them in your favorite editor or execute arbitrary commands.&lt;/p>
&lt;/blockquote>
&lt;p>Think of &lt;code>fpp&lt;/code> as the result of parsing file-looking paths in &lt;code>stdout&lt;/code> and
injecting them into &lt;a href="https://github.com/junegunn/fzf">&lt;code>fzf&lt;/code>&lt;/a>.&lt;/p>
&lt;p>It&amp;rsquo;s part of my daily tool belt.&lt;/p>
&lt;p>Sadly, the project is &lt;a href="https://github.com/facebook/PathPicker/commits/main/">somewhat
abandoned&lt;/a> since 2022.
Nonetheless, it doesn&amp;rsquo;t need any new features: &lt;a href="https://en.wikipedia.org/wiki/Unix_philosophy">it does one thing and does it
well&lt;/a>.&lt;/p>
&lt;p>Its latest released version is
&lt;a href="https://github.com/facebook/PathPicker/releases/tag/0.9.5">0.9.5&lt;/a>. Ironically,
due to a bug, there is a mismatch in &lt;code>--version&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% fpp --version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>fpp version 0.9.2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>A few usage examples:&lt;/p>
&lt;ul>
&lt;li>&lt;code>git st | fpp&lt;/code>: modified files in a git repository&lt;/li>
&lt;li>&lt;code>fd -e ts --type file | fpp&lt;/code>: files with a given extension&lt;/li>
&lt;li>&lt;code>ack -l {pattern} | fpp&lt;/code>: files that match a given pattern&lt;/li>
&lt;/ul>
&lt;p>To continuously edit files in a loop, use &lt;code>fpp -ko&lt;/code> (&lt;code>ko&lt;/code> stands for
&lt;code>--keep-open&lt;/code>).&lt;/p></description></item><item><title>Espanso: hello world</title><link>https://perrotta.dev/2025/05/espanso-hello-world/</link><pubDate>Fri, 16 May 2025 17:40:26 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/espanso-hello-world/</guid><description>&lt;p>&lt;a href="https://perrotta.dev/2025/03/maccy-pin-items/">Previously&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>Sometimes it&amp;rsquo;s useful to have certain code snippets be easily accessible from
the clipboard manager.&lt;/p>
&lt;p>[&amp;hellip;]&lt;/p>
&lt;p>This workflow is decent for temporary entries. For semi-permanent ones, I
should look into &lt;a href="https://espanso.org/">Espanso&lt;/a> at some point. For now,
&lt;a href="https://perrotta.dev/2025/01/raycast-snippets/">Raycast Snippets&lt;/a> fills in this
role.&lt;/p>
&lt;/blockquote>
&lt;p>Today is the day!&lt;/p>
&lt;p>&lt;a href="https://espanso.org/">Espanso&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>Supercharge your typing| experience.&lt;/p>
&lt;p>Tired of typing the same sentences over and over? Discover the incredible
power of a full-blown text expander.&lt;/p>
&lt;/blockquote>
&lt;p>So?&lt;/p>
&lt;blockquote>
&lt;p>How it works&lt;/p>
&lt;p>Espanso detects when you type a keyword&lt;/p>
&lt;p>Today is :date&lt;/p>
&lt;p>(becomes) Today is 05/16/2025&lt;/p>
&lt;p>and replaces it while you&amp;rsquo;re typing.&lt;/p>
&lt;/blockquote>
&lt;p>It&amp;rsquo;s just like &lt;a href="https://www.raycast.com/core-features/snippets">Text Expander&lt;/a>
from Raycast snippets.&lt;/p>
&lt;p>It&amp;rsquo;s available on all major OSes (Windows, Linux, macOS). I am testing it on
macOS. Installation:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% brew install espanso
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>After installing it and opening it, give it all sorts of System Accessibility
permissions so that it can perform its magic.&lt;/p>
&lt;p>This is just a &amp;ldquo;hello world&amp;rdquo; post, therefore I am not going to list every single
capability it has. Let&amp;rsquo;s just keep it simple and get our feet wet.&lt;/p>
&lt;p>I have to type &lt;code>helm ls -A --max 9999 | grep -i {release}&lt;/code> &lt;a href="https://perrotta.dev/2024/08/helm-list-all-installed-charts-in-the-cluster/">all the time&lt;/a>, and I&amp;rsquo;m fed
up with it.&lt;/p>
&lt;p>I want to create a &lt;code>:helm:ls&lt;/code> expansion that will trigger that command
expansion.&lt;/p>
&lt;p>Run &lt;code>espanso edit&lt;/code>. It opens a stock &lt;code>base.yml&lt;/code> file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># espanso match file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># For a complete introduction, visit the official docs at: https://espanso.org/docs/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># You can use this file to define the base matches (aka snippets)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># that will be available in every application when using espanso.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Matches are substitution rules: when you type the &amp;#34;trigger&amp;#34; string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># it gets replaced by the &amp;#34;replace&amp;#34; string.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">matches&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#7f848e"># Simple text replacement&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e06c75">trigger&lt;/span>: &lt;span style="color:#98c379">&amp;#34;:espanso&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">replace&lt;/span>: &lt;span style="color:#98c379">&amp;#34;Hi there!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#7f848e"># NOTE: espanso uses YAML to define matches, so pay attention to the indentation!&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#7f848e"># But matches can also be dynamic:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#7f848e"># Print the current date&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e06c75">trigger&lt;/span>: &lt;span style="color:#98c379">&amp;#34;:date&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">replace&lt;/span>: &lt;span style="color:#98c379">&amp;#34;{{mydate}}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">vars&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e06c75">name&lt;/span>: mydate
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">type&lt;/span>: date
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">params&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">format&lt;/span>: &lt;span style="color:#98c379">&amp;#34;%m/%d/%Y&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#7f848e"># Print the output of a shell command&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e06c75">trigger&lt;/span>: &lt;span style="color:#98c379">&amp;#34;:shell&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">replace&lt;/span>: &lt;span style="color:#98c379">&amp;#34;{{output}}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">vars&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e06c75">name&lt;/span>: output
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">type&lt;/span>: shell
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">params&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">cmd&lt;/span>: &lt;span style="color:#98c379">&amp;#34;echo &amp;#39;Hello from your shell&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#7f848e"># And much more! For more information, visit the docs: https://espanso.org/docs/&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The file is self-contained and well-documented enough that I do not need to look
up any docs nor use AI to add the desired entry:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># [...]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">matches&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#7f848e"># [...]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e06c75">trigger&lt;/span>: &lt;span style="color:#98c379">&amp;#34;:helm:ls&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">replace&lt;/span>: &lt;span style="color:#98c379">&amp;#34;helm ls --max 9999 -A | grep -i&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once the file is saved, it&amp;rsquo;s magic ✨, and it takes effect immediately.&lt;/p>
&lt;p>Example usage&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>:helm:ls redis
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip;becomes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>helm ls --max &lt;span style="color:#d19a66">9999&lt;/span> -A | grep -i redis
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>For reference, this is the full path to the file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% espanso edit
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Editing file: /Users/thiago.perrotta/Library/Application Support/espanso/match/base.yml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>I am particularly excited it&amp;rsquo;s YAML and it&amp;rsquo;s accessible in a stable location: it
should be quite easy to integrate it with my dotfiles later on.&lt;/p>
&lt;p>Its out-of-the-box usability (for developers who prefer text files) and
perceived speed are better than Raycast snippets.&lt;/p>
&lt;p>There are so many possibilities to explore: command &lt;del>espansions&lt;/del> expansions, LLM prompts,
email greetings, canned responses, and so on.&lt;/p>
&lt;p>For Raycast snippets I was using &lt;code>@@&lt;/code> as a prefix. Espanso seems to recommend
&lt;code>:&lt;/code>. Let&amp;rsquo;s see which one I will stick to.&lt;/p>
&lt;p>Also, I&amp;rsquo;d like to thank Farzad for the recommendation via email. It wasn&amp;rsquo;t the
first time I had heard about Espanso, but it has reinforced my desire to try it
out.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>In order to type a plain &lt;code>:helm:ls&lt;/code> without expansion (e.g. for this blog
post), type the folowing: &lt;code>:helm:l{left arrow}{right arrow}s&lt;/code>.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Nostalgia: The Linux Setup - Thiago Perrotta, Student</title><link>https://perrotta.dev/2025/05/nostalgia-the-linux-setup-thiago-perrotta-student/</link><pubDate>Thu, 15 May 2025 22:43:17 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/nostalgia-the-linux-setup-thiago-perrotta-student/</guid><description>&lt;p>Back in the (g)old(en) days&amp;hellip;in October 2014 I gave an interview to the blog
&amp;ldquo;Linux Rig&amp;rdquo; by &lt;a href="https://steven.ovadia.org/">Steven Ovadia&lt;/a>.&lt;/p>
&lt;p>The original interview was published at
&lt;code>https://linuxrig.com/2015/01/20/the-linux-setup-thiago-perrotta-student/&lt;/code>, but
the link no longer works. It&amp;rsquo;s purposely not hyperlinked because now it&amp;rsquo;s a
&lt;a href="https://en.wikipedia.org/wiki/Domain_parking">parked domain&lt;/a>.&lt;/p>
&lt;p>You can find the original at the &lt;a href="https://web.archive.org/web/20180527155224/https://linuxrig.com/2015/01/20/the-linux-setup-thiago-perrotta-student/">Web
Archive&lt;/a>.
I wanted to reproduce it here&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> for archiving purposes. All credits go to Steven
:)&lt;/p>
&lt;hr>
&lt;h2 id="the-linux-setup--thiago-perrotta-student">The Linux Setup – Thiago Perrotta, Student&lt;/h2>
&lt;p>Steven Ovadia – January 20th, 2015 – 0 Comments&lt;/p>
&lt;p>&lt;em>Thiago touches on a number of interesting points. For instance, he talks about
testing out new distributions and desktops to see what&amp;rsquo;s going on in Linux.
That&amp;rsquo;s something I kind of have to remind myself to do. Everything works well on
my main workhorse (knock wood…) so I have no natural desire to try out other
distributions and desktops. But I try and remember to give different things a
spin, just so I know if there&amp;rsquo;s something better out there, or if there&amp;rsquo;s
something I should steal for my own system. Finally, Thiago pays respect to his
package manager, which is super classy. Package managers are the unsung heroes
of most setups and without them, we&amp;rsquo;d probably have a rougher time trying new
things out.&lt;/em>&lt;/p>
&lt;p>&lt;em>You can find more of The Linux Setup here.&lt;/em>&lt;/p>
&lt;p>&lt;em>You can follow Linux Rig on Google+ here and follow me on Twitter here.&lt;/em>&lt;/p>
&lt;p>&lt;strong>1. Who are you, and what do you do?&lt;/strong>&lt;/p>
&lt;p>I am a Computer and Information Engineering student living in Rio de Janeiro,
Brazil. I usually use the &amp;rsquo;thiagowfx&amp;rsquo; nickname and I&amp;rsquo;d say I am a
free/open source software and community enthusiast. In particular, today I am an
active member of the Arch Linux community. I also have a blog where I write
about projects I&amp;rsquo;m currently working on and new technology and software I&amp;rsquo;m
trying out.&lt;/p>
&lt;p>&lt;strong>2. Why do you use Linux?&lt;/strong>&lt;/p>
&lt;p>Questions we are passionate about are the hardest to answer. But hey, today I&amp;rsquo;d say I use Linux for at least for three reasons (not in any particular order):&lt;/p>
&lt;ul>
&lt;li>community: it is very hard to find a diverse and rich community such as the
GNU/Linux one;&lt;/li>
&lt;li>open source software: this is very important and includes implications on
philosophy and programming (e.g., pull requests);&lt;/li>
&lt;li>package managers!&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>3. What distribution do you run on your main desktop/laptop?&lt;/strong>&lt;/p>
&lt;p>For a long time, on a monthly basis, I was always switching distributions.
However, during the last year I discovered the one I most enjoy today: Arch
Linux. It is a very customizable, follows KISS (&amp;lsquo;Keep it Short &amp;amp; Simple&amp;rsquo;) and is
a user-centered distro, with a very nice and intelligent community. I still test
the latest improvements of other Linux distributions every now and then, even
though this is less frequent today.&lt;/p>
&lt;p>&lt;strong>4. What desktop environment do you use and why do you use it?&lt;/strong>&lt;/p>
&lt;p>I am always switching desktop environments, mainly because I like to keep up to
date with the latest improvements on the Linux desktop (as with distros).
However, I&amp;rsquo;d say the two I use and like most are Cinnamon and i3. Usually I use
Cinnamon at home and i3 elsewhere (when I don&amp;rsquo;t have a mouse with me).&lt;/p>
&lt;p>&lt;strong>5. What one piece of software do you depend upon with this distribution? Why is it so important?&lt;/strong>&lt;/p>
&lt;p>Package manager: it is the piece of software I most value. I don&amp;rsquo;t know how to
live without one anymore. In particular, pacman is my preferred one. Now, if you
were referring to end-user software, I have no doubt that Emacs is the software
I most use today, although I am giving Vim a try. However, I&amp;rsquo;m not dependent of
any software in particular; each task has its own needs.&lt;/p>
&lt;p>&lt;strong>6. What kind of hardware do you run this setup on?&lt;/strong>&lt;/p>
&lt;p>Currently I have a Lenovo Ideapad S400U Ultrabook, which has an Intel Core i5
processor, 4GB RAM and an Intel Graphics HD 4000 graphics card. It
supports Linux pretty well and out-of-the-box with Intel open source drivers. It
has a small SSD (32GB) where I keep the root partition of whichever Linux
distribution I&amp;rsquo;m using at the moment, and a 500GB HDD where I keep my /home and
an alternate Linux distro.&lt;/p>
&lt;p>&lt;strong>7. Will you share a screenshot of your desktop?&lt;/strong>&lt;/p>
&lt;p>As I&amp;rsquo;ve said, I&amp;rsquo;m always switching desktop environments. However, I keep an
album on Flickr with my latest screenshots. This is the last one I
took, on Arch Linux, with KDE 4.14.&lt;/p>
&lt;p>&lt;em>Interview conducted October 5, 2014&lt;/em>&lt;/p>
&lt;hr>
&lt;p>&lt;em>&lt;strong>The Linux Setup&lt;/strong> is a feature where I interview people about their Linux
setups. The concept is borrowed, if not outright stolen, from this site. If
you&amp;rsquo;d like to participate, drop me a line.&lt;/em>&lt;/p>
&lt;p>&lt;em>You can follow Linux Rig on Google+ here, follow me on Twitter here, and subscribe to the feed here.&lt;/em>&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>The reproduction was done verbatim, with the exception of hyperlinks.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>VSCode: Github Pull Requests plug-in: collapse all comments by default</title><link>https://perrotta.dev/2025/05/vscode-github-pull-requests-plug-in-collapse-all-comments-by-default/</link><pubDate>Wed, 14 May 2025 14:40:34 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/vscode-github-pull-requests-plug-in-collapse-all-comments-by-default/</guid><description>&lt;p>&lt;strong>Problem statement&lt;/strong>: I am constantly annoyed at opening files in VSCode with
PR comments being automatically expanded by default and occupying precious real
estate. Get rid of these comments!&lt;/p>
&lt;p>&lt;a href="https://github.com/Microsoft/vscode-pull-request-github/issues/665">Github
issue&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>From your user settings with &lt;code>&amp;quot;githubPullRequests.commentExpandState&amp;quot;&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>I added the following to my &lt;code>settings.json&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">&amp;#34;githubPullRequests.commentExpandState&amp;#34;&lt;/span>: &lt;span style="color:#98c379">&amp;#34;collapseAll&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Do you like to live in danger?</title><link>https://perrotta.dev/2025/05/do-you-like-to-live-in-danger/</link><pubDate>Mon, 05 May 2025 18:11:23 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/05/do-you-like-to-live-in-danger/</guid><description>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% claude --dangerously-skip-permissions &lt;span style="color:#98c379">&amp;#34;fix the zizmor issue: pre-commit run --all-files zizmor&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ WARNING: Claude Code running in Bypass Permissions mode │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ In Bypass Permissions mode, Claude Code will not ask &lt;span style="color:#c678dd">for&lt;/span> your approval before running potentially dangerous commands. │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ This mode should only be used in a sandboxed container/VM that has restricted internet access and can easily be restored &lt;span style="color:#c678dd">if&lt;/span> damaged. │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ By proceeding, you accept all responsibility &lt;span style="color:#c678dd">for&lt;/span> actions taken &lt;span style="color:#c678dd">while&lt;/span> running in Bypass Permissions mode. │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ https://docs.anthropic.com/s/claude-code-security │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ ❯ 1. No, &lt;span style="color:#e5c07b">exit&lt;/span> │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ 2. Yes, I accept │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ │
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Enter to confirm · Esc to &lt;span style="color:#e5c07b">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">[&lt;/span>...&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>⏺ Great! The zizmor pre-commit check now passes. Let&amp;#39;s summarize the changes we made:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 1. Removed user-provided inputs &lt;span style="color:#c678dd">for&lt;/span> version numbers that could potentially be used &lt;span style="color:#c678dd">for&lt;/span> code injection
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 2. Replaced them with an auto-generated timestamp-based version when the workflow is manually triggered
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 3. Maintained the existing behavior &lt;span style="color:#c678dd">for&lt;/span> automatic triggers &lt;span style="color:#56b6c2">(&lt;/span>using &lt;span style="color:#98c379">&amp;#34;latest&amp;#34;&lt;/span> tag&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> This approach is more secure since:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 1. No user inputs are used in any &lt;span style="color:#e5c07b">command&lt;/span> execution context
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 2. The version tag is generated from a trusted &lt;span style="color:#e5c07b">source&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>the system timestamp&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 3. The workflow still provides versioned images when manually triggered, just with an automatically generated version instead of a user-provided one
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Let the agentic overlords take over 😬🤖.&lt;/p>
&lt;p>How does it know it can do so?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% grep -i bypass ~/.claude.json
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#98c379">&amp;#34;bypassPermissionsModeAccepted&amp;#34;&lt;/span>: &lt;span style="color:#e5c07b">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a href="https://docs.anthropic.com/en/docs/agents-and-tools/claude-code/overview#control-claude-code-with-commands">Anthropic Docs&lt;/a>.&lt;/p></description></item><item><title>The ack + xargs + sed pattern</title><link>https://perrotta.dev/2025/04/the-ack--xargs--sed-pattern/</link><pubDate>Wed, 30 Apr 2025 16:20:24 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/04/the-ack--xargs--sed-pattern/</guid><description>&lt;p>I employ this pattern almost every day:&lt;/p>
&lt;ul>
&lt;li>use &lt;a href="https://beyondgrep.com/">&lt;code>ack&lt;/code>&lt;/a> to search for a given string in a codebase (git repo)&lt;/li>
&lt;li>use &lt;a href="https://man.archlinux.org/man/xargs.1">&lt;code>xargs&lt;/code>&lt;/a> to iterate through each finding&lt;/li>
&lt;li>use &lt;a href="https://www.gnu.org/software/sed/manual/sed.html">&lt;code>sed&lt;/code>&lt;/a> to make a text transformation&lt;/li>
&lt;/ul>
&lt;p>Example of the day:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% ack &lt;span style="color:#98c379">&amp;#34;limit: 2&amp;#34;&lt;/span> -l | xargs -n &lt;span style="color:#d19a66">1&lt;/span> gsed -i -e &lt;span style="color:#98c379">&amp;#39;s/limit: 2/limit: 5/g&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Given multiple &lt;a href="https://argo-cd.readthedocs.io/en/stable/">ArgoCD app manifests&lt;/a> in the form:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">spec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">syncPolicy&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">retry&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">limit&lt;/span>: &lt;span style="color:#d19a66">2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">backoff&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">duration&lt;/span>: 5s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">factor&lt;/span>: &lt;span style="color:#d19a66">2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">maxDuration&lt;/span>: 1m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Replace &lt;code>limit: 2&lt;/code> with &lt;code>limit: 5&lt;/code> in all files. That&amp;rsquo;s what the command above
does:&lt;/p>
&lt;ul>
&lt;li>&lt;code>ack -l&lt;/code> lists all files that match the given pattern&lt;/li>
&lt;li>pipe to &lt;code>xargs -n 1&lt;/code> iterates on each of them&lt;/li>
&lt;li>&lt;code>gsed -i&lt;/code> (GNU &lt;code>sed&lt;/code>) makes a text transformation in-place&lt;/li>
&lt;/ul>
&lt;p>It&amp;rsquo;s not bulletproof, but it works most of the time.&lt;/p>
&lt;p>Sometimes I use &lt;a href="https://github.com/sharkdp/fd">&lt;code>fd&lt;/code>&lt;/a> to narrow the search down
to a file pattern. For example:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% fd -e yaml | xargs ack &lt;span style="color:#98c379">&amp;#34;limit: 2&amp;#34;&lt;/span> -l
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this case, though, &lt;code>ack --yaml&lt;/code> would be even simpler.&lt;/p>
&lt;p>When &lt;code>sed&lt;/code> isn&amp;rsquo;t up for the job, &lt;code>awk&lt;/code> tends to be a decent alternative.&lt;/p>
&lt;p>Regular expression replacements aren&amp;rsquo;t always precise.
False positives can easily take place.
Adding &lt;code>\b&lt;/code> (word boundaries) sometimes helps.&lt;/p>
&lt;p>Other times it&amp;rsquo;s better to use a syntax-aware tool instead of &lt;code>sed&lt;/code>.&lt;/p>
&lt;p>For YAML, there&amp;rsquo;s &lt;a href="https://github.com/mikefarah/yq">&lt;code>yq&lt;/code>&lt;/a>.&lt;/p>
&lt;p>For JSON, there&amp;rsquo;s &lt;a href="https://jqlang.org/">&lt;code>jq&lt;/code>&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>jq&lt;/code> is like &lt;code>sed&lt;/code> for JSON data - you can use it to slice and filter and map
and transform structured data with the same ease that &lt;code>sed&lt;/code>, &lt;code>awk&lt;/code>, &lt;code>grep&lt;/code> and
friends let you play with text.&lt;/p>
&lt;/blockquote></description></item><item><title>Delete newlines in a pipe</title><link>https://perrotta.dev/2025/04/delete-newlines-in-a-pipe/</link><pubDate>Fri, 25 Apr 2025 11:59:20 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/04/delete-newlines-in-a-pipe/</guid><description>&lt;p>&lt;strong>Problem statement&lt;/strong>: Given &lt;code>{cmd}&lt;/code> that emits lots of blank lines, delete all
blank lines in a pipe.&lt;/p>
&lt;p>The following is a very elegant (and easy to remember!) way to do so:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">{&lt;/span>cmd&lt;span style="color:#56b6c2">}&lt;/span> | awk &lt;span style="color:#98c379">&amp;#39;NF&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>From the LLM:&lt;/p>
&lt;blockquote>
&lt;p>When you use awk &amp;lsquo;NF&amp;rsquo;, it evaluates to true for lines where NF is greater than
zero—that is, lines that are not empty or do not consist solely of whitespace.
This makes it a concise way to filter out blank lines.&lt;/p>
&lt;/blockquote>
&lt;p>Other ways with classic tools and regular expressions:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">{&lt;/span>cmd&lt;span style="color:#56b6c2">}&lt;/span> | grep -v &lt;span style="color:#98c379">&amp;#39;^[[:space:]]*$&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">{&lt;/span>cmd&lt;span style="color:#56b6c2">}&lt;/span> | sed -e &lt;span style="color:#98c379">&amp;#39;/^[[:space:]]*$/d&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>They are just a bit harder to remember.&lt;/p></description></item><item><title>Alpine Linux: the maintainer workflow</title><link>https://perrotta.dev/2025/04/alpine-linux-the-maintainer-workflow/</link><pubDate>Sun, 20 Apr 2025 15:12:09 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/04/alpine-linux-the-maintainer-workflow/</guid><description>&lt;p>I maintain &lt;a href="https://pkgs.alpinelinux.org/packages?name=&amp;amp;branch=edge&amp;amp;repo=&amp;amp;arch=x86_64&amp;amp;origin=&amp;amp;flagged=&amp;amp;maintainer=Thiago+Perrotta">a couple of
packages&lt;/a>
on Alpine Linux.&lt;/p>
&lt;p>Every now and then, a new software version is released, and it&amp;rsquo;s my duty&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> as an
active package maintainer to update my packages.&lt;/p>
&lt;p>The typical workflow looks like the following.&lt;/p>
&lt;p>First I get an email notification from &amp;ldquo;Alpine Package DB&amp;rdquo;:&lt;/p>
&lt;blockquote>
&lt;p>Dear Thiago Perrotta&lt;/p>
&lt;p>This is an automatic message send from pkgs.alpinelinux.org
One or more of your aports have been flagged out of date based on
Anitya monitoring system &lt;a href="https://release-monitoring.org/">https://release-monitoring.org/&lt;/a>&lt;/p>
&lt;p>argocd current: 2.14.2-r1 new: 2.14.9&lt;/p>
&lt;p>To update the package you can use our helper script:&lt;/p>
&lt;p>abump aport-version&lt;/p>
&lt;p>If the provided information is incorrect, please let us know on IRC
or &lt;a href="mailto:alpine-infra@alpinelinux.org">alpine-infra@alpinelinux.org&lt;/a>. Thanks!&lt;/p>
&lt;/blockquote>
&lt;p>It&amp;rsquo;s important not to &lt;a href="https://opensource.com/business/15/12/avoid-burnout-live-happy">burn oneself
out&lt;/a>.&lt;/p>
&lt;p>I treat these notifications as an FYI. They &lt;em>are not&lt;/em> prompts to make me
immediately go and update the packages&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>. For packages with frequent updates,
like &lt;code>argocd&lt;/code>, I&amp;rsquo;ll let a few patch versions accumulate before I take action.
Other times it is handy to batch package upgrades together so to do them all at
once. I use my personal judgment here. At the very least, this email will
trigger a TODO in my task list, so that it will not be forgotten. &lt;em>At some
point&lt;/em> it will be taken care of.&lt;/p>
&lt;p>Once I am ready to update the package, I &lt;code>ssh&lt;/code> to my Alpine Linux server. There
is absolutely no requirement to update alpine linux packages from alpine linux,
but it&amp;rsquo;s the most convenient to do, and I already have an alpine linux system
anyway.&lt;/p>
&lt;p>Then &lt;code>cd aports/&lt;/code>. This is a local git clone of the &lt;a href="https://gitlab.alpinelinux.org/alpine/aports">aports
tree&lt;/a>
(&lt;a href="https://wiki.alpinelinux.org/wiki/Aports_tree">wiki&lt;/a>).&lt;/p>
&lt;p>&lt;code>git pull&lt;/code>. I tend to clean up after myself, so the last branch is likely
already &lt;code>master&lt;/code>. But, if not, then &lt;code>git reset --hard &amp;amp;&amp;amp; git checkout master &amp;amp;&amp;amp; git pull&lt;/code>. Amen.&lt;/p>
&lt;p>Now the real fun starts. And it&amp;rsquo;s surprisingly quick and simple, it feels like
cheating:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% abump argocd-2.14.9
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This will update the version and checksums in the corresponding &lt;code>APKBUILD&lt;/code> and
trigger a package build.&lt;/p>
&lt;p>It&amp;rsquo;s sensible to check the package release notes or changelog to find potential
incompatibilities and/or updates to the build process. It&amp;rsquo;s also sensible to
look at the package diffs to inspect for potential malware, which is becoming
increasingly more common these days in open source packages. &amp;ldquo;Secure your supply
chain&amp;rdquo;, as they say it.&lt;/p>
&lt;p>If the build completes successfully, create a new branch (&lt;code>git nb argocd&lt;/code>),
commit, push it (&lt;code>git pushm&lt;/code>), then create a merge request (MR) on
&lt;a href="https://gitlab.alpinelinux.org/">GitLab&lt;/a>. I normally use the Web UI to do so,
but it&amp;rsquo;s also possible to do it with the CLI. A link to create the MR is printed
to stdout upon pushing the branch, which makes the process even easier.&lt;/p>
&lt;p>It could happen that the MR fails CI for some architectures (even if it works
locally on my machine™). These errors need to be dealt with.&lt;/p>
&lt;p>The commit message must follow a certain style. I have a pre-commit script set
up that does it for me. It is typically in this form:&lt;/p>
&lt;pre tabindex="0">&lt;code>testing/argocd: upgrade to 2.14.9
&lt;/code>&lt;/pre>&lt;p>There&amp;rsquo;s a rule: only one package per merge request.&lt;/p>
&lt;p>If there are more packages to upgrade, I run &lt;code>git bd&lt;/code> (&amp;ldquo;branch delete&amp;rdquo;) and then
restart this process. It&amp;rsquo;s quite manageable, as I don&amp;rsquo;t maintain a lot of
packages. Perhaps it could be further automated if there were more packages
and/or if the package upgrades were more frequent.&lt;/p>
&lt;p>The final MR looks like the following:
&lt;a href="https://gitlab.alpinelinux.org/alpine/aports/-/merge_requests/83026">!83026&lt;/a>.&lt;/p>
&lt;p>Now I sit tight and wait for approval.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>On a &lt;a href="https://xkcd.com/2347/">&lt;em>best-effort&lt;/em>&lt;/a> basis.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2">
&lt;p>Unless it&amp;rsquo;s a security risk or incident (e.g. whenever there&amp;rsquo;s a CVE
associated with it).&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Pipe to Claude</title><link>https://perrotta.dev/2025/04/pipe-to-claude/</link><pubDate>Wed, 09 Apr 2025 17:56:05 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/04/pipe-to-claude/</guid><description>&lt;p>One of the most effective ways to resolve random software development problems
in 2025:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">{&lt;/span>&lt;span style="color:#e5c07b">command&lt;/span> that emits warnings or errors&lt;span style="color:#56b6c2">}&lt;/span> | claude
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>claude&lt;/code> is Anthropic&amp;rsquo;s &lt;a href="https://docs.anthropic.com/en/docs/agents-and-tools/claude-code/overview">Claude
Code&lt;/a>
CLI LLM agent tool:&lt;/p>
&lt;blockquote>
&lt;p>Learn about Claude Code, an agentic coding tool made by Anthropic. Currently
in beta as a research preview.&lt;/p>
&lt;/blockquote>
&lt;p>There is a series of little / simple tasks I&amp;rsquo;ve been procrastinating (e.g.
linter issues) that can be quickly resolved with the assistance of a LLM tool.&lt;/p>
&lt;p>There&amp;rsquo;s no silver bullet here: all changes need to be properly reviewed and
tested. Nonetheless, even if the tool is wrong 50% of the time, it&amp;rsquo;s still
faster for me to use the LLM tool as an initial suggestion than having to
do the research myself from scratch.&lt;/p></description></item><item><title>Github Actions: ubuntu-latest tools</title><link>https://perrotta.dev/2025/04/github-actions-ubuntu-latest-tools/</link><pubDate>Wed, 09 Apr 2025 01:00:47 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/04/github-actions-ubuntu-latest-tools/</guid><description>&lt;p>Which tools are installed in the Github Actions environment for &lt;code>ubuntu-latest&lt;/code>?&lt;/p>
&lt;p>&lt;a href="https://github.com/actions/runner-images/blob/main/images/ubuntu/Ubuntu2404-Readme.md">This
repository&lt;/a>
has the answer.&lt;/p></description></item><item><title>First Alpine Linux package in Community</title><link>https://perrotta.dev/2025/04/first-alpine-linux-package-in-community/</link><pubDate>Tue, 01 Apr 2025 14:27:41 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/04/first-alpine-linux-package-in-community/</guid><description>&lt;p>How wholesome: someone sent a MR (Merge Request)
&lt;a href="https://gitlab.alpinelinux.org/alpine/aports/-/merge_requests/82047">!82047&lt;/a> in
&lt;code>alpine/aports&lt;/code> with the &lt;a href="https://github.com/google/yamlfmt">&lt;code>yamlfmt&lt;/code>&lt;/a> package
I maintain, moving it from &lt;code>testing/&lt;/code> to &lt;code>community/&lt;/code>&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>.&lt;/p>
&lt;p>This means the package will be included in the next release of Alpine (3.22) as
part of its official repositories (unlike &amp;ldquo;testing&amp;rdquo;, which is only included in
&amp;ldquo;edge&amp;rdquo;).&lt;/p>
&lt;p>&lt;strong>In other words&lt;/strong>: This is the first time a package I maintain will make it to the
official repositories of a Linux distro I like!&lt;/p>
&lt;p>&lt;strong>Next milestone&lt;/strong>: Follow suit with a project I maintain.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>I did not initiate this: it has just happened organically / spontaneously.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>yaml: wrong new line character: expected \n</title><link>https://perrotta.dev/2025/03/yaml-wrong-new-line-character-expected-%5Cn/</link><pubDate>Fri, 14 Mar 2025 15:09:47 +0100</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/03/yaml-wrong-new-line-character-expected-%5Cn/</guid><description>&lt;p>Example upstream issue: &lt;a href="https://github.com/sbaudoin/sonar-yaml/issues/24">https://github.com/sbaudoin/sonar-yaml/issues/24&lt;/a>&lt;/p>
&lt;p>How to reproduce:&lt;/p>
&lt;ul>
&lt;li>start with a helm chart in a git repository: &lt;code>helm create foo&lt;/code>&lt;/li>
&lt;li>delete &lt;code>values.yaml&lt;/code>&lt;/li>
&lt;li>commit it, create a github PR&lt;/li>
&lt;li>realize that later on you need to create an empty &lt;code>values.yaml&lt;/code> file: &lt;code>touch values.yaml&lt;/code>&lt;/li>
&lt;li>commit it, push it&lt;/li>
&lt;li>realize that you need to add a comment to the YAML file&lt;/li>
&lt;li>use the github web UI to add a comment. Click edit, and add this comment:&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Purposely empty for `ct lint`.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>commit it&lt;/li>
&lt;li>wait for CI checks to run&lt;/li>
&lt;li>&lt;a href="https://github.com/adrienverge/yamllint">&lt;code>yamllint&lt;/code>&lt;/a> will fail:&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code>yaml: wrong new line character: expected \n
&lt;/code>&lt;/pre>&lt;p>This error can also be observed in &lt;code>vim&lt;/code> (with certain plug-ins).&lt;/p>
&lt;p>&lt;strong>What&amp;rsquo;s the issue?&lt;/strong> It&amp;rsquo;s a line ending problem: CR LF et al being different in
Windows vs Linux / macOS.&lt;/p>
&lt;p>&lt;strong>How to fix it?&lt;/strong> Run &lt;code>dos2unix values.yaml&lt;/code>, commit, profit.&lt;/p>
&lt;p>You can get &lt;code>dos2unix&lt;/code> e.g. via &lt;a href="https://brew.sh/">homebrew&lt;/a>.&lt;/p>
&lt;p>&lt;strong>What&amp;rsquo;s the lesson?&lt;/strong> Avoid the github web UI to edit files, even when in a
rush. ■&lt;/p></description></item><item><title>gh pr view</title><link>https://perrotta.dev/2025/02/gh-pr-view/</link><pubDate>Tue, 25 Feb 2025 11:46:06 +0100</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/02/gh-pr-view/</guid><description>&lt;p>When working on a local git branch that has a github PR associated to it, at
some point you&amp;rsquo;ll want to open its pull request page.&lt;/p>
&lt;p>If you have the &lt;a href="https://cli.github.com/">github CLI&lt;/a> installed (&lt;code>gh&lt;/code>), you can do so with &lt;code>gh pr view --web&lt;/code>.&lt;/p>
&lt;p>If you don&amp;rsquo;t pass &lt;code>--web&lt;/code>, then it will simply output markdown.&lt;/p></description></item><item><title>zsh: setopt magic_equal_subst</title><link>https://perrotta.dev/2025/02/zsh-setopt-magic_equal_subst/</link><pubDate>Tue, 18 Feb 2025 13:52:57 +0100</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/02/zsh-setopt-magic_equal_subst/</guid><description>&lt;p>&lt;strong>Problem statement&lt;/strong>: Write the following command line in &lt;code>zsh&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% terraform plan -var-file&lt;span style="color:#56b6c2">=&lt;/span>../../../config/global-dns-changer-
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now press &lt;code>&amp;lt;TAB&amp;gt;&lt;/code>.&lt;/p>
&lt;p>&lt;strong>Expected&lt;/strong>: Filename expansion.&lt;/p>
&lt;p>&lt;strong>Observed&lt;/strong>:&lt;/p>
&lt;pre tabindex="0">&lt;code>No matches for: `filename&amp;#39; or `file&amp;#39;
&lt;/code>&lt;/pre>&lt;p>Ugh. How about some magic 🪄?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>setopt magic_equal_subst
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% terraform plan -var-file&lt;span style="color:#56b6c2">=&lt;/span>../../../config/global-dns-changer-&amp;lt;TAB&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>completing file
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>global-dns-changer-&lt;span style="color:#56b6c2">{&lt;/span>foo&lt;span style="color:#56b6c2">}&lt;/span>.tfvars global-dns-changer-&lt;span style="color:#56b6c2">{&lt;/span>bar&lt;span style="color:#56b6c2">}&lt;/span>.tfvars
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Yay!&lt;/p>
&lt;p>There&amp;rsquo;s a workaround if you don&amp;rsquo;t want to set the aforementioned option. Just
remove the &lt;code>=&lt;/code> character:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% terraform plan -var-file ../../../config/global-dns-changer-&amp;lt;TAB&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>completing file
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>global-dns-changer-&lt;span style="color:#56b6c2">{&lt;/span>foo&lt;span style="color:#56b6c2">}&lt;/span>.tfvars global-dns-changer-&lt;span style="color:#56b6c2">{&lt;/span>bar&lt;span style="color:#56b6c2">}&lt;/span>.tfvars
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>I find it&amp;rsquo;s more convenient to have this option work in both situations though.&lt;/p>
&lt;p>(via &lt;a href="https://www.reddit.com/r/zsh/comments/10o018l/glob_expansion_and_tab_completion_after_the_sign/">Reddit&lt;/a>)&lt;/p></description></item><item><title>Kubernetes: create a pod in pending state</title><link>https://perrotta.dev/2025/02/kubernetes-create-a-pod-in-pending-state/</link><pubDate>Fri, 07 Feb 2025 13:58:36 +0100</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/02/kubernetes-create-a-pod-in-pending-state/</guid><description>&lt;p>We are making a non-trivial change to our cluster monitoring architecture, and I
needed to verify the new rollout is properly working in our infratesting
environment.&lt;/p>
&lt;p>A simple way to do so is to create a pod that never leaves the &amp;ldquo;Pending&amp;rdquo; state,
because we have an alert (a prometheus rule) that fires whenever a pod is in
that stack for too long (15 minutes is our threshold in most cases).&lt;/p>
&lt;p>Use the following manifest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">apiVersion&lt;/span>: v1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">kind&lt;/span>: Pod
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">metadata&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">name&lt;/span>: pending-pod
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">spec&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">affinity&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">podAffinity&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">requiredDuringSchedulingIgnoredDuringExecution&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e06c75">labelSelector&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">matchExpressions&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e06c75">key&lt;/span>: &lt;span style="color:#98c379">&amp;#34;non/existent&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">operator&lt;/span>: In
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">values&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#98c379">&amp;#34;true&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">topologyKey&lt;/span>: &lt;span style="color:#98c379">&amp;#34;kubernetes.io/hostname&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">containers&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - &lt;span style="color:#e06c75">name&lt;/span>: busybox
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">image&lt;/span>: busybox
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">command&lt;/span>: [&lt;span style="color:#98c379">&amp;#39;sh&amp;#39;&lt;/span>, &lt;span style="color:#98c379">&amp;#39;-c&amp;#39;&lt;/span>, &lt;span style="color:#98c379">&amp;#39;echo Hello, Kubernetes! &amp;amp;&amp;amp; sleep 3600&amp;#39;&lt;/span>]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip;it creates a &lt;code>pending-pod&lt;/code> in the &lt;code>default&lt;/code> namespace that should never be
scheduled, due to its strict pod affinity rules.&lt;/p>
&lt;p>Save it as &lt;code>pending-pod.yaml&lt;/code>, deploy it with &lt;code>kubectl apply -f pending-pod.yaml&lt;/code>.&lt;/p>
&lt;pre tabindex="0">&lt;code>$ kubectl get pod pending-pod -w
NAME READY STATUS RESTARTS AGE
pending-pod 0/1 Pending 0 21s
 pending-pod 0/1 Pending 0 65s
pending-pod 0/1 Pending 0 74s
pending-pod 0/1 Pending 0 2m6s
pending-pod 0/1 Pending 0 3m8s
pending-pod 0/1 Pending 0 4m8s
pending-pod 0/1 Pending 0 4m18s
&lt;/code>&lt;/pre>&lt;p>At some point the alert fires, as expected.
And now we can roll out these changes to prod!&lt;/p></description></item><item><title>SmartTube</title><link>https://perrotta.dev/2025/01/smarttube/</link><pubDate>Thu, 30 Jan 2025 18:18:25 +0100</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/01/smarttube/</guid><description>&lt;p>&lt;a href="https://github.com/yuliskov/SmartTube">https://github.com/yuliskov/SmartTube&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>SmartTube is an advanced player for Android TVs and TV boxes, free &amp;amp; open
source. You can play content from different public sources.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>✅ Features: no ads ‧ SponsorBlock ‧ adjustable playback speed ‧ 8k support ‧
60fps ‧ HDR ‧ read live chat ‧ customizable buttons ‧ no Google Services ‧
helpful international community&lt;/p>
&lt;/blockquote>
&lt;p>Works as advertised. Super easy to install on Android TVs. The main appeal is
surely adblocking.&lt;/p>
&lt;p>Note the following:&lt;/p>
&lt;blockquote>
&lt;p>Do not download SmartTube from any app store, APK websites or blogs; these
were uploaded by other people and may contain malware or ads. SmartTube is not
officially published on any app store. Sadly, the Google PlayStore does not
allow ad-free Youtube apps using unofficial APIs.&lt;/p>
&lt;/blockquote></description></item><item><title>Alpine Linux: install / pin old packages</title><link>https://perrotta.dev/2025/01/alpine-linux-install-/-pin-old-packages/</link><pubDate>Wed, 08 Jan 2025 15:54:44 -0300</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2025/01/alpine-linux-install-/-pin-old-packages/</guid><description>&lt;p>Let&amp;rsquo;s say you want to install an older version of &lt;code>jq&lt;/code> in Alpine Linux.&lt;/p>
&lt;p>For example:&lt;/p>
&lt;ul>
&lt;li>Alpine v3.18 has &lt;code>jq&lt;/code> 1.6&lt;/li>
&lt;li>Alpine v3.19 has &lt;code>jq&lt;/code> 1.7&lt;/li>
&lt;/ul>
&lt;p>You&amp;rsquo;re probably using Alpine v3.21 or edge today, which has an even newer
version of &lt;code>jq&lt;/code>. Hence &lt;code>doas apk add jq&lt;/code> will not do.&lt;/p>
&lt;p>Let&amp;rsquo;s assume you do not want to edit your &lt;code>/etc/apk/repositories&lt;/code>, as this is an
one-off, for a single package. What can you do then?&lt;/p>
&lt;p>Use the &lt;code>--repository&lt;/code> flag from &lt;code>apk&lt;/code>!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% doas apk add --no-cache --repository&lt;span style="color:#56b6c2">=&lt;/span>http://dl-cdn.alpinelinux.org/alpine/v3.18/main &lt;span style="color:#e06c75">jq&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>~1.6
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It&amp;rsquo;s also important to pin the package version (&lt;code>~1.6&lt;/code>), otherwise the latest
one available gets installed.&lt;/p>
&lt;p>Replace &amp;ldquo;main&amp;rdquo; with &amp;ldquo;community&amp;rdquo; or &amp;ldquo;testing&amp;rdquo; as needed.&lt;/p></description></item><item><title>Running multiple servers in a single bash script</title><link>https://perrotta.dev/2024/12/running-multiple-servers-in-a-single-bash-script/</link><pubDate>Mon, 23 Dec 2024 22:52:40 -0300</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/12/running-multiple-servers-in-a-single-bash-script/</guid><description>&lt;p>Inspired by &lt;a href="https://github.com/simonw/til/blob/main/bash/multiple-servers.md">Simon
Willison&lt;/a>&amp;rsquo;s
TIL.&lt;/p>
&lt;p>When I was working on the &lt;a href="https://stadia.com/">Stadia&lt;/a> Partner Portal as a
full-stack tech lead, I wrote and maintained a &lt;code>run.sh&lt;/code> script that would start
up our two (front-end and back-end) Boq&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> server instances.&lt;/p>
&lt;p>It resembled the following:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#!/usr/bin/env bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cleanup&lt;span style="color:#56b6c2">()&lt;/span> &lt;span style="color:#56b6c2">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e5c07b">kill&lt;/span> &lt;span style="color:#e06c75">$pid_fe&lt;/span> &lt;span style="color:#e06c75">$pid_be&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e5c07b">exit&lt;/span> &lt;span style="color:#d19a66">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">trap&lt;/span> cleanup SIGINT
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>start_fe&lt;span style="color:#56b6c2">()&lt;/span> &lt;span style="color:#56b6c2">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#7f848e"># [...init deps...]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> boq run //java/com/google/chrome/cloudcast/&lt;span style="color:#56b6c2">[&lt;/span>...&lt;span style="color:#56b6c2">]&lt;/span>/publishing/partnerportal/ui &amp;amp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">pid_fe&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#e06c75">$!&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>start_be&lt;span style="color:#56b6c2">()&lt;/span> &lt;span style="color:#56b6c2">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#7f848e"># [...init deps...]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> boq run //java/com/google/chrome/cloudcast/&lt;span style="color:#56b6c2">[&lt;/span>...&lt;span style="color:#56b6c2">]&lt;/span>/publishing/partnerportal &amp;amp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">pid_be&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#e06c75">$!&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>start_fe
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>start_be
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">wait&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This version is heavily simplified, but that was its gist. It worked perfectly.
Back in ~2018, it took quite a bit of trial-and-error to get it right. Now it
seems so easy to just ask GenAI to generate it for you! Yikes. Our profession
might get obsoleted in just a few more years to come&amp;hellip;&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>A proprietary / internal framework for web applications.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Unbuffer</title><link>https://perrotta.dev/2024/12/unbuffer/</link><pubDate>Mon, 23 Dec 2024 21:41:38 -0300</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/12/unbuffer/</guid><description>&lt;p>The &lt;code>unbuffer&lt;/code> binary comes from the &lt;a href="https://www.nist.gov/services-resources/software/expect">expect&lt;/a> package.
I didn&amp;rsquo;t realize until now that it is hosted in NIST.gov!&lt;/p>
&lt;p>There are two scenarios in which I find &lt;code>unbuffer&lt;/code> quite helpful:&lt;/p>
&lt;ol>
&lt;li>flush stdout line output immediately, in programs such as &lt;code>tail&lt;/code> or &lt;code>python&lt;/code>.
Julia Evans noted this
&lt;a href="https://jvns.ca/blog/2024/11/29/why-pipes-get-stuck-buffering/#solution-5-use-unbuffer">here&lt;/a>:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% tail -f /some/log/file | unbuffer grep thing1 | grep thing2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Without &lt;code>unbuffer&lt;/code> there&amp;rsquo;s no guarantee &lt;code>tail&lt;/code> would print its stdout output in
real time.&lt;/p>
&lt;ol start="2">
&lt;li>force stdout to write to a TTY (or to pretend that it will write to a TTY):&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% unbuffer ls --color&lt;span style="color:#56b6c2">=&lt;/span>auto | less -R
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this example, &lt;code>less&lt;/code> will properly recognize and display color output from
&lt;code>ls&lt;/code>.&lt;/p></description></item><item><title>Default apps 2024</title><link>https://perrotta.dev/2024/12/default-apps-2024/</link><pubDate>Sat, 21 Dec 2024 16:02:54 -0300</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/12/default-apps-2024/</guid><description>&lt;p>The list of my default apps for this year.&lt;/p>
&lt;p>In the past I would maintain an &lt;a href="https://uses.tech/">&amp;ldquo;uses&amp;rdquo;&lt;/a> page in my blog, but I no longer believe in it.
User needs change all the time, and it&amp;rsquo;s a chore to keep them up-to-date.
People shouldn&amp;rsquo;t be defined by the software they use.&lt;/p>
&lt;p>That said, having a clean snapshot of the software I use at a fixed point in time isn&amp;rsquo;t a bad proposition.
It doesn&amp;rsquo;t need to be maintained.
I will probably look back at it within 5 years and laugh at myself for how many things changed.
And also for how many didn&amp;rsquo;t.&lt;/p>
&lt;ul>
&lt;li>Browser: Google Chrome on macOS, Chromium on Linux, Safari on iOS.&lt;/li>
&lt;li>Search: A combination of Google and DuckDuckGo (mostly for their &lt;a href="https://duckduckgo.com/bangs">!bangs&lt;/a>).&lt;/li>
&lt;li>Writing: A combination of VSCode, &lt;code>vim&lt;/code> and &lt;a href="https://github.com/MarkEdit-app/MarkEdit">MarkEdit&lt;/a> (macOS markdown editor app). I never got around to long-form writing in Obsidian or Logseq, however it&amp;rsquo;s something I strive to.&lt;/li>
&lt;li>Cloud File Storage: There&amp;rsquo;s no need to share this. Basic OpSec. Why would people share it?&lt;/li>
&lt;li>Chat: WhatsApp remains king in terms of popularity, despite Telegram being superior from an architectural and usability perspective for power users. Facebook Messenger is officially dead at this point. And I&amp;rsquo;m too much of a millennial for all other apps (Discord, Matrix, etc). Disappearing messages exist in all of these, except Instagram.&lt;/li>
&lt;li>Scheduling: There&amp;rsquo;s no real choice here. You use the platform your employer uses. Otherwise, Google Calendar is the most sensible choice other than self-hosting.&lt;/li>
&lt;li>Video Calls: Ditto. I am way too used to Google Meet to justify switching to an alternative at this point.&lt;/li>
&lt;li>Music: Spotify, hands down. YouTube Music is a good fallback. There&amp;rsquo;s no need to pay for YouTube Premium for music, do your research.&lt;/li>
&lt;li>Podcasts: Overcast on iOS.&lt;/li>
&lt;li>Password Management: Once again, why would you share this?&lt;/li>
&lt;li>Code Editor: VScode and &lt;code>vim&lt;/code>. Maybe I&amp;rsquo;ll switch to &lt;code>neovim&lt;/code> at some point. I refrain from using IDEs in general but, when I need to, JetBrains is the answer. I tried &lt;a href="https://zed.dev/">&lt;code>zed&lt;/code>&lt;/a> this year but wasn&amp;rsquo;t convinced, and their core team is quite small. The flurry of &amp;ldquo;AI&amp;rdquo;&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> editors should be ignored, as none of them are likely to stick long-term. Instead, it&amp;rsquo;s better to invest in &amp;ldquo;AI&amp;rdquo; tooling that is editor agnostic; for example, Simon Willison&amp;rsquo;s &lt;a href="https://github.com/simonw/llm">&lt;code>llm&lt;/code>&lt;/a>, or GitHub Copilot.&lt;/li>
&lt;li>Terminal: iTerm2 on macOS. I haven&amp;rsquo;t used desktop linux in a while (:sad:), but I&amp;rsquo;d probably still stick to Tilix and/or Alacritty there. I no longer use hterm (ChromeOS).&lt;/li>
&lt;li>VPN: Unless you&amp;rsquo;re rolling your own, it doesn&amp;rsquo;t matter too much. Avoid the big players if you can afford to.&lt;/li>
&lt;li>Bookmarks: None. &lt;a href="https://www.goodreads.com/book/show/25614984-spark-joy">Absolutely none&lt;/a>. When I need to store &lt;em>transient&lt;/em> link lists, I use my Second Brain app to do so.&lt;/li>
&lt;li>Read It Later: Ditto as above. Otherwise: starring articles on Miniflux, or keeping Safari tabs open until I get to them, or parking a handful of items in an &amp;ldquo;inbox&amp;rdquo; browser bookmarks folder.&lt;/li>
&lt;li>Mail Client: The official clients of my email providers. No agnostic app at this time. It&amp;rsquo;s especially inconvenient to do so on iOS.&lt;/li>
&lt;li>Mail Server: N/A.&lt;/li>
&lt;li>Launcher: &lt;code>Cmd-Space&lt;/code> on macOS a.k.a. Spotlight. I keep Raycast around but I rarely use it. On Linux &lt;code>i3-dmenu-desktop&lt;/code> is still my favorite.&lt;/li>
&lt;li>Screenshots: &lt;code>Cmd-Shift-4&lt;/code> on macOS, or &lt;code>scrot&lt;/code> on Linux.&lt;/li>
&lt;li>Menu Bar: &lt;a href="https://github.com/dwarvesf/hidden">Hidden Bar&lt;/a>. It&amp;rsquo;s free, and available as a cask on homebrew.&lt;/li>
&lt;li>Containers: Rancher Desktop.&lt;/li>
&lt;li>Automation: None. I tried Hammerspoon this year but found no use for it.&lt;/li>
&lt;li>Second Brain: A mixture of Obsidian and Logseq. Which I&amp;rsquo;d really like to end, it would be easier to have a single app to rule them all, as they both support multiple vaults / graphs anyway (e.g. to partition personal vs work notes).&lt;/li>
&lt;li>Operating System: &lt;a href="https://alpinelinux.org/">Alpine Linux&lt;/a> is my current favorite for servers, and I&amp;rsquo;m biased anyway because I maintain a couple of aports (packages) there. For desktop, it&amp;rsquo;s awfully hard to use anything other than macOS ever since M1 processors got released. I miss Linux desktop from time to time but realistically it&amp;rsquo;s no longer an intrinsic goal of mine; that said, I&amp;rsquo;d likely go back to my beloved Arch Linux should that ever reoccur.&lt;/li>
&lt;li>Shell: &lt;code>zsh&lt;/code> + &lt;a href="https://grml.org/zsh/">&lt;code>grml-zsh-config&lt;/code>&lt;/a>, no change here. Sometimes I think of migrating to &lt;code>fish&lt;/code>, but the POSIX incompability always discourages me to do so.&lt;/li>
&lt;li>Terminal Multiplexer: &lt;code>tmux&lt;/code>, but only for remote sessions (&lt;code>ssh&lt;/code>). Locally I tend to just open new terminal tabs on VSCode and/or iTerm2. Alas, &lt;code>tmux&lt;/code> + &lt;code>VSCode&lt;/code> do not play well together anyway (citation needed, for another day).&lt;/li>
&lt;/ul>
&lt;p>This post was inspired by &lt;a href="https://micro.webology.dev/2024/12/19/default-apps.html">https://micro.webology.dev/2024/12/19/default-apps.html&lt;/a>.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>For the correct way to refer to them, pick one of: LLMs, Gen AI, or &amp;ldquo;AI&amp;rdquo;. &lt;em>Never&lt;/em> drop the quotes when using the plain term! Otherwise you fall into the same trap for using the term &amp;ldquo;crypto&amp;rdquo; to distinguish between cryptography and cryptocurrency.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Steam Deck "downloading update" boot loop</title><link>https://perrotta.dev/2024/10/steam-deck-downloading-update-boot-loop/</link><pubDate>Sat, 05 Oct 2024 23:58:48 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/10/steam-deck-downloading-update-boot-loop/</guid><description>&lt;p>Today I tried to use my Steam Deck to no avail.&lt;/p>
&lt;p>Upon turning it on, a &amp;ldquo;Downloading update (…)&amp;rdquo; splash screen would appear, then the device would quickly turn itself off, in a matter of seconds.&lt;/p>
&lt;p>Repeating this dance a couple of times yielded the same results.&lt;/p>
&lt;p>Then I found out that if you hold the three-dot button (the quick settings menu button) briefly after turning it on, you are prompted with a boot loader screen that resembles GRUB. In this screen it&amp;rsquo;s possible to roll back to an earlier OS version.&lt;/p>
&lt;p>The Steam Deck disk partitioning has two partitions (A and B), just choose the second one (i.e. not the latest one).&lt;/p>
&lt;p>This time upon restarting the device the boot loop was gone.&lt;/p>
&lt;p>&lt;strong>Credits&lt;/strong>: &lt;a href="https://www.reddit.com/r/SteamDeck/comments/1bb5767/steam_deck_stuck_at_update_complete_launching/">https://www.reddit.com/r/SteamDeck/comments/1bb5767/steam_deck_stuck_at_update_complete_launching/&lt;/a>&lt;/p></description></item><item><title>apk autoupdate on alpine linux</title><link>https://perrotta.dev/2024/08/apk-autoupdate-on-alpine-linux/</link><pubDate>Sun, 18 Aug 2024 17:32:48 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/08/apk-autoupdate-on-alpine-linux/</guid><description>&lt;p>&lt;strong>Problem statement&lt;/strong>: Upon running &lt;code>doas apk upgrade&lt;/code> on Alpine Linux, select
packages with binaries backed by system services should be automatically
restarted.&lt;/p>
&lt;p>Deb-based systems have
&lt;a href="https://manpages.debian.org/bookworm/debian-goodies/checkrestart.8.en.html">&lt;code>checkrestart(8)&lt;/code>&lt;/a>.&lt;/p>
&lt;p>On Alpine, the best available approach as of today is &lt;a href="https://github.com/jirutka/apk-autoupdate/">https://github.com/jirutka/apk-autoupdate/&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>doas apk add apk-autoupdate
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">$EDITOR&lt;/span> /etc/apk/autoupdate.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then make the two following changes&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>:&lt;/p>
&lt;pre tabindex="0">&lt;code># Because the default is &amp;#39;*&amp;#39;, which will prevent all services from restarting.
services_blacklist=&amp;#34;&amp;#34;

# List of services that should be restarted upon package upgrades.
services_whitelist=&amp;#34;miniflux tailscale&amp;#34;
&lt;/code>&lt;/pre>&lt;p>From this point on, whenever there are system upgrades for the aforementioned
services (&lt;code>doas apk upgrade&lt;/code>), they will be automatically restarted. There&amp;rsquo;s no
need for &lt;code>doas /etc/init.d/miniflux restart&lt;/code>.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>h/t to @fossdd for replying to my
&lt;a href="https://github.com/jirutka/apk-autoupdate/issues/8">https://github.com/jirutka/apk-autoupdate/issues/8&lt;/a> thread.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Alpine Linux: How to install all manpages (idiomatically)</title><link>https://perrotta.dev/2024/07/alpine-linux-how-to-install-all-manpages-idiomatically/</link><pubDate>Sat, 20 Jul 2024 16:19:53 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/07/alpine-linux-how-to-install-all-manpages-idiomatically/</guid><description>&lt;p>This post is a reply to
&lt;a href="https://tilde.town/~kzimmermann/articles/installing_alpine_manpages.html">https://tilde.town/~kzimmermann/articles/installing_alpine_manpages.html&lt;/a>.&lt;/p>
&lt;p>The author describes their experience while attempting to install all man pages
for all the packages in use in their system.&lt;/p>
&lt;p>The breakdown progression has some valuable insights on how a typical Unix
sysadmin addresses a problem. I tend to adopt a similar approach when entering
unknown territory.&lt;/p>
&lt;p>However, in Alpine Linux, there is a better way.&lt;/p>
&lt;h2 id="solution">Solution&lt;/h2>
&lt;p>There is a &lt;code>docs&lt;/code> metapackage:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% apk info docs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docs-0.2-r6 description:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Meta package &lt;span style="color:#c678dd">for&lt;/span> pulling in all documentation
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docs-0.2-r6 webpage:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>https://alpinelinux.org
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docs-0.2-r6 installed size:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d19a66">4096&lt;/span> B
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>All you have to do is:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% doas apk add docs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">(&lt;/span>1/125&lt;span style="color:#56b6c2">)&lt;/span> Installing mandoc-doc &lt;span style="color:#56b6c2">(&lt;/span>1.14.6-r13&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">(&lt;/span>2/125&lt;span style="color:#56b6c2">)&lt;/span> Installing docs &lt;span style="color:#56b6c2">(&lt;/span>0.2-r6&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">(&lt;/span>3/125&lt;span style="color:#56b6c2">)&lt;/span> Installing libseccomp-doc &lt;span style="color:#56b6c2">(&lt;/span>2.5.5-r1&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">(&lt;/span>4/125&lt;span style="color:#56b6c2">)&lt;/span> Installing busybox-doc &lt;span style="color:#56b6c2">(&lt;/span>1.36.1-r31&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">[&lt;/span>...&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Likewise, it is trivial to get rid of all man pages:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% doas apk del docs
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>I would like to give a few other suggestions to the author, if we were to assume
there is no &lt;code>docs&lt;/code> metapackage:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Step 2&lt;/strong>: You could also &lt;code>cat /etc/apk/world&lt;/code>
(&lt;a href="https://serverfault.com/questions/1032488/alpine-linux-apk-list-out-directly-installed-packages-by-apk-add">reference&lt;/a>).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Step 4&lt;/strong>: &lt;code>combine&lt;/code> from &lt;a href="https://perrotta.dev/2022/05/tools-you-should-know-about-moreutils/">moreutils&lt;/a> is more
user-friendly than &lt;code>comm&lt;/code>. I need to look up how to use &lt;code>comm&lt;/code> every single
time, whereas &lt;code>combine&lt;/code> is much easier to remember.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="appendix">Appendix&lt;/h2>
&lt;p>This was also a typical &lt;a href="https://perrotta.dev/2024/06/xy-problem/">xyproblem&lt;/a> example:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>What is the attempt? &amp;ldquo;I want to install, via &lt;code>apk add&lt;/code>, all &lt;code>foo-doc&lt;/code> packages
for every &lt;code>foo&lt;/code> package on my system&amp;rdquo;.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>What is the end goal? &amp;ldquo;I want to install all man pages for the installed
packages on my system&amp;rdquo;.&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>Explain a crontab expression</title><link>https://perrotta.dev/2024/07/explain-a-crontab-expression/</link><pubDate>Mon, 01 Jul 2024 18:48:47 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/07/explain-a-crontab-expression/</guid><description>&lt;p>Given, for example, &lt;code>0 0 * * *&lt;/code>, how do you figure out when it will run?&lt;/p>
&lt;ul>
&lt;li>Option 1: Read the docs! The &lt;a href="https://wiki.archlinux.org/title/Cron">ArchWiki&lt;/a>
is frequently a great reference. Alternatively, use your favorite search
engine.&lt;/li>
&lt;li>Option 2: Ask ChatGPT! A simple &lt;code>cron: 0 0 * * *&lt;/code> prompt is enough. No need
to embezzle it with &lt;code>explain what this does&lt;/code> or &lt;code>what does this do?&lt;/code>.&lt;/li>
&lt;li>Option 3: Paste it into &lt;a href="https://crontab.guru/">https://crontab.guru/&lt;/a>.&lt;/li>
&lt;/ul></description></item><item><title>Localhost domain</title><link>https://perrotta.dev/2024/07/localhost-domain/</link><pubDate>Mon, 01 Jul 2024 11:34:34 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/07/localhost-domain/</guid><description>&lt;p>If you find yourself in a situation wherein http://localhost:1313 has issues,
you can use a domain that redirects to localhost. For example:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="http://localdev.me:1313/">http://localdev.me:1313/&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://demo.localdev.me:1313/">http://demo.localdev.me:1313/&lt;/a>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>When I&amp;rsquo;m doing local development, I sometimes need a domain name that routes
back to localhost. I&amp;rsquo;ve long run into cases where I need subdomains and ended
up modifying my local hosts file. I&amp;rsquo;ve used this for a variety of situations
going back for a long time. From Kubernetes ingress work to web development.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>&lt;code>localdev.me&lt;/code> DNS is served through amazon. The domain name and any subdomains
point to &lt;code>127.0.0.1&lt;/code>.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>The next time you need a custom domain or subdomain for local development,
instead of hancking your hosts file you might consider localdev.me.&lt;/p>
&lt;/blockquote>
&lt;p>Source: &lt;a href="https://codeengineered.com/blog/2022/localdev-me/">https://codeengineered.com/blog/2022/localdev-me/&lt;/a>&lt;/p></description></item><item><title>Copy files from laptop to Steam Deck</title><link>https://perrotta.dev/2024/06/copy-files-from-laptop-to-steam-deck/</link><pubDate>Sun, 30 Jun 2024 15:05:37 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/06/copy-files-from-laptop-to-steam-deck/</guid><description>&lt;p>Let&amp;rsquo;s say the files you want to copy are in &lt;code>~/Downloads&lt;/code>.&lt;/p>
&lt;p>Start a local HTTP server on your laptop:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ cd ~/Downloads
$ python3 -m http.server
Serving HTTP on :: port 8000 (http://[::]:8000/) ...
&lt;/code>&lt;/pre>&lt;p>Find the IP address of your laptop within your LAN:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ ifconfig # macOS
$ ip addr # linux
&lt;/code>&lt;/pre>&lt;p>Now go to your Steam Deck, access &lt;code>http://&amp;lt;ip&amp;gt;:8000&lt;/code> via the installed web
browser, and download your files.&lt;/p>
&lt;p>Alternatively, run &lt;code>wget&lt;/code> / &lt;code>curl&lt;/code> in a terminal.&lt;/p></description></item><item><title>Rename files in bulk</title><link>https://perrotta.dev/2024/06/rename-files-in-bulk/</link><pubDate>Wed, 19 Jun 2024 13:39:04 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/06/rename-files-in-bulk/</guid><description>&lt;p>Whenever the files are in the same directory, &lt;code>vidir&lt;/code> from &lt;a href="https://perrotta.dev/2022/05/tools-you-should-know-about-moreutils/">moreutils&lt;/a> is the best
interactive tool.&lt;/p>
&lt;p>If files are scattered across multiple directories, consider using the
&lt;a href="https://man.archlinux.org/man/rename.1.en">&lt;code>rename&lt;/code>&lt;/a> utility from &lt;code>util-linux&lt;/code>.&lt;/p>
&lt;p>A simple example to rename all &lt;code>readme.md&lt;/code> files to &lt;code>README.md&lt;/code> for consistency:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>rename &lt;span style="color:#98c379">&amp;#39;s/readme\.md/README.md/&amp;#39;&lt;/span> **/*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>A more recent example (2024-07-25):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>rename &lt;span style="color:#98c379">&amp;#39;s/promtail-global-testing/promtail-global/g&amp;#39;&lt;/span> **/*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If there are nested directories that match the expression, you&amp;rsquo;ll need to run
&lt;code>rename&lt;/code> multiple times.&lt;/p></description></item><item><title>Sleep forever</title><link>https://perrotta.dev/2024/06/sleep-forever/</link><pubDate>Sat, 15 Jun 2024 15:01:02 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/06/sleep-forever/</guid><description>&lt;p>The following commands will make the shell sleep indefinitely:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sleep inf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sleep infinity
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Previously I would call a command such as a &lt;code>while true&lt;/code> loop or the &lt;code>yes&lt;/code>
utility, but &lt;code>sleep&lt;/code> is also handy.&lt;/p></description></item><item><title>Bcrypt-hash a password</title><link>https://perrotta.dev/2024/06/bcrypt-hash-a-password/</link><pubDate>Thu, 06 Jun 2024 13:35:05 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/06/bcrypt-hash-a-password/</guid><description>&lt;p>Given the password &lt;code>correct horse battery staple&lt;/code>, we would like to bcrypt-hash
it.&lt;/p>
&lt;figure>&lt;a href="https://xkcd.com/936/">&lt;img src="https://imgs.xkcd.com/comics/password_strength.png"
 alt="Through 20 years of effort, we&amp;#39;ve successfully trained everyone to use passwords that are hard for humans to remember, but easy for computers to guess.">&lt;/a>&lt;figcaption>
 &lt;p>XKCD Courtesy of Randall Munroe&lt;/p>
 &lt;/figcaption>
&lt;/figure>

&lt;p>Here&amp;rsquo;s one way to do so via the command line:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ htpasswd -nbBC &lt;span style="color:#d19a66">10&lt;/span> &lt;span style="color:#98c379">&amp;#34;&amp;#34;&lt;/span> &lt;span style="color:#98c379">&amp;#39;correct horse battery staple&amp;#39;&lt;/span> | tr -d &lt;span style="color:#98c379">&amp;#39;:\n&amp;#39;&lt;/span> | sed &lt;span style="color:#98c379">&amp;#39;s/$2y/$2a/&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip;which yields:&lt;/p>
&lt;pre tabindex="0">&lt;code>$2a$10$HKSHfLu4l7TvOmnLkhUngu2U1pJUUw7hEU0LE1iN84S09fJsZowHm
&lt;/code>&lt;/pre>&lt;p>You could verify it matches e.g. via &lt;a href="https://bcrypt-generator.com/">https://bcrypt-generator.com/&lt;/a>.&lt;/p>
&lt;p>&lt;strong>Context&lt;/strong>: &lt;a href="https://argo-cd.readthedocs.io/en/stable/">ArgoCD&lt;/a> expects a
bcrypt-hashed password in its config file.&lt;/p></description></item><item><title>Adding a healthcheck to chartmuseum in AWS Fargate</title><link>https://perrotta.dev/2024/05/adding-a-healthcheck-to-chartmuseum-in-aws-fargate/</link><pubDate>Fri, 17 May 2024 11:15:09 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/05/adding-a-healthcheck-to-chartmuseum-in-aws-fargate/</guid><description>&lt;p>Assume that you have a &lt;a href="https://chartmuseum.com/">Chartmuseum&lt;/a> container running
in &lt;a href="https://aws.amazon.com/fargate/">AWS Fargate&lt;/a>.&lt;/p>
&lt;p>Chartmuseum is a repository for helm charts. AWS Fargate is an Amazon service to
run containers (&amp;ldquo;serverless&amp;rdquo;), being part of ECS (Elastic Container Service).&lt;/p>
&lt;p>Problem statement: Add a container &lt;em>healthcheck&lt;/em> to the chartmuseum task
definition associated with the container.&lt;/p>
&lt;p>The &lt;a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_HealthCheck.html">official
docs&lt;/a>
suggest using &lt;code>curl&lt;/code>:&lt;/p>
&lt;pre tabindex="0">&lt;code>[&amp;#34;CMD-SHELL&amp;#34;, &amp;#34;curl -f http://localhost/ || exit 1&amp;#34;]
&lt;/code>&lt;/pre>&lt;p>For Chartmuseum specifically we&amp;rsquo;re interested in its &lt;code>/health&lt;/code> endpoint, as per
&lt;a href="https://github.com/helm/chartmuseum/issues/28">this reference&lt;/a>:&lt;/p>
&lt;pre tabindex="0">&lt;code>[&amp;#34;CMD-SHELL&amp;#34;, &amp;#34;curl -f http://localhost/health || exit 1&amp;#34;]
&lt;/code>&lt;/pre>&lt;p>But we&amp;rsquo;re using port 8080:&lt;/p>
&lt;pre tabindex="0">&lt;code>[&amp;#34;CMD-SHELL&amp;#34;, &amp;#34;curl -f http://localhost:8080/health || exit 1&amp;#34;]
&lt;/code>&lt;/pre>&lt;p>If you use this healthcheck for the official chartmuseum image
(&lt;code>ghcr.io/helm/chartmuseum&lt;/code>) it will fail, because the Alpine Linux environment
it uses does not contain &lt;code>curl&lt;/code>.&lt;/p>
&lt;p>A straightforward fix is to use &lt;code>wget&lt;/code> instead:&lt;/p>
&lt;pre tabindex="0">&lt;code>[&amp;#34;CMD-SHELL&amp;#34;, &amp;#34;wget -q --spider http://localhost:8080/health || exit 1&amp;#34;]
&lt;/code>&lt;/pre>&lt;p>&lt;code>--spider&lt;/code> is needed because we do not want to download anything, &lt;code>-q&lt;/code> is
optional and short for &amp;ldquo;quiet&amp;rdquo;.&lt;/p>
&lt;p>The &lt;code>/health&lt;/code> endpoint merely returns a simple JSON:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{&lt;span style="color:#e06c75">&amp;#34;healthy&amp;#34;&lt;/span>:&lt;span style="color:#e5c07b">true&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>References: &lt;a href="https://stackoverflow.com/questions/47722898/how-can-i-make-a-docker-healthcheck-with-wget-instead-of-curl">https://stackoverflow.com/questions/47722898/how-can-i-make-a-docker-healthcheck-with-wget-instead-of-curl&lt;/a>&lt;/p></description></item><item><title>Be aware that your public SSH keys can reveal your identity</title><link>https://perrotta.dev/2024/05/be-aware-that-your-public-ssh-keys-can-reveal-your-identity/</link><pubDate>Fri, 03 May 2024 16:46:28 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/05/be-aware-that-your-public-ssh-keys-can-reveal-your-identity/</guid><description>&lt;p>If you have a GitHub account configured with SSH, your public keys are available
at &lt;code>https://github.com/$USERNAME.keys&lt;/code>.&lt;/p>
&lt;p>For example, mine: &lt;a href="https://github.com/thiagowfx.keys">https://github.com/thiagowfx.keys&lt;/a>&lt;/p>
&lt;p>And then let&amp;rsquo;s say you also use your full name on GitHub.&lt;/p>
&lt;pre tabindex="0">&lt;code>% ssh whoami.filippo.io
The authenticity of host &amp;#39;whoami.filippo.io (2a09:8280:1::a:5d6)&amp;#39; can&amp;#39;t be established.
ED25519 key fingerprint is SHA256:qGAqPqtlvFBCt4LfMME3IgJqZWlcrlBMxNmGjhLVYzY.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added &amp;#39;whoami.filippo.io&amp;#39; (ED25519) to the list of known hosts.

 +---------------------------------------------------------------------+
 | |
 | _o/ Hello Thiago Perrotta!
 | |
 | |
 | Did you know that ssh sends all your public keys to any server |
 | it tries to authenticate to? |
 | |
 | We matched them to the keys of your GitHub account, |
 | @thiagowfx, which are available via the GraphQL API
 | and at https://github.com/thiagowfx.keys
 | |
 | -- Filippo (https://filippo.io) |
 | |
 | |
 | P.S. The source of this server is at |
 | https://github.com/FiloSottile/whoami.filippo.io |
 | |
 +---------------------------------------------------------------------+

Shared connection to whoami.filippo.io closed.
&lt;/code>&lt;/pre>&lt;p>Then be careful when connecting to random public ssh servers when you have an
intent to be anonymous.&lt;/p>
&lt;p>It&amp;rsquo;s possible to &amp;ldquo;hide&amp;rdquo; yourself by either setting the &lt;code>IdentitiesOnly=yes&lt;/code>
option, or by removing all your local ssh keys altogether, even if only
temporarily.&lt;/p></description></item><item><title>Shell text substitution</title><link>https://perrotta.dev/2024/04/shell-text-substitution/</link><pubDate>Sun, 07 Apr 2024 23:13:09 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2024/04/shell-text-substitution/</guid><description>&lt;p>I learned a neat shell trick this week. In both &lt;code>bash&lt;/code> and &lt;code>zsh&lt;/code> you can use the
circumflex / caret (&lt;code>^&lt;/code>) symbol to find &amp;amp; replace a word from the previous
command.&lt;/p>
&lt;p>Usage: &lt;code>^prev^next&lt;/code>. It&amp;rsquo;s best illustrated with examples:&lt;/p>
&lt;h2 id="terraform">terraform&lt;/h2>
&lt;p>Instead of running:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>terraform init -var-file /path/to/foo.tfvars
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>terraform plan -var-file /path/to/foo.tfvars
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>terraform apply -var-file /path/to/foo.tfvars
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Run:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>terraform init -var-file /path/to/foo.tfvars
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>^init^plan
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>^plan^apply
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="systemd">systemd&lt;/h2>
&lt;p>Instead of running:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo systemctl restart nginx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo systemctl status nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Run:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo systemctl restart nginx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>^restart^status
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="one-observation">one observation&lt;/h2>
&lt;p>&lt;code>zsh&lt;/code> will run the substitution right away, whereas &lt;code>bash&lt;/code> will allow you
to review and edit the replaced command before running it.&lt;/p></description></item><item><title>Tools you should know about: moreutils</title><link>https://perrotta.dev/2022/05/tools-you-should-know-about-moreutils/</link><pubDate>Sun, 01 May 2022 13:02:51 -0400</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/05/tools-you-should-know-about-moreutils/</guid><description>&lt;p>&lt;a href="https://joeyh.name/code/moreutils/">&lt;code>moreutils&lt;/code>&lt;/a> has previously been covered &lt;a href="https://news.ycombinator.com/item?id=31043655">elsewhere&lt;/a>, multiple times. It&amp;rsquo;s a collection of small unix tools that follow the &lt;a href="https://en.wikipedia.org/wiki/Unix_philosophy">unix philosophy&lt;/a>&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> very strongly.&lt;/p>
&lt;p>Here are some of my favorites with example usages. Obviously this post isn&amp;rsquo;t a manual which would have been a disservice to the community; refer to the upstream man pages for detailed instructions.&lt;/p>
&lt;h2 id="sponge">sponge&lt;/h2>
&lt;blockquote>
&lt;p>sponge(1) - soak up standard input and write to a file&lt;/p>
&lt;/blockquote>
&lt;p>Here&amp;rsquo;s a typical workflow &lt;code>sponge(1)&lt;/code> is great at:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Given a file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cat myfile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>a
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>b
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>c
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Imagine that for whatever reason we want to replace &amp;#39;a&amp;#39; with &amp;#39;b&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Naively, we could try this:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cat myfile | tr &lt;span style="color:#98c379">&amp;#39;a&amp;#39;&lt;/span> &lt;span style="color:#98c379">&amp;#39;b&amp;#39;&lt;/span> &amp;gt; myfile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cat myfile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># However the file becomes empty!&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># It got clobbered when we tried to simultenaously read from and write to it&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># sponge comes to the rescue!&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cat myfile | tr &lt;span style="color:#98c379">&amp;#39;a&amp;#39;&lt;/span> &lt;span style="color:#98c379">&amp;#39;b&amp;#39;&lt;/span> | sponge myfile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cat myfile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>b
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>b
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>c
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It is great to use &lt;code>sponge&lt;/code> in lieu of &lt;code>&amp;gt;&lt;/code> (shell output redirection) in shell pipelines when trying to both read from and write to the same file.&lt;/p>
&lt;h2 id="vidir">vidir&lt;/h2>
&lt;blockquote>
&lt;p>vidir(1) - edit directories and filenames&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>vidir(1)&lt;/code> is great to bulk rename files/directories within a given directory, one level at a time. For example, if I open &lt;code>vidir&lt;/code> at the top-level directory of this blog repository, it opens up &lt;code>vim&lt;/code> (although it doesn&amp;rsquo;t need to be &lt;code>vim&lt;/code>, your &lt;code>$EDITOR&lt;/code> is honoured) with the following content:&lt;/p>
&lt;pre tabindex="0">&lt;code>1	./.git
2	./.github
3	./.gitignore
4	./.gitmodules
5	./.hugo_build.lock
6	./LICENSE
7	./Makefile
8	./README.md
9	./archetypes
10	./config.yml
11	./content
12	./layouts
13	./public
14	./resources
15	./static
16	./themes
&lt;/code>&lt;/pre>&lt;p>If I make, say, the following modifications (lines 7 and 8):&lt;/p>
&lt;pre tabindex="0">&lt;code>1	./.git
2	./.github
3	./.gitignore
4	./.gitmodules
5	./.hugo_build.lock
6	./LICENSE
7	./GNUMakefile
8	./README.rst
9	./archetypes
10	./config.yml
11	./content
12	./layouts
13	./public
14	./resources
15	./static
16	./themes
&lt;/code>&lt;/pre>&lt;p>And then save and quit &lt;code>vim&lt;/code> (&lt;code>:wq&lt;/code>), then the effect would have been the same as:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ mv Makefile GNUMakefile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ mv README.md README.rst
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If I changed my mind and decided not to save the modifications, I could just do &lt;code>:cq&lt;/code>.&lt;/p>
&lt;p>It&amp;rsquo;s possible to leverage vim features such as &lt;code>.&lt;/code> (repeat command) and &lt;code>:%s/&lt;/code> (find and replace) to perform those mass file renames quickly and effectively. &lt;code>vidir&lt;/code> is a breeze to use!&lt;/p>
&lt;h2 id="ifne">ifne&lt;/h2>
&lt;blockquote>
&lt;p>ifne(1) - Run command if the standard input is not empty&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>ifne(1)&lt;/code> is effective when used with &lt;code>find&lt;/code> or &lt;code>fd&lt;/code> to keep shell pipes &amp;ldquo;happy&amp;rdquo;. Here&amp;rsquo;s one simple example:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ find . -name &lt;span style="color:#98c379">&amp;#39;*.cpp&amp;#39;&lt;/span> | xargs clang-format
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This should work as expected, but it&amp;rsquo;s cleaner to do:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ find . -name &lt;span style="color:#98c379">&amp;#39;*.cpp&amp;#39;&lt;/span> | ifne xargs clang-format
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The added &lt;code>ifne&lt;/code> ensures the &lt;code>xargs&lt;/code> command is only executed if and only if &lt;code>find&lt;/code> yields at least one result in its output.&lt;/p>
&lt;p>This wasn&amp;rsquo;t a very practical example though: a more realistic way to use &lt;code>ifne&lt;/code> is with prototypical on-the-fly manipulation of shell pipes wherein initially you just do whatever, but then whenever you notice some command in the middle of the pipe has failed because its input was empty (=the previous pipe command output was empty) you just prepend &lt;code>ifne&lt;/code> to it:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ this | is | a | complicated | pipe
# assume &amp;#34;complicated&amp;#34; fails because it has no input
# so we iterate and do:
$ this | is | a | ifne complicated | pipe
&lt;/code>&lt;/pre>&lt;h2 id="combine">combine&lt;/h2>
&lt;blockquote>
&lt;p>combine(1) - combine sets of lines from two files using boolean operations&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>combine(1)&lt;/code> is pretty much &lt;code>comm(1)&lt;/code>, but much more user-friendly. Given two files &lt;code>file1&lt;/code> and &lt;code>file2&lt;/code> it makes it easy to query which lines are {unique, common} to {each, both} files, using boolean operations (or, and, not, xor). Here&amp;rsquo;s one example to find the &lt;em>common lines&lt;/em> in &lt;em>both&lt;/em> files, compare &lt;code>combine&lt;/code> and &lt;code>comm&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ combine file1 and file2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ comm -12 file1 file2 &lt;span style="color:#7f848e"># flags are harder to remember&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>The Unix philosophy emphasizes building simple, short, clear, modular, and extensible code that can be easily maintained and repurposed by developers other than its creators. The Unix philosophy favors composability as opposed to monolithic design.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Linux: US International keyboard layout</title><link>https://perrotta.dev/2022/02/linux-us-international-keyboard-layout/</link><pubDate>Sun, 27 Feb 2022 22:47:09 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/02/linux-us-international-keyboard-layout/</guid><description>&lt;p>I use QWERTY keyboards with a US layout. Sometimes I need to type accents or
cedillas, and I keep forgetting how to do so, this post summarizes how to do it.&lt;/p>
&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>There are basically two layouts:&lt;/p>
&lt;ol>
&lt;li>US (&lt;em>&amp;lsquo;vanilla&amp;rsquo;&lt;/em>): type accents like &lt;code>'^`~&lt;/code> and they will be emitted immediately&lt;/li>
&lt;li>US International (INTL): accents are the so called &lt;a href="https://en.wikipedia.org/wiki/Dead_key">&amp;lsquo;dead keys&amp;rsquo;&lt;/a>:&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>A dead key is a special kind of a modifier key on a mechanical typewriter, or
computer keyboard, that is typically used to attach a specific diacritic to a
base letter.&lt;/p>
&lt;/blockquote>
&lt;p>We can switch between keyboard layouts with &lt;code>setxkbmap&lt;/code>. It&amp;rsquo;s also possible to
use &lt;code>localectl&lt;/code> in systemd-based distros, but its syntax is harder to remember
so I won&amp;rsquo;t even include it here.&lt;/p>
&lt;h2 id="set-us-vanilla-keyboard-layout">Set US &amp;lsquo;vanilla&amp;rsquo; keyboard layout&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ setxkbmap us
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This is what a standard QWERTY keyboard should use to type in English.&lt;/p>
&lt;h2 id="set-us-international-intl-keyboard-layout">Set US International (INTL) keyboard layout&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ setxkbmap -layout us -variant intl
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This is what a standard QWERTY keyboard&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> should use to type, for example, in Portuguese or in German.&lt;/p>
&lt;h3 id="portuguese">Portuguese&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>- á é í ó ú : &amp;#39; + &amp;lt;vowel&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- â ê î ô û : ^ + &amp;lt;vowel&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- ã õ : ~ + &amp;lt;vowel&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- à : ` + &amp;lt;vowel&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- ç (cedilla) : Alt Gr + , (Option + c on macOS)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="german">German&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>- ß (ss) : Alt Gr + s (Option + s on macOS)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>- ä ö ü : &amp;#34; + &amp;lt;vowel&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>Alt Gr is typically the Right Alt key.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Wayland: from i3 to sway</title><link>https://perrotta.dev/2022/02/wayland-from-i3-to-sway/</link><pubDate>Sat, 19 Feb 2022 19:18:25 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/02/wayland-from-i3-to-sway/</guid><description>&lt;p>I&amp;rsquo;ve been giving Wayland a try. My window manager of choice in X11/Xorg is &lt;a href="https://i3wm.org/">&lt;code>i3&lt;/code>&lt;/a>, so the natural choice in Wayland is &lt;a href="https://swaywm.org/">&lt;code>sway&lt;/code>&lt;/a>.&lt;/p>
&lt;h2 id="intro">Intro&lt;/h2>
&lt;p>&lt;code>sway&lt;/code> works well with the &lt;code>i3&lt;/code> config out-of-the-box. A few adjustments were necessary for full compatibility. To maximize code reuse, I went with the following structure:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ tree ~/.config/&lt;span style="color:#56b6c2">{&lt;/span>i3,sway&lt;span style="color:#56b6c2">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/home/typhoon/.config/i3
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── conf.d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ └── i3.conf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└── config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/home/typhoon/.config/sway
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>├── conf.d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>│ └── sway.conf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>└── config -&amp;gt; ../../../i3/.config/i3/config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>The master config is
&lt;a href="https://github.com/thiagowfx/.dotfiles/blob/master/i3/.config/i3/config">&lt;code>~/.config/i3/config&lt;/code>&lt;/a>.
It is pretty standard, generated by
&lt;a href="https://build.i3wm.org/docs/i3-config-wizard.html">&lt;code>i3-config-wizard&lt;/code>&lt;/a> with
a few tweaks on top for my own workflow. It works for both &lt;code>i3&lt;/code> and &lt;code>sway&lt;/code>.
The config contains this snippet:&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code># Load user configs if existing. Order is important.
include conf.d/*.conf
&lt;/code>&lt;/pre>&lt;p>The snippet allows drop-in customizations to live in &lt;code>conf.d&lt;/code>. The &lt;code>include&lt;/code> directive is a relatively &lt;a href="https://github.com/i3/i3/pull/4420">new&lt;/a> addition to the i3config syntax and it&amp;rsquo;s the main reason this setup is elegant and minimalist.&lt;/p>
&lt;ul>
&lt;li>i3-only config options live in &lt;a href="https://github.com/thiagowfx/.dotfiles/blob/master/i3/.config/i3/conf.d/i3.conf">&lt;code>~/.config/i3/conf.d/i3.conf&lt;/code>&lt;/a>. To give you an idea of what it looks like and which options aren&amp;rsquo;t compatible with &lt;code>sway&lt;/code>, here&amp;rsquo;s a snapshot of my config in early 2022:&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code class="language-conf" data-lang="conf"># i3(1) only config file
# Commands herein are not compatible or interoperable with sway(1)
# Reference: https://i3wm.org/docs/userguide.html

# Autostart XDG applications (.desktop files).
# https://wiki.archlinux.org/title/XDG_Autostart
#
# Troubleshooting:
# dex -ade i3
exec dex --autostart --environment i3

# lock screen, Ctrl+Alt+l (systemd)
exec --no-startup-id xss-lock -l -- i3lock -c 222222
bindsym Ctrl+Mod1+l exec loginctl lock-session

# XF86AudioPlayPause is not recognized by sway, add it only to i3
# https://github.com/swaywm/sway/issues/4783
bindsym XF86AudioPlayPause exec playerctl play-pause

# show window title icon
for_window [all] title_window_icon on

set $bgcolor #526532
set_from_resource $black i3.color0
set_from_resource $red i3.color1
set_from_resource $green i3.color2
set_from_resource $white i3.color7
set_from_resource $gray i3.color8

# Theme colors
client.focused $bgcolor $bgcolor $white $green
client.focused_inactive $gray $gray $black $gray
client.unfocused $black $black $gray $black
client.urgent $red $red $white $red

# Start i3bar to display a workspace and status bar
bar {
 status_command i3status
 position top
 workspace_min_width 25

 colors {
 background $black
 statusline $white

 focused_workspace $bgcolor $bgcolor $white $black
 active_workspace $gray $gray $black $gray
 inactive_workspace $black $black $gray $gray
 urgent_workspace $red $red $white $green
 }
}

# restart i3 inplace (preserves layout/session, can be used to upgrade i3)
bindsym $mod+Shift+r restart

# vim: ft=i3config
&lt;/code>&lt;/pre>&lt;p>It&amp;rsquo;s possible some of these configs will become compatible with &lt;code>sway&lt;/code> over time, but at the time of this writing they are not.&lt;/p>
&lt;ul>
&lt;li>sway-only config options live in &lt;a href="https://github.com/thiagowfx/.dotfiles/blob/master/sway/.config/sway/conf.d/sway.conf">&lt;code>~/.config/sway/conf.d/sway.conf&lt;/code>&lt;/a>. To give you an idea of what it looks like and which options aren&amp;rsquo;t compatible with i3, here&amp;rsquo;s a snapshot of my config in early 2022:&lt;/li>
&lt;/ul>
&lt;pre tabindex="0">&lt;code class="language-conf" data-lang="conf"># sway(1) only config file
# Commands herein are not compatible or interoperable with i3(1)
# References:
# sway(5)
# https://github.com/swaywm/sway/wiki
# https://github.com/swaywm/sway/wiki/Useful-add-ons-for-sway

# HiDPI
output &amp;#34;*&amp;#34; scale 1.5

# Wallpaper
output &amp;#34;*&amp;#34; bg ~/.wallpaper fill

# Gaps a la i3-gaps
gaps inner 10

# XF86AudioPlayPause is not recognized by sway: xmodmap -pke | grep XF86AudioPlay
# https://github.com/swaywm/sway/issues/4783
bindcode 172 exec playerctl play-pause

# Start i3bar to display a workspace and status bar
bar {
 status_command i3status
 position top
 workspace_min_width 25
}

# restart i3 inplace (preserves layout/session, can be used to upgrade i3)
bindsym $mod+Shift+r exec sway reload

# vim: ft=i3config
&lt;/code>&lt;/pre>&lt;p>Most of those are wayland-specific options.&lt;/p>
&lt;h2 id="quirks">Quirks&lt;/h2>
&lt;p>&lt;code>gaps&lt;/code> is available in &lt;code>i3&lt;/code> as well but only if you use
&lt;a href="https://github.com/Airblader/i3">&lt;code>i3-gaps&lt;/code>&lt;/a>, which generally I refuse to in
order to stay closer to vanilla/upstream &lt;code>i3&lt;/code>.&lt;/p>
&lt;p>The &lt;code>play-pause&lt;/code> multimedia key is
a &lt;a href="https://github.com/swaywm/sway/issues/4783">bug&lt;/a> I found on &lt;code>sway&lt;/code>. It&amp;rsquo;s quite
annoying, the workaround as you can see above is to use &lt;code>bindcode&lt;/code> instead of
&lt;code>bindsym&lt;/code>. For more details see the bug.&lt;/p>
&lt;p>In general &lt;code>sway&lt;/code> works very well out-of-the-box so long as you install
&lt;a href="https://wayland.freedesktop.org/xserver.html">XWayland&lt;/a> (&lt;code>xorg-xwayland&lt;/code> on
Arch Linux). XWayland &lt;strong>transparently&lt;/strong> proxies X11 apps to a X11 server that
runs inside wayland.&lt;/p>
&lt;p>It&amp;rsquo;s possible to detect those apps by running
&lt;a href="https://www.x.org/releases/X11R7.5/doc/man/man1/xprop.1.html">&lt;code>xprop&lt;/code>&lt;/a> and
trying to click a window: If you cannot do it, then the window is not a X11
app. Alternatively
&lt;a href="https://unix.stackexchange.com/questions/162769/what-is-the-purpose-of-xeyes">&lt;code>xeyes&lt;/code>&lt;/a>
is another way to detect them.&lt;/p>
&lt;p>To achieve a 100% Xorg/X11-free experience with pure wayland, just add
&lt;code>xwayland disable&lt;/code> to the &lt;code>sway&lt;/code> config. I wouldn&amp;rsquo;t recommend that though, most
Linux GUI apps aren&amp;rsquo;t Wayland ready and will probably never be. To put it
another way, X11/Xorg will take a long time (if ever) to disappear the same way
that IPv4 will take a long time (if ever) to let IPv6 completely replace it.
That&amp;rsquo;s life.&lt;/p>
&lt;p>X11 apps look a bit blurry in a 4K monitor with scaled DPI (&amp;gt;96) when they run
inside Wayland with XWayland. I am not particularly bothered by that, but it&amp;rsquo;s
noticeable.&lt;/p>
&lt;p>There&amp;rsquo;s no need to replace all of your small &lt;code>i3&lt;/code> Xorg utilities with wayland
ones. For example, &lt;a href="https://github.com/davatorium/rofi">&lt;code>rofi&lt;/code>&lt;/a> (application
launcher) works just fine (no need for &lt;code>wofi&lt;/code>). The stock &lt;code>i3&lt;/code> bar (&lt;code>sway&lt;/code> bar?)
works just fine, there&amp;rsquo;s no need for &lt;code>polybar&lt;/code> or &lt;code>waybar&lt;/code>.&lt;/p>
&lt;p>Some utilities need to be replaced though. For example, &lt;code>dunst&lt;/code> (notification
daemon) does not seem to work with &lt;code>sway&lt;/code> out-of-the-box, &lt;code>mako&lt;/code> seems to be a
recommended replacement. &lt;code>i3lock&lt;/code> (lock screen) also does not work, &lt;code>sway&lt;/code>
comes with its own screen lock directives. Screenshotters (e.g. &lt;code>scrot&lt;/code>) will
also need to be replaced.&lt;/p>
&lt;p>The system tray does not seem to work fine out-of-the-box. I haven&amp;rsquo;t
investigated much to figure out what&amp;rsquo;s wrong with it.&lt;/p>
&lt;p>I was looking for a display manager that works well with both X11 and Xorg and
ended up trying &lt;a href="https://git.sr.ht/~kennylevinsen/greetd">&lt;code>greetd&lt;/code>&lt;/a>,
&lt;a href="https://github.com/tvrzna/emptty/">&lt;code>emptty&lt;/code>&lt;/a> and
&lt;a href="https://github.com/fairyglade/ly">&lt;code>ly&lt;/code>&lt;/a>, in that order. &lt;code>ly&lt;/code> is in my opinion
the best one in terms of balancing simplicity and usefulness.&lt;/p>
&lt;p>&lt;code>sway&lt;/code> / &lt;code>XWayland&lt;/code> doesn&amp;rsquo;t source &lt;code>~/.Xresources&lt;/code>. This is an issue if you
rely on customizations therein. It does source &lt;code>~/.Xdefaults&lt;/code> though!
Leveraging this, I did the following changes:&lt;/p>
&lt;ul>
&lt;li>(i) &lt;code>~/.Xresources&lt;/code> sources &lt;code>~/.Xdefaults&lt;/code>:&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ cat ~/.Xresources
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! These settings apply to X11 only.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! Use ~/.Xdefaults &lt;span style="color:#c678dd">for&lt;/span> settings that apply to both X11 and Wayland &lt;span style="color:#56b6c2">(&lt;/span>xorg-xwayland&lt;span style="color:#56b6c2">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#include &amp;#34;.Xdefaults&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! Source:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! xrdb -merge ~/.Xresources
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! Dump all properties:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! xrdb -q
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! Check &lt;span style="color:#c678dd">if&lt;/span> DPI is set:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! xrdb -q | grep -i dpi
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! HiDPI
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! Common values:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! &lt;span style="color:#d19a66">96&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>x1.0, baseline&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! &lt;span style="color:#d19a66">144&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>x1.5&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! &lt;span style="color:#d19a66">192&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>x2.0, HiDPI&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>*.dpi: &lt;span style="color:#d19a66">144&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>(ii) &lt;code>~/.Xdefaults&lt;/code> holds my customizations that originally lived in &lt;code>~/.Xresources&lt;/code>:&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ cat ~/.Xdefaults
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! These settings apply to both X11 and Wayland &lt;span style="color:#56b6c2">(&lt;/span>xorg-xwayland&lt;span style="color:#56b6c2">)&lt;/span>.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>! Use ~/.Xresources &lt;span style="color:#c678dd">for&lt;/span> X11-only settings.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Xft.antialias: &lt;span style="color:#e5c07b">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Xft.hinting: &lt;span style="color:#e5c07b">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In principle I could just have symlinked them:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ ln -s ~/.Xresources ~/.Xdefaults
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The reason why I didn&amp;rsquo;t do it is to avoid double scaling (DPI). You see, my
&lt;code>sway&lt;/code> config already sets DPI / scaling to 1.5x. If we do that in
&lt;code>~/.Xdefaults&lt;/code> as well then Xorg applications would have been scaled twice.&lt;/p>
&lt;h2 id="closing-remarks">Closing remarks&lt;/h2>
&lt;p>In general Wayland / &lt;code>sway&lt;/code> works reasonably well out-of-the-box in 2022, but
tiny adjustments are still necessary, and it isn&amp;rsquo;t as polished as it could have
been. Furthermore, my workflow is very simple. Try sharing your screen in a
video call in Wayland and you&amp;rsquo;ll run into other quirks. I have mixed feelings
and wouldn&amp;rsquo;t necessarily recommend it. I wouldn&amp;rsquo;t give an anti recommendation
either. It&amp;rsquo;s complicated&amp;hellip;even though Wayland is supposed to overcome some X11
/ Xorg limitations, as a client and without knowing its internals I fail to see
its advantages.&lt;/p></description></item><item><title>nix-env in a nutshell for basic usage in macOS</title><link>https://perrotta.dev/2022/02/nix-env-in-a-nutshell-for-basic-usage-in-macos/</link><pubDate>Wed, 16 Feb 2022 20:48:02 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/02/nix-env-in-a-nutshell-for-basic-usage-in-macos/</guid><description>&lt;p>I am currently evaluating &lt;a href="https://nixos.org/download.html">Nix&lt;/a> as a
replacement for &lt;a href="https://brew.sh">Homebrew&lt;/a> CLI apps in macOS&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>.
&lt;a href="https://wickedchicken.github.io/post/macos-nix-setup/">Others&lt;/a>
&lt;a href="https://ianthehenry.com/posts/how-to-learn-nix/switching-from-homebrew-to-nix/">have&lt;/a>
&lt;a href="https://ghedam.at/15490/so-tell-me-about-nix">previously&lt;/a> written about this.&lt;/p>
&lt;p>My goal is to keep a sane learning curve and learn things on-the-fly, only as
needed. Nix is a massive ecosystem and has so many batteries included and
components (NixOS, NixPkgs, NixOps, Nix programming language, nix-shell,
nix-env, nix-darwin, home-manager, &amp;hellip;). The good news is that those components
are for the most part modular, there&amp;rsquo;s no need to adopt them all in order to
reap the benefits that Nix provides.&lt;/p>
&lt;p>For now, I am only adopting &lt;code>nix-env&lt;/code> and &lt;code>nix-shell&lt;/code>, with no &lt;code>*.nix&lt;/code> config
files. This post covers &lt;code>nix-env&lt;/code>.&lt;/p>
&lt;p>For simplicity, think of &lt;code>nix-env&lt;/code> as a package manager, akin to &lt;code>apk&lt;/code>,
&lt;code>pacman&lt;/code>, &lt;code>brew&lt;/code>, &lt;code>apt&lt;/code>, &lt;code>pkg&lt;/code>, etc.&lt;/p>
&lt;h2 id="install-a-package">Install a package&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env -i moreutils
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>installing &lt;span style="color:#98c379">&amp;#39;moreutils-0.67&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>building &lt;span style="color:#98c379">&amp;#39;/nix/store/jsp0l5ny3kx8p9lx9w9r0x159i9jjnn6-user-environment.drv&amp;#39;&lt;/span>...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>I see some guides using &lt;code>nix-env -iA&lt;/code> but &lt;code>-i&lt;/code> seems to suffice. We could
optionally specify the &lt;code>nixpkgs.&lt;/code> prefix:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env -i nixpkgs.moreutils
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>error: selector &lt;span style="color:#98c379">&amp;#39;nixpkgs.moreutils&amp;#39;&lt;/span> matches no derivations
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Oh no! Maybe that&amp;rsquo;s what the &lt;code>-A&lt;/code> is for?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env -iA nixpkgs.moreutils
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>replacing old &lt;span style="color:#98c379">&amp;#39;moreutils-0.67&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>installing &lt;span style="color:#98c379">&amp;#39;moreutils-0.67&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Indeed! Apparently that &lt;code>-A&lt;/code> thing stands for attribute. The only thing I know
is that there are both &lt;code>nixpkgs.*&lt;/code> and &lt;code>nixos.*&lt;/code>. But I don&amp;rsquo;t care about NixOS
at this point. I&amp;rsquo;ll just ignore &lt;code>-A&lt;/code> from now on, for the time being.&lt;/p>
&lt;h2 id="list-installed-packages">List installed packages&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env -q
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>moreutils-0.67
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Easy! This actually gets displayed in my &lt;code>less&lt;/code> pager.&lt;/p>
&lt;h2 id="upgrade-installed-packages">Upgrade installed packages&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env -u
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Easy! At this point, I am not super confident whether that works as intended
though. We will find out in a few days when there&amp;rsquo;s some update to one of my
installed CLI applications. I&amp;rsquo;ve heard there&amp;rsquo;s something called nix channel to
control that. Leaving it for another day though.&lt;/p>
&lt;p>&lt;strong>Update(2022-02-18)&lt;/strong>: I learned that &lt;code>nix-env -u&lt;/code> is akin to &lt;code>apt upgrade&lt;/code> or
&lt;code>apk upgrade&lt;/code>. It upgrades installed packages to newer versions but only if it
is aware there are newer versions. To actually refresh the repositories à la
&lt;code>apt update&lt;/code> or &lt;code>apk update&lt;/code>, use &lt;code>nix-channel --update&lt;/code>.&lt;/p>
&lt;p>&lt;strong>Note&lt;/strong>: On macOS this needs to be &lt;code>sudo -i nix-channel --update&lt;/code>. See
&lt;a href="https://github.com/NixOS/nix/issues/3595">issue&lt;/a>.&lt;/p>
&lt;h2 id="uninstall-a-package">Uninstall a package&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env --uninstall moreutils
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>uninstalling &lt;span style="color:#98c379">&amp;#39;moreutils-0.67&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>building &lt;span style="color:#98c379">&amp;#39;/nix/store/5k8rsf4cxg4iz7cqnqirpww6r97bwnqr-user-environment.drv&amp;#39;&lt;/span>...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Easy!&lt;/p>
&lt;h2 id="search-for-packages">Search for packages&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env -qaP &lt;span style="color:#98c379">&amp;#39;.*moreutils.*&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>.*&lt;/code> seems to be needed. It works if I omit them, but only if I write the exact package name (apparently called &amp;lsquo;derivation&amp;rsquo; in Nix):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env -qaP moreutils
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>nixpkgs.moreutils moreutils-0.67
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If I write the wrong package name, the following happens:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env -qaP moreutil
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>error: selector &lt;span style="color:#98c379">&amp;#39;moreutil&amp;#39;&lt;/span> matches no derivations, maybe you meant:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> moreutils
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It was helpful in this case, but I wouldn&amp;rsquo;t always count on that. It is a bit
annoying that there&amp;rsquo;s no &lt;code>nix search moreutils&lt;/code> command, but it seems that
&lt;code>nix-env&lt;/code> is very heavily tailored to use short flags, just like &lt;code>pacman&lt;/code> in
Arch Linux. I got used to &lt;code>pacman&lt;/code>, hopefully I can get used to the &lt;code>nix-env&lt;/code>
short flags at some point.&lt;/p>
&lt;p>Actually I tried it out and there is a &lt;code>nix search&lt;/code> command!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix search moreutils
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>error: experimental Nix feature &lt;span style="color:#98c379">&amp;#39;nix-command&amp;#39;&lt;/span> is disabled; use &lt;span style="color:#98c379">&amp;#39;--extra-experimental-features nix-command&amp;#39;&lt;/span> to override
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This isn&amp;rsquo;t very promising though. How come searching is experimental?! Anyway, I can live with the &lt;code>nix-env&lt;/code> form for now.&lt;/p>
&lt;p>These are the 5 basic package management operations that I needed to bootstrap
my dev environment. Without putting much effort on it, my initial list of package
looks like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-env -q
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>atool-0.39.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>bash-interactive-5.1-p12
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>coreutils-9.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>exa-0.10.1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>fpp-0.9.2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>fzf-0.29.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>git-2.34.1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>htop-3.1.2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>hugo-0.92.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>jq-1.6
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>less-600
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>moreutils-0.67
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ncdu-1.16
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>perl5.34.0-ack-3.5.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ranger-1.9.3
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>stow-2.3.1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>tmux-3.2a
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>tree-1.8.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vim-8.2.4186
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>watch-procps-3.3.16
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wget-1.21.2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>zoxide-0.8.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Those were very intuitive to find, with the exception of &lt;code>ack&lt;/code> and &lt;code>bash-interactive&lt;/code>:&lt;/p>
&lt;ul>
&lt;li>&lt;code>bash&lt;/code> is a bit odd because Nix splits it into two packages:
a non-interactive version and an interactive version. I have no idea why. My
&lt;code>~/.bashrc&lt;/code> wrecked havoc with the non-interactive version.&lt;/li>
&lt;li>&lt;code>ack&lt;/code> is very oddly named. Really. Also: &lt;code>nix-env -i ack&lt;/code> doesn&amp;rsquo;t work, but
&lt;code>nix-env -iA nixpkgs.ack&lt;/code> does. I suspect it will be hard to ignore &lt;code>-A&lt;/code> in
the future.&lt;/li>
&lt;/ul>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>Strictly speaking there&amp;rsquo;s nothing special about macOS in this context.
The same setup can also be used in Linux distributions, for example, &lt;a href="https://ariya.io/2020/05/nix-package-manager-on-ubuntu-or-debian">Debian
or Ubuntu&lt;/a>.
In fact, this is what I did at $DAYJOB, because relying solely on Debian for
package management is a very big limitation. I find that Nix complements the
Debian repositories very well, the same way that it does for macOS.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>SSH plus tmux automatically</title><link>https://perrotta.dev/2022/02/ssh-plus-tmux-automatically/</link><pubDate>Sun, 13 Feb 2022 20:20:27 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/02/ssh-plus-tmux-automatically/</guid><description>&lt;p>One of the most classic sysadmin/DevOps tasks is to use secure shell to connect to remote machines.&lt;/p>
&lt;p>To persist those connections, a terminal multiplexer is often used, &lt;code>tmux&lt;/code> and &lt;code>screen&lt;/code> being the two most popular ones.&lt;/p>
&lt;p>In this post I will cover a few different client-side and server-side ways to have &lt;code>ssh&lt;/code> automatically spawn &lt;code>tmux&lt;/code> upon connection.&lt;/p>
&lt;h2 id="option-1-use-command-line-ssh-flags-client-side-recommended">Option #1: Use command-line ssh flags (client-side, recommended)&lt;/h2>
&lt;p>Start &lt;code>tmux&lt;/code>, forcing unicode, attaching to and/or creating a session named &lt;em>main&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ ssh user@host -t -- tmux -u new -A -s main
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>-u&lt;/code> is not strictly necessary, however I experienced occasional weirdness when connecting to some machines and omitting it. Some unicode characters wouldn&amp;rsquo;t be properly rendered, like the horizontal and vertical lines used to render tmux pane splits. Even though most machines should work just fine these days by supporting UTF-8 out-of-the-box, it&amp;rsquo;s safer to always include &lt;code>-u&lt;/code> just in case.&lt;/p>
&lt;p>Tip: If it&amp;rsquo;s annoying to remember to type the full command above, consider adding an &lt;code>alias&lt;/code> in your shell config. Alternatively, use a ssh client that remembers your flags preferences such as the &lt;a href="https://chrome.google.com/webstore/detail/secure-shell/iodihamcpbpeioajjeobimgagajmlibd?hl=en">chrome secure shell&lt;/a> extension.&lt;/p>
&lt;h2 id="option-2-use-sshconfig-client-side">Option #2: Use &lt;code>~/.ssh/config&lt;/code> (client-side)&lt;/h2>
&lt;p>This option is very similar to the previous one, but the flags live in the ssh config rather then being specified at the command line:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ cat ~/.ssh/config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Host *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> RequestTTY yes
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> RemoteCommand tmux -u new -A -s main
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>You don&amp;rsquo;t need to match all hosts (&lt;code>Host *&lt;/code>), if you&amp;rsquo;d rather match one or more specific hosts, refer to the ssh config syntax &lt;code>ssh_config(5)&lt;/code> to add them. A simple example would be &lt;code>Host mymachine.example.org&lt;/code>.&lt;/p>
&lt;p>&lt;strong>Caveat&lt;/strong>: I&amp;rsquo;ve found this method interferes with &lt;code>git&lt;/code> + &lt;code>ssh&lt;/code> authentication. More specifically:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ git remote -v
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>origin	git@github.com:thiagowfx/.dotfiles.git &lt;span style="color:#56b6c2">(&lt;/span>fetch&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>origin	git@github.com:thiagowfx/.dotfiles.git &lt;span style="color:#56b6c2">(&lt;/span>push&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ git push
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Cannot execute command-line and remote command.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>fatal: Could not &lt;span style="color:#e5c07b">read&lt;/span> from remote repository.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Please make sure you have the correct access rights
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>and the repository exists.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Therefore I discourage it, unless you only use it with specific hosts i.e. don&amp;rsquo;t use it with &lt;code>Host *&lt;/code>.&lt;/p>
&lt;h2 id="option-3-use-bash_profile-or-similar-server-side-recommended">Option #3: Use &lt;code>~/.bash_profile&lt;/code> or similar (server-side, recommended)&lt;/h2>
&lt;p>This method leverages your login shell startup config file (&lt;code>~/.bash_profile&lt;/code>, &lt;code>~/.zprofile&lt;/code>, etc) to automatically spawn &lt;code>tmux&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># This file is invoked as part of my ~/.bash_profile.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cat ~/.profile.d/tmux_auto_ssh.sh.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Automatically spawn tmux within ssh sessions for interactive terminals.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># https://stackoverflow.com/a/43819740/1745064&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># The session is called `main`.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Create a session with PREFIX :new, rename with PREFIX $, toggle with PREFIX s.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Escape hatch:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># ssh &amp;lt;host&amp;gt; -t -- NOTMUX=1 &amp;lt;shell&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">if&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span> -z &lt;span style="color:#98c379">&amp;#34;&lt;/span>&lt;span style="color:#e06c75">$NOTMUX&lt;/span>&lt;span style="color:#98c379">&amp;#34;&lt;/span> &lt;span style="color:#56b6c2">]&lt;/span> &lt;span style="color:#56b6c2">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span> -z &lt;span style="color:#98c379">&amp;#34;&lt;/span>&lt;span style="color:#e06c75">$TMUX&lt;/span>&lt;span style="color:#98c379">&amp;#34;&lt;/span> &lt;span style="color:#56b6c2">]&lt;/span> &lt;span style="color:#56b6c2">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#56b6c2">[&lt;/span> -n &lt;span style="color:#98c379">&amp;#34;&lt;/span>&lt;span style="color:#e06c75">$SSH_TTY&lt;/span>&lt;span style="color:#98c379">&amp;#34;&lt;/span> &lt;span style="color:#56b6c2">]&lt;/span> &lt;span style="color:#56b6c2">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#56b6c2">[[&lt;/span> &lt;span style="color:#e06c75">$-&lt;/span> &lt;span style="color:#56b6c2">=&lt;/span>~ i &lt;span style="color:#56b6c2">]]&lt;/span>; &lt;span style="color:#c678dd">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tmux -u new -A -s main
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e5c07b">exit&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">fi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>if&lt;/code> basically checks:&lt;/p>
&lt;ul>
&lt;li>whether we&amp;rsquo;re not already inside a tmux session (we shouldn&amp;rsquo;t be), so that we don&amp;rsquo;t nest &lt;code>tmux&lt;/code>&lt;/li>
&lt;li>whether we&amp;rsquo;re accessing the shell via &lt;code>ssh&lt;/code> (we should be)&lt;/li>
&lt;li>whether we&amp;rsquo;re accessing an interactive shell (we should be), so that it doesn&amp;rsquo;t interfere with oneshot &lt;code>ssh&lt;/code> commands&lt;/li>
&lt;/ul>
&lt;p>There&amp;rsquo;s also a escape hatch. If you want to get an interactive shell but bypass &lt;code>tmux&lt;/code> for some reason&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>, just set &lt;code>NOTMUX=1&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ ssh user@host -t -- &lt;span style="color:#e06c75">NOTMUX&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">1&lt;/span> bash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="final-remarks">Final remarks&lt;/h2>
&lt;p>My favorite methods are #1 and #3, and whether I use one or the other depends whether I want to unconditionally spawn &lt;code>tmux&lt;/code> server-side, or selectively spawn &lt;code>tmux&lt;/code> client-side.&lt;/p>
&lt;p>When using chrome secure shell (hterm) I find #1 convenient because hterm remembers your &lt;code>ssh&lt;/code> host settings. That said, in scenarios where I fully control a host and it&amp;rsquo;s not solely used for production, #3 is my favorite as it works unconditionally regardless of the client terminal emulator I am using.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>For example, maybe if &lt;code>tmux&lt;/code> broke due to a recent upgrade, or if the &lt;code>~/.tmux.conf&lt;/code> is invalid.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>nix-shell in a nutshell</title><link>https://perrotta.dev/2022/02/nix-shell-in-a-nutshell/</link><pubDate>Thu, 10 Feb 2022 20:48:02 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/02/nix-shell-in-a-nutshell/</guid><description>&lt;p>As soon as we finish installing &lt;a href="https://nixos.org/download.html">&lt;code>Nix&lt;/code>&lt;/a> on
Darwin, we&amp;rsquo;re greeted with a call to action:&lt;/p>
&lt;pre tabindex="0">&lt;code>Alright! We&amp;#39;re done!
Try it! Open a new terminal, and type:

 $ nix-shell -p nix-info --run &amp;#34;nix-info -m&amp;#34;

Thank you for using this installer. If you have any feedback or need
help, don&amp;#39;t hesitate:

You can open an issue at https://github.com/nixos/nix/issues
&lt;/code>&lt;/pre>&lt;h2 id="hello-world-bloated">Hello world (bloated)&lt;/h2>
&lt;p>All right then, let&amp;rsquo;s do it!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-shell -p nix-info --run &lt;span style="color:#98c379">&amp;#34;nix-info -m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - system: &lt;span style="color:#98c379">`&lt;/span>&lt;span style="color:#98c379">&amp;#34;aarch64-darwin&amp;#34;&lt;/span>&lt;span style="color:#98c379">`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - host os: &lt;span style="color:#98c379">`&lt;/span>Darwin 21.3.0, macOS 12.2&lt;span style="color:#98c379">`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - multi-user?: &lt;span style="color:#98c379">`&lt;/span>yes&lt;span style="color:#98c379">`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - sandbox: &lt;span style="color:#98c379">`&lt;/span>no&lt;span style="color:#98c379">`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - version: &lt;span style="color:#98c379">`&lt;/span>nix-env &lt;span style="color:#56b6c2">(&lt;/span>Nix&lt;span style="color:#56b6c2">)&lt;/span> 2.6.0&lt;span style="color:#98c379">`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - channels&lt;span style="color:#56b6c2">(&lt;/span>root&lt;span style="color:#56b6c2">)&lt;/span>: &lt;span style="color:#98c379">`&lt;/span>&lt;span style="color:#98c379">&amp;#34;nixpkgs&amp;#34;&lt;/span>&lt;span style="color:#98c379">`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - nixpkgs: &lt;span style="color:#98c379">`&lt;/span>/nix/var/nix/profiles/per-user/root/channels/nixpkgs&lt;span style="color:#98c379">`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Cool, it works. Let&amp;rsquo;s break it down a bit.&lt;/p>
&lt;h2 id="hello-world-classic">Hello world (classic)&lt;/h2>
&lt;p>Nix shell creates an ephemeral shell environment with the customizations you
want. The most basic customization is to make a given set of packages
available. There&amp;rsquo;s a &lt;code>hello&lt;/code> package:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-shell -p hello
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ hello
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hello, world!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In case you&amp;rsquo;re curious, this is a GNU binary:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ hello --version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>hello &lt;span style="color:#56b6c2">(&lt;/span>GNU Hello&lt;span style="color:#56b6c2">)&lt;/span> 2.10
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Copyright &lt;span style="color:#56b6c2">(&lt;/span>C&lt;span style="color:#56b6c2">)&lt;/span> &lt;span style="color:#d19a66">2014&lt;/span> Free Software Foundation, Inc.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>License GPLv3+: GNU GPL version &lt;span style="color:#d19a66">3&lt;/span> or later &amp;lt;http://gnu.org/licenses/gpl.html&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>This is free software: you are free to change and redistribute it.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>There is NO WARRANTY, to the extent permitted by law.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>I have no idea why they are in version 2.10 and what their changelog is. It&amp;rsquo;s
such a simple binary&amp;hellip;&lt;/p>
&lt;p>If you exit the shell, &lt;code>hello&lt;/code> seemingly vanishes:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ exit
exit
$ hello
zsh: command not found: hello
&lt;/code>&lt;/pre>&lt;p>An easy way to think of &lt;code>nix-shell&lt;/code> is like an ephemeral sandbox where all your
desired packages are made available when you enter it. It&amp;rsquo;s possible to provide
more than one package, naturally. It&amp;rsquo;s also possible to provide a &lt;code>shell.nix&lt;/code>
file with the package declarations, so that when you can &lt;code>nix-shell&lt;/code> without
any arguments.&lt;/p>
&lt;pre tabindex="0">&lt;code>$ cat shell.nix
{ pkgs ? import &amp;lt;nixpkgs&amp;gt; {} }:
 pkgs.mkShell {
 # nativeBuildInputs is usually what you want – tools you need to run
 nativeBuildInputs = [ pkgs.buildPackages.hello ];
}
$ nix-shell
$ hello
Hello, world!
&lt;/code>&lt;/pre>&lt;h2 id="hello-world-oneshot">Hello world (oneshot)&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ nix-shell -p hello --run hello
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hello, world!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This oneshot style doesn&amp;rsquo;t enter the shell, it just runs the given &lt;code>--run&lt;/code>
command and then exits.&lt;/p>
&lt;p>This post just scratched the surface of what &lt;code>nix-shell&lt;/code> can do. See the
references below for more in-depth guides about it.&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://cuddly-octo-palm-tree.com/posts/2021-12-19-tyska-nix-shell/">Tools You Should Know About: nix-shell&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://ghedam.at/15978/an-introduction-to-nix-shell">An introduction to nix-shell&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://nixos.org/manual/nix/stable/command-ref/nix-shell.html">NixOS manual: &lt;code>nix-shell&lt;/code>&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Doas: bridging the sudo gap</title><link>https://perrotta.dev/2022/02/doas-bridging-the-sudo-gap/</link><pubDate>Mon, 07 Feb 2022 14:49:03 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/02/doas-bridging-the-sudo-gap/</guid><description>&lt;p>&lt;a href="https://man.openbsd.org/doas">&lt;code>doas&lt;/code>&lt;/a> is a lightweight and safer replacement for &lt;code>sudo&lt;/code>. In most occasions you invoke it exactly like &lt;code>sudo&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ sudo apt install &amp;lt;foo&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ doas apt install &amp;lt;foo&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>doas&lt;/code> has gained popularity recently. Besides being the default in OpenBSD, Alpine Linux 3.15 (released last year) has also &lt;a href="https://wiki.alpinelinux.org/wiki/Release_Notes_for_Alpine_3.15.0#Move_from_sudo_to_doas">switched to it&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>doas&lt;/code> is the default temporary privilege escalation tool. You are advised to migrate from &lt;code>sudo&lt;/code> to &lt;code>doas&lt;/code> as 3.15 will be the last release to support &lt;code>sudo&lt;/code> throughout its full lifecycle, in 3.16 &lt;code>sudo&lt;/code> will be moved from main to community.&lt;/p>
&lt;/blockquote>
&lt;p>It&amp;rsquo;s not very difficult to get used to it, however you may still find yourself writing &lt;code>sudo&lt;/code> occasionally. This post highlights a few ways to bridge that gap.&lt;/p>
&lt;h2 id="use-a-shell-alias">Use a shell alias&lt;/h2>
&lt;p>In your &lt;code>~/.bashrc&lt;/code> or &lt;code>~/.zshrc&lt;/code> or in your favorite shell, do:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">alias&lt;/span> &lt;span style="color:#e06c75">sudo&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>doas
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Caveat: Besides being an user-dependent workaround&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>, &lt;code>doas&lt;/code> isn&amp;rsquo;t really a full drop-in replacement to &lt;code>sudo&lt;/code>. This workaround will work in most day-to-day situations but it will obviously not support most &lt;code>sudo&lt;/code> specific flags.&lt;/p>
&lt;h2 id="use-a-shimwrapper-recommended">Use a shim/wrapper (recommended)&lt;/h2>
&lt;p>Alpine Linux provides a &lt;a href="https://pkgs.alpinelinux.org/package/edge/main/x86_64/doas-sudo-shim">&lt;code>doas-sudo-shim&lt;/code>&lt;/a> package:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ doas apk add doas-sudo-shim
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>This is a shim for the &lt;code>sudo&lt;/code> command that utilizes &lt;code>doas&lt;/code>. It supports only a subset of the &lt;code>sudo&lt;/code> options (both short and long variants) that have an equivalent in &lt;code>doas&lt;/code>, plus option &lt;code>-i&lt;/code> (&lt;code>--login&lt;/code>).&lt;/p>
&lt;/blockquote>
&lt;p>This is a slightly better solution, as this thin wrapper is aware of some &lt;code>sudo&lt;/code> flags, translating them to the equivalent &lt;code>doas&lt;/code> ones; furthermore, it works out-of-the-box and it&amp;rsquo;s system-wide. As an added bonus, it&amp;rsquo;s implemented entirely in shell script, being as much portable as possible.&lt;/p>
&lt;h2 id="final-remarks">Final remarks&lt;/h2>
&lt;p>Last but not least, you could choose to install &lt;code>sudo&lt;/code> and configure it, keeping both &lt;code>doas&lt;/code> and &lt;code>sudo&lt;/code>, but what&amp;rsquo;s the point? If your system favours &lt;code>doas&lt;/code>, stick to &lt;code>doas&lt;/code>. There&amp;rsquo;s no need to unnecessarily increase complexity by keeping around two programs that serve exactly the same purpose.&lt;/p>
&lt;p>If you don&amp;rsquo;t like or want &lt;code>doas&lt;/code> for some reason, you could look into the other way around: find a &lt;code>doas&lt;/code> shim that bridges to &lt;code>sudo&lt;/code>, or define an alias: &lt;code>$ alias doas=sudo&lt;/code>.&lt;/p>
&lt;p>The best long-term solution though would be to just use &lt;code>doas&lt;/code> without any alias or shim, but our muscle memory may have trouble adapting to that, especially when &lt;code>sudo&lt;/code> is still the &lt;em>de facto standard&lt;/em> in most Linux distributions out there these days.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>To make it system-wide, change the relevant file in &lt;code>/etc&lt;/code>: for example, &lt;code>/etc/bashrc&lt;/code> for &lt;code>bash&lt;/code>. I would advise against it though.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Transfer bash history to zsh</title><link>https://perrotta.dev/2022/02/transfer-bash-history-to-zsh/</link><pubDate>Fri, 04 Feb 2022 21:58:50 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/02/transfer-bash-history-to-zsh/</guid><description>&lt;p>After years of using &lt;code>bash&lt;/code> as my default interactive shell at $DAYJOB,
I decided to switch to &lt;code>zsh&lt;/code>. I didn&amp;rsquo;t want to start from scratch and lose all
my history though:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ wc -l ~/.bash_history | cut -f1 -d&lt;span style="color:#98c379">&amp;#39; &amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d19a66">64002&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Thus my goal was to first migrate all my history from &lt;code>bash&lt;/code> to &lt;code>zsh&lt;/code>.&lt;/p>
&lt;p>The &lt;code>bash-to-zsh-hist.py&lt;/code> python script in this
&lt;a href="https://gist.github.com/muendelezaji/c14722ab66b505a49861b8a74e52b274">gist&lt;/a>
did most of the job:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#!/usr/bin/env python&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># -*- coding: utf-8 -*-&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># This is how I used it:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># $ cat ~/.bash_history | python bash-to-zsh-hist.py &amp;gt;&amp;gt; ~/.zsh_history&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">import&lt;/span> &lt;span style="color:#e06c75">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">import&lt;/span> &lt;span style="color:#e06c75">time&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">def&lt;/span> &lt;span style="color:#61afef;font-weight:bold">main&lt;/span>():
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">timestamp&lt;/span> &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#e5c07b">None&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">for&lt;/span> &lt;span style="color:#e06c75">line&lt;/span> &lt;span style="color:#56b6c2">in&lt;/span> &lt;span style="color:#e06c75">sys&lt;/span>&lt;span style="color:#56b6c2">.&lt;/span>&lt;span style="color:#e06c75">stdin&lt;/span>&lt;span style="color:#56b6c2">.&lt;/span>&lt;span style="color:#e06c75">readlines&lt;/span>():
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">line&lt;/span> &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#e06c75">line&lt;/span>&lt;span style="color:#56b6c2">.&lt;/span>&lt;span style="color:#e06c75">rstrip&lt;/span>(&lt;span style="color:#98c379">&amp;#39;&lt;/span>&lt;span style="color:#98c379">\n&lt;/span>&lt;span style="color:#98c379">&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">if&lt;/span> &lt;span style="color:#e06c75">line&lt;/span>&lt;span style="color:#56b6c2">.&lt;/span>&lt;span style="color:#e06c75">startswith&lt;/span>(&lt;span style="color:#98c379">&amp;#39;#&amp;#39;&lt;/span>) &lt;span style="color:#56b6c2">and&lt;/span> &lt;span style="color:#e06c75">timestamp&lt;/span> &lt;span style="color:#56b6c2">is&lt;/span> &lt;span style="color:#e5c07b">None&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">t&lt;/span> &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#e06c75">line&lt;/span>[&lt;span style="color:#d19a66">1&lt;/span>:]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">if&lt;/span> &lt;span style="color:#e06c75">t&lt;/span>&lt;span style="color:#56b6c2">.&lt;/span>&lt;span style="color:#e06c75">isdigit&lt;/span>():
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">timestamp&lt;/span> &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#e06c75">t&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#c678dd">else&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">sys&lt;/span>&lt;span style="color:#56b6c2">.&lt;/span>&lt;span style="color:#e06c75">stdout&lt;/span>&lt;span style="color:#56b6c2">.&lt;/span>&lt;span style="color:#e06c75">write&lt;/span>(&lt;span style="color:#98c379">&amp;#39;: &lt;/span>&lt;span style="color:#98c379">%s&lt;/span>&lt;span style="color:#98c379">:0;&lt;/span>&lt;span style="color:#98c379">%s&lt;/span>&lt;span style="color:#98c379">\n&lt;/span>&lt;span style="color:#98c379">&amp;#39;&lt;/span> &lt;span style="color:#56b6c2">%&lt;/span> (&lt;span style="color:#e06c75">timestamp&lt;/span> &lt;span style="color:#56b6c2">or&lt;/span> &lt;span style="color:#e06c75">time&lt;/span>&lt;span style="color:#56b6c2">.&lt;/span>&lt;span style="color:#e06c75">time&lt;/span>(), &lt;span style="color:#e06c75">line&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">timestamp&lt;/span> &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#e5c07b">None&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c678dd">if&lt;/span> &lt;span style="color:#e06c75">__name__&lt;/span> &lt;span style="color:#56b6c2">==&lt;/span> &lt;span style="color:#98c379">&amp;#39;__main__&amp;#39;&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e06c75">main&lt;/span>()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>To use it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ wget https://gist.githubusercontent.com/muendelezaji/c14722ab66b505a49861b8a74e52b274/raw/49f0fb7f661bdf794742257f58950d209dd6cb62/bash-to-zsh-hist.py
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ chmod +x ./bash-to-zsh-hist.py
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ cat .bash_history | ./bash-to-zsh-hist.py &amp;gt;&amp;gt; ~/.zsh_history
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>However, that didn&amp;rsquo;t fully work. Upon running &lt;code>zsh&lt;/code>, there was an error:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ zsh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>zsh: corrupt &lt;span style="color:#e5c07b">history&lt;/span> file /usr/local/google/home/tperrotta/.zsh_history
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>A quick google search led me to &lt;a href="https://shapeshed.com/zsh-corrupt-history-file/">a blog post&lt;/a>. I adapted the command suggest therein&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ strings -eS .zsh_history | sponge .zsh_history
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And that fixed the issue!&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>&lt;code>sponge&lt;/code> comes from the &lt;a href="https://joeyh.name/code/moreutils/">moreutils&lt;/a> package.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Linux swap shenanigans</title><link>https://perrotta.dev/2022/02/linux-swap-shenanigans/</link><pubDate>Tue, 01 Feb 2022 17:03:13 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/02/linux-swap-shenanigans/</guid><description>&lt;p>In this post we will cover a few linux swap recipes.&lt;/p>
&lt;h2 id="empty-swap-space">Empty swap space&lt;/h2>
&lt;p>Completely empty (&lt;em>flush&lt;/em>) swap space:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% swapoff --all &lt;span style="color:#56b6c2">&amp;amp;&amp;amp;&lt;/span> swapon --all
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="decrease-swappiness">Decrease swappiness&lt;/h2>
&lt;p>Emptying is too extreme. Why did you get so much swap in the first place?
A small tweak is to decrease the sensibility of the system to swap:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ cat /etc/sysctl.d/90-custom.conf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vm.swappiness&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">20&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vm.vfs_cache_pressure&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">50&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The default swappiness of the Linux kernel these days is 60%, which IMHO is
quite aggressive for desktop usage. By decreasing it to 20%, our system will
only start to swap once we use more than 80% of total RAM. In other words, only
when there is 20% or less of free / available RAM.&lt;/p>
&lt;p>&lt;a href="https://www.kernel.org/doc/Documentation/sysctl/vm.txt">&lt;code>vfs_cache_pressure&lt;/code>&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>This percentage value controls the tendency of the kernel to reclaim the
memory which is used for caching of directory and inode objects.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>At the default value of vfs_cache_pressure=100 the kernel will attempt to
reclaim dentries and inodes at a &amp;ldquo;fair&amp;rdquo; rate with respect to pagecache and
swapcache reclaim. Decreasing vfs_cache_pressure causes the kernel to prefer
to retain dentry and inode caches. When vfs_cache_pressure=0, the kernel will
never reclaim dentries and inodes due to memory pressure and this can easily
lead to out-of-memory conditions. Increasing vfs_cache_pressure beyond 100
causes the kernel to prefer to reclaim dentries and inodes.&lt;/p>
&lt;/blockquote>
&lt;p>However, &lt;code>/etc/sysctl.d&lt;/code> settings will only be applied after a reboot. To apply
them immediately, use the &lt;code>sysctl(8)&lt;/code> command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% sudo sysctl -p /etc/sysctl.d/90-custom.conf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vm.swappiness &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#d19a66">20&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>vm.vfs_cache_pressure &lt;span style="color:#56b6c2">=&lt;/span> &lt;span style="color:#d19a66">50&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="use-a-swapfile">Use a swapfile&lt;/h2>
&lt;p>If you find yourself with a fully partitioned disk without any dedicated swap
partition, there&amp;rsquo;s a trick to adding swap anyway: Use a swap file! &lt;a href="https://en.wikipedia.org/wiki/Everything_is_a_file">Everything is
a file&lt;/a> anyway!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># https://wiki.archlinux.org/title/Swap#Swap_file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Create the swap file: 8GiB in this case, to match our total RAM&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% dd &lt;span style="color:#c678dd">if&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>/dev/zero &lt;span style="color:#e06c75">of&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>/swapfile &lt;span style="color:#e06c75">bs&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>1M &lt;span style="color:#e06c75">count&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">8000&lt;/span> &lt;span style="color:#e06c75">status&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>progress
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Set restricting permissions&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% chmod &lt;span style="color:#d19a66">600&lt;/span> /swapfile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Format the ~~partition~~ file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% mkswap /swapfile
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Activate the swap file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% swapon /swapfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>You can check it&amp;rsquo;s working correctly by inspecting &lt;code>/proc/swaps&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% cat /proc/swaps
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Filename				Type		Size		Used		Priority
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/swapfile file		8388604		0		-2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then finally add it to your &lt;code>/etc/fstab&lt;/code> so that it is automatically mounted in subsequent boots:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># swap file&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/swapfile none swap defaults &lt;span style="color:#d19a66">0&lt;/span> &lt;span style="color:#d19a66">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="add-zram-swap">Add ZRAM swap&lt;/h2>
&lt;p>Explaining &lt;code>zram&lt;/code> is out of scope if this post, but check out the
&lt;a href="https://wiki.archlinux.org/title/Improving_performance#zram_or_zswap">ArchWiki&lt;/a>
or &lt;a href="https://en.wikipedia.org/wiki/Zram">Wikipedia&lt;/a>.&lt;/p>
&lt;p>The recipe I use in Arch Linux is the &lt;a href="https://aur.archlinux.org/packages/zramswap/">&lt;code>zramswap&lt;/code>&lt;/a> package:&lt;/p>
&lt;ol>
&lt;li>Install the package.&lt;/li>
&lt;li>Set desired zram swap percentage, I picked 20%:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% cat /etc/zramswap.conf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">ZRAM_SIZE_PERCENT&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">20&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>Enable/Start the service:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% systemctl &lt;span style="color:#e5c07b">enable&lt;/span> --now zramswap
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>% systemctl status zramswap
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>● zramswap.service - Zram-based swap &lt;span style="color:#56b6c2">(&lt;/span>compressed RAM block devices&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Loaded: loaded &lt;span style="color:#56b6c2">(&lt;/span>/usr/lib/systemd/system/zramswap.service; enabled; vendor preset: disabled&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Active: active &lt;span style="color:#56b6c2">(&lt;/span>exited&lt;span style="color:#56b6c2">)&lt;/span> since Tue 2022-02-01 16:13:37 EST; 7h ago
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Main PID: &lt;span style="color:#d19a66">582&lt;/span> &lt;span style="color:#56b6c2">(&lt;/span>&lt;span style="color:#e06c75">code&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>exited, &lt;span style="color:#e06c75">status&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>0/SUCCESS&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPU: 27ms
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Feb &lt;span style="color:#d19a66">01&lt;/span> 16:13:37 localhost.localdomain systemd&lt;span style="color:#56b6c2">[&lt;/span>1&lt;span style="color:#56b6c2">]&lt;/span>: Starting Zram-based swap &lt;span style="color:#56b6c2">(&lt;/span>compressed RAM block devices&lt;span style="color:#56b6c2">)&lt;/span>...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Feb &lt;span style="color:#d19a66">01&lt;/span> 16:13:37 localhost.localdomain zramctrl&lt;span style="color:#56b6c2">[&lt;/span>627&lt;span style="color:#56b6c2">]&lt;/span>: Setting up swapspace version 1, &lt;span style="color:#e06c75">size&lt;/span> &lt;span style="color:#56b6c2">=&lt;/span> 1.5 GiB &lt;span style="color:#56b6c2">(&lt;/span>&lt;span style="color:#d19a66">1654009856&lt;/span> bytes&lt;span style="color:#56b6c2">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Feb &lt;span style="color:#d19a66">01&lt;/span> 16:13:37 localhost.localdomain zramctrl&lt;span style="color:#56b6c2">[&lt;/span>627&lt;span style="color:#56b6c2">]&lt;/span>: &lt;span style="color:#e06c75">LABEL&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>zram0, &lt;span style="color:#e06c75">UUID&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>a39e0131-f102-4503-a1e7-a3e0ca330126
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Feb &lt;span style="color:#d19a66">01&lt;/span> 16:13:37 localhost.localdomain systemd&lt;span style="color:#56b6c2">[&lt;/span>1&lt;span style="color:#56b6c2">]&lt;/span>: Finished Zram-based swap &lt;span style="color:#56b6c2">(&lt;/span>compressed RAM block devices&lt;span style="color:#56b6c2">)&lt;/span>.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>You can inspect &lt;code>/proc/swaps&lt;/code> again to check it&amp;rsquo;s working properly&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>% cat /proc/swaps
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Filename				Type		Size		Used		Priority
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/swapfile file		8388604		0		-2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/dev/zram0 partition	1615244		0		&lt;span style="color:#d19a66">100&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>zswap should have more priority than the swap file.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>systemd: share environment variables with xorg</title><link>https://perrotta.dev/2022/01/systemd-share-environment-variables-with-xorg/</link><pubDate>Mon, 31 Jan 2022 21:38:54 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/01/systemd-share-environment-variables-with-xorg/</guid><description>&lt;p>In this post we will learn how to share environment variables (e.g.
&lt;code>$GDK_SCALE&lt;/code>) between a system user session and X11/Xorg.&lt;/p>
&lt;p>The typical &lt;a href="https://wiki.archlinux.org/title/Xinit">&lt;code>~/.xinitrc&lt;/code>&lt;/a> and/or &lt;a href="https://wiki.archlinux.org/title/Xprofile">&lt;code>~/.xprofile&lt;/code>&lt;/a> setup in
2020s involves some environment variable exports such as the following:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># fix java application decorations, for tiling window managers&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">export&lt;/span> &lt;span style="color:#e06c75">_JAVA_AWT_WM_NONREPARENTING&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># make Chrome pick up proxy settings stored in gconf&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">export&lt;/span> &lt;span style="color:#e06c75">DESKTOP_SESSION&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>gnome
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># HiDPI settings for GTK3+&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">export&lt;/span> &lt;span style="color:#e06c75">GDK_DPI_SCALE&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>0.5
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">export&lt;/span> &lt;span style="color:#e06c75">GDK_SCALE&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># HiDPI settings for QT&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">export&lt;/span> &lt;span style="color:#e06c75">QT_FONT_DPI&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">192&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This particular set of customizations stems from my &lt;a href="https://github.com/thiagowfx/.dotfiles">dotfiles&lt;/a> but
there isn&amp;rsquo;t anything special about it. I&amp;rsquo;ll include an explanation anyway for
completeness:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>The java setting is meant for launching certain java-based applications from
within a tiling window manager.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>All the other settings are meant for 4K HiDPI displays. The baseline DPI is
96, which is too small for 4K monitors, the fonts and icons all look tiny. In
order to make them scale it&amp;rsquo;s necessary to use a higher DPI. Typical setups
use either 144 (x1.5) or 192 (x2.0), the bigger the DPI the bigger fonts and
icons will appear in the screen.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Those exports work well for graphical applications launched from your favorite
window manager after it has already started, however if you decide to launch an
application from &lt;code>systemd&lt;/code>, those settings will not be picked up by it.&lt;/p>
&lt;p>For example, if you decide to manage &lt;a href="http://jonls.dk/redshift/">&lt;code>redshift&lt;/code>&lt;/a>&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> (more
specifically, &lt;code>redshift-gtk&lt;/code> which has a system tray app) from a systemd user
session&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>, its fonts will look small.&lt;/p>
&lt;p>There are several ways to address this issue.&lt;/p>
&lt;p>One of them is to edit the service file directly:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ systemctl --user edit redshift-gtk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And then add:&lt;/p>
&lt;pre tabindex="0">&lt;code>[Unit]
Environment=GDK_SCALE=2 GDK_DPI_SCALE=0.5
&lt;/code>&lt;/pre>&lt;p>Which results in:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ cat ~/.config/systemd/user/redshift-gtk.service.d/override.conf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">[&lt;/span>Unit&lt;span style="color:#56b6c2">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">Environment&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#e06c75">GDK_SCALE&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">2&lt;/span> &lt;span style="color:#e06c75">GDK_DPI_SCALE&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>0.5
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Which you can make effective by:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ systemctl --user daemon-reload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ systemctl --user restart redshift-gtk
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>I am not a fan of this approach though, because this step would need to be repeated
to all service files you want to manage this way. There&amp;rsquo;s a better, &lt;a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY&lt;/a> way to
do so.&lt;/p>
&lt;p>&lt;code>systemd&lt;/code> supports &lt;a href="https://www.freedesktop.org/software/systemd/man/environment.d.html">environment
files&lt;/a>
(&lt;code>environment.d(5)&lt;/code>). User-defined ones live in
&lt;code>~/.config/environment.d/*.conf&lt;/code> by default.&lt;/p>
&lt;p>This means we could produce the following file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ cat ~/.config/environment.d/user.conf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># systemd environment.d(5) EnvironmentFile&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># https://www.freedesktop.org/software/systemd/man/environment.d.html&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Do not use export here.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Alternatively&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># systemctl --user import-environment [var1] [var2] [...]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Troubleshooting&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># systemctl --user show-environment&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># fix java application decorations, for tiling window managers&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">_JAVA_AWT_WM_NONREPARENTING&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># make Chrome pick up proxy settings stored in gconf&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">DESKTOP_SESSION&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>gnome
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># HiDPI settings for GTK3+&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">GDK_DPI_SCALE&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>0.5
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">GDK_SCALE&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># HiDPI settings for QT&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e06c75">QT_FONT_DPI&lt;/span>&lt;span style="color:#56b6c2">=&lt;/span>&lt;span style="color:#d19a66">192&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Which is applied to all systemd user service files automatically, no need to
set &lt;code>Environment=&lt;/code> manually everywhere.&lt;/p>
&lt;p>However, now we need to maintain two different files: the systemd &lt;code>.conf&lt;/code> one
and the xorg &lt;code>~/.xinitrc&lt;/code> one.&lt;/p>
&lt;p>One elegant way to reduce maintenance burden is, in my opinion, the follownig:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ cat ~/.xinitrc
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Parse user session environment variables.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># This file is shared with the systemd user instance.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># Export all variables: https://stackoverflow.com/a/30969768/1745064&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">set&lt;/span> -a
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#56b6c2">[&lt;/span> -r ~/.config/environment.d/user.conf &lt;span style="color:#56b6c2">]&lt;/span> &lt;span style="color:#56b6c2">&amp;amp;&amp;amp;&lt;/span> . ~/.config/environment.d/user.conf
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">set&lt;/span> +a
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It does what you expect: the underlying shell sources the &lt;code>*.conf&lt;/code> file as if
you were &lt;code>export&lt;/code>ing each variable therein.&lt;/p>
&lt;p>One caveat of this setup is that you cannot define the variables
dynamically; for example, with subshells, with external programs, or with
simple mathematical operations derived from other variables&lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup>.&lt;/p>
&lt;p>Ultimately though you end up with only one file to manage, which is the systemd one.
&lt;a href="https://en.wikipedia.org/wiki/KISS_principle">KISS&lt;/a>™.&lt;/p>
&lt;figure>&lt;a href="https://xkcd.com/963/">&lt;img src="https://imgs.xkcd.com/comics/x11.png"
 alt="Thomas Jefferson thought that every law and every constitution should be torn down and rewritten from scratch every nineteen years--which means X is overdue.">&lt;/a>&lt;figcaption>
 &lt;p>XKCD Courtesy of Randall Munroe&lt;/p>
 &lt;/figcaption>
&lt;/figure>

&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>Redshift adjusts the color temperature of your screen according to your
surroundings. This may help your eyes hurt less if you are working in front
of the screen at night. Redshift is similar to &lt;a href="https://justgetflux.com/">f.lux&lt;/a>.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2">
&lt;p>&lt;code>systemctl --user start redshift&lt;/code>.&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3">
&lt;p>For example, &lt;code>QT_FONT_DPI=$(($GDK_SCALE * 96))&lt;/code> or similar.&amp;#160;&lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Watch files and react to changes during development</title><link>https://perrotta.dev/2022/01/watch-files-and-react-to-changes-during-development/</link><pubDate>Sun, 30 Jan 2022 21:32:17 -0500</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><guid>https://perrotta.dev/2022/01/watch-files-and-react-to-changes-during-development/</guid><description>&lt;p>This post describes some tooling usages to watch for file changes and run or reload a command whenever they happen.&lt;/p>
&lt;h2 id="context">Context&lt;/h2>
&lt;p>I am contributing to &lt;a href="https://github.com/miniflux/v2">miniflux&lt;/a>, a minimalist and opinionated RSS reader. Miniflux&amp;rsquo;s stack is as minimalist as the app itself: It&amp;rsquo;s a Golang application that connects to a local PostgreSQL database. It has a well-documented and comprehensive &lt;a href="https://github.com/miniflux/v2/blob/master/Makefile">&lt;code>Makefile&lt;/code>&lt;/a>.&lt;/p>
&lt;p>In order to achieve an edit-and-preview workflow for quick prototyping and local iteration, all that it&amp;rsquo;s needed is to execute &lt;code>make run&lt;/code> whenever any&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup> file in the repository is changed.&lt;/p>
&lt;p>My goal was to achieve that workflow with the least amount of friction, and with an application that is widely available in most package managers / linux distributions out there.&lt;/p>
&lt;h2 id="option-1-entr-recommended">Option #1: entr (recommended)&lt;/h2>
&lt;p>&lt;a href="https://eradman.com/entrproject/">&lt;code>entr(1)&lt;/code>&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>Run arbitrary commands when files change&lt;/p>
&lt;/blockquote>
&lt;p>The following invocation does the job:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ fd | entr -r -- make run
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>However, we could do better. From the upstream docs:&lt;/p>
&lt;blockquote>
&lt;p>» ag and ack offer many advantages over utilities such as find(1) or ls(1) in that they recognize files by their contents and are smart enough to skip directories such as .git&lt;/p>
&lt;/blockquote>
&lt;p>I am happy with &lt;code>fd&lt;/code> for this use case though. To limit &lt;code>entr&lt;/code> to &lt;code>.go&lt;/code> files only, we could do:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>$ fd -e go | entr -r -- make run
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It took me less than 5 minutes to install and figure out how to use &lt;code>entr&lt;/code>.&lt;/p>
&lt;p>&lt;a href="https://schauderbasis.de/posts/entr/">This blog post&lt;/a> covers it in more detail.&lt;/p>
&lt;h2 id="option-2-watchman">Option #2: watchman&lt;/h2>
&lt;p>&lt;a href="https://facebook.github.io/watchman/">&lt;code>watchman&lt;/code>&lt;/a> from Facebook Open Source:&lt;/p>
&lt;blockquote>
&lt;p>Watchman exists to watch files and record when they change. It can also trigger actions (such as rebuilding assets) when matching files change.&lt;/p>
&lt;/blockquote>
&lt;p>Watchman&amp;rsquo;s workflow doesn&amp;rsquo;t seem to be very suited for this job though. It&amp;rsquo;s much more centered on subscribing to &lt;code>inotify&lt;/code> events:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e5c07b">cd&lt;/span> &amp;lt;repository root&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>watchman watch .
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip;and then adding predefined actions to recompile parts of the application as they change. The official docs give an example with CSS minification:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># set up a trigger named &amp;#39;buildme&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#7f848e"># will run &amp;#39;minify-css&amp;#39; whenever a CSS file is changed&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>watchman -- trigger . buildme &lt;span style="color:#98c379">&amp;#39;*.css&amp;#39;&lt;/span> -- minify-css
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this regard it seems to be more modular, and I could easily see a scenario where I would kick off several specialized triggers in a webdev project: for example, one for CSS minification, one for JS minification, another one for TypeScript compilation, etc.&lt;/p>
&lt;p>That said, for the simple use case of triggering (and reloading) &lt;code>make run&lt;/code>, it seems overkill. I also found its &lt;a href="https://facebook.github.io/watchman/docs/install.html">official docs&lt;/a> too verbose and lacking sample usages for simple &lt;code>Makefile&lt;/code>-based projects like miniflux.&lt;/p>
&lt;p>One caveat of &lt;a href="https://repology.org/project/watchman/versions">&lt;code>watchman&lt;/code>&lt;/a> is that it&amp;rsquo;s less widely available than &lt;a href="https://repology.org/project/entr/versions">&lt;code>entr&lt;/code>&lt;/a>. Another caveat is that recently official distributions of watchman seem to be binary only, even though watchman itself is open source.&lt;/p>
&lt;p>It took me several minutes to figure out what&amp;rsquo;s the gist of watchman, only to realize it is more bloated than warranted.&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>For simple projects, &lt;code>entr&lt;/code> is the way to go, hands down. For complex webdev projects, I would look into &lt;code>watchman&lt;/code> more deeply.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>To be truly strict, only changes to &lt;code>.go&lt;/code> files matter.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item></channel></rss>