<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet type="text/xsl" href="https://perrotta.dev/rss.xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Kubernetes on ¬¨ just serendipity üçÄ</title><link>https://perrotta.dev/</link><description>Recent content in Kubernetes on ¬¨ just serendipity üçÄ</description><generator>Hugo</generator><language>en</language><managingEditor>serendipity@perrotta.dev (Thiago Perrotta)</managingEditor><webMaster>serendipity@perrotta.dev (Thiago Perrotta)</webMaster><copyright>¬© 2013 - 2026 Thiago Perrotta ¬∑
[some rights reserved](https://creativecommons.org/licenses/by-nc-sa/4.0/) ¬∑
a fork of [hugo  ï‚Ä¢·¥•‚Ä¢ î bear](https://github.com/janraasch/hugo-bearblog/)</copyright><lastBuildDate>Sun, 18 Jan 2026 22:34:12 -0300</lastBuildDate><atom:link href="https://perrotta.dev/tags/kubernetes/index.xml" rel="self" type="application/rss+xml"/><item><title>Kubernetes: pod memory usage</title><link>https://perrotta.dev/2025/09/kubernetes-pod-memory-usage/</link><pubDate>Fri, 26 Sep 2025 11:54:57 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/09/kubernetes-pod-memory-usage/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: Given a pod in Kubernetes, check its memory (RAM) usage.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://stackoverflow.com/questions/54531646/checking-kubernetes-pod-cpu-and-memory-utilization"&gt;Stack
Overflow&lt;/a&gt;:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl top pod -n {namespace} {pod name} [--containers]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;--containers=false:
 If present, print usage of containers within a pod.&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;This only works if &lt;a href="https://github.com/kubernetes-sigs/metrics-server"&gt;metrics
server&lt;/a&gt; is installed (it
should be!).&lt;/p&gt;
&lt;p&gt;There&amp;rsquo;s an alternative:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl describe PodMetrics {pod name}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;It must be &lt;code&gt;PodMetrics&lt;/code&gt;. &lt;code&gt;PodMetric&lt;/code&gt; does not work (ugh!&lt;sup id="fnref:1"&gt;&lt;a href="https://perrotta.dev/2025/09/kubernetes-pod-memory-usage/#fn:1" class="footnote-ref" role="doc-noteref"&gt;1&lt;/a&gt;&lt;/sup&gt;):&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl get PodMetric
error: the server doesn&amp;#39;t have a resource type &amp;#34;PodMetric&amp;#34;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;If metrics server is not available for some reason, then one needs to dive into
the container:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl exec -it {pod name} -n {namespace} -- /bin/sh&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&amp;hellip;which won&amp;rsquo;t always work; not every container has &lt;code&gt;/bin/sh&lt;/code&gt;. Then read the
contents of &lt;code&gt;/sys/fs/cgroup/memory/memory.usage_in_bytes&lt;/code&gt;.&lt;/p&gt;
&lt;div class="footnotes" role="doc-endnotes"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Who designed this? Is it so hard to achieve consistency? Both &lt;code&gt;kubectl get pod&lt;/code&gt; and &lt;code&gt;kubectl get pods&lt;/code&gt; work. Why can&amp;rsquo;t it be the same with &lt;code&gt;PodMetric&lt;/code&gt;?
And, no, &lt;code&gt;PodMetricses&lt;/code&gt; does not work either.&amp;#160;&lt;a href="https://perrotta.dev/2025/09/kubernetes-pod-memory-usage/#fnref:1" class="footnote-backref" role="doc-backlink"&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Kubernetes: pod memory usage"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>kubectl: verbose logging</title><link>https://perrotta.dev/2025/09/kubectl-verbose-logging/</link><pubDate>Fri, 05 Sep 2025 18:10:33 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/09/kubectl-verbose-logging/</guid><description>&lt;p&gt;When running &lt;code&gt;kubectl&lt;/code&gt; commands, to get a glimpse of what is happening under the
hood, pass &lt;code&gt;-v={N}&lt;/code&gt; to it.&lt;/p&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl get pod -n argocd -v=6
I0905 16:10:19.893576 3929356 loader.go:395] Config loaded from file: /home/ubuntu/.kube/config
I0905 16:10:19.919935 3929356 round_trippers.go:553] GET https://{REDACTED}.us-east-1.elb.amazonaws.com/api/v1/namespaces/argocd/pods?limit=500 200 OK in 17 milliseconds
NAME READY STATUS RESTARTS AGE
argo-workflows-server-6ffcfbb779-kxdzk 1/1 Running 0 4d18h
argo-workflows-workflow-controller-85c667cf96-rm9dw 1/1 Running 0 2d4h
argocd-application-controller-0 1/1 Running 0 48m
[...]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;code&gt;-v=10&lt;/code&gt; is super verbose. Fine-tune as needed.&lt;/p&gt;
&lt;p&gt;Another example:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl get deploy -n argocd -w -v6
I0905 16:12:49.277471 3929550 loader.go:395] Config loaded from file: /home/ubuntu/.kube/config
I0905 16:12:49.302783 3929550 round_trippers.go:553] GET https://{REDACTED}.us-east-1.elb.amazonaws.com/apis/apps/v1/namespaces/argocd/deployments?limit=500 200 OK in 17 milliseconds
NAME READY UP-TO-DATE AVAILABLE AGE
argo-workflows-server 1/1 1 1 91d
argo-workflows-workflow-controller 1/1 1 1 44d
argocd-applicationset-controller 1/1 1 1 23d
argocd-dex-server 1/1 1 1 451d
argocd-notifications-controller 1/1 1 1 449d
argocd-redis 1/1 1 1 451d
argocd-repo-server 1/1 1 1 451d
argocd-server 3/3 3 3 428d
I0905 16:12:49.316961 3929550 round_trippers.go:553] GET https://{REDACTED}.us-east-1.elb.amazonaws.com/apis/apps/v1/namespaces/argocd/deployments?resourceVersion=695374153&amp;amp;watch=true 200 OK in 2 milliseconds&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: kubectl: verbose logging"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>Uninstall Kyverno</title><link>https://perrotta.dev/2025/09/uninstall-kyverno/</link><pubDate>Fri, 05 Sep 2025 17:03:04 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/09/uninstall-kyverno/</guid><description>&lt;p&gt;It&amp;rsquo;s always a bit frustrating to do it.&lt;/p&gt;
&lt;p&gt;Despite the excellent &lt;a href="https://kyverno.io/docs/installation/uninstallation/"&gt;upstream
documentation&lt;/a&gt;, our
Kubernetes clusters often leave cruft behind when doing so.&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl rollout restart sts -n argocd argocd-redis-ha-server
E0905 12:29:24.284879 3908207 memcache.go:287] couldn&amp;#39;t get resource list for wgpolicyk8s.io/v1alpha2: the server is currently unable to handle the request
E0905 12:29:24.287856 3908207 memcache.go:287] couldn&amp;#39;t get resource list for reports.kyverno.io/v1: the server is currently unable to handle the request
E0905 12:29:24.290250 3908207 memcache.go:121] couldn&amp;#39;t get resource list for reports.kyverno.io/v1: the server is currently unable to handle the request
E0905 12:29:24.292666 3908207 memcache.go:121] couldn&amp;#39;t get resource list for wgpolicyk8s.io/v1alpha2: the server is currently unable to handle the request
E0905 12:29:24.295959 3908207 memcache.go:121] couldn&amp;#39;t get resource list for reports.kyverno.io/v1: the server is currently unable to handle the request
E0905 12:29:24.298226 3908207 memcache.go:121] couldn&amp;#39;t get resource list for wgpolicyk8s.io/v1alpha2: the server is currently unable to handle the request
E0905 12:29:24.302703 3908207 memcache.go:121] couldn&amp;#39;t get resource list for reports.kyverno.io/v1: the server is currently unable to handle the request
E0905 12:29:24.305009 3908207 memcache.go:121] couldn&amp;#39;t get resource list for wgpolicyk8s.io/v1alpha2: the server is currently unable to handle the request
[...]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;That output junk is emitted on every &lt;code&gt;kubectl&lt;/code&gt; command.&lt;/p&gt;
&lt;p&gt;This time the culprit was:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl get apiservice | egrep -i &amp;#34;(kyverno|wgpolicy)&amp;#34;
v1.reports.kyverno.io reports-server/kyverno-reports-server False (MissingEndpoints) 76d
v1alpha2.wgpolicyk8s.io reports-server/kyverno-reports-server False (MissingEndpoints) 76d&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Deleting these two entries resolves the issue:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl delete apiservice v1.reports.kyverno.io v1alpha2.wgpolicyk8s.io -n reports-server&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Uninstall Kyverno"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>helm: diff manifests</title><link>https://perrotta.dev/2025/08/helm-diff-manifests/</link><pubDate>Thu, 28 Aug 2025 17:57:32 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/08/helm-diff-manifests/</guid><description>&lt;p&gt;Lately I&amp;rsquo;ve been employing (with great success) the following pattern in order
to test whether changes to helm charts are harmless (and expected):&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;cd path/to/my/helm/chart
git checkout origin/master # or main
helm template -f values.yaml . &amp;gt; golden
git switch --create thiagowfx/my-feature-branch
# develop, develop, develop
helm template -f values.yaml . &amp;gt; candidate
diff candidate golden # or icdiff&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;The &lt;code&gt;diff&lt;/code&gt; output will reliably demonstrate whether your changes are WAI.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: If needed, pass &lt;code&gt;--release-name {foo}&lt;/code&gt; to &lt;code&gt;helm template&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;This pattern is comparable to running a golden &lt;code&gt;helm install&lt;/code&gt; followed by a
&lt;a href="https://github.com/databus23/helm-diff"&gt;&lt;code&gt;helm-diff&lt;/code&gt;&lt;/a&gt; (&lt;code&gt;helm diff upgrade&lt;/code&gt;)
candidate in the cluster.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: helm: diff manifests"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>ArgoCD: git index.lock issue</title><link>https://perrotta.dev/2025/08/argocd-git-index.lock-issue/</link><pubDate>Sat, 23 Aug 2025 12:39:14 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>git</category><category>kubernetes</category><guid>https://perrotta.dev/2025/08/argocd-git-index.lock-issue/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: Every ArgoCD application is stuck in &lt;em&gt;Unknown&lt;/em&gt; state,
with the following error:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;Failed to load target state: failed to generate manifest for source 1 of 2:
rpc error: code = Unknown desc = failed to initialize repository resources: rpc
error: code = Internal desc = Failed to checkout FETCH_HEAD: failed to checkout
FETCH_HEAD: `git checkout --force FETCH_HEAD` failed exit status 128: fatal:
Unable to create &amp;#39;&amp;lt;path to cached source&amp;gt;/.git/index.lock&amp;#39;: File exists. Another
git process seems to be running in this repository, e.g. an editor opened by
&amp;#39;git commit&amp;#39;. Please make sure all processes are terminated then try again. If
it still fails, a git process may have crashed in this repository earlier:
remove the file manually to continue.&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;It is a lock contention race condition issue within the ArgoCD repo server
component, with the git &lt;code&gt;index.lock&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The easiest way to address it is to restart the repo server:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl rollout restart deploy -n argocd argocd-repo-server&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Afterwards, refresh all applications in the cluster via the web UI:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;click Applications on the left-side nav bar&lt;/li&gt;
&lt;li&gt;click Refresh apps at the top&lt;/li&gt;
&lt;li&gt;select ALL applications, set refresh type to NORMAL&lt;/li&gt;
&lt;li&gt;click refresh&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: git index.lock issue"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/git/"&gt;#git&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>‚òÖ Kubernetes: list all ImagePullBackOff container images</title><link>https://perrotta.dev/2025/08/kubernetes-list-all-imagepullbackoff-container-images/</link><pubDate>Thu, 21 Aug 2025 13:34:27 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>bestof</category><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/08/kubernetes-list-all-imagepullbackoff-container-images/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt; Upgrade the
&lt;a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack"&gt;&lt;code&gt;kube-prometheus-stack&lt;/code&gt;&lt;/a&gt;
helm chart in &lt;a href="https://portal.azure.cn/"&gt;Azure China&lt;/a&gt; to the latest version.
&lt;em&gt;Side effect&lt;/em&gt;: Many container images are now missing from our internal
&lt;a href="https://azure.microsoft.com/en-us/products/container-registry"&gt;ACR&lt;/a&gt; (Azure
Container Registry). They need to be synced with &lt;a href="https://github.com/containers/skopeo"&gt;&lt;code&gt;skopeo&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Which images need to be synced? Use the command below, it is quite readable&lt;sup id="fnref:1"&gt;&lt;a href="https://perrotta.dev/2025/08/kubernetes-list-all-imagepullbackoff-container-images/#fn:1" class="footnote-ref" role="doc-noteref"&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl get pods --all-namespaces -o json | jq -r &amp;#39;.items[] | select(any(.status.containerStatuses[]; .state.waiting.reason == &amp;#34;ImagePullBackOff&amp;#34;)) | .metadata.namespace &amp;#43; &amp;#34;/&amp;#34; &amp;#43; .metadata.name &amp;#43; &amp;#34;\t&amp;#34; &amp;#43; ( [.status.containerStatuses[] | select(.state.waiting.reason == &amp;#34;ImagePullBackOff&amp;#34;).image] | join(&amp;#34;, &amp;#34;) )&amp;#39;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Sample run:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;ubuntu@universe:~ $ kubectl get pods --all-namespaces -o json | jq -r &amp;#39;.items[]
 | select(any(.status.containerStatuses[]; .state.waiting.reason == &amp;#34;ImagePullBackOff&amp;#34;))
 | .metadata.namespace &amp;#43; &amp;#34;/&amp;#34; &amp;#43; .metadata.name &amp;#43; &amp;#34;\t&amp;#34; &amp;#43;
 ( [.status.containerStatuses[] | select(.state.waiting.reason == &amp;#34;ImagePullBackOff&amp;#34;).image] | join(&amp;#34;, &amp;#34;) )&amp;#39;
monitoring/clustermon-kube-prometheus-operator-67c8b6c87c-w72km {my-registry-name}.azurecr.cn/quay.io/prometheus-operator/prometheus-operator:v0.83.0
monitoring/clustermon-prometheus-node-exporter-v7bpt {my-registry-name}.azurecr.cn/quay.io/prometheus/node-exporter:v1.9.1&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;How to &lt;code&gt;skopeo&lt;/code&gt;? First, log in:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;echo -n &amp;#34;{password}&amp;#34; | skopeo login {my-registry-name}.azurecr.cn --password-stdin --username {my-username}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;How do you get these credentials? Log in to the Azure China Portal, find the ACR
resource, navigate to Settings &amp;gt; Access keys.&lt;/p&gt;
&lt;p&gt;Then sync each image&lt;sup id="fnref:2"&gt;&lt;a href="https://perrotta.dev/2025/08/kubernetes-list-all-imagepullbackoff-container-images/#fn:2" class="footnote-ref" role="doc-noteref"&gt;2&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% skopeo sync \
 --override-os linux --override-arch amd64 \
 --src docker --dest docker \
 quay.io/prometheus/node-exporter:v1.9.1 \
 {my-registry-name}.azurecr.cn/quay.io/prometheus&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="footnotes" role="doc-endnotes"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;I cannot promise I am able to craft this by hand without looking up man
pages or getting assistance from an LLM. &lt;em&gt;C&amp;rsquo;est la vie&lt;/em&gt;.&amp;#160;&lt;a href="https://perrotta.dev/2025/08/kubernetes-list-all-imagepullbackoff-container-images/#fnref:1" class="footnote-backref" role="doc-backlink"&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;If there are many images, consider using an
&lt;a href="https://www.gnu.org/software/bash/manual/html_node/Arrays.html"&gt;array&lt;/a&gt; +
&lt;code&gt;for&lt;/code&gt; loop.&amp;#160;&lt;a href="https://perrotta.dev/2025/08/kubernetes-list-all-imagepullbackoff-container-images/#fnref:2" class="footnote-backref" role="doc-backlink"&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Kubernetes: list all ImagePullBackOff container images"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/bestof/"&gt;#bestof&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>ArgoCD: app version notifications</title><link>https://perrotta.dev/2025/08/argocd-app-version-notifications/</link><pubDate>Tue, 12 Aug 2025 12:07:20 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/08/argocd-app-version-notifications/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: when using &lt;a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/notifications/"&gt;ArgoCD
notifications&lt;/a&gt;,
starting off from their
&lt;a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/notifications/catalog/"&gt;catalog&lt;/a&gt;,
print the app chart version in addition to existing information.&lt;/p&gt;
&lt;p&gt;More specifically, currently, a Slack notification message from Argo looks like
the following:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;Cluster 37: Application heart-of-gold is unhealthy.&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;We want to improve it to:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;Cluster 37: Application heart-of-gold (~1.18.3) is unhealthy.&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;The following diff (under a &lt;code&gt;template&lt;/code&gt; block) accomplishes that:&lt;/p&gt;
&lt;div class="codeblock" data-lang="diff"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;diff&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-diff"&gt;- {{if eq .serviceType &amp;#34;slack&amp;#34;}}:interrobang:{{end}} Cluster &amp;lt;{{.context.argocdUrl}}|*{{.context.clusterId}}*&amp;gt;: Application &amp;lt;{{.context.argocdUrl}}/applications/{{.app.metadata.name}}|`{{.app.metadata.name}}`&amp;gt; _sync_ by {{.app.status.operationState.operation.initiatedBy.username | default &amp;#34;_automation_&amp;#34; }} is _unknown_.
&amp;#43; {{if eq .serviceType &amp;#34;slack&amp;#34;}}:interrobang:{{end}} Cluster &amp;lt;{{.context.argocdUrl}}|*{{.context.clusterId}}*&amp;gt;: Application &amp;lt;{{.context.argocdUrl}}/applications/{{.app.metadata.name}}|`{{.app.metadata.name}}`&amp;gt;{{if .app.spec.source.targetRevision}} ({{.app.spec.source.targetRevision}}){{else}}{{range .app.spec.sources}}{{if .targetRevision}} ({{.targetRevision}}){{break}}{{end}}{{end}}{{end}} _sync_ by {{.app.status.operationState.operation.initiatedBy.username | default &amp;#34;_automation_&amp;#34; }} is _unknown_.&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Diving into it with pretty-printing&lt;sup id="fnref:1"&gt;&lt;a href="https://perrotta.dev/2025/08/argocd-app-version-notifications/#fn:1" class="footnote-ref" role="doc-noteref"&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class="codeblock" data-lang="go-template"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;go-template&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-go-template"&gt;{{if .app.spec.source.targetRevision}}
 ({{.app.spec.source.targetRevision}})
{{else}}
 {{range .app.spec.sources}}
 {{if .targetRevision}}
 ({{.targetRevision}})
 {{break}}
 {{end}}
 {{end}}
{{end}}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;If there&amp;rsquo;s a single source in the helm chart, we extract its &lt;code&gt;targetRevision&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Otherwise, when using a &lt;a href="https://argo-cd.readthedocs.io/en/latest/user-guide/multiple_sources/"&gt;multi-source
app&lt;/a&gt;, we
extract the first available &lt;code&gt;targetRevision&lt;/code&gt;.&lt;/p&gt;
&lt;div class="footnotes" role="doc-endnotes"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;These are
&lt;a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/GoTemplate/"&gt;golang&lt;/a&gt;
&lt;a href="https://pkg.go.dev/text/template"&gt;templates&lt;/a&gt;.&amp;#160;&lt;a href="https://perrotta.dev/2025/08/argocd-app-version-notifications/#fnref:1" class="footnote-backref" role="doc-backlink"&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: app version notifications"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>ArgoCD: recovery when traefik is broken</title><link>https://perrotta.dev/2025/08/argocd-recovery-when-traefik-is-broken/</link><pubDate>Sat, 09 Aug 2025 15:24:53 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/08/argocd-recovery-when-traefik-is-broken/</guid><description>&lt;p&gt;It&amp;rsquo;s Friday. The best day to push to prod‚Ñ¢.
An internal scheduled upgrade for &lt;code&gt;traefik&lt;/code&gt; goes awry.
Internal services are no longer accessible.
HTTP requests won&amp;rsquo;t be properly routed.&lt;/p&gt;
&lt;p&gt;The most sensible SRE / DevOps will simply roll it back. Roll back first,
investigate later: it&amp;rsquo;s crucial to minimize downtime.&lt;/p&gt;
&lt;p&gt;How do we roll back?
We&amp;rsquo;re using GitOps, the most sensible approach is to make a new git commit by
submitting a pull request.
However, this is an emergency situation. Can we roll back faster?&lt;/p&gt;
&lt;p&gt;Sure, let&amp;rsquo;s make temporary changes directly in the cluster.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;traefik&lt;/code&gt; app is managed with ArgoCD. Let&amp;rsquo;s log in to the ArgoCD web UI and
roll back to the previous version.&lt;/p&gt;
&lt;p&gt;Oh, wait. We can&amp;rsquo;t. The ArgoCD web UI isn&amp;rsquo;t accessible, because traefik is
broken. &lt;em&gt;Sighs&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s use the ArgoCD CLI then.&lt;/p&gt;
&lt;p&gt;Aaaah, no. The ArgoCD CLI is really a REST client for the ArgoCD API. HTTP(S) is
not accessible, so the CLI won&amp;rsquo;t work either.&lt;/p&gt;
&lt;p&gt;What&amp;rsquo;s next? A plain &lt;code&gt;helm&lt;/code&gt; upgrade should work. But &lt;code&gt;helm&lt;/code&gt; is picky and will
refuse to touch manifests it doesn&amp;rsquo;t own. The manifests are managed by Argo.
&lt;code&gt;helm&lt;/code&gt; won&amp;rsquo;t budge. Oh gosh.&lt;/p&gt;
&lt;p&gt;Last option: the ArgoCD controllers are still running. We don&amp;rsquo;t need the ArgoCD
HTTPS API to communicate with them. Let&amp;rsquo;s simply edit the k8s manifests
directly.&lt;/p&gt;
&lt;p&gt;First we patch the root app (app-of-apps pattern):&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl edit app -n argocd root&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;We remove the &lt;code&gt;automated&lt;/code&gt; block, to effectively pause auto sync, otherwise our
subsequent changes to traefik would be immediately reverted:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;spec:
# automated:
# prune: [..]
# selfHeal: [...]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;You can comment or delete the &lt;code&gt;automated:&lt;/code&gt; block, either is fine.&lt;/p&gt;
&lt;p&gt;Next, we need to remove traefik from all application project (app project) sync
windows, so that changes to it will be immediately applied:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl edit appproject -n argocd cluster&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;The traefik entry got removed from all sync windows.&lt;/p&gt;
&lt;p&gt;Now, finally, let&amp;rsquo;s instruct Argo to roll traefik back.&lt;/p&gt;
&lt;p&gt;The broken version is 2.5.1, the previous working version was 2.4.1.&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl edit app -n argocd traefik&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Update &lt;code&gt;targetRevision: 2.4.1&lt;/code&gt; under the &lt;code&gt;helm&lt;/code&gt; block.&lt;/p&gt;
&lt;p&gt;Wait a few seconds. Observe traefik pods as they are rolling restarted:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl get deploy -n kube-system traefik -w&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Finally, all services are once again accessible!&lt;/p&gt;
&lt;p&gt;From this point on, we can go back to &lt;code&gt;git&lt;/code&gt; and do a proper pull request revert
to reconcile the codebase with the live cluster state.&lt;/p&gt;
&lt;p&gt;This was an interesting exercise. I&amp;rsquo;m quite familiar with ArgoCD and GitOps at
this point, and I instinctively knew what to do in this situation, without
needing to consult the official documentation or even an LLM. I wouldn&amp;rsquo;t have
minded doing either of these if needed, but the point is that it feels good to
be well familiar with how a system works and how to apply your knowledge to fix
day-to-day problems.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: recovery when traefik is broken"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>ArgoCD: all applications stuck on refresh</title><link>https://perrotta.dev/2025/08/argocd-all-applications-stuck-on-refresh/</link><pubDate>Fri, 01 Aug 2025 14:30:58 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/08/argocd-all-applications-stuck-on-refresh/</guid><description>&lt;p&gt;The problem is very likely the Application Controller.&lt;/p&gt;
&lt;p&gt;You can restart it:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl rollout restart sts -n argocd argocd-application-controller&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Or inspect its logs:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl logs -n argocd argocd-application-controller-0 --tail=100 | less&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;While we&amp;rsquo;re here, make sure there is at least one replica running:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;% kubectl get sts -n argocd argocd-application-controller
NAME READY AGE
argocd-application-controller 1/1 415d&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;a href="https://github.com/argoproj/argo-cd/issues/11831"&gt;Upstream issue&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: all applications stuck on refresh"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>ArgoCD: deployment spec.selector: field is immutable</title><link>https://perrotta.dev/2025/06/argocd-deployment-spec.selector-field-is-immutable/</link><pubDate>Mon, 30 Jun 2025 13:04:51 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/06/argocd-deployment-spec.selector-field-is-immutable/</guid><description>&lt;p&gt;When using &lt;a href="https://argo-cd.readthedocs.io/en/stable/"&gt;ArgoCD&lt;/a&gt; to manage an app,
the Deployment manifest needs to undergo significant changes, updating its
selector labels. When trying to sync the argocd app, we get the following error:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;one or more objects failed to apply, reason: error when patching &amp;#34;/dev/shm/3469418025&amp;#34;: Deployment.apps &amp;#34;myapp&amp;#34; is invalid: spec.selector: Invalid value: v1.LabelSelector{MatchLabels:v1.LabelSelectorRequirement(nil)}: field is immutable. Retrying attempt #2 at 11:02AM.&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;This error doesn&amp;rsquo;t come directly from Argo, it is from &lt;code&gt;kubectl apply&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;There are two ways to address it:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Sync the argo app with the
&lt;a href="https://argo-cd.readthedocs.io/en/latest/user-guide/sync-options/#force-sync"&gt;&amp;ldquo;force&amp;rdquo;&lt;/a&gt;
option enabled&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Run &lt;code&gt;kubectl apply&lt;/code&gt; with &lt;code&gt;--force&lt;/code&gt; (which is ultimately what the
aforementioned option maps to).&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In action (&lt;code&gt;-w&lt;/code&gt; is short for &lt;code&gt;--watch&lt;/code&gt;):&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;% kubectl get endpoints -w
NAME ENDPOINTS AGE
myapp &amp;lt;none&amp;gt; 5y44d
myapp 5y44d
myapp 10.1.13.40:8080 5y44d&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: deployment spec.selector: field is immutable"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>Helm repository with a trailing slash</title><link>https://perrotta.dev/2025/06/helm-repository-with-a-trailing-slash/</link><pubDate>Tue, 24 Jun 2025 11:32:50 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><category>pre-commit</category><guid>https://perrotta.dev/2025/06/helm-repository-with-a-trailing-slash/</guid><description>&lt;p&gt;&lt;a href="https://github.com/argoproj/argo-cd/issues/9857"&gt;A repository URL with a trailing slash, and the same URL without a trailing
slash, are treated as different
repos&lt;/a&gt;. We found this out the
hard way:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;Failed to load target state: failed to generate manifest for source 1 of 2: rpc error: code = Unknown desc = error building helm chart dependencies: failed to add helm repository https://chartmuseum.{corp intranet}/orgs/{corp}/: failed to add repository: failed to get command args to log: `helm repo add https:--chartmuseum.{corp intranet}-orgs-{corp}- https://chartmuseum.{corp intranet}/orgs/{corp}/` failed exit status 1: Error: looks like &amp;#34;https://chartmuseum.{corp intranet}/orgs/{corp}/&amp;#34; is not a valid chart repository or cannot be reached: failed to fetch https://chartmuseum.{corp intranet}/orgs/{corp}/index.yaml : 401 Unauthorized&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Let&amp;rsquo;s put aside the fact the error message REALLY likes to repeat the repo name.&lt;/p&gt;
&lt;p&gt;This is a repository that we&amp;rsquo;ve already configured, with proper authentication
credentials. Why would it start to fail now, all of a sudden?&lt;/p&gt;
&lt;p&gt;You already got spoiled in the post title. Given &lt;code&gt;Chart.yaml&lt;/code&gt;:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;apiVersion: v2
name: corp-postgres-operator
description: Corp Postgres Operator
type: application
version: 1.1.13

dependencies:
 - name: postgres-operator
 repository: https://chartmuseum.{corp intranet}/orgs/archive&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;And also:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;apiVersion: v2
name: corp-postgres-operator
description: Corp Postgres Operator
type: application
version: 1.1.13

dependencies:
 - name: postgres-operator
 repository: https://chartmuseum.{corp intranet}/orgs/archive/&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;These two dependencies end up being treated differently by Argo, even though
they are effectively the same. It&amp;rsquo;s an upstream bug.&lt;/p&gt;
&lt;p&gt;To work around it, I decided to simply remove all trailing slashes from
helm repository dependencies. Canonicalize everything!&lt;/p&gt;
&lt;p&gt;A git &lt;a href="https://pre-commit.com"&gt;pre-commit.com hook&lt;/a&gt; is a good mechanism to do so:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;repos:
 repo: local
 hooks:
 - id: helm-repo-trailing-slash
 name: Helm repositories must not contain trailing slashes in Chart.yaml
 files: Chart.yaml$
 language: pygrep
 entry: &amp;#39;\s*repository: [\w:/.]&amp;#43;/$&amp;#39;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Run &lt;code&gt;pre-commit run -a helm-repo-trailing-slash&lt;/code&gt;, fix all violations, and then
never think about this again.&lt;/p&gt;
&lt;p&gt;Should the upstream bug ever be fixed, we can remove this workaround.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Helm repository with a trailing slash"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/pre-commit/"&gt;#pre-commit&lt;/a&gt;&lt;/p&gt;</description></item><item><title>‚òÖ ArgoCD: every application in unknown state</title><link>https://perrotta.dev/2025/06/argocd-every-application-in-unknown-state/</link><pubDate>Fri, 13 Jun 2025 22:34:33 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>bestof</category><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/06/argocd-every-application-in-unknown-state/</guid><description>&lt;p&gt;&lt;strong&gt;Symptom&lt;/strong&gt;: Every single application in the Kubernetes cluster that is managed
by Argo is in &lt;code&gt;Unknown&lt;/code&gt; sync status. A disaster! üò±&lt;/p&gt;
&lt;p&gt;This has only happened in one of our clusters. More specifically, in an
&lt;a href="https://learn.microsoft.com/en-us/azure/aks/core-aks-concepts"&gt;AKS&lt;/a&gt; cluster
(from Microsoft Azure).&lt;/p&gt;
&lt;p&gt;An observed effect:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl get --raw=&amp;#39;/openapi/v2&amp;#39; | head -c 200
Error from server (ServiceUnavailable): the server is currently unable to handle the request&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Aha! The Kubernetes OpenAPI server is not responding properly.
That explains why Argo is having so much trouble to figure out the state of affairs in
the cluster.&lt;/p&gt;
&lt;p&gt;It was quite difficult to troubleshoot this issue. There are barely any
resources about it in the open web. We filed an Azure Support ticket, but it was
completely useless. They offered to restart&lt;sup id="fnref:1"&gt;&lt;a href="https://perrotta.dev/2025/06/argocd-every-application-in-unknown-state/#fn:1" class="footnote-ref" role="doc-noteref"&gt;1&lt;/a&gt;&lt;/sup&gt; the OpenAPI server, but that
didn&amp;rsquo;t help (of course it wouldn&amp;rsquo;t!).&lt;/p&gt;
&lt;p&gt;Because this is a managed Kubernetes cluster, we have limited access to it,
which includes lack of access to raw logs. The Azure portal doesn&amp;rsquo;t make it easy
but, after digging quite deep into it, eventually we found this error message in
the logs:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt; {&amp;#34;pod&amp;#34;:&amp;#34;kube-apiserver-7785d59f4f-scqmp&amp;#34;,&amp;#34;stream&amp;#34;:&amp;#34;stderr&amp;#34;,&amp;#34;containerID&amp;#34;:&amp;#34;925345f6501626aa6cd40dd187d5cf57837389eec9cb39b2292fb9ae3f66242f&amp;#34;,&amp;#34;log&amp;#34;:&amp;#34;E0512 12:01:36.876768 1 handler.go:160] Error in OpenAPI handler: failed to build merge specs: unable to merge: duplicated path \/apis\/reports.kyverno.io\/v1\/clusterephemeralreports\n&amp;#34;}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;That was the first clue! Now we know it&amp;rsquo;s related to
&lt;a href="https://kyverno.io/"&gt;Kyverno&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;That error eventually led us to
&lt;a href="https://github.com/kubernetes/kubernetes/issues/122668#issuecomment-2531243040"&gt;this&lt;/a&gt;
issue in Kubernetes:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;We have the same issue here, actually also triggered by installing the kyverno
reports-server with both apiservices (different groups served by the same
api-server).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Aha!&lt;/p&gt;
&lt;p&gt;Deleting the duplicate CRDs installed by &lt;a href="https://github.com/kyverno/reports-server"&gt;kyverno reports
server&lt;/a&gt; has immediately resolved the
OpenAPI server unresponsiveness. It wasn&amp;rsquo;t even necessary to restart it:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl delete crd ephemeralreports.reports.kyverno.io clusterephemeralreports.reports.kyverno.io clusterpolicyreports.wgpolicyk8s.io policyreports.wgpolicyk8s.io
customresourcedefinition.apiextensions.k8s.io &amp;#34;ephemeralreports.reports.kyverno.io&amp;#34; deleted
customresourcedefinition.apiextensions.k8s.io &amp;#34;clusterephemeralreports.reports.kyverno.io&amp;#34; deleted
customresourcedefinition.apiextensions.k8s.io &amp;#34;clusterpolicyreports.wgpolicyk8s.io&amp;#34; deleted
customresourcedefinition.apiextensions.k8s.io &amp;#34;policyreports.wgpolicyk8s.io&amp;#34; deleted&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;And now:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;$ kubectl get --raw=&amp;#39;/openapi/v2&amp;#39; | head -c 200
{&amp;#34;swagger&amp;#34;:&amp;#34;2.0&amp;#34;,&amp;#34;info&amp;#34;:{&amp;#34;title&amp;#34;:&amp;#34;Kubernetes&amp;#34;,&amp;#34;version&amp;#34;:&amp;#34;v1.30.11&amp;#34;},&amp;#34;paths&amp;#34;:{&amp;#34;/.well-known/openid-configuration/&amp;#34;:{&amp;#34;get&amp;#34;:{&amp;#34;description&amp;#34;:&amp;#34;get service account issuer OpenID configuration, also known as&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;That was a tricky one! Interestingly: it has only occurred in AKS.
&lt;a href="https://aws.amazon.com/eks/"&gt;EKS&lt;/a&gt; was fine.&lt;/p&gt;
&lt;div class="footnotes" role="doc-endnotes"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;&lt;a href="https://en.wikiquote.org/wiki/The_IT_Crowd"&gt;Hello, IT. Have you tried turning it off and on
again?&lt;/a&gt;.&amp;#160;&lt;a href="https://perrotta.dev/2025/06/argocd-every-application-in-unknown-state/#fnref:1" class="footnote-backref" role="doc-backlink"&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: every application in unknown state"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/bestof/"&gt;#bestof&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>‚òÖ ArgoCD: custom health check for StatefulSet (OnDelete)</title><link>https://perrotta.dev/2025/06/argocd-custom-health-check-for-statefulset-ondelete/</link><pubDate>Fri, 13 Jun 2025 21:40:01 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>bestof</category><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/06/argocd-custom-health-check-for-statefulset-ondelete/</guid><description>&lt;p&gt;It turns out the
&lt;a href="https://github.com/argoproj/gitops-engine/blob/master/pkg/health/health_statefulset.go"&gt;built-in&lt;/a&gt;
health check for
&lt;a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/"&gt;StatefulSets&lt;/a&gt;
in ArgoCD is not comprehensive enough.&lt;/p&gt;
&lt;p&gt;It covers
&lt;a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#update-strategies"&gt;&lt;code&gt;RollingUpdate&lt;/code&gt;&lt;/a&gt;
well enough, but &lt;code&gt;OnDelete&lt;/code&gt; is incomplete.&lt;/p&gt;
&lt;p&gt;More specifically:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Observed&lt;/strong&gt;: whenever you push an update to an STS whose &lt;code&gt;.spec.updateStrategy&lt;/code&gt;
is &lt;code&gt;OnDelete&lt;/code&gt;, its health status stays as &lt;code&gt;Healthy&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Expected&lt;/strong&gt;: there should be an indication that the STS pods are not
up-to-date, and hence need to be restarted to incorporate the latest changes.&lt;/p&gt;
&lt;p&gt;There is &lt;a href="https://github.com/argoproj/argo-cd/issues/6527"&gt;an open bug&lt;/a&gt;:
&lt;code&gt;Statefulset healthcheck does not work #6527&lt;/code&gt; for it.&lt;/p&gt;
&lt;p&gt;I managed to work around it by defining my own health check. This is an use case
where Gen AI is helpful, though it does not shine. I could not have Gen AI
produce a fully working health check for this scenario. Instead, I used it to
bootstrap a basic example, then had to tweak it until it worked. This has been
tested multiple times, I am reasonably confident it works well (some edge cases
could be missing though).&lt;/p&gt;
&lt;div class="codeblock" data-lang="lua"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;lua&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-lua"&gt;health_status = {}

if obj.status == nil then
 health_status.status = &amp;#34;Progressing&amp;#34;
 health_status.message = &amp;#34;Waiting for status to be reported&amp;#34;
 return health_status
end

local strategy = obj.spec.updateStrategy and obj.spec.updateStrategy.type or &amp;#34;RollingUpdate&amp;#34;
local spec_replicas = obj.spec.replicas or 1
local ready_replicas = obj.status.readyReplicas or 0
local updated_replicas = obj.status.updatedReplicas or 0
local status_replicas = obj.status.replicas or 0
local current_revision = obj.status.currentRevision or &amp;#34;&amp;#34;
local update_revision = obj.status.updateRevision or &amp;#34;&amp;#34;

if strategy == &amp;#34;OnDelete&amp;#34; then
 if ready_replicas == status_replicas and updated_replicas == spec_replicas then
 health_status.status = &amp;#34;Healthy&amp;#34;
 health_status.message = &amp;#34;All replicas are ready and updated (OnDelete strategy)&amp;#34;
 elseif updated_replicas == 0 then
 health_status.status = &amp;#34;Degraded&amp;#34;
 health_status.message = &amp;#34;No replicas have been updated (OnDelete strategy): 0/&amp;#34; .. spec_replicas .. &amp;#34; updated. Still running an old revision!&amp;#34;
 else
 health_status.status = &amp;#34;Progressing&amp;#34;
 health_status.message = &amp;#34;Progressing (OnDelete): &amp;#34; .. ready_replicas .. &amp;#34;/&amp;#34; .. status_replicas .. &amp;#34; ready, &amp;#34; .. updated_replicas .. &amp;#34;/&amp;#34; .. spec_replicas .. &amp;#34; updated&amp;#34;
 end
else
 if ready_replicas == status_replicas and updated_replicas == spec_replicas then
 if current_revision ~= update_revision then
 health_status.status = &amp;#34;Progressing&amp;#34;
 health_status.message = &amp;#34;Waiting for rollout to complete: revision mismatch (&amp;#34; .. current_revision .. &amp;#34; ‚â† &amp;#34; .. update_revision .. &amp;#34;)&amp;#34;
 else
 health_status.status = &amp;#34;Healthy&amp;#34;
 health_status.message = &amp;#34;All replicas updated, ready, and revisions match&amp;#34;
 end
 else
 health_status.status = &amp;#34;Progressing&amp;#34;
 health_status.message = &amp;#34;RollingUpdate progressing: &amp;#34; .. ready_replicas .. &amp;#34;/&amp;#34; .. status_replicas .. &amp;#34; ready, &amp;#34; .. updated_replicas .. &amp;#34;/&amp;#34; .. spec_replicas .. &amp;#34; updated&amp;#34;
 end
end
return health_status&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;It is necessary to distinguish between &lt;code&gt;OnDelete&lt;/code&gt; and &lt;code&gt;RollingUpdate&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;OnDelete&lt;/code&gt; should not use &lt;code&gt;currentRevision&lt;/code&gt; / &lt;code&gt;update_revision&lt;/code&gt;, as these values
don&amp;rsquo;t mean anything for that update strategy. This can be observed
&lt;a href="https://github.com/argoproj/gitops-engine/blob/f8f1b61ba3fd5fcb647563db3106977e1364de31/pkg/health/health_statefulset.go#L63"&gt;upstream&lt;/a&gt;
as well.&lt;/p&gt;
&lt;p&gt;It is easy to write / tweak the health check when you look at the live STS
resource / manifest in the cluster. &lt;code&gt;obj&lt;/code&gt; refers to the STS manifest (&lt;code&gt;kubectl get sts -o yaml&lt;/code&gt;). The most relevant field is &lt;code&gt;status:&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;If you deploy ArgoCD via its helm chart, add that check for &lt;code&gt;argocd-cm&lt;/code&gt;. The
&lt;code&gt;values.yaml&lt;/code&gt; file:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;argo-cd:
 configs:
 cm:
 resource.customizations.health.apps_StatefulSet: |
 health_status = {}
 [...]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;This custom health check was partly inspired by a Prometheus alert we have:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;alert: StatefulSetUpdateNotRolledOut
expr: max without (revision) (kube_statefulset_status_current_revision unless kube_statefulset_status_update_revision) * (kube_statefulset_replicas != kube_statefulset_status_replicas_updated)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;How long will it take until LLMs &lt;del&gt;steal&lt;/del&gt; adopt this novel solution from me?&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: custom health check for StatefulSet (OnDelete)"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/bestof/"&gt;#bestof&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>ArgoCD: application stuck in unknown</title><link>https://perrotta.dev/2025/06/argocd-application-stuck-in-unknown/</link><pubDate>Thu, 12 Jun 2025 11:51:32 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/06/argocd-application-stuck-in-unknown/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: An application in ArgoCD that was previously running
smoothly has suddenly started to fail. Its status has changed to &amp;ldquo;Unknown&amp;rdquo;.
The &amp;ldquo;Refresh&amp;rdquo; button is grayed out in the Argo web UI.&lt;/p&gt;
&lt;p&gt;I found the following works in this scenario, which is typically a transient
issue:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;restart the argo server&lt;/li&gt;
&lt;li&gt;restart the argo repo server&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In terms of commands:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl rollout restart deployment argocd-server -n argocd
% kubectl rollout restart deployment argocd-repo-server -n argocd&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: application stuck in unknown"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>ArgoCD: upgrade to v3, remove helm labels</title><link>https://perrotta.dev/2025/06/argocd-upgrade-to-v3-remove-helm-labels/</link><pubDate>Mon, 02 Jun 2025 13:03:24 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/06/argocd-upgrade-to-v3-remove-helm-labels/</guid><description>&lt;p&gt;I am leading the effort to upgrade ArgoCD to its &lt;a href="https://blog.argoproj.io/announcing-argo-cd-v3-small-but-mighty-df05c0b39ad6"&gt;newest major version
(v3)&lt;/a&gt;
across our fleet.&lt;/p&gt;
&lt;p&gt;One of its &lt;a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/upgrading/2.14-3.0/"&gt;breaking
changes&lt;/a&gt;
is the removal of helm labels from argo applications, like such:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;metadata:
# [...]
 labels:
 app.kubernetes.io/managed-by: Helm&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Applying a normal sync does not get rid of the label.&lt;/p&gt;
&lt;p&gt;I found out that doing an one-off &lt;a href="https://argo-cd.readthedocs.io/en/latest/user-guide/sync-options/#server-side-apply"&gt;server-side apply
sync&lt;/a&gt;
addresses the label removal, and it is safe to do (incurs no downtime):&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;However, there are some cases where you want to use &lt;code&gt;kubectl apply --server-side&lt;/code&gt; over &lt;code&gt;kubectl apply&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;[&amp;hellip;]&lt;/p&gt;
&lt;p&gt;Patching of existing resources on the cluster that are not fully managed by
Argo CD.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;There&amp;rsquo;s no need to make the server-side apply a permanent config, i.e.:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;apiVersion: argoproj.io/v1alpha1
kind: Application
spec:
 syncPolicy:
 syncOptions:
 - ServerSideApply=true&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&amp;hellip;though there&amp;rsquo;s no harm either in doing so.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: upgrade to v3, remove helm labels"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>PDB: minAvailable and maxUnavailable cannot be both set</title><link>https://perrotta.dev/2025/06/pdb-minavailable-and-maxunavailable-cannot-be-both-set/</link><pubDate>Mon, 02 Jun 2025 12:00:05 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/06/pdb-minavailable-and-maxunavailable-cannot-be-both-set/</guid><description>&lt;p&gt;In Kubernetes it&amp;rsquo;s not possible to have a &lt;a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/"&gt;&lt;code&gt;PodDisruptionBudget&lt;/code&gt;
(PDB)&lt;/a&gt; with
both &lt;code&gt;minAvailable&lt;/code&gt; and &lt;code&gt;maxUnavailable&lt;/code&gt; set simultaneously:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;one or more objects failed to apply, reason: PodDisruptionBudget.policy &amp;#34;pgbouncer-pgbouncer&amp;#34; is invalid: spec: Invalid value: policy.PodDisruptionBudgetSpec{MinAvailable:(*intstr.IntOrString)(0xc02c03dd20), Selector:(*v1.LabelSelector)(0xc02c03dd40), MaxUnavailable:(*intstr.IntOrString)(0xc02c03dd60), UnhealthyPodEvictionPolicy:(*policy.UnhealthyPodEvictionPolicyType)(nil)}: minAvailable and maxUnavailable cannot be both set (retried 5 times).&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Our manifests did not violate this rule though. Then where did the error message
come from?&lt;/p&gt;
&lt;p&gt;It turns out &lt;a href="https://argo-cd.readthedocs.io/en/stable/"&gt;ArgoCD&lt;/a&gt; was creating an
intermediate state containing both properties:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;# [...]
spec:
 minAvailable: 1
 maxUnavailable: 1
# [...]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;One solution is to sync the underlying application PDB manifest with
&lt;a href="https://argo-cd.readthedocs.io/en/latest/user-guide/sync-options/#replace-resource-instead-of-applying-changes"&gt;replace&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Warning&lt;/strong&gt;: It&amp;rsquo;s better to &amp;ldquo;sync with replace&amp;rdquo; &lt;strong&gt;only&lt;/strong&gt; the PDB. Do not do it
in the entire application.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: PDB: minAvailable and maxUnavailable cannot be both set"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>kubernetes: list pending pods in daemonset</title><link>https://perrotta.dev/2025/05/kubernetes-list-pending-pods-in-daemonset/</link><pubDate>Tue, 20 May 2025 16:41:00 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/05/kubernetes-list-pending-pods-in-daemonset/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: Given a DaemonSet with a couple of pods stuck in
&amp;ldquo;Pending&amp;rdquo; state during their rollout, find out which nodes did not yet complete
the pod initialization.&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl get nodes -o name | grep -vFf &amp;lt;(kubectl get pods -n {namespace} -l {ds-label-selector} -o wide --no-headers | awk &amp;#39;{print &amp;#34;node/&amp;#34; $7}&amp;#39;)
node/aks-database-12345678-vmss000000
node/aks-database-12345678-vmss000002
node/aks-systempool-87654321-vmss000000
node/aks-systempool-87654321-vmss000001&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Notes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;kubectl get nodes -o name&lt;/code&gt;: list all node names in the &lt;code&gt;node/&amp;lt;name&amp;gt;&lt;/code&gt; form&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kubectl get pods [...] -o wide&lt;/code&gt;: get the node name for each running DaemonSet pod&lt;/li&gt;
&lt;li&gt;&lt;code&gt;awk '{print &amp;quot;node/&amp;quot; $7}'&lt;/code&gt;: get the node name matching the output of &lt;code&gt;get nodes&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;grep [...]&lt;/code&gt;: find the nodes we are looking for&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Surely there must be an easier way to accomplish this?&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: kubernetes: list pending pods in daemonset"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>helm-secrets + vals: string interpolation</title><link>https://perrotta.dev/2025/05/helm-secrets--vals-string-interpolation/</link><pubDate>Thu, 08 May 2025 15:25:14 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><category>security</category><guid>https://perrotta.dev/2025/05/helm-secrets--vals-string-interpolation/</guid><description>&lt;p&gt;&lt;a href="https://github.com/jkroepke/helm-secrets"&gt;helm-secrets&lt;/a&gt; is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;a helm plugin that helps to manage secrets with Git workflow and store them
anywhere.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;It uses &lt;a href="https://github.com/helmfile/vals"&gt;vals&lt;/a&gt; underneath, which is a:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Helm-like configuration values loader with support for various sources&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&amp;hellip;including, in particular, &lt;a href="https://www.hashicorp.com/en/products/vault"&gt;HashiCorp Vault&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;vals&lt;/code&gt; syntax is documented
&lt;a href="https://github.com/helmfile/vals?tab=readme-ov-file#expression-syntax"&gt;in the vals documentation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: construct a string composed of the following two vault
entries:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;vault://kv-v2/services/common/postgres/#url&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;vault://kv-v2/services/common/postgres/#params&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&amp;hellip;to yield &lt;code&gt;{url}?{params}&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;How do we concatenate two vault entries?
The secret is in the &lt;code&gt;+&lt;/code&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Finally, the optional trailing &lt;code&gt;+&lt;/code&gt; is the explicit &amp;ldquo;end&amp;rdquo; of the expression.
You usually don&amp;rsquo;t need it, as if omitted, it treats anything after &lt;code&gt;ref+&lt;/code&gt; and
before the new-line or the end-of-line as an expression to be evaluated. An
explicit &lt;code&gt;+&lt;/code&gt; is handy when you want to do a simple string interpolation. That
is, &lt;code&gt;foo ref+SECRET1+ ref+SECRET2+ bar&lt;/code&gt; evaluates to &lt;code&gt;foo SECRET1_VALUE SECRET2_VALUE bar&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The final result:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;secrets&amp;#43;literal://ref&amp;#43;vault://kv-v2/services/common/postgres/#url&amp;#43;?ref&amp;#43;vault://kv-v2/services/common/postgres/#params&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&amp;hellip;wherein &lt;code&gt;secrets+literal://&lt;/code&gt; comes from &lt;code&gt;helm-secrets&lt;/code&gt;. It needs to appear only
once. &lt;code&gt;ref+vault://&lt;/code&gt; comes from &lt;code&gt;vals&lt;/code&gt;, it appears once for each vault entry.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: helm-secrets + vals: string interpolation"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/security/"&gt;#security&lt;/a&gt;&lt;/p&gt;</description></item><item><title>HashiCorp Vault from helm values</title><link>https://perrotta.dev/2025/04/hashicorp-vault-from-helm-values/</link><pubDate>Wed, 23 Apr 2025 16:56:16 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><category>security</category><guid>https://perrotta.dev/2025/04/hashicorp-vault-from-helm-values/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: Populate HashiCorp Vault with select keys from &lt;code&gt;helm get values&lt;/code&gt; for a given chart release.&lt;/p&gt;
&lt;p&gt;The following script works:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;#!/bin/bash
# Usage: Tweak entries as needed and then run the script.

set -euo pipefail

# It&amp;#39;s an associative array: a dictionary, a hash map
#
# Key: the entry to be populated in vault
# Value: a `jq` JSON selector from the output of `helm get values -o json`
declare -A entries=(
 # keep-sorted start
 [config.aws.accessKey]=&amp;#34;.config.aws.accessKey&amp;#34;
 [config.aws.secretKey]=&amp;#34;.config.aws.secretKey&amp;#34;
 [config.cronjob.apiPassword]=&amp;#34;.config.cronjob.apiPassword&amp;#34;
 [config.cronjob.apiUser]=&amp;#34;.config.cronjob.apiUser&amp;#34;
 [config.postgresql.adminpass]=&amp;#34;.config.postgresql.adminpass&amp;#34;
 [config.postgresql.password]=&amp;#34;.config.postgresql.password&amp;#34;
 [config.postgresql.ropass]=&amp;#34;.config.postgresql.ropass&amp;#34;
 [config.postgresql.rwpass]=&amp;#34;.config.postgresql.rwpass&amp;#34;
 [config.slack.token]=&amp;#34;.config.slack.token&amp;#34;
 [config.slack.verificationToken]=&amp;#34;.config.slack.verificationToken&amp;#34;
 # keep-sorted end
)

main() {
 vault login

 FIRST=1
 for entry in &amp;#34;${!entries[@]}&amp;#34;; do
 key=&amp;#34;$entry&amp;#34;
 value=&amp;#34;${entries[$entry]}&amp;#34;
 content=&amp;#34;$(helm get values -n tools mychart -o json | jq -r &amp;#34;$value&amp;#34;)&amp;#34;

 echo &amp;#34;Populating vault $key from helm value $key: $content...&amp;#34;

 if [[ &amp;#34;$FIRST&amp;#34; == &amp;#34;1&amp;#34; ]]; then
 vault kv put -mount=&amp;#34;kv-v2&amp;#34; &amp;#34;services/mychart/&amp;#34; &amp;#34;$key=$content&amp;#34;
 FIRST=0
 else
 vault kv patch -mount=&amp;#34;kv-v2&amp;#34; &amp;#34;services/mychart/&amp;#34; &amp;#34;$key=$content&amp;#34;
 fi
 done

 vault kv get -mount=&amp;#34;kv-v2&amp;#34; &amp;#34;services/mychart&amp;#34;

 rm ~/.vault-token
}

main&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;code&gt;FIRST&lt;/code&gt;: In the first time we need to create an entry (&lt;code&gt;vault kv put&lt;/code&gt;), in the
second time we need to patch it (&lt;code&gt;vault kv patch&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: HashiCorp Vault from helm values"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/security/"&gt;#security&lt;/a&gt;&lt;/p&gt;</description></item><item><title>ArgoCD: vertical-pod-autoscaler sync loop</title><link>https://perrotta.dev/2025/02/argocd-vertical-pod-autoscaler-sync-loop/</link><pubDate>Thu, 13 Feb 2025 13:17:36 +0100</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/02/argocd-vertical-pod-autoscaler-sync-loop/</guid><description>&lt;p&gt;We&amp;rsquo;ve had a long time issue wherein our
&lt;a href="https://artifacthub.io/packages/helm/cowboysysop/vertical-pod-autoscaler"&gt;vertical-pod-autoscaler&lt;/a&gt;
(VPA) ArgoCD application, deployed via its helm chart, got stuck in a sync loop.&lt;/p&gt;
&lt;p&gt;More specifically: the helm chart automatically generates a self-signed
certificate via the
&lt;a href="https://helm.sh/docs/chart_template_guide/function_list/#genca"&gt;GenCA&lt;/a&gt; helm
function upon every change to our gitops repository. It turns out
&lt;a href="https://github.com/cowboysysop/charts/blob/9527602f8f2ea59f51cd3a7d3380810ba60c39fc/charts/vertical-pod-autoscaler/README.md?plain=1#L236"&gt;this&lt;/a&gt;
is documented and we can see its corresponding manifest
&lt;a href="https://github.com/cowboysysop/charts/blob/9527602f8f2ea59f51cd3a7d3380810ba60c39fc/charts/vertical-pod-autoscaler/templates/admission-controller/tls-secret.yaml#L3C1-L3C91"&gt;in the chart template&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;So that&amp;rsquo;s where the sync loop was coming from! ArgoCD was constantly reporting
(and resolving) a diff in the admission controller secret.&lt;/p&gt;
&lt;p&gt;The manifest:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;apiVersion: v1
data:
 ca.crt: &amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;
 tls.crt: &amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;
 tls.key: &amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;&amp;#43;
kind: Secret
metadata:
[...]
 name: vertical-pod-autoscaler-admission-controller-tls
 namespace: kube-system
[...]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;The problematic are all the ones under &lt;code&gt;data:&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I confirmed that was indeed the case in the &lt;a href="https://cloud-native.slack.com/archives/C01TSERG0KZ/p1739442822542539"&gt;CNCF
Slack&lt;/a&gt;
&lt;code&gt;#argo-cd&lt;/code&gt;. Thanks Tim!&lt;/p&gt;
&lt;p&gt;How to address it?&lt;/p&gt;
&lt;p&gt;We leverage
&lt;a href="https://argo-cd.readthedocs.io/en/stable/user-guide/diffing/"&gt;&lt;code&gt;ignoreDifferences&lt;/code&gt;&lt;/a&gt;
(c.f. &lt;a href="https://stackoverflow.com/questions/77510338/argocd-show-as-out-of-sync-on-every-push-for-auto-generate-certs-password"&gt;Stack
Overflow&lt;/a&gt;)
in the ArgoCD app manifest:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;% git diff HEAD~2..HEAD
diff --git apps/base/vertical-pod-autoscaler/vertical-pod-autoscaler.yaml apps/base/vertical-pod-autoscaler/vertical-pod-autoscaler.yaml
index 92bfbcc..90d8435 100644
--- apps/base/vertical-pod-autoscaler/vertical-pod-autoscaler.yaml
&amp;#43;&amp;#43;&amp;#43; apps/base/vertical-pod-autoscaler/vertical-pod-autoscaler.yaml
@@ -34,3 &amp;#43;34,15 @@ spec:
 maxDuration: 1m
 syncOptions:
 - CreateNamespace=true
&amp;#43; - RespectIgnoreDifferences=true
&amp;#43; ignoreDifferences:
&amp;#43; - group: &amp;#34;&amp;#34;
&amp;#43; kind: Secret
&amp;#43; name: vertical-pod-autoscaler-admission-controller-tls
&amp;#43; jsonPointers:
&amp;#43; - /data
&amp;#43; - group: apps
&amp;#43; kind: Deployment
&amp;#43; name: vertical-pod-autoscaler-admission-controller
&amp;#43; jsonPointers:
&amp;#43; - /spec/template/metadata/annotations/checksum~1tls-secret&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;In &lt;a href="https://www.rfc-editor.org/rfc/rfc6901"&gt;JSON Pointers&lt;/a&gt; (RFC 6901), one
escapes the slash character with a &lt;code&gt;~1&lt;/code&gt; (c.f. section 3 in the spec):&lt;/p&gt;
&lt;blockquote&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;Because the characters &amp;#39;~&amp;#39; (%x7E) and &amp;#39;/&amp;#39; (%x2F) have special meanings in
JSON Pointer, &amp;#39;~&amp;#39; needs to be encoded as &amp;#39;~0&amp;#39; and &amp;#39;/&amp;#39; needs to be encoded as
&amp;#39;~1&amp;#39; when these characters appear in a reference token.&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/blockquote&gt;
&lt;p&gt;Problem resolved!&lt;/p&gt;
&lt;p&gt;In general all helm charts that generate self-signed certificates (with &lt;code&gt;genCA&lt;/code&gt;)
may experience this sync loop when used with a CD framework such as Argo.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: vertical-pod-autoscaler sync loop"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>Kubernetes: create a pod in pending state</title><link>https://perrotta.dev/2025/02/kubernetes-create-a-pod-in-pending-state/</link><pubDate>Fri, 07 Feb 2025 13:58:36 +0100</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/02/kubernetes-create-a-pod-in-pending-state/</guid><description>&lt;p&gt;We are making a non-trivial change to our cluster monitoring architecture, and I
needed to verify the new rollout is properly working in our infratesting
environment.&lt;/p&gt;
&lt;p&gt;A simple way to do so is to create a pod that never leaves the &amp;ldquo;Pending&amp;rdquo; state,
because we have an alert (a prometheus rule) that fires whenever a pod is in
that stack for too long (15 minutes is our threshold in most cases).&lt;/p&gt;
&lt;p&gt;Use the following manifest:&lt;/p&gt;
&lt;div class="codeblock" data-lang="yaml"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;yaml&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-yaml"&gt;apiVersion: v1
kind: Pod
metadata:
 name: pending-pod
spec:
 affinity:
 podAffinity:
 requiredDuringSchedulingIgnoredDuringExecution:
 - labelSelector:
 matchExpressions:
 - key: &amp;#34;non/existent&amp;#34;
 operator: In
 values:
 - &amp;#34;true&amp;#34;
 topologyKey: &amp;#34;kubernetes.io/hostname&amp;#34;
 containers:
 - name: busybox
 image: busybox
 command: [&amp;#39;sh&amp;#39;, &amp;#39;-c&amp;#39;, &amp;#39;echo Hello, Kubernetes! &amp;amp;&amp;amp; sleep 3600&amp;#39;]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&amp;hellip;it creates a &lt;code&gt;pending-pod&lt;/code&gt; in the &lt;code&gt;default&lt;/code&gt; namespace that should never be
scheduled, due to its strict pod affinity rules.&lt;/p&gt;
&lt;p&gt;Save it as &lt;code&gt;pending-pod.yaml&lt;/code&gt;, deploy it with &lt;code&gt;kubectl apply -f pending-pod.yaml&lt;/code&gt;.&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;$ kubectl get pod pending-pod -w
NAME READY STATUS RESTARTS AGE
pending-pod 0/1 Pending 0 21s
 pending-pod 0/1 Pending 0 65s
pending-pod 0/1 Pending 0 74s
pending-pod 0/1 Pending 0 2m6s
pending-pod 0/1 Pending 0 3m8s
pending-pod 0/1 Pending 0 4m8s
pending-pod 0/1 Pending 0 4m18s&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;At some point the alert fires, as expected.
And now we can roll out these changes to prod!&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Kubernetes: create a pod in pending state"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>ArgoCD: cache: key is missing</title><link>https://perrotta.dev/2025/01/argocd-cache-key-is-missing/</link><pubDate>Thu, 09 Jan 2025 20:20:03 -0300</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/01/argocd-cache-key-is-missing/</guid><description>&lt;p&gt;If you experience the title error message in ArgoCD (e.g. via its web UI and/or
in pod logs), it&amp;rsquo;s related to
&lt;a href="https://github.com/argoproj/argo-cd/issues/5068"&gt;argo-cd#5068&lt;/a&gt;. The full error
message is:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;Unable to load data: cache: key is missing&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;As I
&lt;a href="https://github.com/argoproj/argo-cd/issues/5068#issuecomment-2580878251"&gt;commented&lt;/a&gt;
in the bug, here&amp;rsquo;s how to fix it:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The following workaround sufficed for me: &lt;code&gt;kubectl delete pod -n argocd argocd-application-controller-0&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Initially I ran &lt;code&gt;kubectl rollout restart deployment -n argocd argocd-application-controller&lt;/code&gt; but it didn&amp;rsquo;t work.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;In my experience, this error only happens once, ephemerally, during ArgoCD
bootstrapping. Once fixed it does not reoccur.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update(2025-06-06)&lt;/strong&gt;: This error reoccurs intermittently ü§∑.&lt;/p&gt;
&lt;p&gt;Another potential workaround is to disable redis / caching altogether, as ArgoCD
can fully operate without it, but I wouldn&amp;rsquo;t recommend that.&lt;/p&gt;
&lt;p&gt;See also: &lt;a href="https://github.com/argoproj/argo-cd/issues/18503"&gt;#18503&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: ArgoCD: cache: key is missing"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>Helm: migrate chart dependencies from HTTPS to OCI</title><link>https://perrotta.dev/2025/01/helm-migrate-chart-dependencies-from-https-to-oci/</link><pubDate>Wed, 08 Jan 2025 18:45:57 -0300</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2025/01/helm-migrate-chart-dependencies-from-https-to-oci/</guid><description>&lt;p&gt;I got aware of this due to
&lt;a href="https://blog.bitnami.com/2024/10/bitnami-helm-charts-moving-to-oci.html"&gt;Bitnami&lt;/a&gt;&amp;rsquo;s
blog post.&lt;/p&gt;
&lt;p&gt;In &lt;code&gt;Chart.yaml&lt;/code&gt;, instead of depending on:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;- https://charts.bitnami.com/bitnami/airflow-18.3.2.tgz&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Instead, depend on:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;- oci://registry-1.docker.io/bitnamicharts/airflow:18.3.2&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;The switch is transparent, it works out-of-the-box.&lt;/p&gt;
&lt;p&gt;However there&amp;rsquo;s one caveat: You cannot &lt;code&gt;helm repo add oci://registry-1.docker.io/bitnamicharts&lt;/code&gt;. That only works for &lt;code&gt;https://&lt;/code&gt;
registries.&lt;/p&gt;
&lt;p&gt;The workaround is to &lt;code&gt;helm pull oci://[...] --version {version}&lt;/code&gt; and/or to
browse available tags/versions via docker hub.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Helm: migrate chart dependencies from HTTPS to OCI"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>‚òÖ skopeo: operate container images and registries</title><link>https://perrotta.dev/2024/12/skopeo-operate-container-images-and-registries/</link><pubDate>Tue, 17 Dec 2024 17:49:31 -0300</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>aws</category><category>bestof</category><category>dev</category><category>docker</category><category>kubernetes</category><guid>https://perrotta.dev/2024/12/skopeo-operate-container-images-and-registries/</guid><description>&lt;p&gt;When working with &lt;code&gt;docker&lt;/code&gt; and private image registries, a common workflow is to copy images from one private registry in the cloud to another. This can be done with &lt;a href="https://github.com/containers/skopeo/"&gt;&lt;code&gt;skopeo&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This post includes some common recipes for it.&lt;/p&gt;
&lt;h2 id="usage-1-default--root-to-staging"&gt;Usage 1) Default / Root to Staging&lt;/h2&gt;
&lt;p&gt;From the default / root account registry to the staging registry:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;skopeo sync \
 --src-creds &amp;#34;AWS:$(aws ecr get-login-password --region {region} --profile default)&amp;#34; \
 --dest-creds &amp;#34;AWS:$(aws ecr get-login-password --region {region} --profile staging)&amp;#34; \
 --override-os linux --override-arch amd64 \
 --src docker --dest docker \
 {account_id_root}.dkr.ecr.{region}.amazonaws.com/{org}/{repository}:{tag} \
 {account_id_staging}.dkr.ecr.{region}.amazonaws.com/{org}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Example values&lt;sup id="fnref:1"&gt;&lt;a href="https://perrotta.dev/2024/12/skopeo-operate-container-images-and-registries/#fn:1" class="footnote-ref" role="doc-noteref"&gt;1&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;repository: &lt;code&gt;argocd-gitops-tools&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;tag (version): &lt;code&gt;1.0.1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;region: &lt;code&gt;us-east-1&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="usage-2-public-to-mfa"&gt;Usage 2) Public to MFA&lt;/h2&gt;
&lt;p&gt;From a public registry to a private registry that uses MFA (multi-factor authentication).&lt;/p&gt;
&lt;p&gt;First, it&amp;rsquo;s necessary to get MFA credentials. Source the script below
(&lt;code&gt;china.mfa.sh&lt;/code&gt;):&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;#!/usr/bin/env bash
# shellcheck disable=SC2155

export AWS_PROFILE=china

echo -n &amp;#34;Enter the MFA token code for your AWS China account: &amp;#34; &amp;amp;&amp;amp; read -r token

mfa_arn=&amp;#34;$(aws iam --profile &amp;#34;$AWS_PROFILE&amp;#34; get-user --output text --query User.Arn | sed &amp;#39;s/:user\//:mfa\//&amp;#39;)&amp;#34;
credentials=&amp;#34;$(aws --profile &amp;#34;$AWS_PROFILE&amp;#34; sts get-session-token --serial-number &amp;#34;$mfa_arn&amp;#34; --token-code &amp;#34;$token&amp;#34; --duration-seconds 86400)&amp;#34;

echo &amp;#34;Got credentials: $credentials&amp;#34;

export AWS_ACCESS_KEY_ID=$(echo &amp;#34;$credentials&amp;#34; | jq -r &amp;#39;.Credentials.AccessKeyId&amp;#39;)
export AWS_SECRET_ACCESS_KEY=$(echo &amp;#34;$credentials&amp;#34; | jq -r &amp;#39;.Credentials.SecretAccessKey&amp;#39;)
export AWS_SESSION_TOKEN=$(echo &amp;#34;$credentials&amp;#34; | jq -r &amp;#39;.Credentials.SessionToken&amp;#39;)

[[ -n &amp;#34;$AWS_SESSION_TOKEN&amp;#34; ] &amp;amp;&amp;amp; echo &amp;#34;Success!&amp;#34;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Important&lt;/strong&gt;: It is necessary to do &lt;code&gt;source china-mfa.sh&lt;/code&gt;. Doing &lt;code&gt;./china-mfa.sh&lt;/code&gt;
will &lt;strong&gt;not&lt;/strong&gt; work.&lt;/p&gt;
&lt;p&gt;Then we can proceed with the image sync:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;skopeo sync \
 --dest-creds &amp;#34;AWS:$(aws ecr get-login-password --region cn-north-1)&amp;#34; \
 --override-os linux --override-arch amd64 \
 --src docker \
 --dest docker \
 quay.io/argoproj/argocd:v2.12.6 \
 {account_id_mfa}.dkr.ecr.cn-north-1.amazonaws.com.cn/quay.io/argoproj&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Notes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A public registry does not need authentication, hence there&amp;rsquo;s no &lt;code&gt;--src-creds&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;--dest-creds&lt;/code&gt; does not specify a &lt;code&gt;--profile&lt;/code&gt;. Likewise, no &lt;code&gt;AWS_PROFILE&lt;/code&gt; env var should be defined.&lt;/li&gt;
&lt;li&gt;In this example, China (&lt;code&gt;cn-north-1&lt;/code&gt;) is an AWS account with MFA enabled.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="potpourri"&gt;Potpourri&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;It&amp;rsquo;s possible to pass &lt;code&gt;--scoped&lt;/code&gt; to prefix images at destination using the
full source image path as scope.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;To sync multiple image architectures, pass &lt;code&gt;-a&lt;/code&gt; or &lt;code&gt;--all&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;If syncing from/to Azure (ACR), use &lt;code&gt;az acr login&lt;/code&gt;. Find the &lt;code&gt;username&lt;/code&gt; in the
Azure portal. For example:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;az acr login -n {container registry name} --expose-token | jq -r &amp;#39;.accessToken&amp;#39; | skopeo login {registry} --password-stdin --username {username}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="footnotes" role="doc-endnotes"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;image = registry (includes the org name) + repository + tag&amp;#160;&lt;a href="https://perrotta.dev/2024/12/skopeo-operate-container-images-and-registries/#fnref:1" class="footnote-backref" role="doc-backlink"&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: skopeo: operate container images and registries"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/aws/"&gt;#aws&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/bestof/"&gt;#bestof&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/docker/"&gt;#docker&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>Kubernetes: tail logs from pods with stern</title><link>https://perrotta.dev/2024/12/kubernetes-tail-logs-from-pods-with-stern/</link><pubDate>Tue, 17 Dec 2024 16:37:16 -0300</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/12/kubernetes-tail-logs-from-pods-with-stern/</guid><description>&lt;p&gt;You can always use &lt;code&gt;kubectl logs -n {namespace} {pod} [-c {container}] -f&lt;/code&gt; to
inspect logs from a specific pod&lt;sup id="fnref:1"&gt;&lt;a href="https://perrotta.dev/2024/12/kubernetes-tail-logs-from-pods-with-stern/#fn:1" class="footnote-ref" role="doc-noteref"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;Nonetheless that doesn&amp;rsquo;t scale when you don&amp;rsquo;t know which pod you want in the
first place.&lt;/p&gt;
&lt;p&gt;You could start with deployments, dive into replica sets, and then into
individual pods, one by one, but&amp;hellip; that is tedious and slow.&lt;/p&gt;
&lt;p&gt;We can do better with &lt;a href="https://github.com/stern/stern"&gt;stern&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;‚éà Multi pod and container log tailing for Kubernetes&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Usage:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;stern pod-query [flags]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;The pod-query is a regular expression or a Kubernetes resource in the form
&lt;code&gt;&amp;lt;resource&amp;gt;/&amp;lt;name&amp;gt;&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% stern -n argocd argocd&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;We can also &lt;code&gt;grep&lt;/code&gt; for specific strings in log lines with &lt;code&gt;--include&lt;/code&gt;:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% stern -n argocd argocd --include level=error&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Or &lt;code&gt;grep -v&lt;/code&gt; with &lt;code&gt;--exclude&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s better to use &lt;code&gt;--include&lt;/code&gt; / &lt;code&gt;--exclude&lt;/code&gt; than to &lt;code&gt;| grep&lt;/code&gt;, because it
preserves color attributes (each pod has a different color in the aggregated
log output).&lt;/p&gt;
&lt;p&gt;The logs stream by default (like &lt;code&gt;tail -f&lt;/code&gt;, or &lt;code&gt;kubectl logs -f&lt;/code&gt;).&lt;/p&gt;
&lt;div class="footnotes" role="doc-endnotes"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;&lt;code&gt;-c&lt;/code&gt; to specify a container within it, and &lt;code&gt;-f&lt;/code&gt; to stream logs √† la &lt;code&gt;tail -f&lt;/code&gt;.&amp;#160;&lt;a href="https://perrotta.dev/2024/12/kubernetes-tail-logs-from-pods-with-stern/#fnref:1" class="footnote-backref" role="doc-backlink"&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Kubernetes: tail logs from pods with stern"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>Kubernetes: debugging services</title><link>https://perrotta.dev/2024/12/kubernetes-debugging-services/</link><pubDate>Mon, 16 Dec 2024 10:14:11 -0300</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/12/kubernetes-debugging-services/</guid><description>&lt;p&gt;I am deploying a new helm chart to our staging environments, and needed a way to
ensure its dependencies in &lt;code&gt;values.yaml&lt;/code&gt; are properly configured.&lt;/p&gt;
&lt;p&gt;From the official kubernetes
&lt;a href="https://kubernetes.io/docs/tasks/debug/debug-application/debug-service/"&gt;documentation&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;An issue that comes up rather frequently for new installations of Kubernetes
is that a Service is not working properly. You&amp;rsquo;ve run your Pods through a
Deployment (or other workload controller) and created a Service, but you get
no response when you try to access it. This document will hopefully help you
to figure out what&amp;rsquo;s going wrong.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id="run-commands-in-a-brand-new-pod"&gt;Run commands in a brand new pod&lt;/h2&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl run -it --rm --restart=Never busybox --image=gcr.io/google-containers/busybox sh&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&amp;hellip;quite verbose, but it works reliably, spawning a basic pod with
&lt;a href="https://www.busybox.net/"&gt;busybox&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I prefer to have a package manager at my fingertips, hence &lt;code&gt;alpine&lt;/code&gt; is arguably
a better choice:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl run -it --rm --restart=Never busybox --image=alpine ash&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;You don&amp;rsquo;t need to remember that alpine uses &lt;code&gt;ash&lt;/code&gt; by default, &lt;code&gt;sh&lt;/code&gt; works as
well. In fact:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;/ # ls -al /bin | grep sh
lrwxrwxrwx 1 root root 12 Dec 5 12:17 ash -&amp;gt; /bin/busybox
lrwxrwxrwx 1 root root 12 Dec 5 12:17 fdflush -&amp;gt; /bin/busybox
lrwxrwxrwx 1 root root 12 Dec 5 12:17 sh -&amp;gt; /bin/busybox&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Then I could do, for example, &lt;code&gt;apk update&lt;/code&gt; + &lt;code&gt;apk add mtr nmap&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Alpine is marvellous for this because &lt;code&gt;apk&lt;/code&gt; is very lightweight (and, hence,
fast!) and the available packages from upstream are quite comprehensive.&lt;/p&gt;
&lt;h2 id="run-commands-in-an-already-existing-pod"&gt;Run commands in an already existing pod&lt;/h2&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl exec &amp;lt;POD-NAME&amp;gt; -c &amp;lt;CONTAINER-NAME&amp;gt; -- &amp;lt;COMMAND&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&amp;hellip;however you cannot choose a custom image this way. You&amp;rsquo;re stuck with whatever
the pod is running.&lt;/p&gt;
&lt;p&gt;The way around this is with the use of ephemeral debug containers. Newer
versions of kubernetes have the &lt;code&gt;kubectl debug&lt;/code&gt; command:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% kubectl debug -it &amp;lt;POD-NAME&amp;gt; --image=alpine [--target=&amp;lt;POD-NAME&amp;gt;]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Happy debugging!&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Kubernetes: debugging services"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>Helm: JSON schema generation</title><link>https://perrotta.dev/2024/11/helm-json-schema-generation/</link><pubDate>Thu, 14 Nov 2024 15:05:49 +0100</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/11/helm-json-schema-generation/</guid><description>&lt;p&gt;Helm charts support the inclusion of a &lt;code&gt;values.schema.json&lt;/code&gt; file to validate
&lt;code&gt;values.yaml&lt;/code&gt;. Documentation: &lt;a href="https://helm.sh/docs/topics/charts/#schema-files"&gt;https://helm.sh/docs/topics/charts/#schema-files&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;A JSON schema is akin to defining the structure of and type-annotating a JSON
file. It helps to &amp;ldquo;shift left&amp;rdquo; the lifecycle of your helm releases.&lt;/p&gt;
&lt;p&gt;For a pre-existing &lt;code&gt;values.yaml&lt;/code&gt; file, it may be quite tedious to generate the
schema from scratch, by hand.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Can we automate this process?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Of course we can.&lt;/p&gt;
&lt;p&gt;One possibility is to use GenAI / LLMs. This is out of scope of this post.&lt;/p&gt;
&lt;p&gt;Another possibility is to leverage a helm plug-in to do so.&lt;/p&gt;
&lt;p&gt;I had a good experience with &lt;a href="https://github.com/karuppiah7890/helm-schema-gen"&gt;https://github.com/karuppiah7890/helm-schema-gen&lt;/a&gt;:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;helm plugin install https://github.com/karuppiah7890/helm-schema-gen.git
cd path/to/helm/chart
helm schema-gen values.yaml | tee values.schema.json&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Afterwards, test the generated schema with:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;helm lint path/to/helm/chart&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Usually I need to do some follow-up edits to the generated file, including:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;add string enum types for a tighter validation of strings&lt;/li&gt;
&lt;li&gt;mark certain fields as required&lt;/li&gt;
&lt;li&gt;mark certain fields with &lt;code&gt;additionalProperties: &amp;quot;false&amp;quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;augment &lt;code&gt;[&amp;quot;null&amp;quot;]&lt;/code&gt; to &lt;code&gt;[&amp;quot;null&amp;quot;, &amp;quot;string&amp;quot;]&lt;/code&gt; for keys that do not have a
default value&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It&amp;rsquo;s worth to observe that, at the time of this publication, the following
notice is present in the repository of the plug-in:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This repository has been archived by the owner on Aug 31, 2021. It is now
read-only.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Nonetheless, it still works well.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Helm: JSON schema generation"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>‚òÖ Helm: enforce the directory name matches the chart name</title><link>https://perrotta.dev/2024/11/helm-enforce-the-directory-name-matches-the-chart-name/</link><pubDate>Tue, 12 Nov 2024 11:13:06 +0100</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>bestof</category><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/11/helm-enforce-the-directory-name-matches-the-chart-name/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: Given a helm chart called &lt;code&gt;foo&lt;/code&gt;, enforce that its &lt;code&gt;Chart.yaml&lt;/code&gt; file lives in a directory called &lt;code&gt;foo&lt;/code&gt;&lt;sup id="fnref:1"&gt;&lt;a href="https://perrotta.dev/2024/11/helm-enforce-the-directory-name-matches-the-chart-name/#fn:1" class="footnote-ref" role="doc-noteref"&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h2 id="background"&gt;Background&lt;/h2&gt;
&lt;p&gt;In 2016, this &lt;a href="https://github.com/helm/helm/pull/818/"&gt;used to be&lt;/a&gt; the default behavior in Helm:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;fix(helm): produce error if package name is inconsistent&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;In 2018, this enforcement was &lt;a href="https://github.com/helm/helm/pull/4141"&gt;removed&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;remove dirname constraint on helm package&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;We would like to reintroduce this requirement in our Helm charts codebase, as a best practice, to prevent chart name collisions.&lt;/p&gt;
&lt;p&gt;What would be the most native way to accomplish that?&lt;/p&gt;
&lt;p&gt;I would probably write a git pre-commit hook if there is no native way (e.g. via some &lt;code&gt;helm lint&lt;/code&gt; flag).&lt;/p&gt;
&lt;h2 id="solution"&gt;Solution&lt;/h2&gt;
&lt;p&gt;Use the following script with &lt;a href="https://pre-commit.com/"&gt;pre-commit&lt;/a&gt;:&lt;/p&gt;
&lt;div class="codeblock" data-lang="bash"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;bash&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;#!/usr/bin/env bash
#
# Check that the directory name matches the chart name in Chart.yaml.
#
# Examples:
# - foo/Chart.yaml with &amp;#34;name: hey-foo&amp;#34; fails the check.
# - foo/Chart.yaml with &amp;#34;name: foo&amp;#34; passes the check.
#
# Usage: $0 [path/to/chart/Chart.yaml ...]

for chart in &amp;#34;$@&amp;#34;; do
	dirname=&amp;#34;$(basename &amp;#34;$(dirname &amp;#34;$chart&amp;#34;)&amp;#34;)&amp;#34;

	# Remove trailing slash.
	dirname=&amp;#34;${dirname%/}&amp;#34;

	# Fetch chart name from Chart.yaml.
	chart_name=&amp;#34;$(yq e &amp;#39;.name&amp;#39; &amp;#34;$chart&amp;#34;)&amp;#34;

	if [[ $dirname != &amp;#34;$chart_name&amp;#34; ]]; then
		echo &amp;#34;error: directory name &amp;#39;${dirname}&amp;#39; does not match chart name &amp;#39;${chart_name}&amp;#39;&amp;#34;
		exit 1
	fi
done&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;h2 id="reference"&gt;Reference&lt;/h2&gt;
&lt;p&gt;I asked and self-answered this question on &lt;a href="https://stackoverflow.com/questions/79166730/how-to-enforce-that-the-directory-name-must-match-the-chart-name/79180650#79180650"&gt;Stack Overflow&lt;/a&gt;.&lt;/p&gt;
&lt;div class="footnotes" role="doc-endnotes"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;&lt;em&gt;Why&lt;/em&gt;? For ease of management, simplicity, consistency &amp;amp; uniformity.&amp;#160;&lt;a href="https://perrotta.dev/2024/11/helm-enforce-the-directory-name-matches-the-chart-name/#fnref:1" class="footnote-backref" role="doc-backlink"&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Helm: enforce the directory name matches the chart name"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/bestof/"&gt;#bestof&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>kubectl: list all node pods</title><link>https://perrotta.dev/2024/10/kubectl-list-all-node-pods/</link><pubDate>Wed, 16 Oct 2024 12:26:24 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/10/kubectl-list-all-node-pods/</guid><description>&lt;p&gt;Recipe to list all pods that belong to a given node:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;$ kubectl get pod -o wide --field-selector spec.nodeName={node_name} -A&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Source&lt;/strong&gt;: &lt;a href="https://stackoverflow.com/questions/39231880/kubernetes-api-get-pods-on-specific-nodes"&gt;https://stackoverflow.com/questions/39231880/kubernetes-api-get-pods-on-specific-nodes&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This &lt;em&gt;ought to&lt;/em&gt; be easier to remember&amp;hellip;&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: kubectl: list all node pods"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>kubectl: force delete pods</title><link>https://perrotta.dev/2024/10/kubectl-force-delete-pods/</link><pubDate>Tue, 15 Oct 2024 13:14:40 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/10/kubectl-force-delete-pods/</guid><description>&lt;p&gt;Our installation of &lt;code&gt;traefik&lt;/code&gt; via &lt;code&gt;helm&lt;/code&gt; got stuck today in such a way that its
pods did not terminate, even with successive &lt;code&gt;kubectl delete&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;--force&lt;/code&gt; did not work either :mildshock:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;--grace-period=0&lt;/code&gt; (alongside &lt;code&gt;--force&lt;/code&gt;) did the trick:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl delete pod traefik-{...} --grace-period=0 --force --namespace kube-system&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Source&lt;/strong&gt;: &lt;a href="https://stackoverflow.com/questions/35453792/pods-stuck-in-terminating-status"&gt;https://stackoverflow.com/questions/35453792/pods-stuck-in-terminating-status&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: kubectl: force delete pods"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>New APKBUILD: argocd</title><link>https://perrotta.dev/2024/10/new-apkbuild-argocd/</link><pubDate>Wed, 09 Oct 2024 23:03:32 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>alpine-linux</category><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/10/new-apkbuild-argocd/</guid><description>&lt;p&gt;&lt;a href="https://argo-cd.readthedocs.io/en/stable/"&gt;ArgoCD&lt;/a&gt; is a widely used GitOps
software for Kubernetes Continuous Delivery (see
&lt;a href="https://github.com/argoproj/argo-cd/blob/master/USERS.md"&gt;USERS.md&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;I am quite surprised no one bothered to create an Alpine Linux package for it.&lt;/p&gt;
&lt;p&gt;Until&amp;hellip;&lt;a href="https://gitlab.alpinelinux.org/alpine/aports/-/merge_requests/73305"&gt;now&lt;/a&gt;,
by yours truly.&lt;/p&gt;
&lt;p&gt;This &lt;code&gt;APKBUILD&lt;/code&gt; took a bit longer to create than the usual.
There were a couple of issues with &lt;code&gt;-buildmode=pie&lt;/code&gt;, addressed with
&lt;code&gt;export CGO_ENABLED=1&lt;/code&gt; (via &lt;code&gt;make CGO_FLAG=1&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Also, not every architecture is compatible with it. The following error message
appears in ARM builds:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;cannot use math.MaxInt64 (untyped int constant 9223372036854775807) as int value in argument to env.ParseNumFromEnv (overflows)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Anyway, once it is merged upstream, enjoy!&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;% doas apk add argocd&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: New APKBUILD: argocd"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/alpine-linux/"&gt;#alpine-linux&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>helm: list recent chart upgrades</title><link>https://perrotta.dev/2024/09/helm-list-recent-chart-upgrades/</link><pubDate>Tue, 24 Sep 2024 14:21:20 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/09/helm-list-recent-chart-upgrades/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: Given a kubernetes cluster with many helm charts in
different namespaces, how to use &lt;code&gt;helm&lt;/code&gt; to query the list of the last recently
&amp;ldquo;touched&amp;rdquo; charts?&lt;/p&gt;
&lt;p&gt;By &amp;ldquo;touched&amp;rdquo; we mean either installed (via &lt;code&gt;helm install&lt;/code&gt;) or upgraded (via
&lt;code&gt;helm upgrade&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Something like: &lt;code&gt;helm ls --all --sort-by updated&lt;/code&gt;. Using &lt;code&gt;kubectl&lt;/code&gt; directly
would also be OK.&lt;/p&gt;
&lt;h2 id="solution"&gt;Solution&lt;/h2&gt;
&lt;p&gt;The brute force way:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;helm ls --max 99999 -A -o json | jq -r &amp;#39;.[] | &amp;#34;\(.updated)\t\(.name)&amp;#34;&amp;#39; | sort | tail | column -t&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-A&lt;/code&gt; for all namespaces&lt;/li&gt;
&lt;li&gt;&lt;code&gt;--max 99999&lt;/code&gt; to &amp;ldquo;disable&amp;rdquo; &lt;a href="https://github.com/helm/helm/issues/3322"&gt;paging&lt;/a&gt; (there&amp;rsquo;s no better way as of 2024-09-24)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;jq&lt;/code&gt; to filter out on the &amp;ldquo;updated&amp;rdquo; field&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note that a sample json entry looks like the following:&lt;/p&gt;
&lt;div class="codeblock" data-lang="json"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;json&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-json"&gt;{
 &amp;#34;name&amp;#34;: &amp;#34;hoth-cb7f8a327&amp;#34;,
 &amp;#34;namespace&amp;#34;: &amp;#34;default&amp;#34;,
 &amp;#34;revision&amp;#34;: &amp;#34;2&amp;#34;,
 &amp;#34;updated&amp;#34;: &amp;#34;2024-06-14 15:02:16.775174131 &amp;#43;0000 UTC&amp;#34;,
 &amp;#34;status&amp;#34;: &amp;#34;deployed&amp;#34;,
 &amp;#34;chart&amp;#34;: &amp;#34;hoth-0.1.0&amp;#34;,
 &amp;#34;app_version&amp;#34;: &amp;#34;1.0.0&amp;#34;
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Sample output of the aforementioned command:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;2024-09-24 10:56:15.655674586 &amp;#43;0000 UTC geonosis
2024-09-24 10:56:15.731630075 &amp;#43;0000 UTC coruscant
2024-09-24 11:01:35.156973247 &amp;#43;0000 UTC endor
2024-09-24 11:02:30.314014351 &amp;#43;0000 UTC hoth&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: helm: list recent chart upgrades"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>Helm: list all installed charts in the cluster</title><link>https://perrotta.dev/2024/08/helm-list-all-installed-charts-in-the-cluster/</link><pubDate>Mon, 26 Aug 2024 17:57:07 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/08/helm-list-all-installed-charts-in-the-cluster/</guid><description>&lt;p&gt;In theory this ought to be really easy:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;$ helm ls -h
[...]
 -a, --all show all releases without any filter applied
 -A, --all-namespaces list releases across all namespaces&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;So&amp;hellip;one of these should work, right?&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;helm ls -a
helm ls -A&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;I have a &lt;code&gt;sms-service&lt;/code&gt; running in the cluster in the &lt;code&gt;default&lt;/code&gt; namespace. If I
&lt;code&gt;grep&lt;/code&gt; any of the previous commands to &lt;code&gt;sms&lt;/code&gt;, it does not show up though.&lt;/p&gt;
&lt;p&gt;Then&amp;hellip;maybe &lt;code&gt;helm ls -a -A&lt;/code&gt;? Nope.&lt;/p&gt;
&lt;p&gt;Here&amp;rsquo;s what works:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;$ helm ls -a --max 9999 | grep sms
sms-service 	default 	356 	2024-08-26 14:09:50.705277885 &amp;#43;0000 UTC	deployed	sms-v0.1.0&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Kinda ridiculous, eh?&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt; -m, --max int maximum number of releases to fetch (default 256)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;From &lt;a href="https://helm.sh/docs/helm/helm_list/"&gt;https://helm.sh/docs/helm/helm_list/&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;By default, up to 256 items may be returned. To limit this, use the &amp;lsquo;&amp;ndash;max&amp;rsquo;
flag. Setting &amp;lsquo;&amp;ndash;max&amp;rsquo; to 0 will not return all results. Rather, it will return
the server&amp;rsquo;s default, which may be much higher than 256. Pairing the &amp;lsquo;&amp;ndash;max&amp;rsquo;
flag with the &amp;lsquo;&amp;ndash;offset&amp;rsquo; flag allows you to page through results.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Therefore I settle with this form:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;$ helm ls -a -A --max 9999 | grep sms&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Happy helming.&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Helm: list all installed charts in the cluster"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>kubectl: print all secret values in plain text</title><link>https://perrotta.dev/2024/08/kubectl-print-all-secret-values-in-plain-text/</link><pubDate>Tue, 06 Aug 2024 13:37:31 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/08/kubectl-print-all-secret-values-in-plain-text/</guid><description>&lt;p&gt;&lt;strong&gt;Problem statement&lt;/strong&gt;: Given a &lt;a href="https://kubernetes.io/docs/concepts/configuration/secret/"&gt;kubernetes
secret&lt;/a&gt; with more
than one key-value pair, print &lt;strong&gt;all&lt;/strong&gt; of them in plain text (i.e.
base64-decoded in this context).&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Edit(2024-08-08)&lt;/strong&gt;: It turns out I made a mistake. The effect of the post
below is akin to &lt;code&gt;kubectl get [...] -o yaml&lt;/code&gt;. I&amp;rsquo;ll keep the post for
bookkeeping purposes anyway.&lt;/p&gt;
&lt;p&gt;Basically, something like:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl cat secret -n infra-services my-cool-secret&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Except that there is no &lt;code&gt;kubectl cat&lt;/code&gt;, what a shame. It would be really great if
we had it, for consistency with &lt;code&gt;systemctl cat&lt;/code&gt;. Oh well.&lt;/p&gt;
&lt;p&gt;There is &lt;code&gt;kubectl edit&lt;/code&gt; though ‚Äì amen, just like &lt;code&gt;systemctl edit&lt;/code&gt;. This will
open your &lt;code&gt;$EDITOR&lt;/code&gt;. It&amp;rsquo;s often inconvenient to copy text to the clipboard from
your terminal-based editor though, due to intricacies of different terminals,
shells, terminal multiplexers, and OSC-52, therefore I don&amp;rsquo;t deem this as an
acceptable solution.&lt;/p&gt;
&lt;p&gt;There is a simple trick though:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;EDITOR=cat kubectl edit secret -n infra-services my-cool-secret&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&amp;hellip;which works exactly as you would expect &lt;code&gt;kubectl cat&lt;/code&gt; to behave. It displays
a warning at the end:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;Edit cancelled, no changes made.&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&amp;hellip;however it can be duly ignored.&lt;/p&gt;
&lt;p&gt;If we didn&amp;rsquo;t have this trick, we could have:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;written a bloated tool in golang to pipe to e.g. &lt;a href="https://github.com/ashleyschuett/kubernetes-secret-decode"&gt;https://github.com/ashleyschuett/kubernetes-secret-decode&lt;/a&gt; (&lt;a href="https://itnext.io/secrets-in-plain-text-13a98f54ef97"&gt;via&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;used the &lt;code&gt;kubectl edit&lt;/code&gt; trick above, with a decent terminal and OSC-52 setup&lt;/li&gt;
&lt;li&gt;used &lt;code&gt;jq&lt;/code&gt; with its &lt;code&gt;map&lt;/code&gt; and &lt;code&gt;base64d&lt;/code&gt; constructs (c.f. &lt;a href="https://stackoverflow.com/questions/50286066/kubernetes-kubectl-print-all-secrets"&gt;Stack
Overflow&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;used &lt;code&gt;kubectl describe&lt;/code&gt; with &lt;code&gt;-o jsonpath&lt;/code&gt;, specifying every single field, one
by one (super tedious) c.f. &lt;a href="https://perrotta.dev/2024/07/kubectl-get-secret-with-jsonpath-and-add-a-newline/"&gt;this previous post&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: kubectl: print all secret values in plain text"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>kubectl: get all logs from all pods</title><link>https://perrotta.dev/2024/07/kubectl-get-all-logs-from-all-pods/</link><pubDate>Mon, 15 Jul 2024 13:23:35 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/07/kubectl-get-all-logs-from-all-pods/</guid><description>&lt;p&gt;Frequently:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl logs -n argocd argocd-repo-server-5d59975687-dxnh7&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;But how do you know what hash to use after &lt;code&gt;server-&lt;/code&gt;?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Option 1)&lt;/strong&gt;: TAB auto-completion:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl logs -n argocd argocd-repo-server-&amp;lt;TAB&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Caveats&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;tab completion for &lt;code&gt;kubectl&lt;/code&gt; isn&amp;rsquo;t always properly set up&lt;/li&gt;
&lt;li&gt;if there is more than one pod, you would have to type in the first few letters
of the hash before hitting TAB again, that&amp;rsquo;s annoying and non-ergonomic&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Option 2)&lt;/strong&gt;: subshell&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl logs -n argocd $(kubectl get pod -n argocd | grep argocd-repo-server | cut -f1 -d&amp;#39; &amp;#39; | head -1)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Caveats&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;a lot of typing&lt;/li&gt;
&lt;li&gt;&lt;code&gt;head -1&lt;/code&gt; is necessary in case there are multiple pods&lt;sup id="fnref:1"&gt;&lt;a href="https://perrotta.dev/2024/07/kubectl-get-all-logs-from-all-pods/#fn:1" class="footnote-ref" role="doc-noteref"&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Option 3)&lt;/strong&gt;: get all logs from all pods that match a given label&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;kubectl logs -n argocd -l app=app.kubernetes.io/instance=argocd
[--all-containers] [--ignore-errors]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;This is much more ergonomic.&lt;/p&gt;
&lt;p&gt;You still need to figure out what label to use though:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;$ kubectl describe pod -n argocd argocd-repo-server-5d59975687-dxnh7 | grep -A7 -i labels:
Labels: app.kubernetes.io/component=repo-server
 app.kubernetes.io/instance=argocd
 app.kubernetes.io/managed-by=Helm
 app.kubernetes.io/name=argocd-repo-server
 app.kubernetes.io/part-of=argocd
 app.kubernetes.io/version=v2.11.4
 helm.sh/chart=argo-cd-7.3.4
 pod-template-hash=5d59975687&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Source&lt;/strong&gt;: &lt;a href="https://stackoverflow.com/questions/33069736/how-do-i-get-logs-from-all-pods-of-a-kubernetes-replication-controller"&gt;https://stackoverflow.com/questions/33069736/how-do-i-get-logs-from-all-pods-of-a-kubernetes-replication-controller&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Happy logging!&lt;/p&gt;
&lt;div class="footnotes" role="doc-endnotes"&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Or &lt;code&gt;tail -1&lt;/code&gt;, for that matter.&amp;#160;&lt;a href="https://perrotta.dev/2024/07/kubectl-get-all-logs-from-all-pods/#fnref:1" class="footnote-backref" role="doc-backlink"&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: kubectl: get all logs from all pods"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>kubectl: get secret with jsonpath and add a newline</title><link>https://perrotta.dev/2024/07/kubectl-get-secret-with-jsonpath-and-add-a-newline/</link><pubDate>Tue, 09 Jul 2024 11:36:34 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>dev</category><category>kubernetes</category><guid>https://perrotta.dev/2024/07/kubectl-get-secret-with-jsonpath-and-add-a-newline/</guid><description>&lt;p&gt;When retrieving opaque secrets with &lt;code&gt;kubectl&lt;/code&gt;, one will often invoke this
typical command:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;ubuntu@ubuntu:~ $ kubectl get secret -n argocd argocd-github-webhook-secret -o jsonpath=&amp;#39;{.data.value}&amp;#39;
eW91IGFyZSBjdXJpb3VzIGFyZW50IHlvdQ==ubuntu@ubuntu:~ $&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;But isn&amp;rsquo;t this ugly? The prompt is concatenated with the output.&lt;/p&gt;
&lt;p&gt;It turns out &lt;code&gt;jsonpath&lt;/code&gt; can emit a newline for improved readability:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;ubuntu@ubuntu:~ $ kubectl get secret -n argocd argocd-github-webhook-secret -o jsonpath=&amp;#39;{.data.value}{&amp;#34;\n&amp;#34;}&amp;#39;
eW91IGFyZSBjdXJpb3VzIGFyZW50IHlvdQ==
ubuntu@ubuntu:~ $&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Note that the &lt;code&gt;{&amp;quot;\n&amp;quot;}&lt;/code&gt; &lt;strong&gt;must&lt;/strong&gt; be quoted.&lt;/p&gt;
&lt;p&gt;And then you could pipe it to &lt;code&gt;base64 -d&lt;/code&gt; afterwards, as usual, and it&amp;rsquo;s a no-op:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;$ kubectl get secret -n argocd argocd-github-webhook-secret -o jsonpath=&amp;#39;{.data.value}{&amp;#34;\n&amp;#34;}&amp;#39; | base64 -d
you are curious arent youubuntu@ubuntu:~ $&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;However, the &lt;code&gt;base64&lt;/code&gt; output also swallows the newline. This can be resolved
with a simple &lt;code&gt;echo&lt;/code&gt;:&lt;/p&gt;
&lt;div class="codeblock" data-lang="shell"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;shell&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-bash"&gt;$ kubectl get secret -n argocd argocd-github-webhook-secret -o jsonpath=&amp;#39;{.data.value}{&amp;#34;\n&amp;#34;}&amp;#39; | base64 -d &amp;amp;&amp;amp; echo
you are curious arent you
ubuntu@ubuntu:~ $&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Newlines are hard, eh?&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: kubectl: get secret with jsonpath and add a newline"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item><item><title>Adding a healthcheck to chartmuseum in AWS Fargate</title><link>https://perrotta.dev/2024/05/adding-a-healthcheck-to-chartmuseum-in-aws-fargate/</link><pubDate>Fri, 17 May 2024 11:15:09 +0200</pubDate><author>serendipity@perrotta.dev (Thiago Perrotta)</author><category>aws</category><category>dev</category><category>docker</category><category>kubernetes</category><guid>https://perrotta.dev/2024/05/adding-a-healthcheck-to-chartmuseum-in-aws-fargate/</guid><description>&lt;p&gt;Assume that you have a &lt;a href="https://chartmuseum.com/"&gt;Chartmuseum&lt;/a&gt; container running
in &lt;a href="https://aws.amazon.com/fargate/"&gt;AWS Fargate&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Chartmuseum is a repository for helm charts. AWS Fargate is an Amazon service to
run containers (&amp;ldquo;serverless&amp;rdquo;), being part of ECS (Elastic Container Service).&lt;/p&gt;
&lt;p&gt;Problem statement: Add a container &lt;em&gt;healthcheck&lt;/em&gt; to the chartmuseum task
definition associated with the container.&lt;/p&gt;
&lt;p&gt;The &lt;a href="https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_HealthCheck.html"&gt;official
docs&lt;/a&gt;
suggest using &lt;code&gt;curl&lt;/code&gt;:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;[&amp;#34;CMD-SHELL&amp;#34;, &amp;#34;curl -f http://localhost/ || exit 1&amp;#34;]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;For Chartmuseum specifically we&amp;rsquo;re interested in its &lt;code&gt;/health&lt;/code&gt; endpoint, as per
&lt;a href="https://github.com/helm/chartmuseum/issues/28"&gt;this reference&lt;/a&gt;:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;[&amp;#34;CMD-SHELL&amp;#34;, &amp;#34;curl -f http://localhost/health || exit 1&amp;#34;]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;But we&amp;rsquo;re using port 8080:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;[&amp;#34;CMD-SHELL&amp;#34;, &amp;#34;curl -f http://localhost:8080/health || exit 1&amp;#34;]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;If you use this healthcheck for the official chartmuseum image
(&lt;code&gt;ghcr.io/helm/chartmuseum&lt;/code&gt;) it will fail, because the Alpine Linux environment
it uses does not contain &lt;code&gt;curl&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;A straightforward fix is to use &lt;code&gt;wget&lt;/code&gt; instead:&lt;/p&gt;
&lt;div class="codeblock"&gt;
 &lt;pre&gt;&lt;code class="language-plaintext"&gt;[&amp;#34;CMD-SHELL&amp;#34;, &amp;#34;wget -q --spider http://localhost:8080/health || exit 1&amp;#34;]&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;&lt;code&gt;--spider&lt;/code&gt; is needed because we do not want to download anything, &lt;code&gt;-q&lt;/code&gt; is
optional and short for &amp;ldquo;quiet&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;/health&lt;/code&gt; endpoint merely returns a simple JSON:&lt;/p&gt;
&lt;div class="codeblock" data-lang="json"&gt;
 &lt;div class="codeblock-header"&gt;
 &lt;span class="codeblock-language"&gt;json&lt;/span&gt;
 &lt;/div&gt;
 &lt;pre&gt;&lt;code class="language-json"&gt;{&amp;#34;healthy&amp;#34;:true}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;References: &lt;a href="https://stackoverflow.com/questions/47722898/how-can-i-make-a-docker-healthcheck-with-wget-instead-of-curl"&gt;https://stackoverflow.com/questions/47722898/how-can-i-make-a-docker-healthcheck-with-wget-instead-of-curl&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;‚Äî ¬ß ‚Äî&lt;/p&gt;&lt;p&gt;Reply via &lt;a href="mailto:serendipity@perrotta.dev?subject=Reply to: Adding a healthcheck to chartmuseum in AWS Fargate"&gt;email&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href="https://perrotta.dev/tags/aws/"&gt;#aws&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/dev/"&gt;#dev&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/docker/"&gt;#docker&lt;/a&gt; &lt;a href="https://perrotta.dev/tags/kubernetes/"&gt;#kubernetes&lt;/a&gt;&lt;/p&gt;</description></item></channel></rss>