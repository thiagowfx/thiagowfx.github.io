<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>★ Direnv: Automate your Environment Variables | Not Just Serendipity</title>
<meta name=keywords content="dev,bestof"><meta name=description content="Direnv is a tool to automate your shell to automatically load and unload environment variables on-the-fly, on a per-project (per-directory) basis."><meta name=author content="Thiago Perrotta"><link rel=canonical href=https://www.perrotta.dev/2022/01/direnv-automate-your-environment-variables/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.perrotta.dev/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://www.perrotta.dev/favicon.ico><link rel=apple-touch-icon href=https://www.perrotta.dev/apple-touch-icon.png><link rel=mask-icon href=https://www.perrotta.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav,.toc,.post-meta{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style><meta property="og:title" content="★ Direnv: Automate your Environment Variables"><meta property="og:description" content="Direnv is a tool to automate your shell to automatically load and unload environment variables on-the-fly, on a per-project (per-directory) basis."><meta property="og:type" content="article"><meta property="og:url" content="https://www.perrotta.dev/2022/01/direnv-automate-your-environment-variables/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-04T00:34:07-05:00"><meta property="article:modified_time" content="2022-01-04T00:34:07-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="★ Direnv: Automate your Environment Variables"><meta name=twitter:description content="Direnv is a tool to automate your shell to automatically load and unload environment variables on-the-fly, on a per-project (per-directory) basis."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.perrotta.dev/posts/"},{"@type":"ListItem","position":2,"name":"★ Direnv: Automate your Environment Variables","item":"https://www.perrotta.dev/2022/01/direnv-automate-your-environment-variables/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"★ Direnv: Automate your Environment Variables","name":"★ Direnv: Automate your Environment Variables","description":"Direnv is a tool to automate your shell to automatically load and unload environment variables on-the-fly, on a per-project (per-directory) basis.\n","keywords":["dev","bestof"],"articleBody":"Direnv is a tool to automate your shell to automatically load and unload environment variables on-the-fly, on a per-project (per-directory) basis.\nPreliminaries: Is it worth it? Questions I like to ask myself before deciding whether to invest my time into learning and potentially adopting a foreign tool are the following:\nIs it popular and stable enough? Is it abandonware?\nPopularity Popularity is relative, it doesn’t need to be worthy of the Hacker News frontpage nor Hotness on Reddit, but it needs to be widely available in popular Linux distributions and/or package managers, one install command away from my development environment.\nRepology is a good proxy for popularity. Looking at direnv therein, it’s available for Alpine, Arch, Debian, Fedora, FreeBSD, HomeBrew, Nix, OpenBSD, Ubuntu…that’s more than enough, we can safely conclude direnv is widely popular.\nThe main takeaway we want to confirm is whether the project isn’t too niche and/or an one-man show. Seeing signs of a small-ish community and/or occasional contributions from external users/developers helps build confidence and give credibility to the project.\nStability and Abandonware Stability is easier to define than popularity and can often be determined just by taking a quick glance at the github (or whichever other forge it’s hosted in) page of the project.\nAt the time of this writing, the latest release of direnv was about a week ago (2.30.2, Dec 28th 2021). It’s definitely not abandonware and it’s well maintained. A few signs that help corroborate that:\nSeveral PRs were merged recently Its issue tracker is quite active, with a good mix of feature requests and bugs I don’t like to judge the project based on the number of issues it has, especially if it’s popular. Chromium has 60k+ issues at the time of this writing, yet I wouldn’t call it bleeding edge. Common sense applies. Since direnv has been around for a while and it’s relatively popular, 150+ open issue seems acceptable to me. Now that direnv passed the Litmus test for adoption1, let’s get our hands dirty.\nInstallation There’s nothing special here, as direnv is widely packaged. Pick your poison:\n$ sudo pacman -Syu direnv # Arch Linux $ doas apk add direnv # Alpine Linux $ sudo apt install direnv # Debian-based distros Is it lightweight?\n$ apk info -L direnv direnv-2.30.1-r0 contains: usr/bin/direnv Hell yes! More lightweight than that? Impossible. It’s a single binary thanks to Golang. No tons of files or dependencies. I mean:\n$ du -sh /usr/bin/direnv 7.5M /usr/bin/direnv …it’s a 7MB binary, let’s not get ahead of ourselves. But that’s fine, really, it’s just a dev tool, we don’t really deploy it to prod.\nUse Cases Everything is controlled with a .envrc file within a repository root. A typical file could look like this:\nexport HOUSE=\"ATREIDES\" layout python3 The upstream website does a great job at summarizing use cases. I am not here to duplicate documentation, so please go ahead and read it. That said, here are some example use cases I found useful:\nUse Case: Python Python developers often need to create different virtual environments for different projects. For example, I was participating in Advent of Code last year and wrote my solutions in Python 3: https://github.com/thiagowfx/adventofcode.\nEach day2 I would cd ~/projects/adventofcode, and then do source ~/.venv/bin/activate. And guess what, that’s for the first terminal where I’d run make, I’d also spawn a second one with vim, thereby needing to activate the virtual environment twice.\nAnd this is assuming the virtual environment already exists. If it didn’t - for example, after a vanilla git clone, I’d have to do python -m venv .venv first.\nQuickly all of this became repetitive and annoying. I kinda “cheated” and stopped using the virtualenv for a few days, relying on my Linux distribution package manager instead:\n% apk add py3-{autopep8,pyflakes,numpy,pylint} This way, my\nimport numpy would correctly work and not yell that numpy was nowhere to be found.\nIt’s not very clean, but it worked. However eventually I wanted to become cleaner and leaner and automate my virtual environment setup. I uninstalled the aforementioned packages after a few days:\n% apk del py3-{autopep8,pyflakes,numpy,pylint} …therefore forcing me to come up with a better setup. I always had direnv in my TODO list, and this was the perfect moment to try it out.\nHow does direnv address this?\nAdd the direnv hook to your shell. I actively use two shells3, bash and zsh, so I did it twice and then added it to my dotfiles: Bash:\n$ cat ~/.bashrc.d/direnv.bash #!/bin/bash # https://direnv.net/ if hash direnv \u003e/dev/null 2\u003e\u00261; then eval \"$(direnv hook bash)\" fi Zsh:\n$ cat ~/.zshrc.d/direnv.zsh #!/bin/zsh # https://direnv.net/ if (( $+commands[direnv] )); then eval \"$(direnv hook zsh)\" fi Set up direnv in the AOC repository: $ cat ~/projects/adventofcode/.envrc layout python3 $ direnv allow # Only needs to be done once That’s it: It’s a single line of configuration. Now what does it do? All of the above. No magic: whenever you cd into the project directory or any of its subdirectories with one of the configured shells, if the venv doesn’t exist:\nit will be automatically created; then it will be sourced Now you may ask yourself: Why go through all this trouble? Why not simply create a shell script to do exactly that for you automatically? That’s perfectly fine, it’s a matter of taste. But then you’ll have to maintain that script. The python ecosystem keeps changing - a few years ago I was using virtualenvwrapper to manage virtual environments, these days it doesn’t exist anymore, people use either python -m env or pyenv or poetry or…it never ends. Drew DeVault wrote a good piece about that.\nXKCD Courtesy of Randall Munroe\nMaintenance is not the only burden, scalability is also one: If you use python in several repositories, you’ll now have to include your script in all of them.\nConsidering that direnv is flexible enough in other scenarios, I consider its adoption in this situation a good trade-off to make.\nUse Case: Hugo This blog is written in Hugo. I have a Makefile with a bunch of environment variables to manage its setup:\n$ make dev Whenever I am working in my VPS, for reasons outside of the scope of this post I need to use a different port other than the default one for Hugo (1313). Since I am using variables, I could just do:\n$ make PORT=1234 dev However, to make this change permanent (“fire-and-forget”), I could also do:\n$ echo 'export PORT=1234' | tee -a .envrc $ direnv allow # Only needs to be done once $ make dev This way, whenever I run make I wouldn’t even need to think twice about which port to use.\nOf course, a small improvement that should be done in this scenario is to add direnv related files to your .gitignore:\n$ git ignore direnv \u003e\u003e .gitignore # Created by https://www.toptal.com/developers/gitignore/api/direnv # Edit at https://www.toptal.com/developers/gitignore?templates=direnv ### direnv ### .direnv .envrc # End of https://www.toptal.com/developers/gitignore/api/direnv Other use cases? I don’t have other real use cases to share because only recently I became familiarized with direnv. That said, the direnv docs are very comprehensive of its full potential usage.\nSome use cases that I like:\ndotenv Automatically sources .env (note: not to confuse with .envrc) files, which are widely common in projects managed with docker-compose. source_env + env_vars_required Alongside .gitignore, this is a great way to source secrets (e.g. API keys or tokens) and not accidentally check them into your repository. fetchurl bash | curl is a cancer4 that should arguably be stopped due to its inherent security risks. That said, direnv provides a safer way to work with it because you can specify a hash to ensure you’re downloading the same script - if an attacker or malicious actor modified it, direnv would throw an error. path_add If your project outputs to e.g. build/\u003c...\u003e/bin or similar (typical in cmake projects and AFAIK in Rust ones too), you could add that directory to your PATH so that you could easily execute your binaries, without having to write the full subdirectory path each time. layout Besides python, direnv supports several other programming languages out-of-the-box. Popular examples include go, nix, node, perl and ruby. Downsides? One could call direnv bloated because of all of the aforementioned capabilities. If it doesn’t spark joy for your taste, consider using autoenv which is basically a leaner version of direnv, meant mostly for doing one thing and doing it well: setting and unsetting variables.\nOther than that, direnv is pretty much a great piece of software.\nOne thing I didn’t cover is how secure it is: You need to run direnv allow explicitly in order to tell direnv that you trust a given .envrc file. If you don’t do it, direnv will refuse to source it:\n$ touch .envrc direnv: error ~/projects/foo/.envrc is blocked. Run `direnv allow` to approve its content If you run direnv allow but later on the file is modified (for example, after git pull, whereby you retrieve a modification from a teammate), direnv will once again refuse to operate. You’ll need to whitelist it again by re-running direnv allow. Direnv will snapshot/hash the file contents of .envrc remember it across sessions.\nReferences Tools You Should Know About: direnv Obviously the aforementioned list was non-exhaustive. There are a few other questions that you may want to ask, out of scope of this article, such as: (i) does the project have an OSS or FLOSS license? (ii) does the project depend on Java? ↩︎\nAdvent of code challenges are released one by one, thereby forcing you to wait until the next day in order to get the next challenge. ↩︎\nmore on this another day ↩︎\nc.f. https://curlpipesh.tumblr.com/, https://gnu.moe/wallofshame.md ↩︎\n","wordCount":"1613","inLanguage":"en","datePublished":"2022-01-04T00:34:07-05:00","dateModified":"2022-01-04T00:34:07-05:00","author":{"@type":"Person","name":"Thiago Perrotta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.perrotta.dev/2022/01/direnv-automate-your-environment-variables/"},"publisher":{"@type":"Person","name":"Not Just Serendipity","logo":{"@type":"ImageObject","url":"https://www.perrotta.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.perrotta.dev/ accesskey=h title="Not Just Serendipity (Alt + H)"><img src=https://www.perrotta.dev/apple-touch-icon.png alt aria-label=logo height=32>Not Just Serendipity</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.perrotta.dev/posts/ title=posts><span>posts</span></a></li><li><a href=https://www.perrotta.dev/archives/ title=archives><span>archives</span></a></li><li><a href=https://www.perrotta.dev/tags/bestof/ title=bestof><span>bestof</span></a></li><li><a href=https://www.perrotta.dev/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://www.perrotta.dev/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>★ Direnv: Automate your Environment Variables</h1><div class=post-meta><span title='2022-01-04 00:34:07 -0500 -0500'>January 4, 2022</span>&nbsp;·&nbsp;1613 words&nbsp;·&nbsp;Thiago Perrotta</div></header><div class=post-content><p><a href=https://direnv.net/>Direnv</a> is a tool to automate your shell to automatically load and unload environment variables on-the-fly, on a per-project (per-directory) basis.</p><h2 id=preliminaries-is-it-worth-it>Preliminaries: Is it worth it?<a hidden class=anchor aria-hidden=true href=#preliminaries-is-it-worth-it>#</a></h2><p>Questions I like to ask myself before deciding whether to invest my time into learning and potentially <strong>adopting</strong> a foreign tool are the following:</p><blockquote><p>Is it <strong>popular</strong> <em>and</em> <strong>stable</strong> enough?
Is it abandonware?</p></blockquote><h3 id=popularity>Popularity<a hidden class=anchor aria-hidden=true href=#popularity>#</a></h3><p>Popularity is relative, it doesn&rsquo;t need to be worthy of the Hacker News frontpage nor Hotness on Reddit, but it needs to be widely available in popular Linux distributions and/or package managers, one install command away from my development environment.</p><p><a href=https://repology.org/>Repology</a> is a good proxy for popularity. Looking at <a href=https://repology.org/project/direnv/badges>direnv</a> therein, it&rsquo;s available for Alpine, Arch, Debian, Fedora, FreeBSD, HomeBrew, Nix, OpenBSD, Ubuntu&mldr;that&rsquo;s more than enough, we can safely conclude <code>direnv</code> is widely popular.</p><p>The main takeaway we want to confirm is whether the project isn&rsquo;t too niche and/or an one-man show. Seeing signs of a small-ish community and/or occasional contributions from external users/developers helps build confidence and give credibility to the project.</p><h3 id=stability-and-abandonware>Stability and Abandonware<a hidden class=anchor aria-hidden=true href=#stability-and-abandonware>#</a></h3><p>Stability is easier to define than popularity and can often be determined just by taking a quick glance at the github (or whichever other forge it&rsquo;s hosted in) page of the project.</p><p>At the time of this writing, the latest release of <a href=https://github.com/direnv/direnv>direnv</a> was about a week ago (2.30.2, Dec 28th 2021). It&rsquo;s definitely not abandonware and it&rsquo;s well maintained. A few signs that help corroborate that:</p><ul><li>Several PRs were merged recently</li><li>Its issue tracker is quite active, with a good mix of feature requests and bugs</li><li>I don&rsquo;t like to judge the project based on the number of issues it has, especially if it&rsquo;s popular. Chromium has <a href=https://bugs.chromium.org/p/chromium/issues/list>60k+</a> issues at the time of this writing, yet I wouldn&rsquo;t call it <em>bleeding edge</em>. Common sense applies. Since <code>direnv</code> has been around for a while and it&rsquo;s relatively popular, 150+ open issue seems acceptable to me.</li></ul><p>Now that <code>direnv</code> passed the Litmus test for adoption<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, let&rsquo;s get our hands dirty.</p><h2 id=installation>Installation<a hidden class=anchor aria-hidden=true href=#installation>#</a></h2><p>There&rsquo;s nothing special here, as <code>direnv</code> is widely packaged. Pick your poison:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo pacman -Syu direnv  <span style=color:#75715e># Arch Linux</span>
</span></span><span style=display:flex><span>$ doas apk add direnv  <span style=color:#75715e># Alpine Linux</span>
</span></span><span style=display:flex><span>$ sudo apt install direnv  <span style=color:#75715e># Debian-based distros</span>
</span></span></code></pre></div><p>Is it lightweight?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ apk info -L direnv
</span></span><span style=display:flex><span>direnv-2.30.1-r0 contains:
</span></span><span style=display:flex><span>usr/bin/direnv
</span></span></code></pre></div><p>Hell yes! More lightweight than that? Impossible. It&rsquo;s a single binary thanks to Golang. No tons of files or dependencies. I mean:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ du -sh /usr/bin/direnv
</span></span><span style=display:flex><span>7.5M    /usr/bin/direnv
</span></span></code></pre></div><p>&mldr;it&rsquo;s a 7MB binary, let&rsquo;s not get ahead of ourselves. But that&rsquo;s fine, really, it&rsquo;s just a dev tool, we don&rsquo;t really deploy it to prod.</p><h2 id=use-cases>Use Cases<a hidden class=anchor aria-hidden=true href=#use-cases>#</a></h2><p>Everything is controlled with a <code>.envrc</code> file within a repository root. A typical file could look like this:</p><pre tabindex=0><code>export HOUSE=&#34;ATREIDES&#34;
layout python3
</code></pre><p>The <a href=https://direnv.net/>upstream website</a> does a great job at summarizing use cases. I am not here to duplicate documentation, so please go ahead and read it. That said, here are some example use cases I found useful:</p><h3 id=use-case-python>Use Case: Python<a hidden class=anchor aria-hidden=true href=#use-case-python>#</a></h3><p>Python developers often need to create different virtual environments for different projects. For example, I was participating in <a href=https://adventofcode.com/>Advent of Code</a> last year and wrote my solutions in Python 3: <a href=https://github.com/thiagowfx/adventofcode>https://github.com/thiagowfx/adventofcode</a>.</p><p>Each day<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> I would <code>cd ~/projects/adventofcode</code>, and then do <code>source ~/.venv/bin/activate</code>. And guess what, that&rsquo;s for the first terminal where I&rsquo;d run <code>make</code>, I&rsquo;d also spawn a second one with <code>vim</code>, thereby needing to activate the virtual environment twice.</p><p>And this is assuming the virtual environment already exists. If it didn&rsquo;t - for example, after a vanilla <code>git clone</code>, I&rsquo;d have to do <code>python -m venv .venv</code> first.</p><p>Quickly all of this became repetitive and annoying. I kinda &ldquo;cheated&rdquo; and stopped using the virtualenv for a few days, relying on my Linux distribution package manager instead:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>% apk add py3-<span style=color:#f92672>{</span>autopep8,pyflakes,numpy,pylint<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This way, my</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> numpy
</span></span></code></pre></div><p>would correctly work and not yell that <code>numpy</code> was nowhere to be found.</p><p>It&rsquo;s not very clean, but it worked. However eventually I wanted to become cleaner and leaner and automate my virtual environment setup. I uninstalled the aforementioned packages after a few days:</p><pre tabindex=0><code>% apk del py3-{autopep8,pyflakes,numpy,pylint}
</code></pre><p>&mldr;therefore forcing me to come up with a better setup. I always had direnv in my TODO list, and this was the perfect moment to try it out.</p><p>How does <code>direnv</code> address this?</p><ol><li>Add the <code>direnv</code> hook to your shell. I actively use two shells<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>, <code>bash</code> and <code>zsh</code>, so I did it twice and then added it to my <a href=https://github.com/thiagowfx/.dotfiles>dotfiles</a>:</li></ol><p>Bash:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat ~/.bashrc.d/direnv.bash
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span><span style=color:#75715e># https://direnv.net/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> hash direnv &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        eval <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>direnv hook bash<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>Zsh:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>$ cat ~/.zshrc.d/direnv.zsh
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/zsh</span>
</span></span><span style=display:flex><span><span style=color:#75715e># https://direnv.net/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span> $+commands<span style=color:#f92672>[</span>direnv<span style=color:#f92672>]</span> <span style=color:#f92672>))</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        eval <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>direnv hook zsh<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><ol start=2><li>Set up direnv in the AOC repository:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cat ~/projects/adventofcode/.envrc
</span></span><span style=display:flex><span>layout python3
</span></span><span style=display:flex><span>$ direnv allow  <span style=color:#75715e># Only needs to be done once</span>
</span></span></code></pre></div><p>That&rsquo;s it: It&rsquo;s a single line of configuration. Now what does it do? All of the above. No magic: whenever you cd into the project directory or any of its subdirectories with one of the configured shells, if the venv doesn&rsquo;t exist:</p><ul><li>it will be automatically created;</li><li>then it will be sourced</li></ul><p>Now you may ask yourself: Why go through all this trouble? Why not simply create a shell script to do exactly that for you automatically? That&rsquo;s perfectly fine, it&rsquo;s a matter of taste. But then you&rsquo;ll have to maintain that script. The python ecosystem keeps changing - a few years ago I was using <code>virtualenvwrapper</code> to manage virtual environments, these days it doesn&rsquo;t exist anymore, people use either <code>python -m env</code> or <code>pyenv</code> or <code>poetry</code> or&mldr;it never ends. <a href=https://drewdevault.com/2021/11/16/Python-stop-screwing-distros-over.html>Drew DeVault</a> wrote a good piece about that.</p><figure class=align-center><a href=https://xkcd.com/1987/><img loading=lazy src=https://imgs.xkcd.com/comics/python_environment.png#center alt="The Python environmental protection agency wants to seal it in a cement chamber, with pictorial messages to future civilizations warning them about the danger of using sudo to install random Python packages."></a><figcaption><p>XKCD Courtesy of Randall Munroe</p></figcaption></figure><p>Maintenance is not the only burden, scalability is also one: If you use python in several repositories, you&rsquo;ll now have to include your script in all of them.</p><p>Considering that <code>direnv</code> is flexible enough in other scenarios, I consider its adoption in this situation a good trade-off to make.</p><h3 id=use-case-hugo>Use Case: Hugo<a hidden class=anchor aria-hidden=true href=#use-case-hugo>#</a></h3><p>This blog is written in Hugo. I have a <code>Makefile</code> with a bunch of environment variables to manage its setup:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ make dev
</span></span></code></pre></div><p>Whenever I am working in my VPS, for reasons outside of the scope of this post I need to use a different port other than the default one for Hugo (<code>1313</code>). Since I am using variables, I could just do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ make PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>1234</span> dev
</span></span></code></pre></div><p>However, to make this change permanent (&ldquo;fire-and-forget&rdquo;), I could also do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ echo <span style=color:#e6db74>&#39;export PORT=1234&#39;</span> | tee -a .envrc
</span></span><span style=display:flex><span>$ direnv allow  <span style=color:#75715e># Only needs to be done once</span>
</span></span><span style=display:flex><span>$ make dev
</span></span></code></pre></div><p>This way, whenever I run <code>make</code> I wouldn&rsquo;t even need to think twice about which port to use.</p><p>Of course, a small improvement that should be done in this scenario is to add <code>direnv</code> related files to your <code>.gitignore</code>:</p><pre tabindex=0><code>$ git ignore direnv &gt;&gt; .gitignore

# Created by https://www.toptal.com/developers/gitignore/api/direnv
# Edit at https://www.toptal.com/developers/gitignore?templates=direnv

### direnv ###
.direnv
.envrc

# End of https://www.toptal.com/developers/gitignore/api/direnv
</code></pre><h3 id=other-use-cases>Other use cases?<a hidden class=anchor aria-hidden=true href=#other-use-cases>#</a></h3><p>I don&rsquo;t have other real use cases to share because only recently I became familiarized with <code>direnv</code>. That said, the <a href=https://direnv.net/man/direnv-stdlib.1.html>direnv docs</a> are very comprehensive of its full potential usage.</p><p>Some use cases that I like:</p><dl><dt><code>dotenv</code></dt><dd>Automatically sources <code>.env</code> (note: not to confuse with <code>.envrc</code>) files, which are widely common in projects managed with <code>docker-compose</code>.</dd><dt><code>source_env</code> + <code>env_vars_required</code></dt><dd>Alongside <code>.gitignore</code>, this is a great way to source secrets (e.g. API keys or tokens) and not accidentally check them into your repository.</dd><dt><code>fetchurl</code></dt><dd><code>bash | curl</code> is a cancer<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> that should arguably be stopped due to its inherent security risks. That said, <code>direnv</code> provides a safer way to work with it because you can specify a hash to ensure you&rsquo;re downloading the same script - if an attacker or malicious actor modified it, direnv would throw an error.</dd><dt><code>path_add</code></dt><dd>If your project outputs to e.g. <code>build/&lt;...>/bin</code> or similar (typical in <code>cmake</code> projects and AFAIK in Rust ones too), you could add that directory to your <code>PATH</code> so that you could easily execute your binaries, without having to write the full subdirectory path each time.</dd><dt><code>layout</code></dt><dd>Besides python, <code>direnv</code> supports several other programming languages out-of-the-box. Popular examples include <code>go</code>, <code>nix</code>, <code>node</code>, <code>perl</code> and <code>ruby</code>.</dd></dl><h2 id=downsides>Downsides?<a hidden class=anchor aria-hidden=true href=#downsides>#</a></h2><p>One could call <code>direnv</code> bloated because of all of the aforementioned capabilities. If it doesn&rsquo;t spark joy for your taste, consider using <a href=https://github.com/hyperupcall/autoenv>autoenv</a> which is basically a leaner version of <code>direnv</code>, meant mostly for doing one thing and doing it well: setting and unsetting variables.</p><p>Other than that, <code>direnv</code> is pretty much a great piece of software.</p><p>One thing I didn&rsquo;t cover is how secure it is: You need to run <code>direnv allow</code> explicitly in order to tell <code>direnv</code> that you trust a given <code>.envrc</code> file. If you don&rsquo;t do it, <code>direnv</code> will refuse to source it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ touch .envrc
</span></span><span style=display:flex><span>direnv: error ~/projects/foo/.envrc is blocked. Run <span style=color:#e6db74>`</span>direnv allow<span style=color:#e6db74>`</span> to approve its content
</span></span></code></pre></div><p>If you run <code>direnv allow</code> but later on the file is modified (for example, after <code>git pull</code>, whereby you retrieve a modification from a teammate), <code>direnv</code> will once again refuse to operate. You&rsquo;ll need to whitelist it again by re-running <code>direnv allow</code>. Direnv will snapshot/hash the file contents of <code>.envrc</code> remember it across sessions.</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://cuddly-octo-palm-tree.com/posts/2021-12-12-tyska-direnv/>Tools You Should Know About: direnv</a></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Obviously the aforementioned list was non-exhaustive. There are a few other questions that you may want to ask, out of scope of this article, such as: (i) does the project have an OSS or FLOSS license? (ii) does the project depend on Java?&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Advent of code challenges are released one by one, thereby forcing you to wait until the next day in order to get the next challenge.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>more on this another day&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>c.f. <a href=https://curlpipesh.tumblr.com/>https://curlpipesh.tumblr.com/</a>, <a href=https://gnu.moe/wallofshame.md>https://gnu.moe/wallofshame.md</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.perrotta.dev/tags/dev/>dev</a></li><li><a href=https://www.perrotta.dev/tags/bestof/>bestof</a></li></ul></footer><div style=text-align:center><a href="mailto:tbperrotta@gmail.com?subject=RE: Not%20Just%20Serendipity comment for '%e2%98%85%20Direnv%3a%20Automate%20your%20Environment%20Variables'" target=_blank><button>Reply via email</button></a></div></article></main><footer class=footer><span>Copyright © 2021 - 2024 Thiago Perrotta • <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> • <a href=/index.xml>RSS</a> •</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>