<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>★ Alpine Linux: apk command not found hook | Not Just Serendipity</title>
<meta name=keywords content="linux,star"><meta name=description content="In this post we will learn how to define a command-not-found hook to the apk(8) package manager in Alpine Linux.
Sneak peek
Before:
$ podman
zsh: correct 'podman' to 'pod2man' [nyae]? n
zsh: command not found: podman
After:
$ podman
zsh: correct 'podman' to 'pod2man' [nyae]? n
podman may be found in the following packages:
  <cmd:podman> podman-3.4.4-r1 x86_64 {podman} (Apache-2.0)
"><meta name=author content="Thiago Perrotta"><link rel=canonical href=https://thiagowfx.github.io/2022/01/alpine-linux-apk-command-not-found-hook/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://thiagowfx.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://thiagowfx.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://thiagowfx.github.io/favicon.ico><link rel=apple-touch-icon href=https://thiagowfx.github.io/apple-touch-icon.png><link rel=mask-icon href=https://thiagowfx.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav,.toc,.post-meta{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style><meta property="og:title" content="★ Alpine Linux: apk command not found hook"><meta property="og:description" content="In this post we will learn how to define a command-not-found hook to the apk(8) package manager in Alpine Linux.
Sneak peek
Before:
$ podman
zsh: correct 'podman' to 'pod2man' [nyae]? n
zsh: command not found: podman
After:
$ podman
zsh: correct 'podman' to 'pod2man' [nyae]? n
podman may be found in the following packages:
  <cmd:podman> podman-3.4.4-r1 x86_64 {podman} (Apache-2.0)
"><meta property="og:type" content="article"><meta property="og:url" content="https://thiagowfx.github.io/2022/01/alpine-linux-apk-command-not-found-hook/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-04T16:25:51-05:00"><meta property="article:modified_time" content="2022-01-04T16:25:51-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="★ Alpine Linux: apk command not found hook"><meta name=twitter:description content="In this post we will learn how to define a command-not-found hook to the apk(8) package manager in Alpine Linux.
Sneak peek
Before:
$ podman
zsh: correct 'podman' to 'pod2man' [nyae]? n
zsh: command not found: podman
After:
$ podman
zsh: correct 'podman' to 'pod2man' [nyae]? n
podman may be found in the following packages:
  <cmd:podman> podman-3.4.4-r1 x86_64 {podman} (Apache-2.0)
"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://thiagowfx.github.io/posts/"},{"@type":"ListItem","position":2,"name":"★ Alpine Linux: apk command not found hook","item":"https://thiagowfx.github.io/2022/01/alpine-linux-apk-command-not-found-hook/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"★ Alpine Linux: apk command not found hook","name":"★ Alpine Linux: apk command not found hook","description":"In this post we will learn how to define a command-not-found hook to the apk(8) package manager in Alpine Linux.\nSneak peek Before:\n$ podman zsh: correct \u0026#39;podman\u0026#39; to \u0026#39;pod2man\u0026#39; [nyae]? n zsh: command not found: podman After:\n$ podman zsh: correct \u0026#39;podman\u0026#39; to \u0026#39;pod2man\u0026#39; [nyae]? n podman may be found in the following packages: \u0026lt;cmd:podman\u0026gt; podman-3.4.4-r1 x86_64 {podman} (Apache-2.0) ","keywords":["linux","star"],"articleBody":"In this post we will learn how to define a command-not-found hook to the apk(8) package manager in Alpine Linux.\nSneak peek Before:\n$ podman zsh: correct 'podman' to 'pod2man' [nyae]? n zsh: command not found: podman After:\n$ podman zsh: correct 'podman' to 'pod2man' [nyae]? n podman may be found in the following packages: podman-3.4.4-r1 x86_64 {podman} (Apache-2.0) Preamble Whenever you type a command that is not in your $PATH, usually your shell will yell at you that it wasn’t found.\nThe typical workflow in this scenario is to use the search functionality of your package manager in order to find which package provides the binary you’re interested in.\nIn Alpine Linux, one would do:\n$ apk search podman podman-doc-3.4.4-r1 podman-remote-3.4.4-r1 podman-docker-3.4.4-r1 openscap-1.3.5-r3 podman-3.4.4-r1 podman-compose-0.1.5-r4 podman-bash-completion-3.4.4-r1 podman-zsh-completion-3.4.4-r1 py3-podman-3.2.1-r1 podman-docker-doc-3.4.4-r1 podman-openrc-3.4.4-r1 podman-fish-completion-3.4.4-r1 The output is a bit noisy, but with a bit of experience you could easily figure out the package you’re looking for is simply called podman, given the output above.\nSurely this was an easy example, what if we tried something less obvious?\n$ vidir zsh: correct 'vidir' to 'vdir' [nyae]? n zsh: command not found: vidir There’s no vidir binary, then surely there’s a vidir package, right?\n$ doas apk add vidir ERROR: unable to select packages: vidir (no such package): required by: world[vidir] Er, no. You’ll need to use search again:\n$ apk search vidir moreutils-0.67-r0 There it is, moreutils. Great piece of software, by the way1.\nWhat if we could automate this?\nAutomating command-not-found: 1st try In bash, one can define a command_not_found_handle function. In zsh, one can define a command_not_found_handler function. I know, why can’t it be the same function, right? Just one r in the way. Regardless of whichever shell you use, the point is that the function is invoked whenever you run a command that is not in the $PATH (or that isn’t a shell built-in).\nIn principle, you could do:\ncommand_not_found_handle() { local cmd=\"$1\" apk search \"$cmd\" } It’s a good first try, and it surely works as expected, but it can be a bit noisy sometimes. Look at the podman output above, it outputs several unrelated packages, none of which provide the podman binary other than its homonym.\nAutomating command-not-found: 2nd try In Alpine, we can do slightly better. apk(8) has the concept of providers:\n$ apk list -P | awk '{print $1}' | egrep '\u003c\\w+:' | cut -f 1 -d ':' | cut -c 2- | sort -u cmd dbus pc so -P above stands for --providers. This roughly means one can search for a package that provides a given shared library (so), or a package that provides a given binary (cmd), and so on. We’re interested in the cmd: provider.\nIf we tried it with podman, we would get the following output:\n$ apk list -P -- \"cmd:podman\" podman-3.4.4-r1 x86_64 {podman} (Apache-2.0) Look at how much shorter and direct it is, compared to the 1st approach!\nHere’s what it looks like if we try it with a binary provided by multiple packages:\n$ apk list -P -- \"cmd:docker\" docker-cli-20.10.11-r0 x86_64 {docker} (Apache-2.0) [installed] podman-docker-3.4.4-r1 x86_64 {podman} (Apache-2.0) It’s very easy to see that both docker-cli and podman-docker provide docker. If you just did a simple search, you’d get a lot of noise:\n$ apk search docker docker-bash-completion-20.10.11-r0 docker-cli-20.10.11-r0 docker-machine-driver-kvm2-1.24.0-r0 x11docker-6.9.0-r2 docker-volume-local-persist-1.3.0-r5 podman-docker-3.4.4-r1 openvswitch-2.12.3-r4 docker-engine-20.10.11-r0 docker-openrc-20.10.11-r0 dockerize-0.6.1-r9 docker-fish-completion-20.10.11-r0 openscap-1.3.5-r3 docker-py-5.0.3-r1 openvswitch-ovn-2.12.3-r4 docker-registry-openrc-2.7.1-r5 docker-doc-20.10.11-r0 rsyslog-imdocker-8.2108.0-r0 lazydocker-0.12-r2 docker-compose-bash-completion-1.29.2-r2 docker-compose-1.29.2-r2 py3-dockerpty-0.4.1-r4 docker-compose-zsh-completion-1.29.2-r2 docker-registry-2.7.1-r5 docker-credential-ecr-login-0.5.0-r2 dockerpy-creds-0.4.0-r3 docker-cli-compose-2.1.1-r0 docker-credential-ecr-login-doc-0.5.0-r2 podman-docker-doc-3.4.4-r1 docker-20.10.11-r0 docker-compose-fish-completion-1.29.2-r2 flannel-contrib-cni-0.15.1-r0 docker-zsh-completion-20.10.11-r0 docker-volume-local-persist-openrc-1.3.0-r5 docker-cli-buildx-0.7.1-r0 Packaging2 it all together I wrote the following scripts, which I source in my respective interactive shells, to achieve this behavior out-of-the-box:\n$ cat apk-command-not-found.bash #!/bin/bash # apk(8) from Alpine Linux command not found hook for bash command_not_found_handle () { local cmd=\"$1\" pkgs mapfile -t pkgs \u003c \u003c(apk list -P -- \"cmd:$cmd\" 2\u003e/dev/null) if (( ${#pkgs[*]} )); then echo \"$cmd may be found in the following packages:\" printf ' %s\\n' \"${pkgs[@]}\" else echo \"bash: command not found: $cmd\" fi 1\u003e\u00262 return 127 } $ cat apk-command-not-found.zsh #!/bin/zsh # apk(8) from Alpine Linux command not found hook for zsh command_not_found_handler() { local cmd=\"$1\" local pkgs=(${(f)\"$(apk list -P -- \"cmd:$cmd\" 2\u003e/dev/null)\"}) if [[ -n \"$pkgs\" ]]; then echo \"$cmd may be found in the following packages:\" printf ' %s\\n' \"${pkgs[@]}\" else echo \"zsh: command not found: $cmd\" fi 1\u003e\u00262 return 127 } The snippets above are snapshots intended for this post. I keep up-to-date versions of these files in my dotfiles repository, try out this query in case I ever move them elsewhere.\nhttps://joeyh.name/code/moreutils/: moreutils is a collection of the unix tools that nobody thought to write long ago when unix was young. ↩︎\npun intended ↩︎\n","wordCount":"779","inLanguage":"en","datePublished":"2022-01-04T16:25:51-05:00","dateModified":"2022-01-04T16:25:51-05:00","author":{"@type":"Person","name":"Thiago Perrotta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://thiagowfx.github.io/2022/01/alpine-linux-apk-command-not-found-hook/"},"publisher":{"@type":"Person","name":"Not Just Serendipity","logo":{"@type":"ImageObject","url":"https://thiagowfx.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://thiagowfx.github.io/ accesskey=h title="Not Just Serendipity (Alt + H)"><img src=https://thiagowfx.github.io/apple-touch-icon.png alt aria-label=logo height=32>Not Just Serendipity</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://thiagowfx.github.io/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://thiagowfx.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://thiagowfx.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://thiagowfx.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>★ Alpine Linux: apk command not found hook</h1><div class=post-meta><span title='2022-01-04 16:25:51 -0500 -0500'>January 4, 2022</span>&nbsp;·&nbsp;779 words&nbsp;·&nbsp;Thiago Perrotta</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#sneak-peek aria-label="Sneak peek">Sneak peek</a></li><li><a href=#preamble aria-label=Preamble>Preamble</a></li><li><a href=#automating-command-not-found-1st-try aria-label="Automating command-not-found: 1st try">Automating command-not-found: 1st try</a></li><li><a href=#automating-command-not-found-2nd-try aria-label="Automating command-not-found: 2nd try">Automating command-not-found: 2nd try</a></li><li><a href=#packagingpackaging-it-all-together aria-label="Packaging2 it all together">Packaging<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> it all together</a></li></ul></div></details></div><div class=post-content><p>In this post we will learn how to define a command-not-found hook to the <code>apk(8)</code> package manager in Alpine Linux.</p><h2 id=sneak-peek>Sneak peek<a hidden class=anchor aria-hidden=true href=#sneak-peek>#</a></h2><p>Before:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ podman
</span></span><span style=display:flex><span>zsh: correct <span style=color:#e6db74>&#39;podman&#39;</span> to <span style=color:#e6db74>&#39;pod2man&#39;</span> <span style=color:#f92672>[</span>nyae<span style=color:#f92672>]</span>? n
</span></span><span style=display:flex><span>zsh: command not found: podman
</span></span></code></pre></div><p>After:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ podman
</span></span><span style=display:flex><span>zsh: correct <span style=color:#e6db74>&#39;podman&#39;</span> to <span style=color:#e6db74>&#39;pod2man&#39;</span> <span style=color:#f92672>[</span>nyae<span style=color:#f92672>]</span>? n
</span></span><span style=display:flex><span>podman may be found in the following packages:
</span></span><span style=display:flex><span>  &lt;cmd:podman&gt; podman-3.4.4-r1 x86_64 <span style=color:#f92672>{</span>podman<span style=color:#f92672>}</span> <span style=color:#f92672>(</span>Apache-2.0<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=preamble>Preamble<a hidden class=anchor aria-hidden=true href=#preamble>#</a></h2><p>Whenever you type a command that is not in your <code>$PATH</code>, usually your shell
will yell at you that it wasn&rsquo;t found.</p><p>The typical workflow in this scenario is to use the search functionality of your package manager in order to find which package provides the binary you&rsquo;re interested in.</p><p>In Alpine Linux, one would do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ apk search podman
</span></span><span style=display:flex><span>podman-doc-3.4.4-r1
</span></span><span style=display:flex><span>podman-remote-3.4.4-r1
</span></span><span style=display:flex><span>podman-docker-3.4.4-r1
</span></span><span style=display:flex><span>openscap-1.3.5-r3
</span></span><span style=display:flex><span>podman-3.4.4-r1
</span></span><span style=display:flex><span>podman-compose-0.1.5-r4
</span></span><span style=display:flex><span>podman-bash-completion-3.4.4-r1
</span></span><span style=display:flex><span>podman-zsh-completion-3.4.4-r1
</span></span><span style=display:flex><span>py3-podman-3.2.1-r1
</span></span><span style=display:flex><span>podman-docker-doc-3.4.4-r1
</span></span><span style=display:flex><span>podman-openrc-3.4.4-r1
</span></span><span style=display:flex><span>podman-fish-completion-3.4.4-r1
</span></span></code></pre></div><p>The output is a bit noisy, but with a bit of experience you could easily figure out the package you&rsquo;re looking for is simply called <code>podman</code>, given the output above.</p><p>Surely this was an easy example, what if we tried something less obvious?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ vidir
</span></span><span style=display:flex><span>zsh: correct <span style=color:#e6db74>&#39;vidir&#39;</span> to <span style=color:#e6db74>&#39;vdir&#39;</span> <span style=color:#f92672>[</span>nyae<span style=color:#f92672>]</span>? n
</span></span><span style=display:flex><span>zsh: command not found: vidir
</span></span></code></pre></div><p>There&rsquo;s no <code>vidir</code> binary, then surely there&rsquo;s a <code>vidir</code> package, right?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ doas apk add vidir
</span></span><span style=display:flex><span>ERROR: unable to <span style=color:#66d9ef>select</span> packages:
</span></span><span style=display:flex><span>  vidir <span style=color:#f92672>(</span>no such package<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>    required by: world<span style=color:#f92672>[</span>vidir<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Er, no. You&rsquo;ll need to use search again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ apk search vidir
</span></span><span style=display:flex><span>moreutils-0.67-r0
</span></span></code></pre></div><p>There it is, <code>moreutils</code>. Great piece of software, by the way<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>What if we could automate this?</p><h2 id=automating-command-not-found-1st-try>Automating command-not-found: 1st try<a hidden class=anchor aria-hidden=true href=#automating-command-not-found-1st-try>#</a></h2><p>In bash, one can define a <code>command_not_found_handle</code> function. In zsh, one can define a <code>command_not_found_handler</code> function. I know, why can&rsquo;t it be the same function, right? Just one <code>r</code> in the way. Regardless of whichever shell you use, the point is that the function is invoked whenever you run a command that is not in the <code>$PATH</code> (or that isn&rsquo;t a shell built-in).</p><p>In principle, you could do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>command_not_found_handle<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  local cmd<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  apk search <span style=color:#e6db74>&#34;</span>$cmd<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>It&rsquo;s a good first try, and it surely works as expected, but it can be a bit noisy sometimes. Look at the podman output above, it outputs several unrelated packages, none of which provide the <code>podman</code> binary other than its homonym.</p><h2 id=automating-command-not-found-2nd-try>Automating command-not-found: 2nd try<a hidden class=anchor aria-hidden=true href=#automating-command-not-found-2nd-try>#</a></h2><p>In Alpine, we can do slightly better. <code>apk(8)</code> has the concept of providers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ apk list -P | awk <span style=color:#e6db74>&#39;{print $1}&#39;</span> | egrep <span style=color:#e6db74>&#39;&lt;\w+:&#39;</span> | cut -f <span style=color:#ae81ff>1</span> -d <span style=color:#e6db74>&#39;:&#39;</span> | cut -c 2- | sort -u
</span></span><span style=display:flex><span>cmd
</span></span><span style=display:flex><span>dbus
</span></span><span style=display:flex><span>pc
</span></span><span style=display:flex><span>so
</span></span></code></pre></div><p><code>-P</code> above stands for <code>--providers</code>. This roughly means one can search for a package that provides a given shared library (<code>so</code>), or a package that provides a given binary (<code>cmd</code>), and so on. We&rsquo;re interested in the <code>cmd:</code> provider.</p><p>If we tried it with <code>podman</code>, we would get the following output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ apk list -P -- <span style=color:#e6db74>&#34;cmd:podman&#34;</span>
</span></span><span style=display:flex><span>&lt;cmd:podman&gt; podman-3.4.4-r1 x86_64 <span style=color:#f92672>{</span>podman<span style=color:#f92672>}</span> <span style=color:#f92672>(</span>Apache-2.0<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Look at how much shorter and direct it is, compared to the 1st approach!</p><p>Here&rsquo;s what it looks like if we try it with a binary provided by multiple packages:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ apk list -P -- <span style=color:#e6db74>&#34;cmd:docker&#34;</span>
</span></span><span style=display:flex><span>&lt;cmd:docker&gt; docker-cli-20.10.11-r0 x86_64 <span style=color:#f92672>{</span>docker<span style=color:#f92672>}</span> <span style=color:#f92672>(</span>Apache-2.0<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>installed<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>&lt;cmd:docker&gt; podman-docker-3.4.4-r1 x86_64 <span style=color:#f92672>{</span>podman<span style=color:#f92672>}</span> <span style=color:#f92672>(</span>Apache-2.0<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>It&rsquo;s very easy to see that both <code>docker-cli</code> and <code>podman-docker</code> provide <code>docker</code>. If you just did a simple search, you&rsquo;d get a lot of noise:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ apk search docker
</span></span><span style=display:flex><span>docker-bash-completion-20.10.11-r0
</span></span><span style=display:flex><span>docker-cli-20.10.11-r0
</span></span><span style=display:flex><span>docker-machine-driver-kvm2-1.24.0-r0
</span></span><span style=display:flex><span>x11docker-6.9.0-r2
</span></span><span style=display:flex><span>docker-volume-local-persist-1.3.0-r5
</span></span><span style=display:flex><span>podman-docker-3.4.4-r1
</span></span><span style=display:flex><span>openvswitch-2.12.3-r4
</span></span><span style=display:flex><span>docker-engine-20.10.11-r0
</span></span><span style=display:flex><span>docker-openrc-20.10.11-r0
</span></span><span style=display:flex><span>dockerize-0.6.1-r9
</span></span><span style=display:flex><span>docker-fish-completion-20.10.11-r0
</span></span><span style=display:flex><span>openscap-1.3.5-r3
</span></span><span style=display:flex><span>docker-py-5.0.3-r1
</span></span><span style=display:flex><span>openvswitch-ovn-2.12.3-r4
</span></span><span style=display:flex><span>docker-registry-openrc-2.7.1-r5
</span></span><span style=display:flex><span>docker-doc-20.10.11-r0
</span></span><span style=display:flex><span>rsyslog-imdocker-8.2108.0-r0
</span></span><span style=display:flex><span>lazydocker-0.12-r2
</span></span><span style=display:flex><span>docker-compose-bash-completion-1.29.2-r2
</span></span><span style=display:flex><span>docker-compose-1.29.2-r2
</span></span><span style=display:flex><span>py3-dockerpty-0.4.1-r4
</span></span><span style=display:flex><span>docker-compose-zsh-completion-1.29.2-r2
</span></span><span style=display:flex><span>docker-registry-2.7.1-r5
</span></span><span style=display:flex><span>docker-credential-ecr-login-0.5.0-r2
</span></span><span style=display:flex><span>dockerpy-creds-0.4.0-r3
</span></span><span style=display:flex><span>docker-cli-compose-2.1.1-r0
</span></span><span style=display:flex><span>docker-credential-ecr-login-doc-0.5.0-r2
</span></span><span style=display:flex><span>podman-docker-doc-3.4.4-r1
</span></span><span style=display:flex><span>docker-20.10.11-r0
</span></span><span style=display:flex><span>docker-compose-fish-completion-1.29.2-r2
</span></span><span style=display:flex><span>flannel-contrib-cni-0.15.1-r0
</span></span><span style=display:flex><span>docker-zsh-completion-20.10.11-r0
</span></span><span style=display:flex><span>docker-volume-local-persist-openrc-1.3.0-r5
</span></span><span style=display:flex><span>docker-cli-buildx-0.7.1-r0
</span></span></code></pre></div><h2 id=packagingpackaging-it-all-together>Packaging<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> it all together<a hidden class=anchor aria-hidden=true href=#packagingpackaging-it-all-together>#</a></h2><p>I wrote the following scripts, which I source in my respective interactive shells, to achieve this behavior out-of-the-box:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cat apk-command-not-found.bash
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span><span style=color:#75715e># apk(8) from Alpine Linux command not found hook for bash</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>command_not_found_handle <span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        local cmd<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> pkgs
</span></span><span style=display:flex><span>        mapfile -t pkgs &lt; &lt;<span style=color:#f92672>(</span>apk list -P -- <span style=color:#e6db74>&#34;cmd:</span>$cmd<span style=color:#e6db74>&#34;</span> 2&gt;/dev/null<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span> <span style=color:#e6db74>${#</span>pkgs[*]<span style=color:#e6db74>}</span> <span style=color:#f92672>))</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;</span>$cmd<span style=color:#e6db74> may be found in the following packages:&#34;</span>
</span></span><span style=display:flex><span>                printf <span style=color:#e6db74>&#39;  %s\n&#39;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>pkgs[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;bash: command not found: </span>$cmd<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span> 1&gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>127</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cat apk-command-not-found.zsh
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/zsh</span>
</span></span><span style=display:flex><span><span style=color:#75715e># apk(8) from Alpine Linux command not found hook for zsh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>command_not_found_handler<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        local cmd<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        local pkgs<span style=color:#f92672>=(</span><span style=color:#e6db74>${</span>(f)<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>apk list -P -- <span style=color:#e6db74>&#34;cmd:</span>$cmd<span style=color:#e6db74>&#34;</span> 2&gt;/dev/null<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>}</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -n <span style=color:#e6db74>&#34;</span>$pkgs<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;</span>$cmd<span style=color:#e6db74> may be found in the following packages:&#34;</span>
</span></span><span style=display:flex><span>                printf <span style=color:#e6db74>&#39;  %s\n&#39;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>pkgs[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                echo <span style=color:#e6db74>&#34;zsh: command not found: </span>$cmd<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span> 1&gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>127</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>The snippets above are snapshots intended for this post.
I keep up-to-date versions of these files in my dotfiles repository, <a href="https://github.com/thiagowfx/.dotfiles/search?q=filename%3Aapk-command-not-found&amp;type=code">try out this query</a> in case I ever move them elsewhere.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://joeyh.name/code/moreutils/>https://joeyh.name/code/moreutils/</a>: moreutils is a collection of the unix tools that nobody thought to write long ago when unix was young.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>pun intended&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://thiagowfx.github.io/tags/linux/>linux</a></li><li><a href=https://thiagowfx.github.io/tags/star/>star</a></li></ul></footer><div style=text-align:center><a href="mailto:tbperrotta@gmail.com?subject=RE: Not%20Just%20Serendipity comment for '%e2%98%85%20Alpine%20Linux%3a%20apk%20command%20not%20found%20hook'" target=_blank><button>Reply via email</button></a></div></article></main><footer class=footer><span>Copyright © 2021 - 2023 Thiago Perrotta • <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> • <a href=/index.xml>RSS</a> •</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>