<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>★ Arch Linux: New PKGBUILD Workflow | Not Just Serendipity</title>
<meta name=keywords content="dev,linux,star"><meta name=description content="This document describes my workflow to manage PKGBUILDs for the AUR (Arch User Repository) in Arch Linux."><meta name=author content="Thiago Perrotta"><link rel=canonical href=https://thiagowfx.github.io/2022/01/arch-linux-new-pkgbuild-workflow/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://thiagowfx.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://thiagowfx.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://thiagowfx.github.io/favicon.ico><link rel=apple-touch-icon href=https://thiagowfx.github.io/apple-touch-icon.png><link rel=mask-icon href=https://thiagowfx.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><style>body{font-family:Crimson Pro,Vollkorn,Alegreya,Iowan Old Style,Apple Garamond,Baskerville,Times New Roman,Noto Serif,Droid Serif,Times,Source Serif Pro,serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}h1,h2,h3,h4,h5,h6,footer,nav,.toc,.post-meta{font-family:Inter,Fira Sans,Lato,system-ui,-apple-system,BlinkMacSystemFont,Avenir Next,Avenir,Segoe UI,Helvetica Neue,Helvetica,Ubuntu,Roboto,Noto,Cantarell,Arial,sans-serif}code,pre{font-family:Fira Code,PT Mono,IBM Plex Mono,Menlo,Consolas,Monaco,Liberation Mono,Ubuntu Mono,Lucida Console,monospace}</style><meta property="og:title" content="★ Arch Linux: New PKGBUILD Workflow"><meta property="og:description" content="This document describes my workflow to manage PKGBUILDs for the AUR (Arch User Repository) in Arch Linux."><meta property="og:type" content="article"><meta property="og:url" content="https://thiagowfx.github.io/2022/01/arch-linux-new-pkgbuild-workflow/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-18T21:59:07-05:00"><meta property="article:modified_time" content="2022-01-18T21:59:07-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="★ Arch Linux: New PKGBUILD Workflow"><meta name=twitter:description content="This document describes my workflow to manage PKGBUILDs for the AUR (Arch User Repository) in Arch Linux."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://thiagowfx.github.io/posts/"},{"@type":"ListItem","position":2,"name":"★ Arch Linux: New PKGBUILD Workflow","item":"https://thiagowfx.github.io/2022/01/arch-linux-new-pkgbuild-workflow/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"★ Arch Linux: New PKGBUILD Workflow","name":"★ Arch Linux: New PKGBUILD Workflow","description":"This document describes my workflow to manage PKGBUILDs for the AUR (Arch User Repository) in Arch Linux.\n","keywords":["dev","linux","star"],"articleBody":"This document describes my workflow to manage PKGBUILDs for the AUR (Arch User Repository) in Arch Linux.\nDisclaimer First of all, this post is not a substitute to the excellent ArchWiki and it will likely get outdated at some point. In particular, refer to the following articles for up-to-date documentation that will outlive this blog:\nhttps://wiki.archlinux.org/title/Arch_User_Repository https://wiki.archlinux.org/title/Arch_package_guidelines https://wiki.archlinux.org/title/Creating_packages https://wiki.archlinux.org/title/PKGBUILD This article is not a tutorial, as such it assumes you already know what a PKGBUILD is and how to use makepkg. In particular, you should have the base-devel and devtools packages installed in your system.\nStructure I manage my packages with git plus Eli Schwartz’s excellent aurpublish. The tree structure is simple, with one PKGBUILD per directory:\n$ git clone https://github.com/thiagowfx/PKGBUILDs \u0026\u0026 tree PKGBUILDs PKGBUILDs ├── bkt │ └── PKGBUILD ├── fpp-git │ └── PKGBUILD ├── git-crecord │ └── PKGBUILD ├── i3a │ └── PKGBUILD ├── LICENSE ├── Makefile ├── README.md ├── ttf-camingocode │ └── PKGBUILD └── urlwatch.yml aurpublish is used solely to automate certain interactions with the AUR, more about it later.\nBootstrapping I am going to illustrate with a package I added recently, bkt:\nBefore you even begin, check if the package already exists, do a quick search in the AUR and also in the official repos1.\nStart by copying over the standard PKGBUILD template:\n$ cd PKGBUILDs $ mkdir bkt \u0026\u0026 cd bkt $ cp /usr/share/pacman/PKGBUILD.proto PKGBUILD $ $EDITOR PKGBUILD Fill in PKGBUILD metadata like pkgname=, url=, etc. Refer to the ArchWiki for up-to-date best practices.\nThe most important step is to refer to https://wiki.archlinux.org/title/Category:Arch_package_guidelines to figure out the package type.\nbkt is a Rust package. This is my first time packaging for Rust, not a problem though, as I can just refer to https://wiki.archlinux.org/title/Rust_package_guidelines.\nThe rust package guidelines page contains the blueprint for prepare(), check(), build() and package(). Packaging is mostly a matter of gluing everything together. Read the project README.md and the wiki, and then combine the needed steps in the PKGBUILD.\nBy doing so, I produced the following PKGBUILD:\npkgname=bkt pkgver=0.5.0 pkgrel=1 pkgdesc=\"A subprocess caching utility\" arch=('x86_64') url=\"https://www.bkt.rs/\" license=('MIT') makedepends=('cargo') source=(\"$pkgname-$pkgver.tar.gz::https://github.com/dimo414/$pkgname/archive/refs/tags/$pkgver.tar.gz\") sha256sums=() prepare() { cd \"$srcdir/$pkgname-$pkgver\" cargo fetch --locked --target \"$CARCH-unknown-linux-gnu\" } build() { cd \"$srcdir/$pkgname-$pkgver\" export RUSTUP_TOOLCHAIN=stable export CARGO_TARGET_DIR=target cargo build --frozen --release --all-features } check() { cd \"$srcdir/$pkgname-$pkgver\" export RUSTUP_TOOLCHAIN=stable cargo test --frozen --all-features } package() { cd \"$srcdir/$pkgname-$pkgver\" install -Dm0755 -t \"$pkgdir/usr/bin/\" \"target/release/$pkgname\" install -Dm644 LICENSE -t \"$pkgdir/usr/share/licenses/$pkgname\" } Note: $srcdir refers to the src/ directory within bkt. $pkgdir refers to the pkg/ directory within bkt.\nAdjustments Generate the checksums with updpkgsums. It will automatically update the PKGBUILD inplace.\nDownload and extract package files with makepkg -o.\nls src/ and check the directory structure. Update cd in your PKGBUILD to match it. Usually it will be cd $srcdir/$pkgname-$pkgver, but sometimes tiny adjustments are necessary.\nThen run makepkg -s. If everything goes well, your package will be successfully built2 (bkt-0.5.0-1-x86_64.pkg.tar.zst), however that doesn’t mean it is a decent package yet.\nRun namcap PKGBUILD and namcap *.pkg.tar.zst to lint your package and catch common errors. Fix the errors, if any.\nTo ensure all dependencies have been correctly declared and none of them are missing, run makepkg within a clean chroot. I like to use Graysky’s excellent ccm (Clean Chroot Manager) to do so. Run ccm s (=“run makepkg in the clean chroot”). If it produces any errors, it likely means you missed some dependencies. Adjust depends=, checkdepends= and makedepends= accordingly.\nRequest feedback if needed If the package is only relevant to you, stop here. git commit, git push, and then you’re done. Install the package with makepkg -i.\nOtherwise, if the package might be potentially useful to other Arch users, you could consider uploading it to the AUR.\nBefore you do so, stop for a moment and make an honest judgment whether this is a high quality package and whether you’re confident it is clean and polished enough, following the best practices documented in the Wiki. The answer doesn’t need to be positive, it’s perfectly OK to commit mistakes and everyone is a newbie at some point.\nIf the answer is negative, or if you’re new to this process and would like some help, fear no more! There are at least two decent community resources wherein to ask for help:\nAUR Issues, Discussion \u0026 PKGBUILD Requests BBS / Forums: Open a new thread, post your PKGBUILD (use [code][/code] tags if you paste it directly!) or a link to it3. Request folks to critique your work, mention that you’re looking for feedback. This kind of thread is generally well received in the official forums if you demonstrate you did diligent research before asking for help.\nAUR General Mailing List: Send an email to the mailing list asking for help. In general, follow proper mailing list etiquette, good resources for that are https://useplaintext.email/ and https://man.sr.ht/lists.sr.ht/etiquette.md. TL;DR: Use plain-text instead of HTML in your email.\nIf you’re part of any other community (e.g. Reddit, Discord) feel free to ask therein as well. Avoid posting everywhere though, pick one community, draft your post and then patiently wait.\nPublish your package If all is well, it’s time to publish your PKGBUILD to the AUR. Follow the up-to-date steps at https://wiki.archlinux.org/title/Arch_User_Repository#Submitting_packages.\nTL;DR: If you don’t use aurpublish, do:\n$ makepkg --printsrcinfo \u003e .SRCINFO Then you’ll need both the PKGBUILD and the .SRCINFO file, it’s basically a matter of committing your changes and pushing them to the right repository.\nIf you do use aurpublish this process is much easier, it’s mostly a matter of doing git commit, git push and aurpublish bkt. Aurpublish automatically generates the .SRCINFO and a commit message by the means of git hooks.\nAnd that’s all! Other useful tips:\nUse repology to look for preexisting packages in other Linux (or even BSD) distributions, it’s very handy as a starting point if you have no idea how to package a given package. In particular, Alpine Linux APKBUILDs are very similar to PKGBUILDs. Gentoo EBUILDs and FreeBSD Makefiles are also reasonable approximations. Use makepkg -src to clean up after building a package. Bonus: Track upstream Use a software like urlwatch or nvchecker to track future upstream changes so that you can update your packages in a timely fashion4. There’s also a web service called Release Monitoring, part of Fedora Infra. I use urlwatch the following way:\n$ cat PKGBUILDs/urlwatch.yml # urls for urlwatch(1) --- name: \"bkt\" command: \"git ls-remote --tags https://github.com/dimo414/bkt\" --- name: \"fpp\" command: \"git ls-remote --tags https://github.com/facebook/PathPicker\" --- name: \"git-crecord\" command: \"git ls-remote --tags https://github.com/andrewshadura/git-crecord\" --- name: \"i3a\" command: \"git ls-remote --tags https://git.goral.net.pl/mgoral/i3a\" # --- # name: \"ttf-camingocode\" # N/A # Run this command periodically via cron or systemd timer. # Set up notifications e.g. via sendmail. $ urlwatch --urls urlwatch.yml If you use https://duckduckgo.com/, query for !aur bkt and !archpkg bkt. Handy! ↩︎\nPackage debugging is out of scope of this post. ↩︎\nFor example, use https://gist.github.com or http://paste.opensuse.org/ or http://ix.io/. ↩︎\nIn 99% of the cases this is just a matter of bumping the pkgver= and updating the checksums. If pkgver= is the same but there’s a fix to the package itself, then bump pkgrel= instead. ↩︎\n","wordCount":"1179","inLanguage":"en","datePublished":"2022-01-18T21:59:07-05:00","dateModified":"2022-01-18T21:59:07-05:00","author":{"@type":"Person","name":"Thiago Perrotta"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://thiagowfx.github.io/2022/01/arch-linux-new-pkgbuild-workflow/"},"publisher":{"@type":"Person","name":"Not Just Serendipity","logo":{"@type":"ImageObject","url":"https://thiagowfx.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://thiagowfx.github.io/ accesskey=h title="Not Just Serendipity (Alt + H)"><img src=https://thiagowfx.github.io/apple-touch-icon.png alt aria-label=logo height=32>Not Just Serendipity</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://thiagowfx.github.io/posts/ title=posts><span>posts</span></a></li><li><a href=https://thiagowfx.github.io/archives/ title=archives><span>archives</span></a></li><li><a href=https://thiagowfx.github.io/tags/star/ title=bestof><span>bestof</span></a></li><li><a href=https://thiagowfx.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://thiagowfx.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>★ Arch Linux: New PKGBUILD Workflow</h1><div class=post-meta><span title='2022-01-18 21:59:07 -0500 -0500'>January 18, 2022</span>&nbsp;·&nbsp;1179 words&nbsp;·&nbsp;Thiago Perrotta</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#disclaimer aria-label=Disclaimer>Disclaimer</a></li><li><a href=#structure aria-label=Structure>Structure</a></li><li><a href=#bootstrapping aria-label=Bootstrapping>Bootstrapping</a></li><li><a href=#adjustments aria-label=Adjustments>Adjustments</a></li><li><a href=#request-feedback-if-needed aria-label="Request feedback if needed">Request feedback if needed</a></li><li><a href=#publish-your-package aria-label="Publish your package">Publish your package</a></li><li><a href=#bonus-track-upstream aria-label="Bonus: Track upstream">Bonus: Track upstream</a></li></ul></div></details></div><div class=post-content><p>This document describes my workflow to manage <code>PKGBUILDs</code> for the <a href=https://aur.archlinux.org/>AUR</a> (Arch User Repository) in <a href=https://www.archlinux.org/>Arch Linux</a>.</p><h2 id=disclaimer>Disclaimer<a hidden class=anchor aria-hidden=true href=#disclaimer>#</a></h2><p>First of all, this post is not a substitute to the excellent <a href=https://wiki.archlinux.org/>ArchWiki</a> and it will likely get outdated at some point. In particular, refer to the following articles for up-to-date documentation that will outlive this blog:</p><ul><li><a href=https://wiki.archlinux.org/title/Arch_User_Repository>https://wiki.archlinux.org/title/Arch_User_Repository</a></li><li><a href=https://wiki.archlinux.org/title/Arch_package_guidelines>https://wiki.archlinux.org/title/Arch_package_guidelines</a></li><li><a href=https://wiki.archlinux.org/title/Creating_packages>https://wiki.archlinux.org/title/Creating_packages</a></li><li><a href=https://wiki.archlinux.org/title/PKGBUILD>https://wiki.archlinux.org/title/PKGBUILD</a></li></ul><p>This article is not a tutorial, as such it assumes you already know what a <code>PKGBUILD</code> is and how to use <code>makepkg</code>. In particular, you should have the <code>base-devel</code> and <code>devtools</code> packages installed in your system.</p><h2 id=structure>Structure<a hidden class=anchor aria-hidden=true href=#structure>#</a></h2><p>I manage my packages with <code>git</code> plus Eli Schwartz&rsquo;s excellent
<a href=https://github.com/eli-schwartz/aurpublish>aurpublish</a>. The tree structure is simple, with one <code>PKGBUILD</code> per directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ git clone https://github.com/thiagowfx/PKGBUILDs <span style=color:#f92672>&amp;&amp;</span> tree PKGBUILDs
</span></span><span style=display:flex><span>PKGBUILDs
</span></span><span style=display:flex><span>├── bkt
</span></span><span style=display:flex><span>│   └── PKGBUILD
</span></span><span style=display:flex><span>├── fpp-git
</span></span><span style=display:flex><span>│   └── PKGBUILD
</span></span><span style=display:flex><span>├── git-crecord
</span></span><span style=display:flex><span>│   └── PKGBUILD
</span></span><span style=display:flex><span>├── i3a
</span></span><span style=display:flex><span>│   └── PKGBUILD
</span></span><span style=display:flex><span>├── LICENSE
</span></span><span style=display:flex><span>├── Makefile
</span></span><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>├── ttf-camingocode
</span></span><span style=display:flex><span>│   └── PKGBUILD
</span></span><span style=display:flex><span>└── urlwatch.yml
</span></span></code></pre></div><p><code>aurpublish</code> is used <em>solely</em> to automate certain interactions with the AUR, more about it later.</p><h2 id=bootstrapping>Bootstrapping<a hidden class=anchor aria-hidden=true href=#bootstrapping>#</a></h2><p>I am going to illustrate with a package I added recently, <a href=https://github.com/dimo414/bkt><code>bkt</code></a>:</p><ul><li><p>Before you even begin, check if the package already exists, do a quick search in the <a href="https://aur.archlinux.org/packages/?O=0&amp;K=bkt">AUR</a> and also in the <a href="https://archlinux.org/packages/?sort=&amp;q=bkt&amp;maintainer=&amp;flagged=">official repos</a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p></li><li><p>Start by copying over the standard <code>PKGBUILD</code> template:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd PKGBUILDs
</span></span><span style=display:flex><span>$ mkdir bkt <span style=color:#f92672>&amp;&amp;</span> cd bkt
</span></span><span style=display:flex><span>$ cp /usr/share/pacman/PKGBUILD.proto PKGBUILD
</span></span><span style=display:flex><span>$ $EDITOR PKGBUILD
</span></span></code></pre></div><ul><li><p>Fill in <code>PKGBUILD</code> metadata like <code>pkgname=</code>, <code>url=</code>, etc. Refer to the ArchWiki for up-to-date best practices.</p></li><li><p>The most important step is to refer to <a href=https://wiki.archlinux.org/title/Category:Arch_package_guidelines>https://wiki.archlinux.org/title/Category:Arch_package_guidelines</a> to figure out the package type.</p></li></ul><p><code>bkt</code> is a Rust package. This is my first time packaging for Rust, not a problem though, as I can just refer to <a href=https://wiki.archlinux.org/title/Rust_package_guidelines>https://wiki.archlinux.org/title/Rust_package_guidelines</a>.</p><p>The rust package guidelines page contains the blueprint for <code>prepare()</code>, <code>check()</code>, <code>build()</code> and <code>package()</code>. Packaging is mostly a matter of gluing everything together. Read the project <code>README.md</code> and the wiki, and then combine the needed steps in the <code>PKGBUILD</code>.</p><p>By doing so, I produced the following <code>PKGBUILD</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pkgname<span style=color:#f92672>=</span>bkt
</span></span><span style=display:flex><span>pkgver<span style=color:#f92672>=</span>0.5.0
</span></span><span style=display:flex><span>pkgrel<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>pkgdesc<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A subprocess caching utility&#34;</span>
</span></span><span style=display:flex><span>arch<span style=color:#f92672>=(</span><span style=color:#e6db74>&#39;x86_64&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://www.bkt.rs/&#34;</span>
</span></span><span style=display:flex><span>license<span style=color:#f92672>=(</span><span style=color:#e6db74>&#39;MIT&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>makedepends<span style=color:#f92672>=(</span><span style=color:#e6db74>&#39;cargo&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>source<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;</span>$pkgname<span style=color:#e6db74>-</span>$pkgver<span style=color:#e6db74>.tar.gz::https://github.com/dimo414/</span>$pkgname<span style=color:#e6db74>/archive/refs/tags/</span>$pkgver<span style=color:#e6db74>.tar.gz&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>sha256sums<span style=color:#f92672>=()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>prepare<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	cd <span style=color:#e6db74>&#34;</span>$srcdir<span style=color:#e6db74>/</span>$pkgname<span style=color:#e6db74>-</span>$pkgver<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	cargo fetch --locked --target <span style=color:#e6db74>&#34;</span>$CARCH<span style=color:#e6db74>-unknown-linux-gnu&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>build<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	cd <span style=color:#e6db74>&#34;</span>$srcdir<span style=color:#e6db74>/</span>$pkgname<span style=color:#e6db74>-</span>$pkgver<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	export RUSTUP_TOOLCHAIN<span style=color:#f92672>=</span>stable
</span></span><span style=display:flex><span>	export CARGO_TARGET_DIR<span style=color:#f92672>=</span>target
</span></span><span style=display:flex><span>	cargo build --frozen --release --all-features
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>check<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	cd <span style=color:#e6db74>&#34;</span>$srcdir<span style=color:#e6db74>/</span>$pkgname<span style=color:#e6db74>-</span>$pkgver<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	export RUSTUP_TOOLCHAIN<span style=color:#f92672>=</span>stable
</span></span><span style=display:flex><span>	cargo test --frozen --all-features
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>package<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	cd <span style=color:#e6db74>&#34;</span>$srcdir<span style=color:#e6db74>/</span>$pkgname<span style=color:#e6db74>-</span>$pkgver<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	install -Dm0755 -t <span style=color:#e6db74>&#34;</span>$pkgdir<span style=color:#e6db74>/usr/bin/&#34;</span> <span style=color:#e6db74>&#34;target/release/</span>$pkgname<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>	install -Dm644 LICENSE -t <span style=color:#e6db74>&#34;</span>$pkgdir<span style=color:#e6db74>/usr/share/licenses/</span>$pkgname<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><strong>Note</strong>: <code>$srcdir</code> refers to the <code>src/</code> directory within <code>bkt</code>. <code>$pkgdir</code> refers to the <code>pkg/</code> directory within <code>bkt</code>.</p><h2 id=adjustments>Adjustments<a hidden class=anchor aria-hidden=true href=#adjustments>#</a></h2><ul><li><p>Generate the checksums with <code>updpkgsums</code>. It will automatically update the <code>PKGBUILD</code> inplace.</p></li><li><p>Download and extract package files with <code>makepkg -o</code>.</p></li><li><p><code>ls src/</code> and check the directory structure. Update <code>cd</code> in your <code>PKGBUILD</code> to match it. Usually it will be <code>cd $srcdir/$pkgname-$pkgver</code>, but sometimes tiny adjustments are necessary.</p></li><li><p>Then run <code>makepkg -s</code>. If everything goes well, your package will be successfully built<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> (<code>bkt-0.5.0-1-x86_64.pkg.tar.zst</code>), however that doesn&rsquo;t mean it is a decent package yet.</p></li><li><p>Run <code>namcap PKGBUILD</code> and <code>namcap *.pkg.tar.zst</code> to lint your package and catch common errors. Fix the errors, if any.</p></li><li><p>To ensure all dependencies have been correctly declared and none of them are missing, run <code>makepkg</code> within a clean <a href=https://wiki.archlinux.org/title/Chroo><em>chroot</em></a>. I like to use Graysky&rsquo;s excellent <a href=https://github.com/graysky2/clean-chroot-manager><code>ccm</code></a> (Clean Chroot Manager) to do so. Run <code>ccm s</code> (=&ldquo;run makepkg in the clean chroot&rdquo;). If it produces any errors, it likely means you missed some dependencies. Adjust <code>depends=</code>, <code>checkdepends=</code> and <code>makedepends=</code> accordingly.</p></li></ul><h2 id=request-feedback-if-needed>Request feedback if needed<a hidden class=anchor aria-hidden=true href=#request-feedback-if-needed>#</a></h2><p>If the package is only relevant to you, stop here. <code>git commit</code>, <code>git push</code>, and then you&rsquo;re done. Install the package with <code>makepkg -i</code>.</p><p>Otherwise, if the package might be potentially useful to other Arch users, you could consider uploading it to the AUR.</p><p>Before you do so, stop for a moment and make an honest judgment whether this is a high quality package and whether you&rsquo;re confident it is clean and polished enough, following the best practices documented in the Wiki. The answer doesn&rsquo;t need to be positive, it&rsquo;s perfectly OK to commit mistakes and everyone is a newbie at some point.</p><p>If the answer is negative, or if you&rsquo;re new to this process and would like some help, fear no more! There are at least two decent community resources wherein to ask for help:</p><ol><li><p><a href="https://bbs.archlinux.org/viewforum.php?id=38.">AUR Issues, Discussion & PKGBUILD Requests</a> BBS / Forums: Open a new thread, post your <code>PKGBUILD</code> (use <code>[code][/code]</code> tags if you paste it directly!) or a link to it<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. Request folks to critique your work, mention that you&rsquo;re looking for feedback. This kind of thread is generally well received in the official forums if you demonstrate you did diligent research before asking for help.</p></li><li><p><a href=https://lists.archlinux.org/pipermail/aur-general/>AUR General Mailing List</a>: Send an email to the mailing list asking for help. In general, follow proper mailing list etiquette, good resources for that are <a href=https://useplaintext.email/>https://useplaintext.email/</a> and <a href=https://man.sr.ht/lists.sr.ht/etiquette.md>https://man.sr.ht/lists.sr.ht/etiquette.md</a>. TL;DR: Use plain-text instead of HTML in your email.</p></li></ol><p>If you&rsquo;re part of any other community (e.g. Reddit, Discord) feel free to ask therein as well. Avoid posting everywhere though, pick one community, draft your post and then patiently wait.</p><h2 id=publish-your-package>Publish your package<a hidden class=anchor aria-hidden=true href=#publish-your-package>#</a></h2><p>If all is well, it&rsquo;s time to publish your <code>PKGBUILD</code> to the <a href=https://aur.archlinux.org/>AUR</a>. Follow the up-to-date steps at <a href=https://wiki.archlinux.org/title/Arch_User_Repository#Submitting_packages>https://wiki.archlinux.org/title/Arch_User_Repository#Submitting_packages</a>.</p><p>TL;DR: If you don&rsquo;t use <em>aurpublish</em>, do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ makepkg --printsrcinfo &gt; .SRCINFO
</span></span></code></pre></div><p>Then you&rsquo;ll need both the <code>PKGBUILD</code> and the <code>.SRCINFO</code> file, it&rsquo;s basically a matter of committing your changes and pushing them to the right repository.</p><p>If you do use <em>aurpublish</em> this process is much easier, it&rsquo;s mostly a matter of doing <code>git commit</code>, <code>git push</code> and <code>aurpublish bkt</code>. <em>Aurpublish</em> automatically generates the <code>.SRCINFO</code> and a commit message by the means of git hooks.</p><p>And that&rsquo;s all! Other useful tips:</p><ul><li>Use <a href=https://repology.org/>repology</a> to look for preexisting packages in other Linux (or even BSD) distributions, it&rsquo;s very handy as a starting point if you have no idea how to package a given package. In particular, Alpine Linux <code>APKBUILDs</code> are very similar to <code>PKGBUILDs</code>. Gentoo <code>EBUILDs</code> and FreeBSD <code>Makefiles</code> are also reasonable approximations.</li><li>Use <code>makepkg -src</code> to clean up after building a package.</li></ul><h2 id=bonus-track-upstream>Bonus: Track upstream<a hidden class=anchor aria-hidden=true href=#bonus-track-upstream>#</a></h2><p>Use a software like <a href=https://thp.io/2008/urlwatch/><code>urlwatch</code></a> or <a href=https://github.com/lilydjwg/nvchecker><code>nvchecker</code></a> to track
future upstream changes so that you can update your packages in a timely
fashion<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>. There&rsquo;s also a web service called <a href=https://release-monitoring.org/>Release
Monitoring</a>, part of Fedora Infra. I use <code>urlwatch</code> the
following way:</p><pre tabindex=0><code>$ cat PKGBUILDs/urlwatch.yml
# urls for urlwatch(1)
---
name: &#34;bkt&#34;
command: &#34;git ls-remote --tags https://github.com/dimo414/bkt&#34;
---
name: &#34;fpp&#34;
command: &#34;git ls-remote --tags https://github.com/facebook/PathPicker&#34;
---
name: &#34;git-crecord&#34;
command: &#34;git ls-remote --tags https://github.com/andrewshadura/git-crecord&#34;
---
name: &#34;i3a&#34;
command: &#34;git ls-remote --tags https://git.goral.net.pl/mgoral/i3a&#34;
# ---
# name: &#34;ttf-camingocode&#34;
# N/A

# Run this command periodically via cron or systemd timer.
# Set up notifications e.g. via sendmail.
$ urlwatch --urls urlwatch.yml
</code></pre><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>If you use <a href=https://duckduckgo.com/>https://duckduckgo.com/</a>, query for <code>!aur bkt</code> and <code>!archpkg bkt</code>. Handy!&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Package debugging is out of scope of this post.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>For example, use <a href=https://gist.github.com>https://gist.github.com</a> or <a href=http://paste.opensuse.org/>http://paste.opensuse.org/</a> or
<a href=http://ix.io/>http://ix.io/</a>.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>In 99% of the cases this is just a matter of bumping the <code>pkgver=</code> and
updating the checksums. If <code>pkgver=</code> is the same but there&rsquo;s a fix to the
package itself, then bump <code>pkgrel=</code> instead.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://thiagowfx.github.io/tags/dev/>dev</a></li><li><a href=https://thiagowfx.github.io/tags/linux/>linux</a></li><li><a href=https://thiagowfx.github.io/tags/star/>star</a></li></ul></footer><div style=text-align:center><a href="mailto:tbperrotta@gmail.com?subject=RE: Not%20Just%20Serendipity comment for '%e2%98%85%20Arch%20Linux%3a%20New%20PKGBUILD%20Workflow'" target=_blank><button>Reply via email</button></a></div></article></main><footer class=footer><span>Copyright © 2021 - 2023 Thiago Perrotta • <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a> • <a href=/index.xml>RSS</a> •</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>